---
title: "An example of seasonal forecast development for Atlantic salmon smolts"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{salmon}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# INTRODUCTION

This document outlines the source of all data and calibration of all models used in the `fishcastr` package. All R scripts required to produce data (e.g., `fishcastr::data_Feeagh_discharge`) are contained in the `data_raw` folder of the package and are named accordingly (e.g., `data_raw/data_Feeagh_discharge.R`. To access the raw external data (e.g., netcdf .nc files) required to run `data_raw` scripts, download the `extdata` folder from the marine institute and paste it into the `fishcastr/inst/` folder and set working directory `setwd()` to the location of the R package.

# (1) DATA PROVENANCE AND PRE-PROCESSING

## (1a) Compile catchment specific data

```{r catchment_specific_data}
# ---------------------------------------------------------------------------------------------------------- #
# FISH COUNTS (see: data-raw/data_ssmolt.R ../data_seel.R  ../data_stsmolt.R) ----
data_ssmolt <- fishcastr::data_ssmolt

# ---------------------------------------------------------------------------------------------------------- #
# WATER TEMPERATURE (see: data-raw/data_Feeagh2m_temp.R) ----
data_Feeagh2m_temp <- fishcastr::data_Feeagh2m_temp

# ---------------------------------------------------------------------------------------------------------- #
# CATCHMENT DISCHARGE (see: data-raw/data_Feeagh_discharge.R) ----
data_Feeagh_discharge <- fishcastr::data_Feeagh_discharge

# ---------------------------------------------------------------------------------------------------------- #
# DATES AND LOCATION OF CATCHMENT ----
# dates <- data_ssmolt$date
# latitude <- 53.932458
# longitude <- -9.575556
```

## (1b) Access lunar and solar data

```{r lunar_solar_data}

# ---------------------------------------------------------------------------------------------------------- #
# CALCULATE PHOTOPERIOD (see: R/photper_calc.R) ----
data_photper <- fishcastr::photper_calc(dates = fishcastr::data_ssmolt[["date"]],
                                        latitude = 53.932458,
                                        longitude = -9.575556)

# ---------------------------------------------------------------------------------------------------------- #
# CATCHMENT MOONLIGHT EXPOSURE (see: R/lunar_light_exposure.R) ----
# subset of dates here as long to calculate
data_lunar <- fishcastr::lunar_light_exposure(date_of_interest = fishcastr::data_ssmolt[["date"]][1:365],
                                              lat = 53.932458,
                                              lon = -9.575556)
```

## (1c) Access climate data

```{r access_climate_data}
# ---------------------------------------------------------------------------------------------------------- #
# OBSERVATIONS (see: data-raw/data_met_obs/..)  ----
grid_met_obs_1979_2019 <- fishcastr::grid_met_obs_1979_2019
#visualizeR::temporalPlot(... = grid_met_obs_1979_2019$tas)

# ---------------------------------------------------------------------------------------------------------- #
# REANALYSIS (see: data-raw/grid_ERA5_reforecasts/..) ----
# raw grid (Re-forecasts and archived operational forecast years; 1993 - 2019)
# SPRING
grid_ERA5_1979_2019_Jan_raw <- fishcastr::grid_ERA5_1979_2019_Jan_raw
#visualizeR::temporalPlot(... = grid_ERA5_1979_2019_Jan_raw$tas)
# AUTUMN
grid_ERA5_1979_2019_Jun_raw <- fishcastr::grid_ERA5_1979_2019_Jun_raw
#visualizeR::temporalPlot(... = grid_ERA5_1979_2019_Jun_raw$tas)

# raw grid (Operational forecast year; 2020)
# SPRING

# AUTUMN

# ---------------------------------------------------------------------------------------------------------- #
# SEASONAL CLIMATE FORECAST (Re-forecasts and archived operational forecasts 1993 - 2019) ----
# (see: data-raw/grid_SEAS5_reforecasts/..)
# SPRING
grid_SEAS5_1993_2019_2_3_4_5_6_7_8_tas_pr_petH_raw <- fishcastr::grid_SEAS5_1993_2019_2_3_4_5_6_7_8_tas_pr_petH_raw
#visualizeR::temporalPlot(... = grid_SEAS5_1993_2019_2_3_4_5_6_7_8_tas_pr_petH_raw$pr)
# AUTUMN
grid_SEAS5_1993_2019_7_8_9_10_11_12_tas_pr_petH_raw <- fishcastr::grid_SEAS5_1993_2019_7_8_9_10_11_12_tas_pr_petH_raw

# SEASONAL CLIMATE FORECAST (Operational forecast year; 2020)
# SPRING

# AUTUMN
```

## (1d) Pre-process climate data

```{r pre_process_climate_data}
# ---------------------------------------------------------------------------------------------------------- #
# REANALYSIS (bias corrected) ----
# BC grid (Re-forecasts and archived operational forecast years; 1993 - 2019)
# SPRING (see: data-raw/grid_ERA5_reforecasts/grid_ERA5_1979_2019_Jan_bc.R)
grid_ERA5_1979_2019_Jan_bc <- fishcastr::grid_ERA5_1979_2019_Jan_bc
#visualizeR::temporalPlot(... = grid_ERA5_1979_2019_Jan_bc$tas)
# plot bias correctedand raw data alongside obs
#grid_met_obs_1979_2019 <- fishcastr::grid_met_obs_1979_2019
#grid_ERA5_1979_2019_Jan_raw <- fishcastr::grid_ERA5_1979_2019_Jan_raw
#par(mfrow = c(1,1))
#plot(grid_met_obs_1979_2019$tas$Data, type = "l", col = "black")
#lines(grid_ERA5_1979_2019_Jan_raw$tas$Data,  col = "red")
#lines(grid_ERA5_1979_2019_Jan_bc$tas$Data,  col = "blue")

# AUTUMN (see: data-raw/grid_ERA5_reforecasts/grid_ERA5_1979_2019_Jun_bc.R)
grid_ERA5_1979_2019_Jun_bc <-fishcastr::grid_ERA5_1979_2019_Jun_bc
#visualizeR::temporalPlot(... = grid_ERA5_1979_2019_Jun_bc$tas)
# if this... Error: object ‘EOF2clim’ is not exported by 'namespace:transformeR', ... install latest version of transformeR 

# ---------------------------------------------------------------------------------------------------------- #
# SEASONAL CLIMATE FORECAST (Re-forecasts and archived operational forecasts 1993 - 2019) ----
# SPRING (see: data-raw/grid_SEAS5_reforecasts/grid_SEAS5_1993_2019_2_3_4_5_6_7_8_tas_pr_petH_bc.R)
grid_SEAS5_1993_2019_2_3_4_5_6_7_8_tas_pr_petH_bc <- fishcastr::grid_SEAS5_1993_2019_2_3_4_5_6_7_8_tas_pr_petH_bc
#visualizeR::temporalPlot(... = grid_SEAS5_1993_2019_2_3_4_5_6_7_8_tas_pr_petH_bc$pr)
# AUTUMN (see: data-raw/grid_SEAS5_reforecasts/grid_SEAS5_1993_2019_7_8_9_10_11_12_tas_pr_petH_bc.R)
grid_SEAS5_1993_2019_7_8_9_10_11_12_tas_pr_petH_bc <- fishcastr::grid_SEAS5_1993_2019_7_8_9_10_11_12_tas_pr_petH_bc

# SEASONAL CLIMATE FORECAST (Operational forecast year; 2020)
# SPRING

# AUTUMN

```

# (2) MODEL CHAIN DEVELOPMENT

## (2a) Model hydrology and water temperature

```{r model_hydrology_water_temp}
# ---------------------------------------------------------------------------------------------------------- #
# CALIBRATE CATCHMENT DISCHARGE MODEL (see: data_raw/model_GR4J_calibration.R) ----
GR4J_Burr_params_ERA5_bcc <- fishcastr::GR4J_Burr_params_ERA5_bcc

# ---------------------------------------------------------------------------------------------------------- #
# CALIBRATE WATER TEMPERATURE MODEL (see: data_raw/data_air_to_water_model.R) ----
air_to_water_Feeagh_params_ERA5_bcc <- fishcastr::air_to_water_Feeagh_params_ERA5_bcc

```

## (2b) Model proxy for migration preparedness

```{r model_proxy_preparedness}
# ---------------------------------------------------------------------------------------------------------- #
# CALIBRATE MIGRATION PREPAREDNESS MODEL (see: data_raw/model_physio_expmG_salmon.R) ----
model_physio_expmG_salmon <- fishcastr::model_physio_expmG_salmon
```

## (2c) Model fish counts

```{r model_fish_counts}
# ---------------------------------------------------------------------------------------------------------- #
# CALCULATE PREDICTORS
# ---------------------------------------------------------------------------------------------------------- #

# ---------------------------------------------------------------------------------------------------------- #
# IMPORT BIAS ADJUSTED METEOROLOGICAL DATA -----
# ---------------------------------------------------------------------------------------------------------- #
data_ERA5_1979_2019_Jan_bc <- fishcastr::convert_grid_to_dataframe(grid_obj = fishcastr::grid_ERA5_1979_2019_Jan_bc)[,-2]
names(data_ERA5_1979_2019_Jan_bc)[which(names(data_ERA5_1979_2019_Jan_bc) == "dates1")] <- "date"

# ---------------------------------------------------------------------------------------------------------- #
# RUN AIR TO WATER TEMP MODEL -----
# ---------------------------------------------------------------------------------------------------------- #
data_water_temp <- data.frame(
  "date" = data_ERA5_1979_2019_Jan_bc$date,
  "Tw_mod" = fishcastr::air_to_water_model(
    Ta = data_ERA5_1979_2019_Jan_bc$tas,
    Yday = lubridate::yday(data_ERA5_1979_2019_Jan_bc$date),
    A = fishcastr::air_to_water_Feeagh_params_ERA5_bcc$A,
    ac = fishcastr::air_to_water_Feeagh_params_ERA5_bcc$ac,
    b = fishcastr::air_to_water_Feeagh_params_ERA5_bcc$b,
    B = fishcastr::air_to_water_Feeagh_params_ERA5_bcc$B
  )
)

# ---------------------------------------------------------------------------------------------------------- #
# RUN HYDROLOGIC MODEL ----
# ---------------------------------------------------------------------------------------------------------- #
data_discharge <- fishcastr::hydrologic_model(met_data = data_ERA5_1979_2019_Jan_bc[,c("date","pr","petH")] ,
                                              warm_up_dates_range = c(as.Date("1979-01-01"),
                                                                     as.Date("1980-12-20")),
                                              run_dates_range = c(as.Date("1980-12-21"),
                                                                 as.Date("2019-01-31")),
                                              GR4J_params = as.numeric(fishcastr::GR4J_Burr_params_ERA5_bcc))


# ---------------------------------------------------------------------------------------------------------- #
# ESTIMATE MIGRATION PREPAREDNESS ----
# ---------------------------------------------------------------------------------------------------------- #

# stratify forecast years and retain photoperiod
data_ssmolt_forecast_years <- fishcastr::bio_year_photoper(dates = data_water_temp$date,
                                                           latitude = 53.932458,
                                                           longitude = -9.575556,
                                                           retain_photoper = TRUE,
                                                           start_previous_year = TRUE,
                                                           shortest_day = TRUE,
                                                           yday_head = "salmonid_yday",
                                                           bio_year_head = "salmonid_year")

# calculate photoperiod weighted degree days from specified solstice dates
pwdds <- fishcastr::convert_stratified_census_data_to_model_warmup_list(
  water_temp = data_water_temp$Tw_mod,
  photoper = data_ssmolt_forecast_years$photoper,
  forecast_years = data_ssmolt_forecast_years$salmonid_year,
  forecast_yday = data_ssmolt_forecast_years$salmonid_yday,
  dates = data_ssmolt_forecast_years$date,
  no_years_warmup = 0,
  delete_op_year = FALSE
)

# convert photoperiod weighted degree days to proxy preparedness variable
migration_preparedness <- data.frame("date"= pwdds$date, "migration_prep" =
  fishcastr::exp_mod_Gaussian_resp(
    x = pwdds$weighted_dds_water,
    c = fishcastr::model_physio_expmG_salmon$coefs["c"],
    mu_exmg = fishcastr::model_physio_expmG_salmon$coefs["mu_exmg"],
    sigma_exmg = fishcastr::model_physio_expmG_salmon$coefs["sigma_exmg"],
    lamb = fishcastr::model_physio_expmG_salmon$coefs["lamb"]
  ))

# ---------------------------------------------------------------------------------------------------------- #
# ESTIMATE MOONLIGHT EXPOSURE ----
# ---------------------------------------------------------------------------------------------------------- #
data_lunar <- data.frame("date"= migration_preparedness$date,
                         "moonlight_exposure" = fishcastr::lunar_light_exposure(date_of_interest = migration_preparedness$date,
                                                                                lat = 53.932458,
                                                                                lon = -9.575556))

# ---------------------------------------------------------------------------------------------------------- #
# IMPORT AND APPEND COUNT DATA TO FORECAST YEARS ENVIRONMENTAL DATA ----
# ---------------------------------------------------------------------------------------------------------- #
data_ssmolt <- fishcastr::data_ssmolt

# Use Reduce function instead of merge...
data_ssmolt_enviro_1981_2019 <- Reduce(function(x,y) merge(x,y,by="date"),
                                       list(data_ssmolt,
                                            data_ssmolt_forecast_years,
                                            data_water_temp,
                                            data_discharge,
                                            migration_preparedness,
                                            data_lunar))

# dirName <- paste0(getwd(),"/vignettes/vignette_data", "/", sep = "", collapse = NULL)
# dir.create(dirName, showWarnings = TRUE, mode = "0777")
# 
# saveRDS(data_ssmolt_enviro_1981_2019, file = paste0(dirName,"data_ssmolt_enviro_1981_2019.rds"))
# rm(list = ls(all.names = TRUE))
# invisible(gc())
# ---------------------------------------------------------------------------------------------------------- #
# 
```
