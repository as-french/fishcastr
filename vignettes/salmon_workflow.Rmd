---
title: "Seasonal forecast development for Atlantic salmon smolts"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown::html_vignette
bibliography: Literature_cited.bib
csl: FishFisheries.csl
vignette: >
  %\VignetteIndexEntry{Seasonal forecast development for Atlantic salmon smolts}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<!-- --- -->
<!-- title: "Seasonal forecast development for Atlantic salmon smolts" -->
<!-- date: "`r format(Sys.time(), '%d %B, %Y')`" -->
<!-- always_allow_html: yes -->
<!-- bibliography: Literature_cited.bib -->
<!-- csl: FishFisheries.csl -->
<!-- output: -->
<!--   md_document: -->
<!--     toc: true -->
<!--   rmarkdown::word_document: -->
<!--     reference_docx: word-styles-reference-02.docx -->
<!--     toc: yes -->
<!--     number_sections: no -->
<!--   rmarkdown::html_notebook: -->
<!--     toc: yes -->
<!--     number_sections: no -->
<!--   rmarkdown::html_document: -->
<!--     code_folding: hide -->
<!--     toc: yes -->
<!--     number_sections: no -->
<!--   fig_height: 7 -->
<!--   fig_width: 7 -->
<!-- vignette: > -->
<!--   %\VignetteEncoding{UTF-8} -->
<!--   %\VignetteIndexEntry{Seasonal forecast development for Atlantic salmon smolts} -->
<!--   %\VignetteEngine{knitr::rmarkdown} -->
<!-- editor_options:  -->
<!--   chunk_output_type: console -->
<!-- --- -->

```{r, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE,
                      comment = "#>")
```

# PURPOSE OF THIS DOCUMENT

Here we highlight the sources of data and models stored in the `fishcastr` in addition to remotely accessed raw data from which the results presented in the accompanying manuscript were ultimately derived. This document and scripts contained in the [/data-raw/](https://github.com/as-french/fishcastr/tree/master/data-raw) folder of the [fishcastr GitHub repository](https://github.com/as-french/fishcastr) complete the reproducibility chain.

## DATA LICENSING

To facilitate faster reproducibility checks while minimising the volume of data stored within the package, we have included only post-processed ECMWF ERA5 and SEAS5 data that we accessed using the [Copernicus Climate Data Store (CDS)](https://doi.org/10.24381/cds.adbb2d47). Here, we aggregated sub-daily data (hourly for ERA5; 6-hourly for SEAS5) to daily values, calculated daily potential evapotranspiration, spatially interpolated from grid to point for Burrishoole and statistically bias adjusted against local gap-filled weather station data. To access the raw ERA5 and SEAS5 data using the Copernicus CDS and follow our processing steps, see [/data-raw/grid_ERA5_download_scripts/](https://github.com/as-french/fishcastr/tree/master/data-raw/grid_ERA5_download_scripts) and [/data-raw/grid_SEAS5_download_scripts/](https://github.com/as-french/fishcastr/tree/master/data-raw/grid_SEAS5_download_scripts).

To comply with the [License to Use Copernicus Products](https://cds.climate.copernicus.eu/api/v2/terms/static/licence-to-use-copernicus-products.pdf) in addition to the [License to Use C3S seasonal forecast multi-system](https://cds.climate.copernicus.eu/api/v2/terms/static/Additional-licence-to-use-non-European-contributions.pdf) for data originating from European modelling centres, we state:

***"The fishcastr R package contains modified Copernicus Climate Change Service information derived from the ECMWF ERA5 hourly data on single levels from 1979 to present (years included in fishcastr: 1979 - 2019) and modified ECMWF SEAS5 Seasonal forecast daily and subdaily data on single levels 1993 to present (years included in fishcastr: 1993 - 2019)"***

## ADDITIONAL INFORMATION

For further details of data sources and corresponding model calibrations referenced in this document (i.e., "hydrologic", "water temperature" and "migration preparedness" elements of the model chain), see scripts contained in [/data-raw/](https://github.com/as-french/fishcastr/tree/master/data-raw).

The following sections correspond to numbered items **1 a b c** and **d** through **2 a** and **b** in **Figure 1** of the accompanying manuscript.

# (1) DATA PROVENANCE AND PRE-PROCESSING

## (1a) Compile catchment specific data

```{r catchment_specific_data_fish, eval=FALSE}
# ---------------------------------------------------------------------------------------------------------- #
# FISH COUNTS ----
# ---------------------------------------------------------------------------------------------------------- #

# download fish data from Foras na Mara Marine Institute (Ireland)
fishcastr::download_fish_data()
data_ssmolt <- fishcastr::import_fish_data(species = "ssmolt")

data_ssmolt$year <-lubridate::year(data_ssmolt$date)
data_ssmolt$yday <-lubridate::yday(data_ssmolt$date)
data_ssmolt <- data_ssmolt[data_ssmolt$year >= 1981,]

# calculate average per year day
mean_daily_count <- tapply(data_ssmolt$ssmolt,INDEX = data_ssmolt$yday,FUN = mean,na.rm = TRUE)
lower_pct <- tapply(data_ssmolt$ssmolt,INDEX = data_ssmolt$yday,FUN = quantile, probs = 0.025,na.rm = TRUE)
upr_pct <- tapply(data_ssmolt$ssmolt,INDEX = data_ssmolt$yday,FUN = quantile,probs = 0.975,na.rm = TRUE)
df_mean <- data.frame("yday" = names(mean_daily_count),
                        "mean_count" = as.vector(mean_daily_count),
                        "lwr" = as.vector(lower_pct),
                        "upr" = as.vector(upr_pct))
df_counts <- merge(data_ssmolt,df_mean, by = "yday",all.x = TRUE)
df_counts_order <- df_counts[order(df_counts$date),]

  # for plotting clarity replace zeros with NAs
  ####
      df_counts_order$ssmolt[1] <- ifelse(df_counts_order$ssmolt[1] == 0 & df_counts_order$ssmolt[2] == 0, NA, df_counts_order$ssmolt[1])

      for(j in 2:(length(df_counts_order$ssmolt)-1)){
        df_counts_order$ssmolt[j] <- ifelse(df_counts_order$ssmolt[j] == 0 & df_counts_order$ssmolt[j-1] == 0 & df_counts_order$ssmolt[j+1] == 0, NA, df_counts_order$ssmolt[j])
      }

      df_counts_order$ssmolt[length(df_counts_order$ssmolt)] <- ifelse(df_counts_order$ssmolt[length(df_counts_order$ssmolt)] == 0 & df_counts_order$ssmolt[length(df_counts_order$ssmolt)-1] == 0, NA, df_counts_order$ssmolt[length(df_counts_order$ssmolt)])
  ####
      
# set plot colours
rgb_col <- col2rgb("black")
col_alpha_black <- rgb(red = rgb_col[1], green = rgb_col[2], blue = rgb_col[3],
                             alpha = 50, maxColorValue = 255)
rgb_col <- col2rgb("red")
col_alpha_red <- rgb(red = rgb_col[1], green = rgb_col[2], blue = rgb_col[3],
                             alpha = 60, maxColorValue = 255)
# plot data
# create vignettes folder
dir_dat <- paste0(system.file("", package = "fishcastr"),"/vignettes/")
dir.create(dir_dat, showWarnings = TRUE, recursive = TRUE, mode = "0777")

dirName <- paste0(system.file("extdata", package = "fishcastr"),"/salmon_wflow_figs/")
dir.create(dirName, showWarnings = TRUE, mode = "0777")

png(filename = paste0(dirName,"catchment_specific_data-1-salmon.png"), height = 2300, width = 1500, res =300)
par(mfcol = c(13,3),oma = c(8,4,1,1), mar = c(0.5,0.5,0.1,0.1))
for(i in unique(df_counts_order$year)) {
#  ylims <- c(0,max(c(max(df_counts_order$mean_count[df_counts_order$year == i],na.rm = TRUE),
#                   max(df_counts_order$ssmolt[df_counts_order$year == i],na.rm = TRUE))))
        low_yvals <- ifelse(is.na(df_counts_order$ssmolt[df_counts_order$year == i]),NA, 0)
  low_yvals_ave <- ifelse(is.na(df_counts_order$lwr[df_counts_order$year == i]),NA, 0)
        
  ylims = c(0,2800)
  xlims <- c(80,180)
  plot(df_counts_order$yday[df_counts_order$year == i],
       df_counts_order$mean_count[df_counts_order$year == i], col = NULL, ylim = ylims,xlab = "", ylab = "",
       xaxt = "n",yaxt = "n", xlim = xlims)
  title(main = i,adj = 0.9, line = -1)
  if(i %in% c(1993,2006,2019)){
    axis(side = 1, tck = 0.1)
  }
    if(i %in% c(1981:1993)){
    axis(side = 2, tck = 0.1)
    }
  
  # polygons upper 95% PI
  fishcastr::step_style_polygon(
    xvals = ifelse(is.na(low_yvals_ave), NA,
                       df_counts_order$yday[df_counts_order$year == i]),
    y_vals_low = low_yvals_ave,
    y_vals_up = ifelse(is.na(low_yvals_ave), NA,
                       df_counts_order$upr[df_counts_order$year == i]),
    col_alpha_rgb = col_alpha_black,
    border = NA
  )
  
  # line for mean
  lines(df_counts_order$yday[df_counts_order$year == i &
                                   df_counts_order$mean_count > 0],
          df_counts_order$mean_count[df_counts_order$year == i &
                                             df_counts_order$mean_count > 0], lwd = 0.5, col = col_alpha_black,type = "s")
  
  fishcastr::step_style_polygon(
    xvals = ifelse(is.na(low_yvals), NA,
                       df_counts_order$yday[df_counts_order$year == i]),
    y_vals_low = low_yvals,
    y_vals_up = ifelse(is.na(low_yvals), NA,
                       df_counts_order$ssmolt[df_counts_order$year == i]),
    col_alpha_rgb = col_alpha_red,
    border = "red", lwd = 0.5
  )
  
}
mtext(side = 1,text = "Calendar year day",outer = TRUE,line = 2)
mtext(side = 2,text = expression(italic("S. salar ")~smolt~count),outer = TRUE,line = 2)
legend("bottomright", legend = c("Daily count","1981 - 2019 mean daily count\nand 95 percentile range"),
       col = c(col_alpha_red,col_alpha_black),pt.lwd = c(NA,1),
       lty = c(NA,1),lwd = c(NA,1),
       pch = c(15,15),bty = "n",
       inset = c(0.1,-2.5),
       xpd = NA, cex = 1.3)
dev.off()
```

```{r catchment_specific_data-1-salmon, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/salmon_wflow_figs/")
knitr::include_graphics(path = paste0(dirName,"catchment_specific_data-1-salmon.png"))
```

```{r catchment_specific_data_water_temp, eval=FALSE}
# ---------------------------------------------------------------------------------------------------------- #
# WATER TEMPERATURE ----
fishcastr::download_Feeagh_water_temp() # this could take a few minutes to download and unzip

data_Feeagh2m_temp <- readRDS(file = paste0(system.file("extdata",
                                                        package = "fishcastr"),
                                            "/data_Feeagh2m_temp.rds"))

data_Feeagh2m_temp$year <-lubridate::year(data_Feeagh2m_temp$date)
data_Feeagh2m_temp$yday <-lubridate::yday(data_Feeagh2m_temp$date)

# calculate average per year day
mean_daily_temp <- tapply(data_Feeagh2m_temp$Water_Temp_2m,INDEX = data_Feeagh2m_temp$yday,FUN = mean,na.rm = TRUE)
lower_pct <- tapply(data_Feeagh2m_temp$Water_Temp_2m,INDEX = data_Feeagh2m_temp$yday,FUN = quantile, probs = 0.025,na.rm = TRUE)
upr_pct <- tapply(data_Feeagh2m_temp$Water_Temp_2m,INDEX = data_Feeagh2m_temp$yday,FUN = quantile,probs = 0.975,na.rm = TRUE)
df_mean <- data.frame("yday" = names(mean_daily_temp),
                        "mean_temp" = as.vector(mean_daily_temp),
                        "lwr" = as.vector(lower_pct),
                        "upr" = as.vector(upr_pct))
df_temps <- merge(data_Feeagh2m_temp,df_mean, by = "yday",all.x = TRUE)
df_temps_order <- df_temps[order(df_temps$date),]

# set plot colours
rgb_col <- col2rgb("black")
col_alpha_black <- rgb(red = rgb_col[1], green = rgb_col[2], blue = rgb_col[3],
                             alpha = 50, maxColorValue = 255)

# plot data
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/salmon_wflow_figs/")
#dir.create(dirName, showWarnings = TRUE, mode = "0777")

png(filename = paste0(dirName,"catchment_specific_data-2-salmon.png"), height = 1500, width = 2000, res =300)
#png(filename = "salmon_wflow_figs/catchment_specific_data-2-salmon.png")
par(mfcol = c(4,4),oma = c(10,4,1,1), mar = c(1,0.5,0.1,0.1))
for(i in unique(df_temps_order$year)) {
  ylims <- c(0,max(c(max(df_temps_order$upr[df_temps_order$year == i],na.rm = TRUE),
                   max(df_temps_order$Water_Temp_2m[df_temps_order$year == i], na.rm = TRUE))))
  xlims <- c(1,365)
  plot(df_temps_order$yday[df_temps_order$year == i],
       df_temps_order$mean_temp[df_temps_order$year == i], col = NULL, ylim = ylims,xlab = "", ylab = "",xaxt = "n",yaxt = "n", xlim = xlims)
  title(main = i,adj = 0.9, line = -1)
  if(i %in% c(2007,2011,2015,2019)){
    axis(side = 1, tck = 0.1)
  }
    if(i %in% c(2004:2007)){
    axis(side = 2, tck = 0.1)
  }
  # polygons
  fishcastr::step_style_polygon(xvals = df_temps_order$yday[df_temps_order$year == i],
                     y_vals_low = df_temps_order$lwr[df_temps_order$year == i],
                     y_vals_up = df_temps_order$upr[df_temps_order$year == i],
                     col_alpha_rgb = col_alpha_black, border = NA)

    lines(df_temps_order$yday[df_temps_order$year == i],
        df_temps_order$mean_temp[df_temps_order$year == i], lty = 1, lwd = 0.75, col = col_alpha_black)
  
  lines(df_temps_order$yday[df_temps_order$year == i],
        df_temps_order$Water_Temp_2m[df_temps_order$year == i], lty = 1, lwd = 0.75, col = "red")

}
mtext(side = 1,text = "yday",outer = TRUE,line = 2)
mtext(side = 2,text = expression("Water temperature ("*~degree*C*")"),outer = TRUE,line = 2)
legend("bottomright", legend = c("Water temperature","1981 - 2019 mean daily water temperature\nand 95 percentile range"),col = c("red",col_alpha_black), pch = c(NA,15),lty = c(1,NULL),bty = "n",inset = c(0.1,-1.8), xpd = NA, cex = 1.5)
dev.off()
```

```{r catchment_specific_data-2-salmon, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/salmon_wflow_figs/")
knitr::include_graphics(path = paste0(dirName,"catchment_specific_data-2-salmon.png"))
```

```{r catchment_specific_data_discharge, eval=FALSE}
# ---------------------------------------------------------------------------------------------------------- #
# CATCHMENT DISCHARGE ----
#data_Feeagh_discharge <- fishcastr::data_Feeagh_discharge
fishcastr::download_Feeagh_wlevel()

data_Feeagh_discharge <- readRDS(file = paste0(system.file("extdata",
                                                        package = "fishcastr"),
                                            "/data_Feeagh_discharge_corr.rds"))

data_Feeagh_discharge$year <-lubridate::year(data_Feeagh_discharge$date)
data_Feeagh_discharge$yday <-lubridate::yday(data_Feeagh_discharge$date)
data_Feeagh_discharge <- data_Feeagh_discharge[data_Feeagh_discharge$year >= 1981 & data_Feeagh_discharge$year <= 2019,]

# calculate average per year day
mean_daily_discharge <- tapply(data_Feeagh_discharge$discharge_m3.s,INDEX = data_Feeagh_discharge$yday,FUN = mean,na.rm = TRUE)
lower_pct <- tapply(data_Feeagh_discharge$discharge_m3.s,INDEX = data_Feeagh_discharge$yday,FUN = quantile, probs = 0.025,na.rm = TRUE)
upr_pct <- tapply(data_Feeagh_discharge$discharge_m3.s,INDEX = data_Feeagh_discharge$yday,FUN = quantile,probs = 0.975,na.rm = TRUE)
df_mean <- data.frame("yday" = names(mean_daily_discharge),
                        "mean_discharge" = as.vector(mean_daily_discharge),
                        "lwr" = as.vector(lower_pct),
                        "upr" = as.vector(upr_pct))
df_discharge <- merge(data_Feeagh_discharge,df_mean, by = "yday",all.x = TRUE)
df_discharge_order <- df_discharge[order(df_discharge$date),]

# set plot colours
rgb_col <- col2rgb("black")
col_alpha_black <- rgb(red = rgb_col[1], green = rgb_col[2], blue = rgb_col[3],
                             alpha = 40, maxColorValue = 255)

# plot data
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/salmon_wflow_figs/")
png(filename = paste0(dirName,"catchment_specific_data-3-salmon.png"), height = 2300, width = 1500, res =300)
par(mfcol = c(13,3),oma = c(8,4,1,1), mar = c(0.5,0.5,0.1,0.1))
for(i in unique(df_discharge_order$year)) {
  ylims <- c(0,max(c(max(df_discharge_order$upr[df_discharge_order$year == i],na.rm = TRUE),
                   max(df_discharge_order$discharge_m3.s[df_discharge_order$year == i], na.rm = TRUE))))
  xlims <- c(1,365)
  plot(df_discharge_order$yday[df_discharge_order$year == i],
       df_discharge_order$mean_discharge[df_discharge_order$year == i], col = NULL, ylim = ylims,xlab = "", ylab = "",xaxt = "n",yaxt = "n", xlim = xlims)
  title(main = i,adj = 0.5, line = -1)
  if(i %in% c(1993,2006,2019)){
    axis(side = 1, tck = 0.1)
  }
    if(i %in% c(1981:1993)){
    axis(side = 2, tck = 0.1)
  }
  # polygons
  fishcastr::step_style_polygon(xvals = df_discharge_order$yday[df_discharge_order$year == i],
                     y_vals_low = df_discharge_order$lwr[df_discharge_order$year == i],
                     y_vals_up = df_discharge_order$upr[df_discharge_order$year == i],
                     col_alpha_rgb = col_alpha_black, border = NA)

      lines(df_discharge_order$yday[df_discharge_order$year == i],
        df_discharge_order$mean_discharge[df_discharge_order$year == i], lty = 1, lwd = 0.75, col = col_alpha_black)
  
  lines(df_discharge_order$yday[df_discharge_order$year == i],df_discharge_order$discharge_m3.s[df_discharge_order$year == i], lty = 1, lwd = 1, col = "blue")

}
mtext(side = 1,text = "yday",outer = TRUE,line = 2)
mtext(side = 2,text = expression(paste("Catchment discharge (","m"^"3", "/s)")),outer = TRUE,line = 2)

legend("bottomright", legend = c("Catchment discharge","1981 - 2019 mean daily count\nand 95 percentile range"),
       col = c("blue",col_alpha_black),pt.lwd = c(NA,1),
       lty = c(1,1),lwd = c(1,1),
       pch = c(NA,15),bty = "n",
       inset = c(0.1,-2.5),
       xpd = NA, cex = 1.3)

dev.off()
# ---------------------------------------------------------------------------------------------------------- #
# DATES AND LOCATION OF CATCHMENT ----
# dates <- data_ssmolt$date
# latitude <- 53.932458
# longitude <- -9.575556
```

```{r catchment_specific_data-3-salmon, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/salmon_wflow_figs/")
knitr::include_graphics(path = paste0(dirName,"catchment_specific_data-3-salmon.png"))
```

## (1b) Access lunar and solar data

```{r lunar_solar_data, eval=FALSE}
# ---------------------------------------------------------------------------------------------------------- #
# CALCULATE PHOTOPERIOD (see: R/photper_calc.R) ----
data_photper <- fishcastr::photper_calc(dates = fishcastr::import_fish_data(species = "ssmolt")[["date"]][1:1000],
                                        latitude = 53.932458,
                                        longitude = -9.575556)
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/salmon_wflow_figs/")
png(filename = paste0(dirName,"lunar_solar_data-1-salmon.png"), height = 1000, width = 1500, res =300)
plot(fishcastr::import_fish_data(species = "ssmolt")[["date"]][1:1000], data_photper[1:1000], type = "l", ylab = "photperiod (hours)", xlab = paste0("days after ",min(fishcastr::import_fish_data(species = "ssmolt")[["date"]])))
dev.off()
#knitr::include_graphics(path = "salmon_wflow_figs/lunar_solar_data-1-salmon.png")

# ---------------------------------------------------------------------------------------------------------- #
# CATCHMENT MOONLIGHT EXPOSURE (see: R/lunar_light_exposure.R) ----
# subset of dates here as long to calculate
# data_lunar <- fishcastr::lunar_light_exposure(date_of_interest = fishcastr::import_fish_data(species = "ssmolt")[["date"]][1:365],
#                                               lat = 53.932458,
#                                               lon = -9.575556,
#                                               log_result = FALSE)
# 
# dirName <- paste0(system.file("extdata", package = "fishcastr"),"/salmon_wflow_figs/")
# png(filename = paste0(dirName,"lunar_solar_data-2-salmon.png"), height = 1000, width = 1500, res =300)
# plot(fishcastr::import_fish_data(species = "ssmolt")[["date"]][1:365], data_lunar[1:365], type = "l", ylab = "moonlight exposure",xlab = paste0("days after ",min(fishcastr::import_fish_data(species = "ssmolt")[["date"]])))
# dev.off()

# ---------------------------------------------------------------------------------------------------------- #
data_lunar <- fishcastr::lunar_light_exposure(date_of_interest = fishcastr::import_fish_data(species = "ssmolt")[["date"]],
                                              lat = 53.932458,
                                              lon = -9.575556,
                                              log_result = FALSE)
data_lunar_df <- data.frame("date" = fishcastr::import_fish_data(species = "ssmolt")[["date"]],
                            "moonlight_exposure" = data_lunar)

data_lunar_df$year <-lubridate::year(data_lunar_df$date)
data_lunar_df$yday <-lubridate::yday(data_lunar_df$date)

# calculate average per year day
mean_lunar_exp <- tapply(data_lunar_df$moonlight_exposure,INDEX = data_lunar_df$yday,FUN = mean,na.rm = TRUE)
lower_pct <- tapply(data_lunar_df$moonlight_exposure,INDEX = data_lunar_df$yday,FUN = quantile, probs = 0.025,na.rm = TRUE)
upr_pct <- tapply(data_lunar_df$moonlight_exposure,INDEX = data_lunar_df$yday,FUN = quantile,probs = 0.975,na.rm = TRUE)
df_mean <- data.frame("yday" = names(mean_lunar_exp),
                        "mean_exp" = as.vector(mean_lunar_exp),
                        "lwr" = as.vector(lower_pct),
                        "upr" = as.vector(upr_pct))
df_temps <- merge(data_lunar_df,df_mean, by = "yday",all.x = TRUE)
df_temps_order <- df_temps[order(df_temps$date),]

# set plot colours
rgb_col <- col2rgb("black")
col_alpha_black <- rgb(red = rgb_col[1], green = rgb_col[2], blue = rgb_col[3],
                             alpha = 50, maxColorValue = 255)

# plot data
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/salmon_wflow_figs/")
#dir.create(dirName, showWarnings = TRUE, mode = "0777")

png(filename = paste0(dirName,"lunar_solar_data-3-salmon.png"), height = 2300, width = 1500, res =300)
par(mfcol = c(13,3),oma = c(8,4,1,1), mar = c(0.5,0.5,0.1,0.1))
for(i in 1981:2019) {
  ylims <- c(0,max(c(max(df_temps_order$upr[df_temps_order$year == i],na.rm = TRUE),
                   max(df_temps_order$moonlight_exposure[df_temps_order$year == i], na.rm = TRUE))))
  xlims <- c(1,365)
  plot(df_temps_order$yday[df_temps_order$year == i],
       df_temps_order$mean_exp[df_temps_order$year == i], col = NULL, ylim = ylims,xlab = "", ylab = "",xaxt = "n",yaxt = "n", xlim = xlims)
  title(main = i,adj = 0.5, line = -1)
  if(i %in% c(1993,2006,2019)){
    axis(side = 1, tck = 0.1)
  }
    if(i %in% c(1981:1993)){
    axis(side = 2, tck = 0.1)
    }
  # polygons
  fishcastr::step_style_polygon(xvals = df_temps_order$yday[df_temps_order$year == i],
                     y_vals_low = df_temps_order$lwr[df_temps_order$year == i],
                     y_vals_up = df_temps_order$upr[df_temps_order$year == i],
                     col_alpha_rgb = col_alpha_black, border = NA)

    lines(df_temps_order$yday[df_temps_order$year == i],
        df_temps_order$mean_exp[df_temps_order$year == i], lty = 1, lwd = 0.75, col = col_alpha_black)
  
  lines(df_temps_order$yday[df_temps_order$year == i],
        df_temps_order$moonlight_exposure[df_temps_order$year == i], lty = 1, lwd = 0.75, col = "red")

}
mtext(side = 1,text = "Calendar year day",outer = TRUE,line = 2)
mtext(side = 2,text = expression("Moonlight exposure"),outer = TRUE,line = 2)
legend("bottomright", legend = c("Moonlight exposure","1981 - 2019 mean daily moonlight exposure\nand 95 percentile range"),
       col = c("red",col_alpha_black),pt.lwd = c(NA,1),
       lty = c(NA,1),lwd = c(NA,1),
       pch = c(15,15),bty = "n",
       inset = c(0.1,-2.5),
       xpd = NA, cex = 1.3)
dev.off()
```

```{r lunar_solar_data-1-salmon, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/salmon_wflow_figs/")
knitr::include_graphics(path = paste0(dirName,"lunar_solar_data-1-salmon.png"))
```

```{r lunar_solar_data-2-salmon, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/salmon_wflow_figs/")
knitr::include_graphics(path = paste0(dirName,"lunar_solar_data-3-salmon.png"))
```

## (1c) Access climate data

```{r access_climate_data, eval=FALSE}
# ---------------------------------------------------------------------------------------------------------- #
# LOCAL OBSERVATIONS (see: data-raw/data_met_obs/..)  ----
fishcastr::download_Met_Eireann_station_data()

# GRID PSEUDO-OBSERVATIONS FOR GAP FILLING ----
library(rJava)
fishcastr::download_EWEMBI()

# run script to identify gaps in local observed data and fill with EWEMBI or linearly interpolate ----
source(file = paste0(system.file("extdata", package = "fishcastr"),
                     "/01_data_grid_met_obs_1979_2019.R"))

# gap filled data
grid_met_obs_1979_2019 <- readRDS(file = paste0(system.file("extdata",
                                                        package = "fishcastr"),
                                            "/grid_met_obs_1979_2019.rds"))
data_met_obs_1979_2019 <- fishcastr::convert_grid_to_dataframe(grid_obj = grid_met_obs_1979_2019)[,-2]
names(data_met_obs_1979_2019)[1] <- "date"

# plot to identify any outliers if present.
# visualizeR::temporalPlot(... = grid_met_obs_1979_2019$tas)

# manual station data with gaps
data_met_obs_1979_2019 <- readRDS(file = paste0(system.file("extdata",
                                                        package = "fishcastr"),
                                            "/data_met_manual_station_1959_2019.rds"))

data_met_obs_1979_2019$petH_manual <- fishcastr::potential_ev_HS(data_met_obs_1979_2019$tas_min_manual,
                                                                 tasmax = data_met_obs_1979_2019$tas_max_manual,
                                                                 refdates = data_met_obs_1979_2019$date,
                                                                 lats = 53.932458)
# plot manual station data
label_text <- list("tas" = list("var" = "tas_manual",
                                "lab" = expression("Mean daily air temperature ("*~degree*C*")"),
                                "legend_lab" = "Mean daily air temperature",
                                "col" = "red"),
                   "pr" = list("var" = "pr_manual",
                                "lab" = expression("Total daily precipitation (mm)"),
                                "legend_lab" = "Total daily precipitation",
                                "col" = "blue"),
                   "petH" = list("var" = "petH_manual",
                                "lab" = expression("Daily potential evapotranspiration (mm)"),
                                "legend_lab" = "Daily potential evapotranspiration",
                                "col" = "darkblue"))

lapply(label_text, function(x){
data_met_obs_df <- data.frame("date" = data_met_obs_1979_2019[["date"]],
                            "tas" = data_met_obs_1979_2019[[x[[1]]]])

data_met_obs_df$year <-lubridate::year(data_met_obs_df$date)
data_met_obs_df$yday <-lubridate::yday(data_met_obs_df$date)

# calculate average per year day
mean_met <- tapply(data_met_obs_df$tas,INDEX = data_met_obs_df$yday,FUN = mean,na.rm = TRUE)
lower_pct <- tapply(data_met_obs_df$tas,INDEX = data_met_obs_df$yday,FUN = quantile, probs = 0.025,na.rm = TRUE)
upr_pct <- tapply(data_met_obs_df$tas,INDEX = data_met_obs_df$yday,FUN = quantile,probs = 0.975,na.rm = TRUE)
df_mean <- data.frame("yday" = names(mean_met),
                        "mean_exp" = as.vector(mean_met),
                        "lwr" = as.vector(lower_pct),
                        "upr" = as.vector(upr_pct))
df_met <- merge(data_met_obs_df,df_mean, by = "yday",all.x = TRUE)
df_met_order <- df_met[order(df_met$date),]

# set plot colours
rgb_col <- col2rgb("black")
col_alpha_black <- rgb(red = rgb_col[1], green = rgb_col[2], blue = rgb_col[3],
                             alpha = 50, maxColorValue = 255)

dirName <- paste0(system.file("extdata", package = "fishcastr"),"/salmon_wflow_figs/")
png(filename = paste0(dirName,"access_climate_data-1-salmon_",x,".png"), height = 2300, width = 1500, res =300)
par(mfcol = c(13,3),oma = c(8,4,1,1), mar = c(0.5,0.5,0.1,0.1))
for(i in 1981:2019) {
  ylims <- c(0,max(c(max(df_met_order$upr[df_met_order$year == i],na.rm = TRUE),
                   max(df_met_order$tas[df_met_order$year == i], na.rm = TRUE))))
  xlims <- c(1,365)
  plot(df_met_order$yday[df_met_order$year == i],
       df_met_order$mean_exp[df_met_order$year == i], col = NULL, ylim = ylims,xlab = "", ylab = "",xaxt = "n",yaxt = "n", xlim = xlims)
  title(main = i,adj = 0.9, line = -1)
  if(i %in% c(1993,2006,2019)){
    axis(side = 1, tck = 0.1)
  }
    if(i %in% c(1981:1993)){
    axis(side = 2, tck = 0.1)
    }
  # polygons
  fishcastr::step_style_polygon(xvals = df_met_order$yday[df_met_order$year == i],
                     y_vals_low = df_met_order$lwr[df_met_order$year == i],
                     y_vals_up = df_met_order$upr[df_met_order$year == i],
                     col_alpha_rgb = col_alpha_black, border = NA)

    lines(df_met_order$yday[df_met_order$year == i],
        df_met_order$mean_exp[df_met_order$year == i], lty = 1, lwd = 0.75, col = col_alpha_black)
  
  lines(df_met_order$yday[df_met_order$year == i],
        df_met_order$tas[df_met_order$year == i], lty = 1, lwd = 0.75, col = x[[4]])

}
mtext(side = 1,text = "Calendar year day",outer = TRUE,line = 2)
mtext(side = 2,text = x[[2]],outer = TRUE,line = 2)
legend("bottomright", legend = c(x[[3]],
                                 paste0("1981 - 2019 ", x[[3]],"\nand 95 percentile range")),
       col = c(x[[4]],col_alpha_black),pt.lwd = c(NA,1),
       lty = c(1,1),lwd = c(1,1),
       pch = c(NA,15),bty = "n",
       inset = c(0.1,-2.5),
       xpd = NA, cex = 1.3)
dev.off()
})

# ---------------------------------------------------------------------------------------------------------- #
# REANALYSIS (see: data-raw/grid_ERA5_reforecasts/..) ----
# raw grid (Re-forecasts and archived operational forecast years; 1993 - 2019)
grid_ERA5_1979_2019_Jan_bc <- fishcastr::grid_ERA5_1979_2019_Jan_bc
#visualizeR::temporalPlot(... = grid_ERA5_1979_2019_Jan_raw$tas)
data_ERA5_1979_2019_Jan_bc <- fishcastr::convert_grid_to_dataframe(grid_obj = grid_ERA5_1979_2019_Jan_bc)

# plot reanalysis data
label_text <- list("tas" = list("var" = "tas",
                                "lab" = expression("Mean 2m air temperature ("*~degree*C*")"),
                                "legend_lab" = "Mean 2m air temperature",
                                "col" = "red"),
                   "pr" = list("var" = "pr",
                                "lab" = expression("Total daily precipitation (mm)"),
                                "legend_lab" = "Total daily precipitation",
                                "col" = "blue"),
                   "petH" = list("var" = "petH",
                                "lab" = expression("Daily potential evapotranspiration (mm)"),
                                "legend_lab" = "Daily potential evapotranspiration",
                                "col" = "darkblue"))

lapply(label_text, function(x){
data_met_obs_df <- data.frame("date" = data_ERA5_1979_2019_Jan_bc[["dates1"]],
                            "tas" = data_ERA5_1979_2019_Jan_bc[[x[[1]]]])

data_met_obs_df$year <-lubridate::year(data_met_obs_df$date)
data_met_obs_df$yday <-lubridate::yday(data_met_obs_df$date)

# calculate average per year day
mean_met <- tapply(data_met_obs_df$tas,INDEX = data_met_obs_df$yday,FUN = mean,na.rm = TRUE)
lower_pct <- tapply(data_met_obs_df$tas,INDEX = data_met_obs_df$yday,FUN = quantile, probs = 0.025,na.rm = TRUE)
upr_pct <- tapply(data_met_obs_df$tas,INDEX = data_met_obs_df$yday,FUN = quantile,probs = 0.975,na.rm = TRUE)
df_mean <- data.frame("yday" = names(mean_met),
                        "mean_exp" = as.vector(mean_met),
                        "lwr" = as.vector(lower_pct),
                        "upr" = as.vector(upr_pct))
df_met <- merge(data_met_obs_df,df_mean, by = "yday",all.x = TRUE)
df_met_order <- df_met[order(df_met$date),]

# set plot colours
rgb_col <- col2rgb("black")
col_alpha_black <- rgb(red = rgb_col[1], green = rgb_col[2], blue = rgb_col[3],
                             alpha = 50, maxColorValue = 255)

dirName <- paste0(system.file("extdata", package = "fishcastr"),"/salmon_wflow_figs/")
png(filename = paste0(dirName,"access_climate_data-2-salmon_",x,"_reanalysis.png"), height = 2300, width = 1500, res =300)
par(mfcol = c(13,3),oma = c(8,4,1,1), mar = c(0.5,0.5,0.1,0.1))
for(i in 1981:2019) {
  ylims <- c(0,max(c(max(df_met_order$upr[df_met_order$year == i],na.rm = TRUE),
                   max(df_met_order$tas[df_met_order$year == i], na.rm = TRUE))))
  xlims <- c(1,365)
  plot(df_met_order$yday[df_met_order$year == i],
       df_met_order$mean_exp[df_met_order$year == i], col = NULL, ylim = ylims,xlab = "", ylab = "",xaxt = "n",yaxt = "n", xlim = xlims)
  title(main = i,adj = 0.9, line = -1)
  if(i %in% c(1993,2006,2019)){
    axis(side = 1, tck = 0.1)
  }
    if(i %in% c(1981:1993)){
    axis(side = 2, tck = 0.1)
    }
  # polygons
  fishcastr::step_style_polygon(xvals = df_met_order$yday[df_met_order$year == i],
                     y_vals_low = df_met_order$lwr[df_met_order$year == i],
                     y_vals_up = df_met_order$upr[df_met_order$year == i],
                     col_alpha_rgb = col_alpha_black, border = NA)

    lines(df_met_order$yday[df_met_order$year == i],
        df_met_order$mean_exp[df_met_order$year == i], lty = 1, lwd = 0.75, col = col_alpha_black)
  
  lines(df_met_order$yday[df_met_order$year == i],
        df_met_order$tas[df_met_order$year == i], lty = 1, lwd = 0.75, col = x[[4]])

}
mtext(side = 1,text = "Calendar year day",outer = TRUE,line = 2)
mtext(side = 2,text = x[[2]],outer = TRUE,line = 2)
legend("bottomright", legend = c(x[[3]],
                                 paste0("1981 - 2019 ", x[[3]],"\nand 95 percentile range")),
       col = c(x[[4]],col_alpha_black),pt.lwd = c(NA,1),
       lty = c(1,1),lwd = c(1,1),
       pch = c(NA,15),bty = "n",
       inset = c(0.1,-2.5),
       xpd = NA, cex = 1.3)
dev.off()
})

# ---------------------------------------------------------------------------------------------------------- #
# SEASONAL CLIMATE FORECAST (Re-forecasts and archived operational forecasts 1993 - 2019) ----
# (see: data-raw/grid_SEAS5_reforecasts/..)
grid_SEAS5_1993_2019_2_3_4_5_6_7_8_tas_pr_petH_bc <- fishcastr::grid_SEAS5_1993_2019_2_3_4_5_6_7_8_tas_pr_petH_bc
data_SEAS5_1993_2019_2_3_4_5_6_7_8_tas_pr_petH_bc <- fishcastr::convert_grid_to_dataframe(grid_obj = grid_SEAS5_1993_2019_2_3_4_5_6_7_8_tas_pr_petH_bc)

label_text <- list("tas" = list("var" = "tas",
                                "lab" = expression("Mean 2m air temperature ("*~degree*C*")"),
                                "legend_lab" = "Mean 2m air temperature",
                                "col" = "red"),
                   "pr" = list("var" = "pr",
                                "lab" = expression("Total daily precipitation (mm)"),
                                "legend_lab" = "Total daily precipitation",
                                "col" = "blue"),
                   "petH" = list("var" = "petH",
                                "lab" = expression("Daily potential evapotranspiration (mm)"),
                                "legend_lab" = "Daily potential evapotranspiration",
                                "col" = "darkblue"))

lapply(label_text, function(x){
  # convert data to single dataframe for each variable
data_SEAS_tas <- lapply(data_SEAS5_1993_2019_2_3_4_5_6_7_8_tas_pr_petH_bc,function(y){y[[x[[1]]]]})
data_SEAS_tas_tab <- data.frame("date" = data_SEAS5_1993_2019_2_3_4_5_6_7_8_tas_pr_petH_bc[[1]][["dates1"]],
                                as.data.frame(do.call(cbind,data_SEAS_tas)))
data_SEAS_tas_tab$yday <- lubridate::yday(data_SEAS_tas_tab$date)
data_SEAS_tas_tab$date <- NULL

# cast to long format retaining ydays
longform <- tidyr::pivot_longer(data_SEAS_tas_tab,
                                cols=c(paste0("V",1:25)),
                                names_to = "member", values_to = x[[1]])

mean_met <- tapply(longform[[x[[1]]]],INDEX = longform$yday,FUN = mean,na.rm = TRUE)
lower_pct <- tapply(longform[[x[[1]]]],INDEX = longform$yday,FUN = quantile, probs = 0.025,na.rm = TRUE)
upr_pct <- tapply(longform[[x[[1]]]],INDEX = longform$yday,FUN = quantile,probs = 0.975,na.rm = TRUE)
#plot(1:213,mean_met,type = "l", ylim = c(0,20))
#lines(1:213,lower_pct)
#lines(1:213,upr_pct)

data_SEAS_tas_tab_dat <- data.frame("date" = data_SEAS5_1993_2019_2_3_4_5_6_7_8_tas_pr_petH_bc[[1]][["dates1"]],
                                    "yday" = lubridate::yday(data_SEAS5_1993_2019_2_3_4_5_6_7_8_tas_pr_petH_bc[[1]][["dates1"]]),
                                as.data.frame(do.call(cbind,data_SEAS_tas)))

df_mean <- data.frame("yday" = names(mean_met),
                        "mean_exp" = as.vector(mean_met),
                        "lwr" = as.vector(lower_pct),
                        "upr" = as.vector(upr_pct))
df_met <- merge(data_SEAS_tas_tab_dat,df_mean, by = "yday",all.x = TRUE)
df_met_order <- df_met[order(df_met$date),]
df_met_order$year <- lubridate::year(df_met_order$date)

# plot seasonal climate forecast data with backdrop of historic forecast
# averages (although note the calculated back drop are calculated from all
# forecast members (e.g., mean and percentiles) and are analagous to climatology
# because the SEAS5 is calibrated and data have been bias corrected.

# set plot colours
rgb_col <- col2rgb("black")
col_alpha_black <- rgb(red = rgb_col[1], green = rgb_col[2], blue = rgb_col[3],
                             alpha = 30, maxColorValue = 255)
rgb_col <- col2rgb(x[[4]])
col_alpha_red <- rgb(red = rgb_col[1], green = rgb_col[2], blue = rgb_col[3],
                             alpha = 30, maxColorValue = 255)

dirName <- paste0(system.file("extdata", package = "fishcastr"),"/salmon_wflow_figs/")
png(filename = paste0(dirName,"access_climate_data-3-salmon_",x,"_SF.png"), height = 2300, width = 2300, res =300)
par(mfcol = c(9,3),oma = c(8,4,1,1), mar = c(0.5,0.5,0.1,0.1))
for(i in 1993:2019) {
  ylims <- c(0,max(c(max(df_met_order$upr[df_met_order$year == i],na.rm = TRUE),
                   max(df_met_order[df_met_order$year == i,c(3:27)], na.rm = TRUE))))
  xlims <- c(min(df_met_order$yday),max(df_met_order$yday))
  plot(df_met_order$yday[df_met_order$year == i],
       df_met_order$mean_exp[df_met_order$year == i], col = NULL, ylim = ylims,xlab = "", ylab = "",xaxt = "n",yaxt = "n", xlim = xlims)
  title(main = i,adj = 0.1, line = -1)
  if(i %in% c(2001,2010,2019)){
    axis(side = 1, tck = 0.1)
  }
    if(i %in% c(1993:2001)){
    axis(side = 2, tck = 0.1)
    }
  # polygons
  fishcastr::step_style_polygon(xvals = df_met_order$yday[df_met_order$year == i],
                     y_vals_low = df_met_order$lwr[df_met_order$year == i],
                     y_vals_up = df_met_order$upr[df_met_order$year == i],
                     col_alpha_rgb = col_alpha_black, border = NA)

    lines(df_met_order$yday[df_met_order$year == i],
        df_met_order$mean_exp[df_met_order$year == i], lty = 1, lwd = 0.75, col = col_alpha_black)
  
    for(j in 3:27){
  lines(df_met_order$yday[df_met_order$year == i],
        df_met_order[df_met_order$year == i,j], lty = 1, lwd = 0.75, col = col_alpha_red)
}
      
}
mtext(side = 1,text = "Calendar year day",outer = TRUE,line = 2)
mtext(side = 2,text = x[[2]],outer = TRUE,line = 2)
legend("bottomright", legend = c(x[[3]],
                                 paste0("1993 - 2019 ", x[[3]],"\nand 95 percentile range")),
       col = c(x[[4]],col_alpha_black),pt.lwd = c(NA,1),
       lty = c(1,1),lwd = c(1,1),
       pch = c(NA,15),bty = "n",
       inset = c(0.1,-1.7),
       xpd = NA, cex = 1.3)
dev.off()
})

#visualizeR::temporalPlot(... = data_SEAS5_1993_2019_2_3_4_5_6_7_8_tas_pr_petH_bc$pr)
```

```{r access_climate_data-1-salmon, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/salmon_wflow_figs/")
knitr::include_graphics(path = paste0(dirName,"access_climate_data-1-salmon_petH_manual.png"))
```

```{r access_climate_data-2-salmon, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/salmon_wflow_figs/")
knitr::include_graphics(path = paste0(dirName,"access_climate_data-2-salmon_pr_reanalysis.png"))
```

```{r access_climate_data-3-salmon, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/salmon_wflow_figs/")
knitr::include_graphics(path = paste0(dirName,"access_climate_data-3-salmon_tas_SF.png"))
```

## (1d) Pre-process climate data

```{r pre_process_climate_data, eval=FALSE}
# ----------------------------------------------------------------------------------------------------------#
# CREATE PLOT SUB-DIRECTORY ----
# ----------------------------------------------------------------------------------------------------------#
dirName <- paste0(system.file("extdata",
                              package = "fishcastr"),
                  "/vignette_figures/meteo_data_bias_adj/")
dir.create(dirName, showWarnings = TRUE, mode = "0777")

# ----------------------------------------------------------------------------------------------------------#
# LOAD IN LOCAL OBS AND BIAS CORRECTED AND RAW ERA5 DATA FOR COMPARISON ----
# ----------------------------------------------------------------------------------------------------------#
met_eireann_obs <- fishcastr::convert_grid_to_dataframe(grid_obj = readRDS(file = paste0(system.file("extdata",
                                                        package = "fishcastr"),
                                            "/grid_met_obs_1979_2019.rds")))[,-c(2,5,6)]
names(met_eireann_obs) <- c("date","tas_met_eireann","pr_met_eireann","petH_met_eireann")

era5_reanalysis_bcc <- fishcastr::convert_grid_to_dataframe(grid_obj = fishcastr::grid_ERA5_1979_2019_Jan_bc)[,-2]
names(era5_reanalysis_bcc) <- c("date","tas_era5_bcc","pr_era5_bcc","petH_era5_bcc")

#load(file = paste0(system.file("extdata",
#                               package = "fishcastr"),
#                   "/grid_ERA5_1979_2019_Jan_raw.rda"))

grid_ERA5_1979_2019_Jan_raw <- readRDS(file = paste0(system.file("extdata",
                               package = "fishcastr"),
                   "/grid_ERA5_1979_2019_Jan_raw.rds"))

era5_reanalysis_raw <-  fishcastr::convert_grid_to_dataframe(grid_obj = grid_ERA5_1979_2019_Jan_raw)[,-2]
names(era5_reanalysis_raw) <- c("date","tas_era5_raw","pr_era5_raw","petH_era5_raw")
rm(grid_ERA5_1979_2019_Jan_raw)

# ----------------------------------------------------------------------------------------------------------#
# COMPARE MET OBS TO RAW AND BIAS CORRECTED ERA5 ----
# ----------------------------------------------------------------------------------------------------------#
metobs_era5 <- Reduce(function(x,y) merge(x,y,by="date"),
                            list(met_eireann_obs,
                                 era5_reanalysis_raw,
                                 era5_reanalysis_bcc))

# ----------------------------------------------------------------------------------------------------------#
# TEMPERATURE DAILY ----
# ----------------------------------------------------------------------------------------------------------#
# mean
mean(era5_reanalysis_raw$tas_era5_raw) - mean(met_eireann_obs$tas_met_eireann) # -0.7367036
mean(era5_reanalysis_bcc$tas_era5_bcc) - mean(met_eireann_obs$tas_met_eireann) # -0.01762837

x=c(1,2,3,4,5,6,7,8,9,10)
y=c(1,2,3,4,5,6,7,8,9,10)
dataf <- data.frame(x = x, y = y)
lin_mod_1_1 <- lm(y~x, data = dataf)
newdat <- data.frame(x = metobs_era5$tas_met_eireann)
pred_mod <- predict(lin_mod_1_1, newdata = newdat)
resids_raw <- pred_mod - metobs_era5$tas_era5_raw

# raw era5 vs local met station
dirName <- paste0(system.file("extdata",
                              package = "fishcastr"),
                  "/vignette_figures/meteo_data_bias_adj/")

png(file = paste0(dirName,"ERA5_bcc_tas.png"), width=2300, height=2400, res=300)
par(mfcol = c(3,2))
plot(metobs_era5$tas_met_eireann,
     metobs_era5$tas_era5_raw, cex = 0.7,
     main = "1979 - 2019 - ERA5 - RAW Temperature",
     type = "p",
          xlab = "Observed",
     ylab = "Reanalysis")
abline(a = 0, b = 1, lty = 3, col = "red")

plot(pred_mod,
     resids_raw, cex = 0.7,
     xlab = "Predicted from 1:1 model",
     ylab = "Residual")
abline(h = 0, lty = 3, col = "red")
hist(resids_raw, xlim = c(-4,4), main = "Histogram of residuals from 1:1 model")
resids_bc <- pred_mod - metobs_era5$tas_era5_bcc

# bc era5 vs local met station
plot(metobs_era5$tas_met_eireann,
     metobs_era5$tas_era5_bcc,
     cex = 0.7,
     main = "1979 - 2019 - ERA5 BC Temperature",
     type = "p",
     xlab = "Observed",
     ylab = "Reanalysis")
abline(a = 0, b = 1, lty = 3, col = "red")

plot(pred_mod, resids_bc, cex = 0.7,
     xlab = "Predicted from 1:1 model",
     ylab = "Residual")
abline(h = 0, lty = 3, col = "red")
hist(resids_bc, xlim = c(-4,4), main = "Histogram of residuals from 1:1 model")
invisible(dev.off())

# ----------------------------------------------------------------------------------------------------------#
# PRECIPITATION DAILY ----
# ----------------------------------------------------------------------------------------------------------#
# mean
mean(era5_reanalysis_raw$pr_era5_raw) - mean(met_eireann_obs$pr_met_eireann) # -0.9363891
mean(era5_reanalysis_bcc$pr_era5_bcc) - mean(met_eireann_obs$pr_met_eireann) # 0.1546429

x=c(1,2,3,4,5,6,7,8,9,10)
y=c(1,2,3,4,5,6,7,8,9,10)
dataf <- data.frame(x = x, y = y)
lin_mod_1_1 <- lm(y~x, data = dataf)
newdat <- data.frame(x = metobs_era5$pr_met_eireann)
pred_mod <- predict(lin_mod_1_1, newdata = newdat)
resids_raw <- pred_mod - metobs_era5$pr_era5_raw

# raw era5 vs local met station
dirName <- paste0(system.file("extdata",
                              package = "fishcastr"),
                  "/vignette_figures/meteo_data_bias_adj/")

png(file = paste0(dirName,"ERA5_bcc_pr.png"), width=2300, height=1400, res=300)
par(mfcol = c(1,2))

# RAW DATA ----
col_alpha_metobs <- c(col2rgb("black"))
col_alpha_era5raw <- c(col2rgb("red"))
p1 <- hist(met_eireann_obs$pr_met_eireann,plot = FALSE, breaks = 100)
p2 <- hist(era5_reanalysis_raw$pr_era5_raw,plot = FALSE, breaks = 100)

plot(p1, col=rgb(col_alpha_metobs[1],col_alpha_metobs[2],col_alpha_metobs[3],
                 alpha = 100,maxColorValue = 255),
     xlim=c(0,40),
      main = "1979 - 2019 - ERA5 RAW Precipitation", xlab = "Daily precipitation (mm)",ylab = "Frequency",
      ylim = c(0.1,max(c(p1$counts,p2$counts))))
plot(p2, col=rgb(col_alpha_era5raw[1],col_alpha_era5raw[2],col_alpha_era5raw[3],
                 alpha = 100,maxColorValue = 255), xlim=c(0,40), add=T)

legend("topright",legend = c("local met","ERA5 raw"), col = c(rgb(col_alpha_metobs[1],col_alpha_metobs[2],col_alpha_metobs[3],
                 alpha = 100,maxColorValue = 255),rgb(col_alpha_era5raw[1],col_alpha_era5raw[2],col_alpha_era5raw[3],
                 alpha = 100,maxColorValue = 255)),bty = "n",pch=15)

# BIAS CORRECTED ----
col_alpha_era5bcc <- c(col2rgb("blue"))
p1 <- hist(met_eireann_obs$pr_met_eireann,plot = FALSE, breaks = 100)
p2 <- hist(era5_reanalysis_bcc$pr_era5_bcc,plot = FALSE, breaks = 100)

plot(p1, col=rgb(col_alpha_metobs[1],col_alpha_metobs[2],col_alpha_metobs[3],
                 alpha = 100,maxColorValue = 255),
     xlim=c(0,40),
      main = "1979 - 2019 - ERA5 BC Precipitation", xlab = "Daily precipitation (mm)",ylab = "Frequency",
      ylim = c(0.1,max(c(p1$counts,p2$counts))))  # first histogram
plot(p2, col=rgb(col_alpha_era5bcc[1],col_alpha_era5bcc[2],col_alpha_era5bcc[3],
                 alpha = 100,maxColorValue = 255),
     xlim=c(0,40), add=T)  # second
legend("topright",legend = c("local met","ERA5 bcc"), col = c(rgb(col_alpha_metobs[1],col_alpha_metobs[2],col_alpha_metobs[3],
                 alpha = 100,maxColorValue = 255),rgb(col_alpha_era5bcc[1],col_alpha_era5bcc[2],col_alpha_era5bcc[3],
                 alpha = 100,maxColorValue = 255)),bty = "n",pch=15)
invisible(dev.off())

# ----------------------------------------------------------------------------------------------------------#
# POTENTIAL EVAPOTRANSPIRATION DAILY ----
# ----------------------------------------------------------------------------------------------------------#
# mean
mean(era5_reanalysis_raw$petH_era5_raw) - mean(met_eireann_obs$petH_met_eireann) # -0.143667
mean(era5_reanalysis_bcc$petH_era5_bcc) - mean(met_eireann_obs$petH_met_eireann) # 0.0002808052

x=c(1,2,3,4,5,6,7,8,9,10)
y=c(1,2,3,4,5,6,7,8,9,10)
dataf <- data.frame(x = x, y = y)
lin_mod_1_1 <- lm(y~x, data = dataf)
newdat <- data.frame(x = metobs_era5$petH_met_eireann)
pred_mod <- predict(lin_mod_1_1, newdata = newdat)
resids_raw <- pred_mod - metobs_era5$petH_era5_raw

# raw era5 vs local met station
png(file = paste0(dirName,"ERA5_bcc_petH.png"), width=2300, height=1400, res=300)
par(mfcol = c(1,2))
# RAW DATA ----
col_alpha_metobs <- c(col2rgb("black"))
col_alpha_era5raw <- c(col2rgb("red"))
p1 <- hist(met_eireann_obs$petH_met_eireann,plot = FALSE, breaks = 10)
p2 <- hist(era5_reanalysis_raw$petH_era5_raw,plot = FALSE, breaks = 10)

plot(p1, col=rgb(col_alpha_metobs[1],col_alpha_metobs[2],col_alpha_metobs[3],
                 alpha = 100,maxColorValue = 255),
     xlim=c(0,10),
      main = "1979 - 2019 - ERA5 RAW petH", xlab = "Daily petH (mm)",ylab = "Frequency",
      ylim = c(0.1,max(c(p1$counts,p2$counts))))
plot(p2, col=rgb(col_alpha_era5raw[1],col_alpha_era5raw[2],col_alpha_era5raw[3],
                 alpha = 100,maxColorValue = 255), xlim=c(0,10), add=T)
legend("topright",legend = c("local met","ERA5 raw"), col = c(rgb(col_alpha_metobs[1],col_alpha_metobs[2],col_alpha_metobs[3],
                 alpha = 100,maxColorValue = 255),rgb(col_alpha_era5raw[1],col_alpha_era5raw[2],col_alpha_era5raw[3],
                 alpha = 100,maxColorValue = 255)),bty = "n",pch=15)

# BIAS CORRECTED ----
col_alpha_era5bcc <- c(col2rgb("blue"))
p1 <- hist(met_eireann_obs$petH_met_eireann,plot = FALSE, breaks = 10)
p2 <- hist(era5_reanalysis_bcc$petH_era5_bcc,plot = FALSE, breaks = 10)

plot(p1, col=rgb(col_alpha_metobs[1],col_alpha_metobs[2],col_alpha_metobs[3],
                 alpha = 100,maxColorValue = 255),
     xlim=c(0,10),
      main = "1979 - 2019 - ERA5 BC petH", xlab = "Daily petH (mm)",ylab = "Frequency",
      ylim = c(0.1,max(c(p1$counts,p2$counts))))  # first histogram
plot(p2, col=rgb(col_alpha_era5bcc[1],col_alpha_era5bcc[2],col_alpha_era5bcc[3],
                 alpha = 100,maxColorValue = 255),
     xlim=c(0,10), add=T)  # second
legend("topright",legend = c("local met","ERA5 bcc"), col = c(rgb(col_alpha_metobs[1],col_alpha_metobs[2],col_alpha_metobs[3],
                 alpha = 100,maxColorValue = 255),rgb(col_alpha_era5bcc[1],col_alpha_era5bcc[2],col_alpha_era5bcc[3],
                 alpha = 100,maxColorValue = 255)),bty = "n",pch=15)
invisible(dev.off())

rm(list = ls(all.names = TRUE))
invisible(gc())
```

```{r pre_process_climate_data-1-salmon, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/meteo_data_bias_adj/")
knitr::include_graphics(path = paste0(dirName,"ERA5_bcc_tas.png"))
```

```{r pre_process_climate_data-2-salmon, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/meteo_data_bias_adj/")
knitr::include_graphics(path = paste0(dirName,"ERA5_bcc_pr.png"))
```

```{r pre_process_climate_data-3-salmon, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/meteo_data_bias_adj/")
knitr::include_graphics(path = paste0(dirName,"ERA5_bcc_petH.png"))
```

# (2) MODEL CHAIN DEVELOPMENT

## (2a) Model hydrology and water temperature

```{r model_hydrology_water_temp, eval=FALSE}
# ---------------------------------------------------------------------------------------------------------- #
# CALIBRATE CATCHMENT DISCHARGE MODEL (see: data_raw/model_GR4J_calibration.R) ----
GR4J_Burr_params_ERA5_bcc <- fishcastr::GR4J_Burr_params_ERA5_bcc

calibration_validation_stats_GR4J <- readRDS(file = paste0(system.file("extdata",
                                                        package = "fishcastr"),
                                            "/vignette_figures/hydrologic_model/GR4J_cal_val_stats.rds"))

# ---------------------------------------------------------------------------------------------------------- #
# CALIBRATE WATER TEMPERATURE MODEL (see: data_raw/model_air_to_water_calibration.R) ----
air_to_water_Feeagh_params_ERA5_bcc <- fishcastr::air_to_water_Feeagh_params_ERA5_bcc

calibration_validation_stats_air_to_water_temp <- readRDS(file = paste0(system.file("extdata",
                                                        package = "fishcastr"),
                                            "/vignette_figures/air_water_temp_model/air_water_temp_val_stats.rds"))
```

### Hydrologic model

```{r model_hydrology_water_temp-1-salmon, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/hydrologic_model/")
knitr::include_graphics(path = paste0(dirName,"Burr_GR4J_ERA5_Calib_results.png"))
```

```{r model_hydrology_water_temp-2-salmon, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/hydrologic_model/")
knitr::include_graphics(path = paste0(dirName,"Burr_GR4J_ERA5_Val_results_1981-1990.png"))
```

```{r model_hydrology_water_temp-3-salmon, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/hydrologic_model/")
knitr::include_graphics(path = paste0(dirName,"Burr_GR4J_ERA5_Val_results_1991-2000.png"))
```

```{r model_hydrology_water_temp-4-salmon, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/hydrologic_model/")
knitr::include_graphics(path = paste0(dirName,"Burr_GR4J_ERA5_Val_results_2001-2010.png"))
```

```{r model_hydrology_water_temp-5-salmon, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/hydrologic_model/")
knitr::include_graphics(path = paste0(dirName,"Burr_GR4J_ERA5_Val_results_2015-2019.png"))
```

### Air to water temperature model

```{r model_hydrology_water_temp-6-salmon, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/air_water_temp_model/")
knitr::include_graphics(path = paste0(dirName,"air_water_cal_Fe.png"))
```

```{r model_hydrology_water_temp-7-salmon, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/air_water_temp_model/")
knitr::include_graphics(path = paste0(dirName,"air_water_val_Fe.png"))
```

```{r model_hydrology_water_temp-8-salmon, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/air_water_temp_model/")
knitr::include_graphics(path = paste0(dirName,"air_water_val_MRpap.png"))
```

```{r model_hydrology_water_temp-9-salmon, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/air_water_temp_model/")
knitr::include_graphics(path = paste0(dirName,"air_water_val_MRtid.png"))
```

```{r model_hydrology_water_temp-10-salmon, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/air_water_temp_model/")
knitr::include_graphics(path = paste0(dirName,"air_water_val_MRorp.png"))
```

## (2b) Model proxy for migration preparedness

```{r model_proxy_preparedness, eval=FALSE}
# ---------------------------------------------------------------------------------------------------------- #
# CALIBRATE MIGRATION PREPAREDNESS MODEL (see: data_raw/model_physio_expmG_salmon_calibration.R) ----
model_physio_expmG_salmon <- fishcastr::model_physio_expmG_salmon
```

```{r model_proxy_preparedness-1-salmon, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/migration_prep_models/salmon/")
knitr::include_graphics(path = paste0(dirName,"genpois_salmon.png"))
```

```{r model_proxy_preparedness-2-salmon, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/migration_prep_models/salmon/val_plots/")
knitr::include_graphics(path = paste0(dirName,"resid_fitted.png"))
```

```{r model_proxy_preparedness-3-salmon, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/migration_prep_models/salmon/val_plots/")
knitr::include_graphics(path = paste0(dirName,"dispersion.png"))
```

```{r model_proxy_preparedness-4-salmon, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/migration_prep_models/salmon/val_plots/")
knitr::include_graphics(path = paste0(dirName,"param_profiles.png"))
```

## (2c) Model fish counts

### Calculate predictors

Prior to fitting glmmTMB models, we pre-processed the raw and model derived catchment environmental data included in `fishcastr`. Pre-processing steps included log transformation of positive skewed predictors (moonlight exposure, discharge and migration preparedness). We included both the log transformed and non-transformed data of these three "likely candidates" in the initial modelling dataset, as it was not clear form the outset whether transformations would improve statistical fit and or computation of the fitting procedure. The inclusion of log transformed vs. non-transformed variables varied among species.

```{r calculate_predictors,eval = FALSE}
# ---------------------------------------------------------------------------------------------------------- #
# IMPORT BIAS ADJUSTED METEOROLOGICAL DATA -----
# ---------------------------------------------------------------------------------------------------------- #
data_ERA5_1979_2019_Jan_bc <- fishcastr::convert_grid_to_dataframe(grid_obj = fishcastr::grid_ERA5_1979_2019_Jan_bc)[,-2]
names(data_ERA5_1979_2019_Jan_bc)[which(names(data_ERA5_1979_2019_Jan_bc) == "dates1")] <- "date"

# ---------------------------------------------------------------------------------------------------------- #
# RUN AIR TO WATER TEMP MODEL -----
# ---------------------------------------------------------------------------------------------------------- #
data_water_temp <- data.frame(
  "date" = data_ERA5_1979_2019_Jan_bc$date,
  "Tw_mod" = fishcastr::air_to_water_model(
    Ta = data_ERA5_1979_2019_Jan_bc$tas,
    Yday = lubridate::yday(data_ERA5_1979_2019_Jan_bc$date),
    A = fishcastr::air_to_water_Feeagh_params_ERA5_bcc$A,
    ac = fishcastr::air_to_water_Feeagh_params_ERA5_bcc$ac,
    b = fishcastr::air_to_water_Feeagh_params_ERA5_bcc$b,
    B = fishcastr::air_to_water_Feeagh_params_ERA5_bcc$B
  )
)

# ---------------------------------------------------------------------------------------------------------- #
# RUN HYDROLOGIC MODEL ----
# ---------------------------------------------------------------------------------------------------------- #
data_discharge <- fishcastr::hydrologic_model(met_data = data_ERA5_1979_2019_Jan_bc[,c("date","pr","petH")] ,
                                              warm_up_dates_range = c(as.Date("1979-01-01"),
                                                                     as.Date("1980-12-20")),
                                              run_dates_range = c(as.Date("1980-12-21"),
                                                                 as.Date("2019-01-31")),
                                              GR4J_params = as.numeric(fishcastr::GR4J_Burr_params_ERA5_bcc),
                                              log_transform = FALSE)

ln_data_discharge <- data.frame("date" = data_discharge$date,
                                "ln_discharge" = log(data_discharge$discharge))

# ---------------------------------------------------------------------------------------------------------- #
# ESTIMATE MIGRATION PREPAREDNESS ----
# ---------------------------------------------------------------------------------------------------------- #

# stratify forecast years and retain photoperiod
data_ssmolt_forecast_years <- fishcastr::bio_year_photoper(dates = data_water_temp$date,
                                                           latitude = 53.932458,
                                                           longitude = -9.575556,
                                                           retain_photoper = TRUE,
                                                           start_previous_year = TRUE,
                                                           shortest_day = TRUE,
                                                           yday_head = "salmonid_yday",
                                                           bio_year_head = "salmonid_year")

# calculate photoperiod weighted degree days from specified solstice dates
pwdds <- fishcastr::convert_stratified_census_data_to_model_warmup_list(
  water_temp = data_water_temp$Tw_mod,
  photoper = data_ssmolt_forecast_years$photoper,
  forecast_years = data_ssmolt_forecast_years$salmonid_year,
  forecast_yday = data_ssmolt_forecast_years$salmonid_yday,
  dates = data_ssmolt_forecast_years$date,
  no_years_warmup = 0,
  delete_op_year = FALSE
)

# convert photoperiod weighted degree days to proxy preparedness variable
migration_preparedness <- data.frame("date"= pwdds$date, "migration_prep" =
  fishcastr::exp_mod_Gaussian_resp(
    x = pwdds$weighted_dds_water,
    c = fishcastr::model_physio_expmG_salmon$coefs["c"],
    mu_exmg = fishcastr::model_physio_expmG_salmon$coefs["mu_exmg"],
    sigma_exmg = fishcastr::model_physio_expmG_salmon$coefs["sigma_exmg"],
    lamb = fishcastr::model_physio_expmG_salmon$coefs["lamb"]
  ))

ln_migration_preparedness <- data.frame("date"= pwdds$date, "ln_migration_prep" =
  log(migration_preparedness$migration_prep))

# ---------------------------------------------------------------------------------------------------------- #
# ESTIMATE MOONLIGHT EXPOSURE ----
# ---------------------------------------------------------------------------------------------------------- #
data_lunar <- data.frame("date"= migration_preparedness$date,
                         "moonlight_exposure" = fishcastr::lunar_light_exposure(log_result = FALSE, date_of_interest = migration_preparedness$date,
                                                                                lat = 53.932458,
                                                                                lon = -9.575556))
ln_data_lunar <- data.frame("date"= migration_preparedness$date,
                         "ln_moonlight_exposure" = fishcastr::lunar_light_exposure(log_result = TRUE, date_of_interest = migration_preparedness$date,
                                                                                lat = 53.932458,
                                                                                lon = -9.575556))

# -------------------------------------------------------------------------------------------------- #
# ADD DELTA TEMPERATURE ----
# -------------------------------------------------------------------------------------------------- #
Delta_temp <- data.frame("date" = data_water_temp$date,
                         "Delta_temp" = fishcastr::delta_var(y = data_water_temp$Tw_mod,
                                                             react_time = 20))

# -------------------------------------------------------------------------------------------------- #
# ADD DELTA PHOTOPERIOD ----
# -------------------------------------------------------------------------------------------------- #
Delta_Photo <- data.frame("date" = data_ssmolt_forecast_years$date,
                          "Delta_photo" = fishcastr::delta_var(y = data_ssmolt_forecast_years$photoper,
                                                               react_time = 1))

# ---------------------------------------------------------------------------------------------------------- #
# IMPORT AND APPEND COUNT DATA TO FORECAST YEARS ENVIRONMENTAL DATA ----
# ---------------------------------------------------------------------------------------------------------- #
fishcastr::download_fish_data()
data_ssmolt <- fishcastr::import_fish_data(species = "ssmolt")

# Use Reduce function instead of merge...
data_ssmolt_enviro_1981_2019 <- Reduce(function(x,y) merge(x,y,by="date"),
                                       list(data_ssmolt,
                                            data_ssmolt_forecast_years,
                                            data_water_temp,
                                            data_discharge,
                                            ln_data_discharge,
                                            migration_preparedness,
                                            ln_migration_preparedness,
                                            data_lunar,
                                            ln_data_lunar,
                                            Delta_temp,
                                            Delta_Photo))

dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_data/")
dir.create(dirName, showWarnings = TRUE, mode = "0777")

 saveRDS(data_ssmolt_enviro_1981_2019, file = paste0(dirName,"data_ssmolt_enviro_1981_2019.rds"))
 rm(list = ls(all.names = TRUE))
 invisible(gc())
```

### Refine model structure based on fit to historic data and validate

Prior to model fitting, we centred and scaled all explanatory variables with the aim of mitigating computational problems with model convergence (see [here](https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html) and [here](https://cran.r-project.org/web/packages/glmmTMB/vignettes/troubleshooting.html)).

Data for 1981 - 1992 were used to refine model structure for salmon smolts.

```{r model_salmon_counts_1981_1992_fit,eval = FALSE}
# ---------------------------------------------------------------------------------------------------------- #
# LOAD COUNT AND PREDICTOR DATA ----
# ---------------------------------------------------------------------------------------------------------- #
data_ssmolt_enviro_1981_2019 <- readRDS(paste0(system.file("extdata",
                                                    package = "fishcastr"),
                                               "/vignette_data/data_ssmolt_enviro_1981_2019.rds"))

# -------------------------------------------------------------------------------------------------- #
# SUBSET DATA TO 1981 - 1992 TO MAINTAIN OUT OF SAMPLE MODEL VALIDATION OF MODEL STRUCTURE ----
# -------------------------------------------------------------------------------------------------- #
# This step is carried out to reduce the risk of overfitting (model structure)
# to the test set. This does not reduce the risk of over-parameterizing the
# model for these data; rather, the aim is stop model re-structuring (relative
# to full model containing no predictor transformations) at the first point at
# which a statistically acceptable model is identified. Priorities for
# acceptability/validation:
# (i) limited set of plausible predictors and no more complex than three-way
# interactions (choice of predictors is set form the outset based on literature);
# (ii) linearity (predictors are transformed to remove patterns in residual vs.
# individual predictor plots);
# (iii) residual dispersion (over/under dispersion - important to get this right
# as using model simulations (and predictions) for forecasts) - here we move
# beyond Poisson to choose a conditional distribution of the response (daily
# count), e.g., negative binomial type I or II, or generalised Poisson (as these
# are implemented in glmmTMB);
# (iv) independence of errors (check for residual autocorrelation within and
# among years using ACF);
# (v) influential groups - check using plots of Cook's distance and dfbetas.
# After model checking as above, we want to assess out of sample predictive
# performance. We use leave-one year out cross validation to refit the model
# sequentially for all years between 1981 to 2019, and we plot the model
# simulations for each year on top of observations to visually assess
# inconsistencies between simulated and observed data. ASSUMPTION - by using
# leave-one-year-out model fitting, we assume that the structure of model
# (derived from 1981 - 1992 fit) is consistent across time series, although it
# is possible that parameters (i.e., associations between counts and predictors
# may vary through time)).
# -------------------------------------------------------------------------------------------------- #

# -------------------------------------------------------------------------------------------------- #
# SUBSET DATA 1981 - 1992 ----
# -------------------------------------------------------------------------------------------------- #
min_1981 <- min(data_ssmolt_enviro_1981_2019$date[data_ssmolt_enviro_1981_2019$salmonid_year == 1981])
max_1992 <- max(data_ssmolt_enviro_1981_2019$date[data_ssmolt_enviro_1981_2019$salmonid_year == 1992])

Train_data <- subset(data_ssmolt_enviro_1981_2019, select = c(date,
                                                              ssmolt,
                                                              salmonid_year,
                                                              salmonid_yday,
                                                              migration_prep,
                                                              ln_migration_prep,
                                                              moonlight_exposure,
                                                              ln_moonlight_exposure,
                                                              discharge,
                                                              ln_discharge,
                                                              Delta_temp,
                                                              Delta_photo,
                                                              photoper,
                                                              Tw_mod),
                     subset = data.table::between(data_ssmolt_enviro_1981_2019$date,
                                                  lower = min_1981,
                                                  upper = max_1992))

# -------------------------------------------------------------------------------------------------- #
# SCALE PREDICTORS AND CENTRE THOSE THAT HAVE NON-MEANINGFUL ZEROS (Here, just scale...) ----
# -------------------------------------------------------------------------------------------------- #
library(caret)
pP_params_train <- caret::preProcess(Train_data[,4:ncol(Train_data)], method = c("center","scale"))
Train_data_scaled_centred_train <- predict(object = pP_params_train, newdata = Train_data)

#dirName <- paste0(system.file("extdata", package = "fishcastr"), "/vignette_data/")
#saveRDS(Train_data_scaled_centred_train, file = paste0(dirName,"Train_data_scaled_centred_train.rds"))

# -------------------------------------------------------------------------------------------------- #
# FIT MODELS ----
# -------------------------------------------------------------------------------------------------- #

# # model 1 all three way interactions
 library(glmmTMB)
# m1 <- glmmTMB::glmmTMB(ssmolt ~ (ln_discharge+migration_prep + moonlight_exposure + Tw_mod)^3 + (1|salmonid_year),
#                                       poisson(link = "log"),
#                                       data=Train_data_scaled_centred_train)
# simulatedResiduals_m1 <- DHARMa::simulateResiduals(m1)
# 
# par(mfrow = c(2,1))
# DHARMa::testDispersion(simulatedResiduals_m1)
# DHARMa::testZeroInflation(simulatedResiduals_m1)
# #overdispersed and zero inflated and non-linearities
# 
# # -------------------------------------------------------------------------------------------------- #
# # model 2 genpois
# m2 <- glmmTMB::glmmTMB(ssmolt ~ (ln_discharge+migration_prep + moonlight_exposure + Tw_mod)^3 + (1|salmonid_year),
#                                       genpois(link = "log"),
#                                       data=Train_data_scaled_centred_train)
# simulatedResiduals_m2 <- DHARMa::simulateResiduals(m2)
# 
# par(mfrow = c(2,1))
# DHARMa::testDispersion(simulatedResiduals_m2)
# DHARMa::testZeroInflation(simulatedResiduals_m2)
# # ok, but nonlinearity for temp and migration_prep

# -------------------------------------------------------------------------------------------------- #
# model 3 all two way interactions and three way interactions involving ln_discharge genpois and quadratic temp
m3 <- glmmTMB::glmmTMB(ssmolt ~ (Tw_mod + I(Tw_mod^2))*(ln_discharge+ln_migration_prep + moonlight_exposure)^2 + (ln_discharge+ln_migration_prep + moonlight_exposure)^3 + (1|salmonid_year),
                                      genpois(link = "log"),
                                      data=Train_data_scaled_centred_train)
simulatedResiduals_m3 <- DHARMa::simulateResiduals(m3)
#par(mfrow = c(2,1))
#DHARMa::testDispersion(simulatedResiduals_m3)
#DHARMa::testZeroInflation(simulatedResiduals_m3)
# some pattern in ln_migration_prep, but not major

# model 3b check structure using poly
m3b <- glmmTMB::glmmTMB(ssmolt ~ (ln_discharge+ln_migration_prep + moonlight_exposure + poly(Tw_mod,2,raw = TRUE))^3  + (1|salmonid_year),
                                      genpois(link = "log"),
                                      data=Train_data_scaled_centred_train)
simulatedResiduals_m3b <- DHARMa::simulateResiduals(m3b)

#par(mfrow = c(2,1))
#DHARMa::testDispersion(simulatedResiduals_m3b)
#DHARMa::testZeroInflation(simulatedResiduals_m3b)

# check effectively identical
effs <- (glmmTMB::fixef(m3))
effsb <- (glmmTMB::fixef(m3b))
param_diffs <- as.vector((signif(sort(effs$cond),3)) - signif(sort(effsb$cond),3))
# do the models produce effectively identical parameter estimates?
ifelse(all(param_diffs <= 0.00005), TRUE,FALSE)

# -------------------------------------------------------------------------------------------------- #
# MODEL VALIDATION PLOTS FOR CHOSEN MODEL ------
# -------------------------------------------------------------------------------------------------- #
mod_check <- simulatedResiduals_m3
# Create vignette sub directories ------------------------------------------------------
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/vignette_figures/")
dir.create(dirName, showWarnings = TRUE, mode = "0777")

dirName <- paste0(system.file("extdata", package = "fishcastr"),"/vignette_figures/count_model_checks/")
dir.create(dirName, showWarnings = TRUE, mode = "0777")

dirName <- paste0(system.file("extdata", package = "fishcastr"),"/vignette_figures/count_model_checks/salmon/")
dir.create(dirName, showWarnings = TRUE, mode = "0777")


png(file = paste0(dirName,'FigS5a.png'), width=2100, height=1200, res=300)
plot(mod_check, rank = T, smoothScatter = FALSE, quantreg = TRUE)
invisible(dev.off())

png(file = paste0(dirName,'FigS5b.png'), width=1800, height=2100, res=300)
par(mfrow = c(2,1), oma = c(0,0,0,0), mar = c(4,4,5,4))
# overdispersion
DHARMa::testDispersion(mod_check)
# zero inflation
DHARMa::testZeroInflation(mod_check)
invisible(dev.off())

# -------------------------------------------------------------------------------------------------- #
# NON-LINEARITY VALIDATION PLOTS (IF PATTERNS PRESENT IN FIT VS RESIDUALS) ----
# -------------------------------------------------------------------------------------------------- #
# individual predictors
png(file = paste0(dirName,'FigS5e.png'), width=2500, height=2500, res=300)
par(mfrow = c(2,2), mar = c(3.5,3.5,3.5,0.5),mgp = c(2.5,1,0))
   DHARMa::plotResiduals(form = Train_data_scaled_centred_train$ln_migration_prep,
                         simulationOutput = mod_check,
                         quantreg = T,smoothScatter = FALSE,
                         rank = T, xlab = "ln_migration_prep")
     DHARMa::plotResiduals(form = Train_data_scaled_centred_train$moonlight_exposure,
                         simulationOutput = mod_check,
                         quantreg = T,smoothScatter = FALSE,
                         rank = T, xlab = "moonlight_exposure",)
       DHARMa::plotResiduals(form = Train_data_scaled_centred_train$ln_discharge,
                         simulationOutput = mod_check,
                         quantreg = T,smoothScatter = FALSE,
                         rank = T, xlab = "ln_discharge")
               DHARMa::plotResiduals(form = Train_data_scaled_centred_train$Tw_mod,
                          simulationOutput = mod_check,
                          quantreg = T,smoothScatter = FALSE,
                          rank = T, xlab = "Tw_mod")
invisible(dev.off())

# -------------------------------------------------------------------------------------------------- #
# TEMPORAL AUTOCORRELATION ----
# -------------------------------------------------------------------------------------------------- #
temp_autocorr_plot_data <- data.frame("residssim_date" = Train_data_scaled_centred_train$date,
                                      "residssim" = mod_check$scaledResiduals,
                                      "residssim_bioyear" = Train_data_scaled_centred_train$salmonid_year)

# among years ---
png(file = paste0(dirName,'FigS5c.png'), width=2400, height=1400, res=300)
par(mfrow = c(1,1), oma = c(0,0,0,0), mar = c(4,4,5,4))
DHARMa::plotResiduals(mod_check,
                      Train_data_scaled_centred_train$salmonid_year,
                      asFactor = TRUE, main = "S. salar")
invisible(dev.off())

# within years -----
temp_auto_within_year <- lapply(unique(temp_autocorr_plot_data$residssim_bioyear),FUN = function(x){
DHARMa::testTemporalAutocorrelation(temp_autocorr_plot_data$residssim[temp_autocorr_plot_data$residssim_bioyear == x],
                                    time = temp_autocorr_plot_data$residssim_date[temp_autocorr_plot_data$residssim_bioyear == x], plot = FALSE)
})

png(file = paste0(dirName,'FigS5d.png'), width=2500, height=2000, res=300)
par(mfrow = c(4,3), mar = c(3.5,4.5,0.5,0.5),mgp = c(2,1,0))
temp_auto_within_year_acf <- lapply(unique(temp_autocorr_plot_data$residssim_bioyear),FUN = function(x){
acf(x = temp_autocorr_plot_data$residssim[temp_autocorr_plot_data$residssim_bioyear == x])
  mtext(text = paste0(x),side = 3,line = -1.5, cex = 0.75, adj = 0.9)
})
invisible(dev.off())

# export model
dirName <- paste0(system.file("extdata", package = "fishcastr"), "/vignette_data/")
saveRDS(m3, file = paste0(dirName,"m3_salmon_historic.rds"))

 rm(list = ls(all.names = TRUE))
 invisible(gc())
```

```{r model_salmon_counts_1981_1992_fit-salmon-1, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/count_model_checks/salmon/")
knitr::include_graphics(path = paste0(dirName,"FigS5a.png"))
```

```{r model_salmon_counts_1981_1992_fit-salmon-2, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/count_model_checks/salmon/")
knitr::include_graphics(path = paste0(dirName,"FigS5b.png"))
```

```{r model_salmon_counts_1981_1992_fit-salmon-3, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/count_model_checks/salmon/")
knitr::include_graphics(path = paste0(dirName,"FigS5c.png"))
```

```{r model_salmon_counts_1981_1992_fit-salmon-4, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/count_model_checks/salmon/")
knitr::include_graphics(path = paste0(dirName,"FigS5d.png"))
```

```{r model_salmon_counts_1981_1992_fit-salmon-5, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/count_model_checks/salmon/")
knitr::include_graphics(path = paste0(dirName,"FigS5e.png"))
```

### Check influence of individual years on model parameters

#### Generate influence statistics (dfbeta)

```{r model_salmon_counts_1981_1992_check_influence_I,eval = FALSE}
# -------------------------------------------------------------------------------------------------- #
# INFLUENTIAL YEARS
# see https://cran.r-project.org/web/packages/glmmTMB/vignettes/model_evaluation.pdf
# -------------------------------------------------------------------------------------------------- #
library(glmmTMB)

Train_data_scaled_centred_train <- readRDS(paste0(system.file("extdata",
                                 package = "fishcastr"),
                     "/vignette_data/Train_data_scaled_centred_train.rds"))

chosen_model <- readRDS(paste0(system.file("extdata",
                                 package = "fishcastr"),
                     "/vignette_data/m3_salmon_historic.rds"))

chosen_model <- m3

source(system.file("other_methods","influence_mixed.R", package="glmmTMB"))
system.time(chosen_model_influence <- influence_mixed(chosen_model,
                                                      groups = "salmonid_year",
                                                      component = "cond"))
#59.03 /60# 0.98 mins

dirName <- paste0(system.file("extdata", package = "fishcastr"), "/vignette_data/")
saveRDS(chosen_model_influence, file = paste0(dirName,"chosen_model_influence.rds"))
```

#### Compute Cook's D from influence statistics

```{r model_salmon_counts_1981_1992_check_influence_II,eval = FALSE}
library(glmmTMB)
library(car)

chosen_model_influence <- readRDS(paste0(system.file("extdata",
                                 package = "fishcastr"),
                     "/vignette_data/chosen_model_influence.rds"))

inf <- as.data.frame(chosen_model_influence[["fixed.effects[-salmonid_year]"]])
inf <- transform(inf,
                 salmonid_year=rownames(inf),
                 cooks=stats::cooks.distance(chosen_model_influence))
inf$ord <- rank(inf$cooks)
```

#### Compute influence statistics scaled by standard errors (dfbetas)

```{r model_salmon_counts_1981_1992_check_influence_III,eval = FALSE}
chosen_model_influence <- readRDS(paste0(system.file("extdata",
                                 package = "fishcastr"),
                     "/vignette_data/chosen_model_influence.rds"))

inf <- as.data.frame(chosen_model_influence[["fixed.effects[-salmonid_year]"]])
inf <- transform(inf,
                 salmonid_year=rownames(inf),
                 cooks=stats::cooks.distance(chosen_model_influence))
inf$ord <- rank(inf$cooks)

inf_full_mod_eff <-as.list(chosen_model_influence[["fixed.effects"]])

# extract standard errors of param estimates excluding higher levels under investigation
year_names <- names(chosen_model_influence[["vcov[-salmonid_year]"]])
serrs_list <- lapply(year_names,FUN = function(x){
  sqrt(diag(chosen_model_influence[["vcov[-salmonid_year]"]][[x]]))
})
serrs <- do.call(rbind,serrs_list)
rownames(serrs) <- year_names

# calculate dfbetas - each value will be positive if the effect with the included level is stronger than without it.
# e.g., the intercept is greater with the inclusion of 1987 data (because 1987 was a high count)
  dfbetas <- inf
for(i in 1:(ncol(inf)-3)){
  dfbetas[,i] = (inf[,i] - inf_full_mod_eff[[i]])/serrs[,i]
}

#for(i in 1:(ncol(inf)-3)){
#  dfbetas[,i] = (inf[,i] - inf_full_mod_eff[[i]])
#}

dfbetas <- transform(dfbetas,
                     salmonid_year=rownames(dfbetas))

dirName <- paste0(system.file("extdata", package = "fishcastr"), "/vignette_data/")
saveRDS(dfbetas, file = paste0(dirName,"dfbetas.rds"))
```

#### Plot dfbetas and Cook's D

```{r model_salmon_counts_1981_1992_check_influence_IV,eval = FALSE}
dfbetas <- readRDS(paste0(system.file("extdata",
                                 package = "fishcastr"),
                     "/vignette_data/dfbetas.rds"))
#inf_long_sort <- inf_long[with(inf_long, order(inf_long$variable,-inf_long$ord)),]

library(ggplot2)
library(reshape2)

theme_set(theme_bw())
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/vignette_figures/count_model_checks/salmon/")
png(file = paste0(dirName,'FigS5f.png'), width=7000, height=4000, res=300)
if (require(reshape2)){
  inf_long <- reshape2::melt(dfbetas, id.vars=c("ord","salmonid_year"))
#  inf_long_sort <- inf_long[with(inf_long, order(inf_long$variable,-inf_long$ord)),]
  gg_infl <- (ggplot2::ggplot(inf_long, aes(salmonid_year,value))
              + geom_segment(aes(x=salmonid_year,xend=salmonid_year,y=0,yend=value),colour="black", size = 2)
              + facet_wrap(~variable, scale="free_y")
              + scale_y_continuous(expand=expansion(mult=0.5))
              + geom_text(data=subset(inf_long,
                                       abs(value) > 1),
                           aes(y = value + (0.6 * (value)), label=salmonid_year),
                           vjust=0.0, angle = 90)
              + geom_hline(yintercept=0,linetype = "dashed")
              + theme(axis.text.x = element_text(angle = 90)))
  print(gg_infl)}
invisible(dev.off())
```

```{r model_salmon_counts_1981_1992_check_influence_IV-salmon, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/count_model_checks/salmon/")
knitr::include_graphics(path = paste0(dirName,"FigS5f.png"))
```

### Plot interactions to gauge plausibility of parameter estimates

```{r model_salmon_counts_1981_1992_plot_interactions,eval = FALSE}

library(glmmTMB)
chosen_model <- readRDS(paste0(system.file("extdata",
                                 package = "fishcastr"),
                     "/vignette_data/m3_salmon_historic.rds"))

Train_data_scaled_centred_train <- readRDS(paste0(system.file("extdata",
                                 package = "fishcastr"),
                     "/vignette_data/Train_data_scaled_centred_train.rds"))

# -------------------------------------------------------------------------------------------------- #
# PLOT ALL TWO AND THREE-WAY INTERACTIONS OF SELECTED MODEL
# -------------------------------------------------------------------------------------------------- #
interactions_list_3 <- list("7" = c("Tw_mod","ln_migration_prep","ln_discharge"),
                          "8" = c("ln_discharge","Tw_mod","moonlight_exposure"),
                          "9" = c("ln_migration_prep","moonlight_exposure","Tw_mod"),
                          "10" = c("moonlight_exposure","ln_discharge","ln_migration_prep"))

# -------------------------------------------------------------------------------------------------- #
# with points
int_plots <- lapply(interactions_list_3,FUN = function(x){
  
  # set x axis lims
  # 75th
  data_75_plus <- Train_data_scaled_centred_train[Train_data_scaled_centred_train[[x[3]]] >= quantile(Train_data_scaled_centred_train[[x[3]]], probs = c((((75+50)/2)/100))),]
xlims75 <- c(range(data_75_plus[[x[1]]]))
  # 50th
  data_50_plus <- Train_data_scaled_centred_train[Train_data_scaled_centred_train[[x[3]]] >= quantile(Train_data_scaled_centred_train[[x[3]]], probs = c((((50+50)/2)/100))),]
xlims50 <- c(range(data_50_plus[[x[1]]]))
  # 75th
  data_25_plus <- Train_data_scaled_centred_train[Train_data_scaled_centred_train[[x[3]]] >= quantile(Train_data_scaled_centred_train[[x[3]]], probs = c((((25+50)/2)/100))),]
xlims25 <- c(range(data_25_plus[[x[1]]]))
# xlims
xlims_min <- max(c(xlims75[1],xlims50[1],xlims25[1]))
xlims_max <- min(c(xlims75[2],xlims50[2],xlims25[2]))
xlims <- c(xlims_min,xlims_max)

 int_plot <- interactions::interact_plot(chosen_model,
                            pred = !!(x[1]),
                            modx = !!(x[2]),
                            mod2 = !!(x[3]),
                            linearity.check = FALSE,interval = TRUE, int.width = 0.95,
                            modx.values = c(quantile(Train_data_scaled_centred_train[[x[2]]],
                                                     probs = c(0.25,0.50,0.75))),
                            mod2.values = c(quantile(Train_data_scaled_centred_train[[x[3]]],
                                                     probs = c(0.25,0.50,0.75))),
                            plot.points = TRUE,data = Train_data_scaled_centred_train, ... = list(allow.new.levels=TRUE)) + scale_x_continuous(expand = c(0,0)) + coord_cartesian(clip = 'on', ylim = c(0, max(Train_data_scaled_centred_train$ssmolt)),xlim = xlims)
  
 return(int_plot)
})

dirName <- paste0(system.file("extdata", package = "fishcastr"),"/vignette_figures/count_model_checks/salmon/")
png(file = paste0(dirName,'FigS5g.png'), width=2500, height=4000, res=300)
ggpubr::ggarrange(int_plots[[1]],int_plots[[2]],int_plots[[3]],int_plots[[4]],
          labels = c("Disch","Moon","Temp","Prep"),
          ncol = 1, nrow = 4)
invisible(dev.off())

# -------------------------------------------------------------------------------------------------- #
# without points
int_plots_no_points <- lapply(interactions_list_3,FUN = function(x){
  
    # set x axis lims
  # 75th
  data_75_plus <- Train_data_scaled_centred_train[Train_data_scaled_centred_train[[x[3]]] >= quantile(Train_data_scaled_centred_train[[x[3]]], probs = c((((75+50)/2)/100))),]
xlims75 <- c(range(data_75_plus[[x[1]]]))
  # 50th
  data_50_plus <- Train_data_scaled_centred_train[Train_data_scaled_centred_train[[x[3]]] >= quantile(Train_data_scaled_centred_train[[x[3]]], probs = c((((50+50)/2)/100))),]
xlims50 <- c(range(data_50_plus[[x[1]]]))
  # 75th
  data_25_plus <- Train_data_scaled_centred_train[Train_data_scaled_centred_train[[x[3]]] >= quantile(Train_data_scaled_centred_train[[x[3]]], probs = c((((25+50)/2)/100))),]
xlims25 <- c(range(data_25_plus[[x[1]]]))
# xlims
xlims_min <- max(c(xlims75[1],xlims50[1],xlims25[1]))
xlims_max <- min(c(xlims75[2],xlims50[2],xlims25[2]))
xlims <- c(xlims_min,xlims_max)
  
int_plot <-  interactions::interact_plot(chosen_model,
                            pred = !!(x[1]),
                            modx = !!(x[2]),
                            mod2 = !!(x[3]),
                            linearity.check = FALSE,interval = TRUE, int.width = 0.95,
                            modx.values = c(quantile(Train_data_scaled_centred_train[[x[2]]],
                                                     probs = c(0.25,0.50,0.75))),
                            mod2.values = c(quantile(Train_data_scaled_centred_train[[x[3]]],
                                                     probs = c(0.25,0.50,0.75))),
                            plot.points = FALSE,data = Train_data_scaled_centred_train, ... = list(allow.new.levels=TRUE)) + scale_x_continuous(expand = c(0,0)) + coord_cartesian(xlim = xlims)

# extract auto ylims and change to max count if exceeding it.
if(ggplot_build(int_plot)$layout$panel_scales_y[[1]]$range$range[2] >= max(Train_data_scaled_centred_train$ssmolt)){
int_plot$coordinates$limits$y <- c(0,max(Train_data_scaled_centred_train$ssmolt))
}
return(int_plot)
})

png(file = paste0(dirName,'FigS5h.png'), width=2500, height=4000, res=300)
ggpubr::ggarrange(int_plots_no_points[[1]],int_plots_no_points[[2]],int_plots_no_points[[3]],int_plots_no_points[[4]],
          labels = c("Disch","Moon","Temp","Prep"),
          ncol = 1, nrow = 4)
invisible(dev.off())

 rm(list = ls(all.names = TRUE))
 invisible(gc())
```

```{r model_salmon_counts_1981_1992_plot_interactions-salmon-1, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/count_model_checks/salmon/")
knitr::include_graphics(path = paste0(dirName,"FigS5g.png"))
```

```{r model_salmon_counts_1981_1992_plot_interactions-salmon-2, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/count_model_checks/salmon/")
knitr::include_graphics(path = paste0(dirName,"FigS5h.png"))
```

### Check plausibility of simulated counts and consistency of predictions with built in glmmTMB simulation

```{r model_salmon_counts_1981_1992_plausible_glmmTMB,eval = FALSE}
# -------------------------------------------------------------------------------------------------- #
# GENERAL PLOTS TO TEST FISHCASTR SIMULATION FUNCTION CONSISTENCY WITH GLMMTMB BUILT IN ----
# -------------------------------------------------------------------------------------------------- #
library(glmmTMB)
object <- readRDS(paste0(system.file("extdata",
                                 package = "fishcastr"),
                     "/vignette_data/m3_salmon_historic.rds"))

object <- m3

Train_data_scaled_centred_train <- readRDS(paste0(system.file("extdata",
                                 package = "fishcastr"),
                     "/vignette_data/Train_data_scaled_centred_train.rds"))

new_data <- Train_data_scaled_centred_train

#for checking if long term trend remains in simulations when new levels added (see re.form documentation in glmmTMB)
#new_data$salmonid_year <- Train_data_scaled_centred_train$salmonid_year + 40

# extract conditional mean
cond_mean <- predict(object, newdata=new_data,
                     type="conditional",
                     re.form = NA,
                     allow.new.levels=TRUE, 
                     na.action = na.pass)

# extract dispersion parameter as function of fixed effects, noting log link (hence exp())
f <- formula(object, component = "disp")
X <- model.matrix(f, data = new_data)
beta <- fixef(object)[["disp"]]
eta <- X %*% beta
odp <- c(exp(eta))

# generate random deviates
mu = cond_mean
disp_param = odp

theta <- as.numeric(mu*(1 - (1 - sqrt(1/disp_param))))
lambda <- (1 - sqrt(1/disp_param))
result <- RMKdiscrete::rLGP(n = 1,theta = theta,lambda = lambda)

# check annual sums are reasonably consistent
df_check <- data.frame("result" = result,
                       "salmonid_year" = new_data$salmonid_year,
                       "ssmolt" = new_data$ssmolt)
tapply(df_check$result,INDEX = df_check$salmonid_year,FUN = sum)
tapply(df_check$ssmolt,INDEX = df_check$salmonid_year,FUN = sum)
#par(mfrow = c(1,1))
plot(tapply(df_check$result,INDEX = df_check$salmonid_year,FUN = sum),
     tapply(df_check$ssmolt,INDEX = df_check$salmonid_year,FUN = sum))

#######
# # or if single param poisson zeroinf
# #or if single pram
# zi_prob <- predict(object, newdata=new_data, type="zprob", allow.new.levels=TRUE, na.action = na.pass,re.form = NA)
# 
# cond <- rpois(n = nrow(new_data),
#               lambda = cond_mean)
# 
# result <- ifelse(stats::runif(nrow(new_data))< zi_prob, 0, cond)
# 
#######
 
 mTrain_genpois_op_sims_sqr <- simulate(object,nsim = 1)
# # plot simulations 
 c = 0
 i = 1
      par(mfrow = c(3,1), mar = c(4,4,1,1))
 plot((1+c):(365+c),mTrain_genpois_op_sims_sqr$sim_1[(1+c):(365+c)], type = "s", col = NULL, ylim = c(0,500), main = paste0(i, "glmmtmb"))
 lines((1+c):(365+c),mTrain_genpois_op_sims_sqr$sim_1[(1+c):(365+c)], type = "h", col = "blue")
 plot((1+c):(365+c),result[(1+c):(365+c)], type = "h", col = "green3", main = "manual",ylim = c(0,500))
 plot((1+c):(365+c),Train_data_scaled_centred_train$ssmolt[(1+c):(365+c)], type = "h", col = "red", main = "ssmolt",ylim = c(0,500))
# 
#      for(i in 1:length(unique(df_check$salmonid_year))-1){
#      par(mfrow = c(3,1), mar = c(4,4,1,1))
#  c = 365*i
# plot((1+c):(365+c),mTrain_genpois_op_sims_sqr$sim_1[(1+c):(365+c)], type = "s", col = NULL, ylim = c(0,500), main = paste0(i+1, "glmmtmb"))
# lines((1+c):(365+c),mTrain_genpois_op_sims_sqr$sim_1[(1+c):(365+c)], type = "h", col = "blue")
# plot((1+c):(365+c),result[(1+c):(365+c)], type = "h", col = "green3", main = "manual",ylim = c(0,500))
# plot((1+c):(365+c),Train_data_scaled_centred_train$ssmolt[(1+c):(365+c)], type = "h", col = "red", main = "ssmolt",ylim = c(0,500))
# }
 rm(list = ls(all.names = TRUE))
 invisible(gc())
```

## Fit refined model to data using leave-one-year-out approach

```{r model_salmon_counts_1981_2018_fit_loo,eval = FALSE}
# ---------------------------------------------------------------------------------------------------------- #
# LOAD COUNT AND PREDICTOR DATA ----
# ---------------------------------------------------------------------------------------------------------- #
data_ssmolt_enviro_1981_2019 <- readRDS(paste0(system.file("extdata",
                                                    package = "fishcastr"),
                                               "/vignette_data/data_ssmolt_enviro_1981_2019.rds"))

######################################################################################################
# -------------------------------------------------------------------------------------------------- #
# SUBSET DATA TO 1981 - 2018 TO BUILD MODEL LIST FOR SEASONAL FORECAST LOO VALIDATION ----
# -------------------------------------------------------------------------------------------------- #
data_ssmolt_enviro_1981_2018 <- data_ssmolt_enviro_1981_2019[data_ssmolt_enviro_1981_2019$salmonid_year %in% c(1981:2018),]
all_timeseries_years <- as.list(1981:2018)
suppressMessages(library(glmmTMB))
suppressMessages(library(caret))
suppressMessages(library(plyr))
  suppressMessages(library(parallel))
  suppressMessages(library(doSNOW))
  # n_cores <- 3
  n_cores <- parallel::detectCores() -1
  
  cl <- parallel::makeCluster(n_cores, type = "SOCK")
  
  parallel::clusterSetRNGStream(cl, iseed = 123)
  parallel::clusterCall(cl, function(){ library(glmmTMB)})
  parallel::clusterCall(cl, function(){ library(caret)})
  parallel::clusterCall(cl, function(){ library(plyr)})
  parallel::clusterExport(cl, varlist = c('data_ssmolt_enviro_1981_2018',
                                          'all_timeseries_years'),
                          envir = environment())
  
    doSNOW::registerDoSNOW(cl)

# calibrate models for all years except for year x (i.e., leave-one-year-out
# calibration). This results in models for all years up to 2018. To build
# operational predictions for year 2019, all years PLUS 2018 must be used for
# calibration.
# FOR 1981 - 2018...
system.time({model_list <- plyr::llply(.data = all_timeseries_years, .fun = function(x){
list_x <- do.call(c, all_timeseries_years)
list_minus_x <- list_x[-which(list_x == x)]

# -------------------------------------------------------------------------------------------------- #
# SCALE PREDICTOR VARIABLES IN TRAINING AND TEST DATASETS ----
# -------------------------------------------------------------------------------------------------- #
Train_data <- subset(data_ssmolt_enviro_1981_2018,
                     salmonid_year %in% c(list_minus_x), select = c(date,
                                                                    ssmolt,
                                                                    salmonid_year,
                                                                    ln_migration_prep,
                                                                    salmonid_yday,
                                                                    moonlight_exposure,
                                                                    ln_discharge,
                                                                    Tw_mod))

# Test_data <- subset(data_ssmolt_enviro_1981_2018,
#                     salmonid_year %in% c(x), select = c(date,
#                                                         ssmolt,
#                                                         salmonid_year,
#                                                         ln_migration_prep,
#                                                         salmonid_yday,
#                                                         moonlight_exposure,
#                                                         ln_discharge,
#                                                         Tw_mod))


# SCALE PREDICTORS AND CENTRE THOSE THAT HAVE NON-MEANINGFUL ZEROS (Here, just scale...)
pP_params <- caret::preProcess(Train_data[,4:ncol(Train_data)], method = c("center","scale"))
Train_data_scaled_centred <- predict(object = pP_params, newdata = Train_data)
#Test_data_scaled_centred <- predict(object = pP_params, newdata = Test_data)

# -------------------------------------------------------------------------------------------------- #
# generalised poisson for underdispersion or overdispersion... ----
# -------------------------------------------------------------------------------------------------- #
mTrain_genpois <- glmmTMB::glmmTMB(ssmolt ~ (Tw_mod + I(Tw_mod^2))*(ln_discharge+ln_migration_prep + moonlight_exposure)^2 + (ln_discharge+ln_migration_prep + moonlight_exposure)^3 + (1|salmonid_year),
                          genpois(link = "log"),
                          data=Train_data_scaled_centred,
                          control = glmmTMBControl(parallel = 3))

return(list(mTrain_genpois,pP_params))
}, .progress = 'text', .parallel = TRUE)})

    parallel::stopCluster(cl) # Close all open clusters
 #577.90/60 # 10 mins for 1981-2018 years
 
# -------------------------------------------------------------------------------------------------- #
# EXPORT MODEL AND SCALING FACTOR LIST AS "TWO" rds OBJECTS FOR REDUCING FILE
# SIZE to less than 100mb for Git Push  ----
# -------------------------------------------------------------------------------------------------- #

# save
model_list_1of2 <- model_list[1:20]
model_list_2of2 <- model_list[21:length(model_list)]

dirName <- paste0(system.file("extdata", package = "fishcastr"), "/vignette_data/")
saveRDS(model_list_1of2, file = paste0(dirName,"mTrain_genpois_salmon_list_1of2.rds"))
saveRDS(model_list_2of2, file = paste0(dirName,"mTrain_genpois_salmon_list_2of2.rds"))

# # load
# dirName <- paste0(system.file("extdata", package = "fishcastr"), "/vignette_data/")
# model_list_1of2 <- readRDS(file = paste0(dirName,"mTrain_genpois_salmon_list_1of2.rds"))
# model_list_2of2 <- readRDS(file = paste0(dirName,"mTrain_genpois_salmon_list_2of2.rds"))
# model_list <- list()
# model_list[1:length(model_list_1of2)] <- model_list_1of2
# model_list[(1 + length(model_list_1of2)):(length(model_list_1of2)+length(model_list_2of2))] <- model_list_2of2
 rm(list = ls(all.names = TRUE))
 invisible(gc())
```

## Fit refined model structure to all data up to operational year

```{r model_salmon_counts_2019_fit_operational,eval = FALSE}
# ---------------------------------------------------------------------------------------------------------- #
# LOAD COUNT AND PREDICTOR DATA ----
# ---------------------------------------------------------------------------------------------------------- #
data_ssmolt_enviro_1981_2019 <- readRDS(paste0(system.file("extdata",
                                                    package = "fishcastr"),
                                               "/vignette_data/data_ssmolt_enviro_1981_2019.rds"))

# -------------------------------------------------------------------------------------------------- #
# OPERATIONAL YEAR 2019 (ALL DATA) ----
# -------------------------------------------------------------------------------------------------- #
min_1981 <- min(data_ssmolt_enviro_1981_2019$date[data_ssmolt_enviro_1981_2019$salmonid_year == 1981])
max_2019 <- max(data_ssmolt_enviro_1981_2019$date[data_ssmolt_enviro_1981_2019$salmonid_year == 2018])

Train_data_op <- subset(data_ssmolt_enviro_1981_2019, select = c(date,
                                                                 ssmolt,
                                                                 salmonid_year,
                                                                 ln_migration_prep,
                                                                 salmonid_yday,
                                                                 moonlight_exposure,
                                                                 ln_discharge,
                                                                 Tw_mod),
                        subset = data.table::between(data_ssmolt_enviro_1981_2019$date,
                                                     lower = min_1981,
                                                     upper = max_2019))

# -------------------------------------------------------------------------------------------------- #
# SCALE PREDICTORS AND CENTRE THOSE THAT HAVE NON-MEANINGFUL ZEROS (Here, just scale...) ----
# -------------------------------------------------------------------------------------------------- #
library(caret)
pP_params_op <- caret::preProcess(Train_data_op[,4:ncol(Train_data_op)], method = c("center","scale"))
Train_data_scaled_centred_op <- predict(object = pP_params_op, newdata = Train_data_op)
    
# -------------------------------------------------------------------------------------------------- #
# FIT MODEL ----
# -------------------------------------------------------------------------------------------------- #
library(glmmTMB)
mop <- glmmTMB::glmmTMB(ssmolt ~ (Tw_mod + I(Tw_mod^2))*(ln_discharge+ln_migration_prep + moonlight_exposure)^2 + (ln_discharge+ln_migration_prep + moonlight_exposure)^3 + (1|salmonid_year),
                          genpois(link = "log"),
                          data=Train_data_scaled_centred_op)
simulatedResiduals_genpois <- DHARMa::simulateResiduals(mop)

# -------------------------------------------------------------------------------------------------- #
# MODEL VALIDATION PLOTS FOR OPERATIONAL YEAR (CHECK FOR ISSUES) ------
# -------------------------------------------------------------------------------------------------- #
mod_check <- simulatedResiduals_genpois
# Create vignette sub directories ------------------------------------------------------
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/count_model_checks/salmon/op_model/")
dir.create(paste0(dirName), showWarnings = TRUE, mode = "0777")

png(file = paste0(dirName,'FigS5a.png'), width=2100, height=1200, res=300)
plot(mod_check, rank = T, smoothScatter = FALSE, quantreg = TRUE)
invisible(dev.off())

png(file = paste0(dirName,'FigS5b.png'), width=1800, height=2100, res=300)
par(mfrow = c(2,1), oma = c(0,0,0,0), mar = c(4,4,5,4))
# overdispersion
DHARMa::testDispersion(mod_check)
# zero inflation
DHARMa::testZeroInflation(mod_check)
invisible(dev.off())

# -------------------------------------------------------------------------------------------------- #
# NON-LINEARITY VALIDATION PLOTS (IF PATTERNS PRESENT IN FIT VS RESIDUALS) ----
# -------------------------------------------------------------------------------------------------- #
# individual predictors
png(file = paste0(dirName,'FigS5e.png'), width=2500, height=2500, res=300)
par(mfrow = c(2,2), mar = c(3.5,3.5,3.5,0.5),mgp = c(2.5,1,0))
   DHARMa::plotResiduals(form = Train_data_scaled_centred_op$ln_migration_prep,
                         simulationOutput = mod_check,
                         quantreg = T,smoothScatter = FALSE,
                         rank = T, xlab = "ln_migration_prep")
     DHARMa::plotResiduals(form = Train_data_scaled_centred_op$moonlight_exposure,
                         simulationOutput = mod_check,
                         quantreg = T,smoothScatter = FALSE,
                         rank = T, xlab = "moonlight_exposure")
       DHARMa::plotResiduals(form = Train_data_scaled_centred_op$ln_discharge,
                         simulationOutput = mod_check,
                         quantreg = T,smoothScatter = FALSE,
                         rank = T, xlab = "ln_discharge")
              DHARMa::plotResiduals(form = Train_data_scaled_centred_op$Tw_mod,
                         simulationOutput = mod_check,
                         quantreg = T,smoothScatter = FALSE,
                         rank = T, xlab = "Tw_mod")
invisible(dev.off())

# -------------------------------------------------------------------------------------------------- #
# TEMPORAL AUTOCORRELATION ----
# -------------------------------------------------------------------------------------------------- #
temp_autocorr_plot_data <- data.frame("residssim_date" = Train_data_scaled_centred_op$date,
                                      "residssim" = mod_check$scaledResiduals,
                                      "residssim_bioyear" = Train_data_scaled_centred_op$salmonid_year)

# among years ---
png(file = paste0(dirName,'FigS5c.png'), width=2400, height=1400, res=300)
par(mfrow = c(1,1), oma = c(0,0,0,0), mar = c(4,4,5,4))
DHARMa::plotResiduals(mod_check,
                      Train_data_scaled_centred_op$salmonid_year,
                      asFactor = TRUE, main = "S. salar")
invisible(dev.off())

# within years -----
temp_auto_within_year <- lapply(unique(temp_autocorr_plot_data$residssim_bioyear),FUN = function(x){
DHARMa::testTemporalAutocorrelation(temp_autocorr_plot_data$residssim[temp_autocorr_plot_data$residssim_bioyear == x],
                                    time = temp_autocorr_plot_data$residssim_date[temp_autocorr_plot_data$residssim_bioyear == x], plot = FALSE)
})

png(file = paste0(dirName,'FigS5d.png'), width=2500, height=2000, res=300)
par(mfrow = c(6,7), mar = c(2.5,3.0,0.1,0.1),mgp = c(1.5,0.5,0))
temp_auto_within_year_acf <- lapply(unique(temp_autocorr_plot_data$residssim_bioyear),FUN = function(x){
acf(x = temp_autocorr_plot_data$residssim[temp_autocorr_plot_data$residssim_bioyear == x], cex.axis = 0.75, cex.lab = 0.75)
  mtext(text = paste0(x),side = 3,line = -1.5, cex = 0.75, adj = 0.9)
})
invisible(dev.off())

# -------------------------------------------------------------------------------------------------- #
# INFLUENTIAL YEARS
# see https://cran.r-project.org/web/packages/glmmTMB/vignettes/model_evaluation.pdf
# -------------------------------------------------------------------------------------------------- #
chosen_model <- mop
source(system.file("other_methods","influence_mixed.R", package="glmmTMB"))
system.time(chosen_model_influence <- influence_mixed(chosen_model,
                                                      groups = "salmonid_year",
                                                      component = "cond"))

#655.80 /60# 11 mins

#inf_ind_plot_data <- car::infIndexPlot(chosen_model_influence)# run this first to load libraryd libraries
#cookdist <- cooks.distance(chosen_model_influence)

#cookdist
#png(file = paste0(dirName,'salmon/FigS5fm5cook.png'), width=1000, height=10000, res=300)
#inf_ind_plot_data <- car::infIndexPlot(chosen_model_influence)
#invisible(dev.off())
#stats::cooks.distance(infl = chosen_model_influence)
#?cooks.distance
library(car)
inf <- as.data.frame(chosen_model_influence[["fixed.effects[-salmonid_year]"]])
inf_full_mod_eff <-as.list(chosen_model_influence[["fixed.effects"]])
inf <- transform(inf,
                 salmonid_year=rownames(inf),
                 cooks=stats::cooks.distance(chosen_model_influence))
inf$ord <- rank(inf$cooks)

# extract standard errors of param estimates excluding higher levels under investigation
year_names <- names(chosen_model_influence[["vcov[-salmonid_year]"]])
serrs_list <- lapply(year_names,FUN = function(x){
  sqrt(diag(chosen_model_influence[["vcov[-salmonid_year]"]][[x]]))
})
serrs <- do.call(rbind,serrs_list)
rownames(serrs) <- year_names

# calculate dfbetas - each value will be positive if the effect with the included level is stronger than without it.
# e.g., the intercept is greater with the inclusion of 1987 data (because 1987 was a high count)
  dfbetas <- inf
for(i in 1:(ncol(inf)-3)){
  dfbetas[,i] = (inf[,i] - inf_full_mod_eff[[i]])/serrs[,i]
}

#for(i in 1:(ncol(inf)-3)){
#  dfbetas[,i] = (inf[,i] - inf_full_mod_eff[[i]])
#}

dfbetas <- transform(dfbetas,
                     salmonid_year=rownames(dfbetas))

#inf_long_sort <- inf_long[with(inf_long, order(inf_long$variable,-inf_long$ord)),]

library(ggplot2)
theme_set(theme_bw())
png(file = paste0(dirName,'FigS5f.png'), width=7000, height=4000, res=300)
if (require(reshape2)){
  inf_long <- reshape2::melt(dfbetas, id.vars=c("ord","salmonid_year"))
#  inf_long_sort <- inf_long[with(inf_long, order(inf_long$variable,-inf_long$ord)),]
  gg_infl <- (ggplot2::ggplot(inf_long, aes(salmonid_year,value))
              + geom_segment(aes(x=salmonid_year,xend=salmonid_year,y=0,yend=value),colour="black", size = 2)
              + facet_wrap(~variable, scale="free_y")
              + scale_y_continuous(expand=expansion(mult=0.5))
              + geom_text(data=subset(inf_long,
                                       abs(value) > 1),
                           aes(y = value + (0.6 * (value)), label=salmonid_year),
                           vjust=0.0, angle = 90)
              + geom_hline(yintercept=0,linetype = "dashed")
              + theme(axis.text.x = element_text(angle = 90)))
  print(gg_infl)}
invisible(dev.off())

# -------------------------------------------------------------------------------------------------- #
# PLOT ALL TWO AND THREE-WAY INTERACTIONS OF SELECTED MODEL
# -------------------------------------------------------------------------------------------------- #
interactions_list_3 <- list("7" = c("Tw_mod","ln_migration_prep","ln_discharge"),
                          "8" = c("ln_discharge","Tw_mod","moonlight_exposure"),
                          "9" = c("ln_migration_prep","moonlight_exposure","Tw_mod"),
                          "10" = c("moonlight_exposure","ln_discharge","ln_migration_prep"))

# -------------------------------------------------------------------------------------------------- #
# with points
int_plots <- lapply(interactions_list_3,FUN = function(x){
  
  # set x axis lims
  # 75th
  data_75_plus <- Train_data_scaled_centred_op[Train_data_scaled_centred_op[[x[3]]] >= quantile(Train_data_scaled_centred_op[[x[3]]], probs = c((((75+50)/2)/100))),]
xlims75 <- c(range(data_75_plus[[x[1]]]))
  # 50th
  data_50_plus <- Train_data_scaled_centred_op[Train_data_scaled_centred_op[[x[3]]] >= quantile(Train_data_scaled_centred_op[[x[3]]], probs = c((((50+50)/2)/100))),]
xlims50 <- c(range(data_50_plus[[x[1]]]))
  # 75th
  data_25_plus <- Train_data_scaled_centred_op[Train_data_scaled_centred_op[[x[3]]] >= quantile(Train_data_scaled_centred_op[[x[3]]], probs = c((((25+50)/2)/100))),]
xlims25 <- c(range(data_25_plus[[x[1]]]))
# xlims
xlims_min <- max(c(xlims75[1],xlims50[1],xlims25[1]))
xlims_max <- min(c(xlims75[2],xlims50[2],xlims25[2]))
xlims <- c(xlims_min,xlims_max)

 int_plot <- interactions::interact_plot(chosen_model,
                            pred = !!(x[1]),
                            modx = !!(x[2]),
                            mod2 = !!(x[3]),
                            linearity.check = FALSE,interval = TRUE, int.width = 0.95,
                            modx.values = c(quantile(Train_data_scaled_centred_op[[x[2]]],
                                                     probs = c(0.25,0.50,0.75))),
                            mod2.values = c(quantile(Train_data_scaled_centred_op[[x[3]]],
                                                     probs = c(0.25,0.50,0.75))),
                            plot.points = TRUE,data = Train_data_scaled_centred_op) + scale_x_continuous(expand = c(0,0)) + coord_cartesian(clip = 'on', ylim = c(0, max(Train_data_scaled_centred_op$ssmolt)),xlim = xlims)
  
 return(int_plot)
})

png(file = paste0(dirName,'FigS5g.png'), width=2500, height=4000, res=300)
ggpubr::ggarrange(int_plots[[1]],int_plots[[2]],int_plots[[3]],int_plots[[4]],
          labels = c("Disch","Moon","Temp","Prep"),
          ncol = 1, nrow = 4)
invisible(dev.off())

# -------------------------------------------------------------------------------------------------- #
# without points
int_plots_no_points <- lapply(interactions_list_3,FUN = function(x){
  
    # set x axis lims
  # 75th
  data_75_plus <- Train_data_scaled_centred_op[Train_data_scaled_centred_op[[x[3]]] >= quantile(Train_data_scaled_centred_op[[x[3]]], probs = c((((75+50)/2)/100))),]
xlims75 <- c(range(data_75_plus[[x[1]]]))
  # 50th
  data_50_plus <- Train_data_scaled_centred_op[Train_data_scaled_centred_op[[x[3]]] >= quantile(Train_data_scaled_centred_op[[x[3]]], probs = c((((50+50)/2)/100))),]
xlims50 <- c(range(data_50_plus[[x[1]]]))
  # 75th
  data_25_plus <- Train_data_scaled_centred_op[Train_data_scaled_centred_op[[x[3]]] >= quantile(Train_data_scaled_centred_op[[x[3]]], probs = c((((25+50)/2)/100))),]
xlims25 <- c(range(data_25_plus[[x[1]]]))
# xlims
xlims_min <- max(c(xlims75[1],xlims50[1],xlims25[1]))
xlims_max <- min(c(xlims75[2],xlims50[2],xlims25[2]))
xlims <- c(xlims_min,xlims_max)
  
int_plot <-  interactions::interact_plot(chosen_model,
                            pred = !!(x[1]),
                            modx = !!(x[2]),
                            mod2 = !!(x[3]),
                            linearity.check = FALSE,interval = TRUE, int.width = 0.95,
                            modx.values = c(quantile(Train_data_scaled_centred_op[[x[2]]],
                                                     probs = c(0.25,0.50,0.75))),
                            mod2.values = c(quantile(Train_data_scaled_centred_op[[x[3]]],
                                                     probs = c(0.25,0.50,0.75))),
                            plot.points = FALSE,data = Train_data_scaled_centred_op) + scale_x_continuous(expand = c(0,0)) + coord_cartesian(xlim = xlims)

# extract auto ylims and change to max count if exceeding it.
if(ggplot_build(int_plot)$layout$panel_scales_y[[1]]$range$range[2] >= max(Train_data_scaled_centred_op$ssmolt)){
int_plot$coordinates$limits$y <- c(0,max(Train_data_scaled_centred_op$ssmolt))
}
return(int_plot)
})

png(file = paste0(dirName,'FigS5h.png'), width=2500, height=4000, res=300)
ggpubr::ggarrange(int_plots_no_points[[1]],int_plots_no_points[[2]],int_plots_no_points[[3]],int_plots_no_points[[4]],
          labels = c("Disch","Moon","Temp","Prep"),
          ncol = 1, nrow = 4)
invisible(dev.off())

# -------------------------------------------------------------------------------------------------- #
# GENERAL PLOTS TO TEST FISHCASTR SIMULATION FUNCTION CONSISTENCY WITH GLMMTMB BUILT IN ----
# -------------------------------------------------------------------------------------------------- #
object = mop
new_data = Train_data_scaled_centred_op

#for checking if long term trend remains in simulations when new levels added (see re.form documentation in glmmTMB)
#new_data$salmonid_year <- Train_data_scaled_centred_train$salmonid_year + 40

# extract conditional mean
cond_mean <- predict(object, newdata=new_data,
                     type="conditional",
                     re.form = NA,
                     allow.new.levels=TRUE, 
                     na.action = na.pass)

# extract dispersion parameter as function of fixed effects, noting log link (hence exp())
f <- formula(object, component = "disp")
X <- model.matrix(f, data = new_data)
beta <- fixef(object)[["disp"]]
eta <- X %*% beta
odp <- c(exp(eta))

# generate random deviates
mu = cond_mean
disp_param = odp

theta <- as.numeric(mu*(1 - (1 - sqrt(1/disp_param))))
lambda <- (1 - sqrt(1/disp_param))
result <- RMKdiscrete::rLGP(n = 1,theta = theta,lambda = lambda)

# check annual sums are consistent
df_check <- data.frame("result" = result,
                       "salmonid_year" = new_data$salmonid_year,
                       "ssmolt" = new_data$ssmolt)
tapply(df_check$result,INDEX = df_check$salmonid_year,FUN = sum)
tapply(df_check$ssmolt,INDEX = df_check$salmonid_year,FUN = sum)
#par(mfrow = c(1,1))
plot(tapply(df_check$result,INDEX = df_check$salmonid_year,FUN = sum),
     tapply(df_check$ssmolt,INDEX = df_check$salmonid_year,FUN = sum))

#######
# # or if single param poisson zeroinf
# #or if single pram
# zi_prob <- predict(object, newdata=new_data, type="zprob", allow.new.levels=TRUE, na.action = na.pass,re.form = NA)
# 
# cond <- rpois(n = nrow(new_data),
#               lambda = cond_mean)
# 
# result <- ifelse(stats::runif(nrow(new_data))< zi_prob, 0, cond)
# 
#######

#  mTrain_genpois_op_sims_sqr <- simulate(mop,nsim = 1)
# # # plot simulations 
#  c = 0
#  i = 1
#       par(mfrow = c(3,1), mar = c(4,4,1,1))
#  plot((1+c):(365+c),mTrain_genpois_op_sims_sqr$sim_1[(1+c):(365+c)], type = "s", col = NULL, ylim = c(0,500), main = paste0(i, "glmmtmb"))
#  lines((1+c):(365+c),mTrain_genpois_op_sims_sqr$sim_1[(1+c):(365+c)], type = "h", col = "blue")
#  plot((1+c):(365+c),result[(1+c):(365+c)], type = "h", col = "green3", main = "manual",ylim = c(0,500))
#  plot((1+c):(365+c),Train_data_scaled_centred_op$ssmolt[(1+c):(365+c)], type = "h", col = "red", main = "ssmolt",ylim = c(0,500))
# 
#      for(i in 1:length(unique(df_check$salmonid_year))-1){
#      par(mfrow = c(3,1), mar = c(4,4,1,1))
#  c = 365*i
# plot((1+c):(365+c),mTrain_genpois_op_sims_sqr$sim_1[(1+c):(365+c)], type = "s", col = NULL, ylim = c(0,500), main = paste0(i+1, "glmmtmb"))
# lines((1+c):(365+c),mTrain_genpois_op_sims_sqr$sim_1[(1+c):(365+c)], type = "h", col = "blue")
# plot((1+c):(365+c),result[(1+c):(365+c)], type = "h", col = "green3", main = "manual",ylim = c(0,500))
# plot((1+c):(365+c),Train_data_scaled_centred_op$ssmolt[(1+c):(365+c)], type = "h", col = "red", main = "ssmolt",ylim = c(0,500))
# }
              
# -------------------------------------------------------------------------------------------------- #
# EXPORT MOST RECENT MODEL TO RData OBJECT ----
# -------------------------------------------------------------------------------------------------- #

dirName <- paste0(system.file("extdata", package = "fishcastr"), "/vignette_data/")
saveRDS(mop, file = paste0(dirName,"mTrain_genpois_salmon_2019.rds"))

# -------------------------------------------------------------------------------------------------- #
# EXPORT MOST RECENT SCALING FACTORS TO RData OBJECT -----
# -------------------------------------------------------------------------------------------------- #
dirName <- paste0(system.file("extdata", package = "fishcastr"), "/vignette_data/")
saveRDS(pP_params_op, file = paste0(dirName,"pP_params_salmon_2019.rds"))

rm(list = ls(all.names = TRUE))
invisible(gc())

```

```{r model_salmon_counts_2019_fit_operational-salmon-1, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/count_model_checks/salmon/op_model/")
knitr::include_graphics(path = paste0(dirName,"FigS5a.png"))
```

```{r model_salmon_counts_2019_fit_operational-salmon-2, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/count_model_checks/salmon/op_model/")
knitr::include_graphics(path = paste0(dirName,"FigS5b.png"))
```

```{r model_salmon_counts_2019_fit_operational-salmon-3, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/count_model_checks/salmon/op_model/")
knitr::include_graphics(path = paste0(dirName,"FigS5c.png"))
```

```{r model_salmon_counts_2019_fit_operational-salmon-4, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/count_model_checks/salmon/op_model/")
knitr::include_graphics(path = paste0(dirName,"FigS5d.png"))
```

```{r model_salmon_counts_2019_fit_operational-salmon-5, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/count_model_checks/salmon/op_model/")
knitr::include_graphics(path = paste0(dirName,"FigS5e.png"))
```

```{r model_salmon_counts_2019_fit_operational-salmon-6, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/count_model_checks/salmon/op_model/")
knitr::include_graphics(path = paste0(dirName,"FigS5f.png"))
```

```{r model_salmon_counts_2019_fit_operational-salmon-7, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/count_model_checks/salmon/op_model/")
knitr::include_graphics(path = paste0(dirName,"FigS5g.png"))
```

```{r model_salmon_counts_2019_fit_operational-salmon-8, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/count_model_checks/salmon/op_model/")
knitr::include_graphics(path = paste0(dirName,"FigS5h.png"))
```

# (3) EVALUATE FORECAST PERFORMANCE

## (3a) Generate migration forecast ensmbles

### Known conditions (ECMWF's ERA5)

The following code produces a 25 member ensemble of plausible Atlantic salmon smolt daily counts under known conditions. We consider the model chain forcing data a "synthetic ensemble" of bias corrected ECMWF ERA5 data, whereby each member for a given forecast year is identical, but different years contained different data. Owing to the simulation based approach, ensemble fish counts are produced stochastically and are effectively random draws from the (generalised Poisson) conditional distribution; thus each member of the output fish count ensemble is unique.

```{r figure_5a_salmon_methods, warning = FALSE, echo = FALSE,  fig.height=7, fig.width=7, eval = FALSE}

# load physio response model
mod_physio_expmG <- fishcastr::model_physio_expmG_salmon

# load and subset list into model and scaling lists for relevant years only 1993 - 2019
model_list_1of2 <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_data/mTrain_genpois_salmon_list_1of2.rds"))
model_list_2of2 <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_data/mTrain_genpois_salmon_list_2of2.rds"))

mTrain_genpois_list <- list()
mTrain_genpois_list[1:length(model_list_1of2)] <- model_list_1of2
mTrain_genpois_list[(1 + length(model_list_1of2)):(length(model_list_1of2)+length(model_list_2of2))] <- model_list_2of2

 # add 2019 data
 mTrain_genpois_salmon_2019 <- model_list_1of2 <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                    "/vignette_data/mTrain_genpois_salmon_2019.rds"))
 pP_params_salmon_2019 <- model_list_1of2 <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                    "/vignette_data/pP_params_salmon_2019.rds"))
 
 mTrain_genpois_list[[39]] <- list(mTrain_genpois_salmon_2019,
                                 pP_params_salmon_2019)

names(mTrain_genpois_list) <- 1981:2019

# subset to 2015 - 2019 models for testing function
mTrain_genpois_list_sub <- mTrain_genpois_list[which(names(mTrain_genpois_list) %in% c(1981:2019))]

# model list
mTrain_genpois_list_sub_mod <- sapply(mTrain_genpois_list_sub, "[", 1)
# scaling param list
mTrain_genpois_list_sub_scPara <- sapply(mTrain_genpois_list_sub, "[", 2)

# --------------------------------------------------------------------------------------------------

# --------------------------------------------------------------------------------------------------
# GENERATE LIST OF DF THAT CONTAIN COMBINED LEAD IN REANALYSIS AND SEASONAL FORECASTS FOR EACH INDIVIDUAL MEMBER
# AND SEASONAL FORECASTS DAILY GLMM SIMULATED PREDICTIONS ------------------------------------------

#install.packages("formatR")
#library(formatR)
#formatR::tidy_source()
#obj <- tidy_source("C:\\Users\\afrench.INSTITUTE\\OneDrive - Marine Institute\\fishcastr_dev\\fishcastr\\R\\compile_seasonal_forecast_list_glmm.R", reindent.space=5)

# reanalysis data subset to 2019 for (antecedent in conditions must run to end of Jan 2019)
data_ERA5_1979_2019_Jan_bc <- fishcastr::convert_grid_to_dataframe(grid_obj = fishcastr::grid_ERA5_1979_2019_Jan_bc)[,-2]
names(data_ERA5_1979_2019_Jan_bc)[which(names(data_ERA5_1979_2019_Jan_bc) == "dates1")] <- "date"

# # reanalysis data subset to 2019
# path_to_reanalysis = paste0(getwd(),"/inst\\extdata\\ERA5_bcc_op\\meteo_file.dat")
#   reanalysis_loc <- path_to_reanalysis
#   reanalysis_data <- read.table(reanalysis_loc, sep = '\t',header = FALSE, colClasses=c("V1"="Date"))
# # subset
#   reanalysis_data_sub <- subset(reanalysis_data, V1 <= as.Date("2019-08-31"))
#   # save
# dir.data <-  paste0(getwd(),'/vignettes/vignette_data/ERA5_bcc_ideal_salmon')
# dirName <- paste0(dir.data, "/", sep = "", collapse = NULL)
# dir.create(dirName, showWarnings = TRUE, recursive = TRUE, mode = "0777")
# write.table(reanalysis_data_sub, paste0(dirName,"meteo_file.dat", sep = "", collapse = NULL), sep = "\t", row.names = FALSE, col.names = FALSE, quote = FALSE)

data_ssmolt_enviro_1981_2019 <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_data/data_ssmolt_enviro_1981_2019.rds"))

# subset the seasonal forecast grid to test using 5 years of data for example check
#seas_subset <- lapply(fishcastr::grid_SEAS5_1993_2019_2_3_4_5_6_7_8_tas_pr_petH_bc,
#                      function(x){transformeR::subsetGrid(x,years = 2017:2019)})

seas_subset <- lapply(fishcastr::grid_ERA5_1981_2019_2_3_4_5_6_7_8_tas_pr_petH_bc,
                      function(x){transformeR::subsetGrid(x,years = 1981:2019)})

# GENERATE FORECAST DATA
system.time({seasonal_forecast_list_dfs_ssmolt_daily_stoc <-
  fishcastr::compile_seasonal_forecast_list_glmm(
    calibrated_physio_model = mod_physio_expmG,
    calibrated_daily_model = mTrain_genpois_list_sub_mod,
    predictor_scaling_params = mTrain_genpois_list_sub_scPara,
    hydro_GR4J_model_params = fishcastr::GR4J_Burr_params_ERA5_bcc,
    air_to_water_model_params = fishcastr::air_to_water_Feeagh_params_ERA5_bcc,
    seasonal_forecast_grid = seas_subset,
    reanalysis_data = data_ERA5_1979_2019_Jan_bc,
    counts_and_antecedent_conditions = data_ssmolt_enviro_1981_2019,
    species_bio_year_name = "salmonid_year",
    species_bio_yday_name = "salmonid_yday",
    fish_reaction_time = 20,
    initialisation_month = 2,
    no_forecast_months = 6,
    forecast_method = "stochastic",
    parallel = TRUE,
    parallel_seed_no = 23456,
    operational_year = 2019
  )})
#174.14/60 # 3 mins for 3 years
 2003.06/60 # 33 mins for 39 years

saveRDS(seasonal_forecast_list_dfs_ssmolt_daily_stoc,
        paste0(system.file("extdata",
                           package = "fishcastr"),
               "/vignette_data/SF_salmon_ideal_loo_cv_23456.rds"))

#saveRDS(seasonal_forecast_list_dfs_ssmolt_daily_stoc,
#        paste0(getwd(),"/vignettes",
#               "/vignette_data/SF_salmon_ideal_loo_cv.rds"))

  rm(list = ls(all.names = TRUE))
invisible(gc())
```

```{r figure_5a_salmon_plots, warning = FALSE, echo = FALSE,  fig.height=7, fig.width=7, eval = FALSE}

# load predictions in list format
seasonal_forecast_list_dfs_ssmolt_daily_stoc <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_data/SF_salmon_ideal_loo_cv_23456.rds"))

#seasonal_forecast_list_dfs_ssmolt_daily_stoc <- readRDS(file = paste0(getwd(),"/vignettes/vignette_data\\SF_salmon_ideal_loo_cv.rds"))

summary_stats = c("mean","50th","5th", "25th","33rd", "66th", "75th", "95th")
pred_or_sim = "forecast_sim_counts"
#pred_or_sim = "forecast_sim_mean"

dirName <- paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_figures/Fig5a/")

dir.create(dirName, showWarnings = TRUE, mode = "0777")

sum_stats_list <- lapply(summary_stats, FUN = function(stat){

# --------------------------------------------------------------------------------------------------#
# EXTRACT TERCILE CLASSES FOR OBS DATA ----
# --------------------------------------------------------------------------------------------------#
seas_fore_df_ssmolt_daily_full_obs <- do.call(rbind,lapply(X = seasonal_forecast_list_dfs_ssmolt_daily_stoc,
                                                  FUN = function(x){x[[1]]}))

seas_fore_df_ssmolt_daily <- seas_fore_df_ssmolt_daily_full_obs[seas_fore_df_ssmolt_daily_full_obs$salmonid_year <= 2019,]

# add observed 2019 smolts to df
#fishcastr::download_fish_data()
data_ssmolt <- fishcastr::import_fish_data(species = "ssmolt")

NA_dates_2019 <- seas_fore_df_ssmolt_daily$date[which(is.na(seas_fore_df_ssmolt_daily$ssmolt))]
data_ssmolt$ssmolt[data_ssmolt$date %in% NA_dates_2019]
seas_fore_df_ssmolt_daily$ssmolt[seas_fore_df_ssmolt_daily$date %in% NA_dates_2019] <- data_ssmolt$ssmolt[data_ssmolt$date %in% NA_dates_2019]

seas_fore_df_ssmolt_daily_tercile_data <-
  fishcastr::boxplot_phenology(
    bio_year = seas_fore_df_ssmolt_daily$salmonid_year,
    counts = seas_fore_df_ssmolt_daily$ssmolt,
    yday = seas_fore_df_ssmolt_daily$salmonid_yday,
    dates = seas_fore_df_ssmolt_daily$date,
    method = stat,
    species_name = "Atlantic salmon (smolt)",
    season = "Spring",
    summary_stat_calculation_months = c(3:7),
    plot = FALSE,
    detrended = FALSE
  )

obs <- seas_fore_df_ssmolt_daily_tercile_data

# ------------------------------------------------------------------------------------------------------------- #
# EXTRACT TERCILE CLASSES FOR FORECAST DATA ----
# ------------------------------------------------------------------------------------------------------------- #
seas_list <- plyr::llply(.data = 1:25,.fun = function(y){
  #y = 1
  seas_fore_df_ssmolt_daily_full <- do.call(rbind,lapply(X = seasonal_forecast_list_dfs_ssmolt_daily_stoc,
                                                         FUN = function(x){x[[y]]}))
  seas_fore_df_ssmolt_daily <- seas_fore_df_ssmolt_daily_full[seas_fore_df_ssmolt_daily_full$salmonid_year <= 2019,]
 # any(is.na(seas_fore_df_ssmolt_daily[[pred_or_sim]]))
  
  # 3. use existing function to calculate quantile trends in observed data
  seas_fore_df_ssmolt_daily_tercile_data_new <-
    fishcastr::boxplot_phenology(
      bio_year = seas_fore_df_ssmolt_daily$salmonid_year,
      counts = seas_fore_df_ssmolt_daily[[pred_or_sim]],
      yday = seas_fore_df_ssmolt_daily$salmonid_yday,
      dates = seas_fore_df_ssmolt_daily$date,
      method = stat,
      species_name = "Atlantic salmon (smolt)",
      season = "Spring",
      summary_stat_calculation_months = c(3:7),
      plot = FALSE,
      detrended = FALSE
    )
  
 reforecasts <- seas_fore_df_ssmolt_daily_tercile_data_new$summary_stats
 return(list(reforecasts_list = reforecasts,
             mean_terciles = seas_fore_df_ssmolt_daily_tercile_data_new$mean_terciles))
})
 #
 names(seas_list) <- 1:25
 
 all_sum_stats_seas_list <- lapply(X = seas_list,FUN = function(x){
    result <- cbind(x[["reforecasts_list"]][["year"]],
                    x[["reforecasts_list"]][[stat]])
return(result)
 })
 
 # bind summ stats together
 all_sum_stats_seas_list.bind <- do.call(cbind,all_sum_stats_seas_list)
 # subset columns to just one year column and 25 members
 all_sum_stats_seas_list.bind.sub <- as.data.frame(cbind(all_sum_stats_seas_list.bind[,1],
                                           all_sum_stats_seas_list.bind[,seq(from = 2, to = ncol(all_sum_stats_seas_list.bind), by = 2)]))
 colnames(all_sum_stats_seas_list.bind.sub) <- c("year",paste0("member_",1:25))

  # compute terciles using all member and year summary stats
 all_member_sum_stats <- c(as.matrix(all_sum_stats_seas_list.bind.sub[,-1]))
#tercile_bnds <- quantile(all_member_sum_stats,probs = c(1/3,2/3))
tercile_bnds <- as.numeric(Hmisc::cut2(all_member_sum_stats,
                                       g=3,
                                       onlycuts = TRUE))[2:3]
 
# assign each member a tercile anomaly
tercile_anoms_sf_ensemble <- cbind(ifelse(all_sum_stats_seas_list.bind.sub[,-1] < tercile_bnds[1],"early",
                              ifelse(all_sum_stats_seas_list.bind.sub[,-1] >= tercile_bnds[2],"late","average")))

rownames(tercile_anoms_sf_ensemble) <- all_sum_stats_seas_list.bind.sub[,1]
colnames(tercile_anoms_sf_ensemble) <- 1:25

# ------------------------------------------------------------------------------------------------------------- #
# TERCILE PLOT ----
# ------------------------------------------------------------------------------------------------------------- #
# dirName <- paste0(getwd(),"/vignettes/vignette_figures", "/Fig5a", "/salmon/", sep = "",
#                  collapse = NULL)
#dir.create(dirName, showWarnings = FALSE, mode = "0777")

dirName <- paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_figures/Fig5a/salmon/")
dir.create(dirName, showWarnings = FALSE, mode = "0777")

 # plot tercile plot -----
# install latest transformeR
#devtools::install_github("SantanderMetGroup/transformeR@v2.0.1") # was 2.0.1
#devtools::install_github("SantanderMetGroup/downscaleR@v3.3.1") # was 3.3.1

type_of_pred <- ifelse(pred_or_sim == "forecast_sim_counts","sim","pred")

  png(file = paste0(dirName,"Fig5a_ERA5_salmon_",type_of_pred,"_",stat,".png"), width=2100, height=2200, res=300)
terciles_summary_stat_plot <-
  fishcastr::tercile_plot_summary_stats(
    seasonal_forecast_predictions = tercile_anoms_sf_ensemble,
    observed_anomalies = obs,
    species_name = "Atlantic salmon (smolt)",
    season = "spring",
    method = stat,
    plot = TRUE
  )
  invisible(dev.off())
  
  return(list("individual_members"= seas_list,
              "combined_members_data" = list("all_member_sum_stat_data" = all_sum_stats_seas_list.bind.sub,
                                             "all_member_sum_stat_data_minus_op_year" = all_member_sum_stats,
                                             "tercile_bnds"= tercile_bnds,
                                             "tercile_anoms_sf_ensemble" = tercile_anoms_sf_ensemble),
              "obs" = obs,
              "terciles_summary_stat_plot" = terciles_summary_stat_plot,
              "seas_fore_df_ssmolt_daily_full_obs" = seas_fore_df_ssmolt_daily_full_obs,
              "tercile_anoms_sf_ensemble" = tercile_anoms_sf_ensemble))
  
})
    names(sum_stats_list) <- summary_stats

# --------------------------------------------------------------------------------------------------#
# EXPORT ALL TERCILE DATA AS RDS
# --------------------------------------------------------------------------------------------------#
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_figures/Fig5a/salmon/")

sum_stats_list_subset <- lapply(sum_stats_list,function(x){
  res <- x[-c(which(names(x) == "seas_fore_df_ssmolt_daily_full_obs"))]
  return(res)
})

saveRDS(object = sum_stats_list_subset,
        file = paste0(dirName,"Fig5a_ERA5_salmon_tercile_data.rds"))
    
# --------------------------------------------------------------------------------------------------#
# COMPILE WINDOWS OF OPPORTUNITY SUMMARY TABLE ----
# --------------------------------------------------------------------------------------------------#
windows_op_table_data <- sapply(sapply(sum_stats_list, "[", 4),"[",2)

df <- plyr::ldply(windows_op_table_data, data.frame)

windows_op_table <- t(data.frame("statistic" = sapply(strsplit(df$.id, "\\."),"[",1),
  "early" = paste0(df$early_ROC.score,ifelse(df$early_ROC.significant_0_05 ==TRUE,"*","")),
                  "average" = paste0(df$average_ROC.score,ifelse(df$average_ROC.significant_0_05 ==TRUE,"*","")),
                  "late" = paste0(df$late_ROC.score,ifelse(df$late_ROC.significant_0_05 ==TRUE,"*",""))))
# export table
dir.data <- paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_figures/Fig5a/salmon/")
dirName <- paste0(dir.data, "/", sep = "", collapse = NULL)
#dir.create(dirName, showWarnings = TRUE, recursive = TRUE, mode = "0777")
write.table(x = windows_op_table, file = paste0(dirName,"windows_op_ERA5_salmon.csv"), row.names = TRUE, sep = ",",col.names = FALSE)
  
# --------------------------------------------------------------------------------------------------#
# PLOT ALL SIMULATIONS (uncomment if required) ----
# --------------------------------------------------------------------------------------------------#
#    dirName <- paste0(getwd(),"/vignettes/vignette_figures", "/Fig5a", "/salmon/year_mem_plot/", sep = "",
#                   collapse = NULL)
# dir.create(dirName, showWarnings = FALSE, mode = "0777")
# 
# type_of_pred <- ifelse(pred_or_sim == "forecast_sim_counts","sim","pred")
# 
#   for(i in 1981:2019){
#  # plot ensemble predictions individually ----
#     png(file = paste0(dirName,'Fig5a_',type_of_pred,'_ideal',i,'.png'), width=8200, height=2500, res=300)
#     ensemble_forecast_data_sumstat <-
#       plot_ensemble_forecast_data_sumstat(
#         seasonal_forecast_predictions = sum_stats_list$mean$tercile_anoms_sf_ensemble,
#         observed_anomalies = sum_stats_list$mean$obs,
#         forecast_list_object = seasonal_forecast_list_dfs_ssmolt_daily_stoc,
#         bioyear_name = "salmonid_year",
#         bioyear_yday_name = "salmonid_yday",
#         count_name = "ssmolt",
#         forecast_data_name = pred_or_sim,
#         plot = TRUE,
#         plot_CIs = FALSE,
#         plot_op_year = i,
#         plot_op_year_obs = TRUE
#       )
#     invisible(dev.off())
#   }

# --------------------------------------------------------------------------------------------------#
# PLOT SIMULATED COUNTS FOR ALL YEARS IN RIDGE LINE PLOT STYLE ----
# --------------------------------------------------------------------------------------------------#

dirName_plots <- paste0(
     system.file("extdata", package = "fishcastr"),
     "/vignette_figures/count_model_checks/"
   )
dir.create(dirName_plots, showWarnings = TRUE, mode = "0777")
png(file = paste0(dirName_plots,"FigS6a_ridge_mean.png"), width=9000, height=13000, res=300)
salmon_anoms <- fishcastr::ridgeline_plot_phenology(bio_year = sum_stats_list$mean$seas_fore_df_ssmolt_daily_full_obs$salmonid_year,
                                         counts = sum_stats_list$mean$seas_fore_df_ssmolt_daily_full_obs[[pred_or_sim]],
                                         yday = sum_stats_list$mean$seas_fore_df_ssmolt_daily_full_obs$salmonid_yday,
                                         dates = sum_stats_list$mean$seas_fore_df_ssmolt_daily_full_obs$date,
                                         method = "mean",
                                         species_name = "Atlantic salmon (smolt)",
                                         season = "spring",
                                         plot = TRUE,
                                         detrended = FALSE,
                                         xlims_plot = c(0.020,0.950))
invisible(dev.off())

  rm(list = ls(all.names = TRUE))
invisible(gc())
```

```{r figure_5a_salmon_result_tab-salmon-1, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_figures/Fig5a/salmon/")
res_tab <- read.table(file = paste0(dirName,"windows_op_ERA5_salmon.csv"), sep = ",",
                      stringsAsFactors = FALSE)
colnames(res_tab) <- res_tab[1,]
res_tab <- res_tab[-1,]

tab <- knitr::kable(res_tab)
tab
```

```{r figure_5a_salmon_plots-salmon-1, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/Fig5a/salmon/")
knitr::include_graphics(path = paste0(dirName,"Fig5a_ERA5_salmon_sim_5th.png"))
```

```{r figure_5a_salmon_plots-salmon-2, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/Fig5a/salmon/")
knitr::include_graphics(path = paste0(dirName,"Fig5a_ERA5_salmon_sim_25th.png"))
```

```{r figure_5a_salmon_plots-salmon-3, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/Fig5a/salmon/")
knitr::include_graphics(path = paste0(dirName,"Fig5a_ERA5_salmon_sim_33rd.png"))
```

```{r figure_5a_salmon_plots-salmon-4, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/Fig5a/salmon/")
knitr::include_graphics(path = paste0(dirName,"Fig5a_ERA5_salmon_sim_50th.png"))
```

```{r figure_5a_salmon_plots-salmon-5, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/Fig5a/salmon/")
knitr::include_graphics(path = paste0(dirName,"Fig5a_ERA5_salmon_sim_66th.png"))
```

```{r figure_5a_salmon_plots-salmon-6, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/Fig5a/salmon/")
knitr::include_graphics(path = paste0(dirName,"Fig5a_ERA5_salmon_sim_75th.png"))
```

```{r figure_5a_salmon_plots-salmon-7, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/Fig5a/salmon/")
knitr::include_graphics(path = paste0(dirName,"Fig5a_ERA5_salmon_sim_95th.png"))
```

```{r figure_5a_salmon_plots-salmon-8, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/Fig5a/salmon/")
knitr::include_graphics(path = paste0(dirName,"Fig5a_ERA5_salmon_sim_mean.png"))
```

### Seasonal forecast (ECMWF's SEAS5)

The following code produces a 25 member ensemble of plausible Atlantic salmon smolt daily counts under seasonal forecast conditions. Here, the model chain forcing data is a true ensemble of bias corrected ECMWF SEAS5 data, whereby each member for a given forecast year is unique and different years contained different data. Likewise for the known condition ensemble scenario described above, ensemble fish counts are produced stochastically and are effectively random draws from the (generalised Poisson) conditional distribution. In the SEAS5 scenario, the uniqueness of members of the output fish count ensemble within years are therefore consequence of both the unique forcing data per member *and* the random draw element.

```{r figure_5b_salmon_methods, warning = FALSE, echo = FALSE,  fig.height=7, fig.width=7, eval = FALSE}

# load physio response model
mod_physio_expmG <- fishcastr::model_physio_expmG_salmon

# load and subset list into model and scaling lists for relevant years only 1993 - 2019
model_list_1of2 <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_data/mTrain_genpois_salmon_list_1of2.rds"))
model_list_2of2 <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_data/mTrain_genpois_salmon_list_2of2.rds"))

mTrain_genpois_list <- list()
mTrain_genpois_list[1:length(model_list_1of2)] <- model_list_1of2
mTrain_genpois_list[(1 + length(model_list_1of2)):(length(model_list_1of2)+length(model_list_2of2))] <- model_list_2of2

 # add 2019 data
 mTrain_genpois_salmon_2019 <- model_list_1of2 <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                    "/vignette_data/mTrain_genpois_salmon_2019.rds"))
 pP_params_salmon_2019 <- model_list_1of2 <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                    "/vignette_data/pP_params_salmon_2019.rds"))
 
 mTrain_genpois_list[[39]] <- list(mTrain_genpois_salmon_2019,
                                 pP_params_salmon_2019)

names(mTrain_genpois_list) <- 1981:2019

# subset to 1993 - 2019 models for testing function
mTrain_genpois_list_sub <- mTrain_genpois_list[which(names(mTrain_genpois_list) %in% c(1993:2019))]

# model list
mTrain_genpois_list_sub_mod <- sapply(mTrain_genpois_list_sub, "[", 1)
# scaling param list
mTrain_genpois_list_sub_scPara <- sapply(mTrain_genpois_list_sub, "[", 2)

# --------------------------------------------------------------------------------------------------

# --------------------------------------------------------------------------------------------------
# GENERATE LIST OF DF THAT CONTAIN COMBINED LEAD IN REANALYSIS AND SEASONAL FORECASTS FOR EACH INDIVIDUAL MEMBER
# AND SEASONAL FORECASTS DAILY GLMM SIMULATED PREDICTIONS ------------------------------------------

#install.packages("formatR")
#library(formatR)
#formatR::tidy_source()
#obj <- tidy_source("C:\\Users\\afrench.INSTITUTE\\OneDrive - Marine Institute\\fishcastr_dev\\fishcastr\\R\\compile_seasonal_forecast_list_glmm.R", reindent.space=5)

# reanalysis data subset to 2019 for (antecedent in conditions must run to end of Jan 2019)
data_ERA5_1979_2019_Jan_bc <- fishcastr::convert_grid_to_dataframe(grid_obj = fishcastr::grid_ERA5_1979_2019_Jan_bc)[,-2]
names(data_ERA5_1979_2019_Jan_bc)[which(names(data_ERA5_1979_2019_Jan_bc) == "dates1")] <- "date"

# # reanalysis data subset to 2019
# path_to_reanalysis = paste0(getwd(),"/inst\\extdata\\ERA5_bcc_op\\meteo_file.dat")
#   reanalysis_loc <- path_to_reanalysis
#   reanalysis_data <- read.table(reanalysis_loc, sep = '\t',header = FALSE, colClasses=c("V1"="Date"))
# # subset
#   reanalysis_data_sub <- subset(reanalysis_data, V1 <= as.Date("2019-08-31"))
#   # save
# dir.data <-  paste0(getwd(),'/vignettes/vignette_data/ERA5_bcc_ideal_salmon')
# dirName <- paste0(dir.data, "/", sep = "", collapse = NULL)
# dir.create(dirName, showWarnings = TRUE, recursive = TRUE, mode = "0777")
# write.table(reanalysis_data_sub, paste0(dirName,"meteo_file.dat", sep = "", collapse = NULL), sep = "\t", row.names = FALSE, col.names = FALSE, quote = FALSE)

data_ssmolt_enviro_1981_2019 <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_data/data_ssmolt_enviro_1981_2019.rds"))

data_ssmolt_enviro_1993_2019 <- data_ssmolt_enviro_1981_2019[data_ssmolt_enviro_1981_2019$salmonid_year %in% c(1993:2019),]

#View(data_ssmolt_enviro_1981_2019)

# subset the seasonal forecast grid to test using 5 years of data for example check
#seas_subset <- lapply(fishcastr::grid_SEAS5_1993_2019_2_3_4_5_6_7_8_tas_pr_petH_bc,
#                      function(x){transformeR::subsetGrid(x,years = 2017:2019)})

seas_subset <- lapply(fishcastr::grid_SEAS5_1993_2019_2_3_4_5_6_7_8_tas_pr_petH_bc,
                      function(x){transformeR::subsetGrid(x,years = 1993:2019)})

# GENERATE FORECAST DATA
system.time({seasonal_forecast_list_dfs_ssmolt_daily_stoc <-
  fishcastr::compile_seasonal_forecast_list_glmm(
    calibrated_physio_model = mod_physio_expmG,
    calibrated_daily_model = mTrain_genpois_list_sub_mod,
    predictor_scaling_params = mTrain_genpois_list_sub_scPara,
    hydro_GR4J_model_params = fishcastr::GR4J_Burr_params_ERA5_bcc,
    air_to_water_model_params = fishcastr::air_to_water_Feeagh_params_ERA5_bcc,
    seasonal_forecast_grid = seas_subset,
    reanalysis_data = data_ERA5_1979_2019_Jan_bc,
    counts_and_antecedent_conditions = data_ssmolt_enviro_1993_2019,
    species_bio_year_name = "salmonid_year",
    species_bio_yday_name = "salmonid_yday",
    fish_reaction_time = 20,
    initialisation_month = 2,
    no_forecast_months = 6,
    forecast_method = "stochastic",
    parallel = TRUE,
    parallel_seed_no = 23456,
    operational_year = 2019
  )})
#174.14/60 # 3 mins for 3 years
 #1307.40/60 # 22 mins for 27 years

saveRDS(seasonal_forecast_list_dfs_ssmolt_daily_stoc,
        paste0(system.file("extdata",
                           package = "fishcastr"),
               "/vignette_data/SF_salmon_loo_cv_23456.rds"))

#saveRDS(seasonal_forecast_list_dfs_ssmolt_daily_stoc,
#        paste0(getwd(),"/vignettes",
#               "/vignette_data/SF_salmon_loo_cv.rds"))

  rm(list = ls(all.names = TRUE))
invisible(gc())
```

```{r figure_5b_salmon_plots, warning = FALSE, echo = FALSE,  fig.height=7, fig.width=7, eval = FALSE}
library(fishcastr)

# load predictions in list format
seasonal_forecast_list_dfs_ssmolt_daily_stoc <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_data/SF_salmon_loo_cv_23456.rds"))

forecast_op_year <- 2019

#seasonal_forecast_list_dfs_ssmolt_daily_stoc_new

summary_stats = c("mean","50th","5th", "25th","33rd", "66th", "75th", "95th")
pred_or_sim = "forecast_sim_counts"
#pred_or_sim = "forecast_sim_mean"
#stat = "mean"
#devtools::install_github("SantanderMetGroup/transformeR@v2.0.1") # was 1.7.4
#devtools::install_github("SantanderMetGroup/downscaleR@v3.3.1") # was 3.1.3

dirName <- paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_figures/Fig5b/")

dir.create(dirName, showWarnings = TRUE, mode = "0777")

sum_stats_list <- lapply(summary_stats, FUN = function(stat){
# --------------------------------------------------------------------------------------------------#
# EXTRACT TERCILE CLASSES FOR OBS DATA ----
# --------------------------------------------------------------------------------------------------#
seas_fore_df_ssmolt_daily_full_obs <- do.call(rbind,lapply(X = seasonal_forecast_list_dfs_ssmolt_daily_stoc,
                                                  FUN = function(x){x[[1]]}))

seas_fore_df_ssmolt_daily <- seas_fore_df_ssmolt_daily_full_obs[seas_fore_df_ssmolt_daily_full_obs$salmonid_year <= 2019,]

# add observed 2019 smolts to df
data_ssmolt <- fishcastr::import_fish_data(species = "ssmolt")

NA_dates_2019 <- seas_fore_df_ssmolt_daily$date[which(is.na(seas_fore_df_ssmolt_daily$ssmolt))]
data_ssmolt$ssmolt[data_ssmolt$date %in% NA_dates_2019]
seas_fore_df_ssmolt_daily$ssmolt[seas_fore_df_ssmolt_daily$date %in% NA_dates_2019] <- data_ssmolt$ssmolt[data_ssmolt$date %in% NA_dates_2019]

#par(mfrow = c(1,1))
# 3. use existing function to calculate quantile trends in obs data
#dev.new()
seas_fore_df_ssmolt_daily_tercile_data <- fishcastr::boxplot_phenology(bio_year = seas_fore_df_ssmolt_daily$salmonid_year,
                                                            counts = seas_fore_df_ssmolt_daily$ssmolt,
                                                            yday = seas_fore_df_ssmolt_daily$salmonid_yday,
                                                            dates = seas_fore_df_ssmolt_daily$date,
                                                            method = stat,
                                                            species_name = "Atlantic salmon (smolt)",
                                                            season = "Spring",
                                                            plot = FALSE,
                                                            summary_stat_calculation_months = c(3:7),
                                                            detrended = FALSE)

obs <- seas_fore_df_ssmolt_daily_tercile_data

# ------------------------------------------------------------------------------------------------------------- #
# EXTRACT TERCILE CLASSES FOR FORECAST DATA ----
# ------------------------------------------------------------------------------------------------------------- #
 seas_list <- plyr::llply(.data = 1:25,.fun = function(y){
   #y = 1
   seas_fore_df_ssmolt_daily_full <- do.call(rbind,lapply(X = seasonal_forecast_list_dfs_ssmolt_daily_stoc,
                                                   FUN = function(x){x[[y]]}))
# which(is.na(seas_fore_df_ssmolt_daily_full$rain_mm_1day))
 seas_fore_df_ssmolt_daily <- seas_fore_df_ssmolt_daily_full[seas_fore_df_ssmolt_daily_full$salmonid_year <= 2019,]
#any(is.na(seas_fore_df_ssmolt_daily[[pred_or_sim]]))
 # 3. use existing function to calculate quantile trends in observed data
 seas_fore_df_ssmolt_daily_tercile_data_new <- fishcastr::boxplot_phenology(bio_year = seas_fore_df_ssmolt_daily$salmonid_year,
                                                            counts = seas_fore_df_ssmolt_daily[[pred_or_sim]],
                                                            yday = seas_fore_df_ssmolt_daily$salmonid_yday,
                                                            dates = seas_fore_df_ssmolt_daily$date,
                                                            method = stat,
                                                            species_name = "Atlantic salmon (smolt)",
                                                            season = "Spring",
                                                            plot = FALSE,
                                                            summary_stat_calculation_months = c(3:7),
                                                            detrended = FALSE)
 
 reforecasts <- seas_fore_df_ssmolt_daily_tercile_data_new$summary_stats
 return(list(reforecasts_list = reforecasts,
             mean_terciles = seas_fore_df_ssmolt_daily_tercile_data_new$mean_terciles))
 })
 #
 names(seas_list) <- 1:25
 
 all_sum_stats_seas_list <- lapply(X = seas_list,FUN = function(x){
    result <- cbind(x[["reforecasts_list"]][["year"]],
                    x[["reforecasts_list"]][[stat]])
return(result)
 })
 
 # bind summ stats together
 all_sum_stats_seas_list.bind <- do.call(cbind,all_sum_stats_seas_list)
 # subset columns to just one year column and 25 members
 all_sum_stats_seas_list.bind.sub <- as.data.frame(cbind(all_sum_stats_seas_list.bind[,1],
                                           all_sum_stats_seas_list.bind[,seq(from = 2, to = ncol(all_sum_stats_seas_list.bind), by = 2)]))
 colnames(all_sum_stats_seas_list.bind.sub) <- c("year",paste0("member_",1:25))

  # compute terciles using all member and year summary stats (removing op year
  # data before computing tercile boundaries) # note this differs from
  # calculation in visualizeR::tercilePlot in that tercile boundaries and
  # tercile classifications for visualizeR are computed for each member in turn
  # (using summary stats calculated for all years for that member), not using
  # all members of all years lumped together.
 
 #all_member_sum_stats_old <- c(as.matrix(all_sum_stats_seas_list.bind.sub[,-1]))
  #tercile_bnds <- quantile(all_member_sum_stats,probs = c(1/3,2/3))
 
  all_member_sum_stats <- c(as.matrix(all_sum_stats_seas_list.bind.sub[-which(all_sum_stats_seas_list.bind.sub[,"year"] == forecast_op_year),-1]))
  tercile_bnds <- as.numeric(Hmisc::cut2(all_member_sum_stats,
                                       g=3,
                                       onlycuts = TRUE))[2:3]
 
# assign each member a tercile anomaly
tercile_anoms_sf_ensemble <- cbind(ifelse(all_sum_stats_seas_list.bind.sub[,-1] < tercile_bnds[1],"early",
                              ifelse(all_sum_stats_seas_list.bind.sub[,-1] >= tercile_bnds[2],"late","average")))

rownames(tercile_anoms_sf_ensemble) <- all_sum_stats_seas_list.bind.sub[,1]
colnames(tercile_anoms_sf_ensemble) <- 1:25


# ------------------------------------------------------------------------------------------------------------- #
# TERCILE PLOT ----
# ------------------------------------------------------------------------------------------------------------- #
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_figures/Fig5b/salmon/")

dir.create(dirName, showWarnings = FALSE, mode = "0777")

type_of_pred <- ifelse(pred_or_sim == "forecast_sim_counts","sim","pred")

#seasonal_forecast_predictions = seas_list

 # plot tercile plot -----
  png(file = paste0(dirName,"Fig5b_SEAS5_salmon_",type_of_pred,"_",stat,".png"), width=2100, height=2200, res=300)
terciles_summary_stat_plot <-
  fishcastr::tercile_plot_summary_stats(
    seasonal_forecast_predictions = tercile_anoms_sf_ensemble,
    observed_anomalies = obs,
    species_name = "Atlantic salmon (smolt)",
    season = "spring",
    method = stat,
    plot = TRUE
  )
  invisible(dev.off())
  
  return(list("individual_members"= seas_list,
              "combined_members_data" = list("all_member_sum_stat_data" = all_sum_stats_seas_list.bind.sub,
                                             "all_member_sum_stat_data_minus_op_year" = all_member_sum_stats,
                                             "tercile_bnds"= tercile_bnds,
                                             "tercile_anoms_sf_ensemble" = tercile_anoms_sf_ensemble),
              "obs" = obs,
              "terciles_summary_stat_plot" = terciles_summary_stat_plot,
              "seas_fore_df_ssmolt_daily_full_obs" = seas_fore_df_ssmolt_daily_full_obs,
              "tercile_anoms_sf_ensemble" = tercile_anoms_sf_ensemble))
  
})
    names(sum_stats_list) <- summary_stats

# --------------------------------------------------------------------------------------------------#
# EXPORT ALL TERCILE DATA AS RDS
# --------------------------------------------------------------------------------------------------#
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_figures/Fig5b/salmon/")

sum_stats_list_subset <- lapply(sum_stats_list,function(x){
  res <- x[-c(which(names(x) == "seas_fore_df_ssmolt_daily_full_obs"))]
  return(res)
})

saveRDS(object = sum_stats_list_subset,
        file = paste0(dirName,"Fig5b_SEAS5_salmon_tercile_data.rds"))
    
# --------------------------------------------------------------------------------------------------#
# COMPILE WINDOWS OF OPPORTUNITY SUMMARY TABLE ----
# --------------------------------------------------------------------------------------------------#
windows_op_table_data <- sapply(sapply(sum_stats_list, "[", 4),"[",2)

df <- plyr::ldply(windows_op_table_data, data.frame)

windows_op_table <- t(data.frame("statistic" = sapply(strsplit(df$.id, "\\."),"[",1),
  "early" = paste0(df$early_ROC.score,ifelse(df$early_ROC.significant_0_05 ==TRUE,"*","")),
                  "average" = paste0(df$average_ROC.score,ifelse(df$average_ROC.significant_0_05 ==TRUE,"*","")),
                  "late" = paste0(df$late_ROC.score,ifelse(df$late_ROC.significant_0_05 ==TRUE,"*",""))))
# export table

# export table
dir.data <- paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_figures/Fig5b/salmon/")
dirName <- paste0(dir.data, "/", sep = "", collapse = NULL)
write.table(x = windows_op_table, file = paste0(dirName,"windows_op_SEAS5_salmon.csv"), row.names = TRUE, sep = ",",col.names = FALSE)
  
# --------------------------------------------------------------------------------------------------#
# PLOT ALL SIMULATIONS (uncomment if required) ----
# --------------------------------------------------------------------------------------------------#
# dirName <- paste0(getwd(),"/vignettes/vignette_figures", "/Fig6", "/salmon/year_mem_plot/", sep = "",
#                   collapse = NULL)
# dir.create(dirName, showWarnings = FALSE, mode = "0777")
# 
# type_of_pred <- ifelse(pred_or_sim == "forecast_sim_counts","sim","pred")
# 
#   for(i in 1993:2019){
#  # plot ensemble predictions individually ----
#     png(file = paste0(dirName,'Fig6a_',type_of_pred,'_SF',i,'.png'), width=8200, height=2500, res=300)
#     ensemble_forecast_data_sumstat <-
#       plot_ensemble_forecast_data_sumstat(
#         seasonal_forecast_predictions = sum_stats_list$mean$tercile_anoms_sf_ensemble,
#         observed_anomalies = sum_stats_list$mean$obs,
#         forecast_list_object = seasonal_forecast_list_dfs_ssmolt_daily_stoc,
#         bioyear_name = "salmonid_year",
#         bioyear_yday_name = "salmonid_yday",
#         count_name = "ssmolt",
#         forecast_data_name = pred_or_sim,
#         plot = TRUE,
#         plot_CIs = FALSE,
#         plot_op_year = i,
#         plot_op_year_obs = TRUE
#       )
#     invisible(dev.off())
#   }

# --------------------------------------------------------------------------------------------------#
# PLOT ANOMALY HISTORICAL CONTEXT (experimental) ----
# --------------------------------------------------------------------------------------------------#
# seas_fore_df_ssmolt_daily <- sum_stats_list$mean$seas_fore_df_ssmolt_daily_full_obs[sum_stats_list$mean$seas_fore_df_ssmolt_daily_full_obs$salmonid_year <= 2019,]
# 
#  dirName <- paste0(getwd(),"/vignettes/vignette_figures", "/Fig7", "/", sep = "",
#                   collapse = NULL)
#  dir.create(dirName, showWarnings = FALSE, mode = "0777")
# 
#   png(file = paste0(dirName,"Fig7a.png"), width=8200, height=2500, res=300)
#  plot_hist_context_op_forecast_sumstat_poly(seasonal_reforecasts_df = seas_fore_df_ssmolt_daily,
#                                             seasonal_reforecast_summary = sum_stats_list$mean$terciles_summary_stat_plot$tercile_data,
#                                             biological_year_name = "salmonid_year",
#                                             biological_yday_name = "salmonid_yday",
#                                             count_name = "ssmolt",
#                                             style = "poly")
#  invisible(dev.off())

rm(list = ls(all.names = TRUE))
invisible(gc())
```

```{r figure_5b_salmon_result_tab-salmon-1, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_figures/Fig5b/salmon/")
res_tab <- read.table(file = paste0(dirName,"windows_op_SEAS5_salmon.csv"), sep = ",",
                      stringsAsFactors = FALSE)
colnames(res_tab) <- res_tab[1,]
res_tab <- res_tab[-1,]

tab <- knitr::kable(res_tab)
tab
```

```{r figure_5b_salmon_plots-salmon-1, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/Fig5b/salmon/")
knitr::include_graphics(path = paste0(dirName,"Fig5b_SEAS5_salmon_sim_5th.png"))
```

```{r figure_5b_salmon_plots-salmon-2, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/Fig5b/salmon/")
knitr::include_graphics(path = paste0(dirName,"Fig5b_SEAS5_salmon_sim_25th.png"))
```

```{r figure_5b_salmon_plots-salmon-3, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/Fig5b/salmon/")
knitr::include_graphics(path = paste0(dirName,"Fig5b_SEAS5_salmon_sim_33rd.png"))
```

```{r figure_5b_salmon_plots-salmon-4, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/Fig5b/salmon/")
knitr::include_graphics(path = paste0(dirName,"Fig5b_SEAS5_salmon_sim_50th.png"))
```

```{r figure_5b_salmon_plots-salmon-5, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/Fig5b/salmon/")
knitr::include_graphics(path = paste0(dirName,"Fig5b_SEAS5_salmon_sim_66th.png"))
```

```{r figure_5b_salmon_plots-salmon-6, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/Fig5b/salmon/")
knitr::include_graphics(path = paste0(dirName,"Fig5b_SEAS5_salmon_sim_75th.png"))
```

```{r figure_5b_salmon_plots-salmon-7, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/Fig5b/salmon/")
knitr::include_graphics(path = paste0(dirName,"Fig5b_SEAS5_salmon_sim_95th.png"))
```

```{r figure_5b_salmon_plots-salmon-8, out.width="100%", eval=TRUE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/Fig5b/salmon/")
knitr::include_graphics(path = paste0(dirName,"Fig5b_SEAS5_salmon_sim_mean.png"))
```
