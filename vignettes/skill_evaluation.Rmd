---
title: "Seasonal forecast skill evaluation for the timing of seaward migration of Atlantic salmon smolt, anadromous brown trout and European eel"
subtitle: 
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{Seasonal forecast skill evaluation for the timing of seaward migration of Atlantic salmon smolt, anadromous brown trout and European ee}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r table_1_figure_4_Results, warning = FALSE, echo = FALSE, eval = FALSE}
# -------------------------------------------------------------------------------- #
# TABLE 1 Read skill data summaries ----
# -------------------------------------------------------------------------------- #
# ideal scenario ----
# Salmon
dirName <- paste0(getwd(),'/vignettes/vignette_figures/Fig5a/salmon')
salmon_ideal <- read.csv(file = paste0(dirName,"/windows_op_salmon_ideal.csv"),header = TRUE)
salmon_ideal$Species <- "S. salar"
salmon_ideal$Forcing <- "ERA5"
colnames(salmon_ideal) <- gsub("^X", "",  colnames(salmon_ideal))
salmon_ideal_no_stars <- as.data.frame(gsub(pattern = "\\*","",as.matrix(salmon_ideal)))

# Trout
dirName <- paste0(getwd(),'/vignettes/vignette_figures/Fig5a/trout')
trout_ideal <- read.csv(file = paste0(dirName,"/windows_op_trout_ideal.csv"),header = TRUE)
trout_ideal$Species <- "S. trutta"
trout_ideal$Forcing <- "ERA5"
colnames(trout_ideal) <- gsub("^X", "",  colnames(trout_ideal))
trout_ideal_no_stars <- as.data.frame(gsub(pattern = "\\*","",as.matrix(trout_ideal)))

# Eel
dirName <- paste0(getwd(),'/vignettes/vignette_figures/Fig5a/eel')
eel_ideal <- read.csv(file = paste0(dirName,"/windows_op_eel_ideal.csv"),header = TRUE)
eel_ideal$Species <- "A. anguilla"
eel_ideal$Forcing <- "ERA5"
colnames(eel_ideal) <- gsub("^X", "",  colnames(eel_ideal))
eel_ideal_no_stars <- as.data.frame(gsub(pattern = "\\*","",as.matrix(eel_ideal)))

# -------------------------------------------------------------------------------- #
# operational scenario
# Salmon
dirName <- paste0(getwd(),'/vignettes/vignette_figures/Fig5b/salmon')
salmon_op <- read.csv(file = paste0(dirName,"/windows_op_salmon.csv"),header = TRUE)
salmon_op$Species <- "S. salar"
salmon_op$Forcing <- "SEAS5"
colnames(salmon_op) <- gsub("^X", "",  colnames(salmon_op))
salmon_op_no_stars <- as.data.frame(gsub(pattern = "\\*","",as.matrix(salmon_op)))

# Trout
dirName <- paste0(getwd(),'/vignettes/vignette_figures/Fig5b/trout')
trout_op <- read.csv(file = paste0(dirName,"/windows_op_trout.csv"),header = TRUE)
trout_op$Species <- "S. trutta"
trout_op$Forcing <- "SEAS5"
colnames(trout_op) <- gsub("^X", "",  colnames(trout_op))
trout_op_no_stars <- as.data.frame(gsub(pattern = "\\*","",as.matrix(trout_op)))

# Eel
dirName <- paste0(getwd(),'/vignettes/vignette_figures/Fig5b/eel')
eel_op <- read.csv(file = paste0(dirName,"/windows_op_eel.csv"),header = TRUE)
eel_op$Species <- "A. anguilla"
eel_op$Forcing <- "SEAS5"
colnames(eel_op) <- gsub("^X", "",  colnames(eel_op))
eel_op_no_stars <- as.data.frame(gsub(pattern = "\\*","",as.matrix(eel_op)))

# -------------------------------------------------------------------------------- #
# merge all tables (no stars)
merged_ideal <- Reduce(function(x, y) rbind(x, y),
                    list(salmon_ideal_no_stars,
                         salmon_op_no_stars,
                         trout_ideal_no_stars,
                         trout_op_no_stars,
                         eel_ideal_no_stars,
                         eel_op_no_stars))

# -------------------------------------------------------------------------------- #
# merge all tables (stars)
list_tabs <- list(salmon_ideal,
                         salmon_op,
                         trout_ideal,
                         trout_op,
                         eel_ideal,
                         eel_op)
list_tabs.char <- lapply(X = list_tabs,FUN = function(x){
                           x[] <- as.data.frame(lapply(x, as.character))
colnames(x) <- gsub("^X", "",  colnames(x))
return(x)
  })
merged_ideal_stars <- Reduce(function(x, y) rbind(x, y),
                    list_tabs.char)

# -------------------------------------------------------------------------------- #
# reorder columns
tab_nostars <- merged_ideal[,c("Species","Forcing","statistic","mean","5th","25th","33rd","50th","66th","75th","95th")]
tab_nostars[,4:11] <- lapply(tab_nostars[,4:11], function(x){
  res = as.numeric(as.character(x))
  return(res)})
names(tab_nostars)[which(names(tab_nostars) == "statistic")] <- "Anomaly"

tab_stars <- merged_ideal_stars[,c("Species","Forcing","statistic","mean","5th","25th","33rd","50th","66th","75th","95th")]
names(tab_stars)[which(names(tab_stars) == "statistic")] <- "Anomaly"


# -------------------------------------------------------------------------------- #
# write to csv (no stars)
dir.data <-  paste0(getwd(),'/vignettes/vignette_tables/')
dirName <- paste0(dir.data, "/", sep = "", collapse = NULL)
dir.create(dirName, showWarnings = TRUE, recursive = TRUE, mode = "0777")
dir.data <-  paste0(getwd(),'/vignettes/vignette_tables/Tab1/')
dirName <- paste0(dir.data, "/", sep = "", collapse = NULL)
dir.create(dirName, showWarnings = TRUE, recursive = TRUE, mode = "0777")
write.table(x = tab_nostars, file = paste0(dirName,"Tab1_nostars.csv"), row.names = FALSE, sep = ",",col.names = TRUE)

# write to csv (stars)
dir.data <-  paste0(getwd(),'/vignettes/vignette_tables/Tab1/')
dirName <- paste0(dir.data, "/", sep = "", collapse = NULL)
write.table(x = tab_stars, file = paste0(dirName,"Tab1_stars.csv"), row.names = FALSE, sep = ",",col.names = TRUE)
# -------------------------------------------------------------------------------- #

# -------------------------------------------------------------------------------- #
# FIGURE 4 plot skill vs percentile
# -------------------------------------------------------------------------------- #
# salmon ideal
dir.data <-  paste0(getwd(),'/vignettes/vignette_figures/Fig4')
dirName <- paste0(dir.data, "/", sep = "", collapse = NULL)
dir.create(dirName, showWarnings = TRUE, recursive = TRUE, mode = "0777")

png(file = paste0(dirName,"Fig4.png"), width=1200, height=2000, res=300)
par(mfrow = c(3,2), oma = c(3,4,1,1), mar = c(4,4,1,1), mgp = c(2,0.5,0))
par(mar = c(1,1,0,0))
t.tab <- as.data.frame(as.matrix(t(tab_nostars[1:3,5:11])))
colnames(t.tab) <- tab_nostars[1:3,3]
t.tab$percent <- c(5,25,33,50,66,75,95)
plot(t.tab$percent,t.tab$early, type = "b", col = "blue", ylim = c(-1,1), ylab = "ROCSS",xlab = "", axes = FALSE, xpd = NA)
box(which = "plot",lty = "solid")
axis(side = 2,at = seq(from = -1, to = 1, by = 0.2),labels = seq(from = -1, to = 1, by = 0.2),tck = 0.03)
axis(side = 1,at = c(0,5,25,33,50,66,75,95,100),labels = NA,tck = 0.03)
title(main = expression(italic("S. salar") * ", ERA5"),line = -1,adj = 0.5)
abline(h = 0, lty = 3, col = "darkgrey")
points(t.tab$percent,t.tab$late, type = "b", col = "red")
points(t.tab$percent,t.tab$average, type = "b", col = "black")
legend("bottomright",legend = c("Early","Average","Late"), col = c("blue","black","red"),pch = c(1,1,1),bty = "n")
# salmon op
par(mar = c(1,1,0,0))
t.tab <- as.data.frame(as.matrix(t(tab_nostars[4:6,5:11])))
colnames(t.tab) <- tab_nostars[4:6,3]
t.tab$percent <- c(5,25,33,50,66,75,95)
plot(t.tab$percent,t.tab$early, type = "b", col = "blue", ylim = c(-1,1), ylab = "",xlab = "", axes = FALSE)
box(which = "plot",lty = "solid")
axis(side = 2,at = seq(from = -1, to = 1, by = 0.2),labels = NA,tck = 0.03)
axis(side = 1,at = c(0,5,25,33,50,66,75,95,100),labels = NA,tck = 0.03)
title(main = expression(italic("S. salar") * ", SEAS5"),line = -1,adj = 0.5)
abline(h = 0, lty = 3, col = "darkgrey")
points(t.tab$percent,t.tab$late, type = "b", col = "red")
points(t.tab$percent,t.tab$average, type = "b", col = "black")

# -------------------------------------------------------------------------------- #
# trout ideal
t.tab <- as.data.frame(as.matrix(t(tab_nostars[7:9,5:11])))
colnames(t.tab) <- tab_nostars[7:9,3]
t.tab$percent <- c(5,25,33,50,66,75,95)
par(mar = c(1,1,0,0))
plot(t.tab$percent,t.tab$early, type = "b", col = "blue", ylim = c(-1,1), ylab = "ROCSS",xlab = "", axes = FALSE, xpd = NA)
box(which = "plot",lty = "solid")
axis(side = 2,at = seq(from = -1, to = 1, by = 0.2),labels = seq(from = -1, to = 1, by = 0.2),tck = 0.03)
axis(side = 1,at = c(0,5,25,33,50,66,75,95,100),labels = NA,tck = 0.03)
abline(h = 0, lty = 3, col = "darkgrey")
title(main = expression(italic("S. trutta") * ", ERA5"),line = -1,adj = 0.5)
points(t.tab$percent,t.tab$late, type = "b", col = "red")
points(t.tab$percent,t.tab$average, type = "b", col = "black")
# trout op
t.tab <- as.data.frame(as.matrix(t(tab_nostars[10:12,5:11])))
colnames(t.tab) <- tab_nostars[10:12,3]
t.tab$percent <- c(5,25,33,50,66,75,95)
par(mar = c(1,1,0,0))
plot(t.tab$percent,t.tab$early, type = "b", col = "blue", ylim = c(-1,1), ylab = "",xlab = "", axes = FALSE)
box(which = "plot",lty = "solid")
axis(side = 2,at = seq(from = -1, to = 1, by = 0.2),labels = NA,tck = 0.03)
axis(side = 1,at = c(0,5,25,33,50,66,75,95,100),labels = NA,tck = 0.03)
abline(h = 0, lty = 3, col = "darkgrey")
title(main = expression(italic("S. trutta") * ", SEAS5"),line = -1,adj = 0.5)
points(t.tab$percent,t.tab$late, type = "b", col = "red")
points(t.tab$percent,t.tab$average, type = "b", col = "black")

# -------------------------------------------------------------------------------- #
# eel ideal
t.tab <- as.data.frame(as.matrix(t(tab_nostars[13:15,5:11])))
colnames(t.tab) <- tab_nostars[13:15,3]
t.tab$percent <- c(5,25,33,50,66,75,95)
par(mar = c(1,1,0,0))
plot(t.tab$percent,t.tab$early, type = "b", col = "blue", ylim = c(-1,1), ylab = "ROCSS",xlab = "Percentile", xpd = NA, axes = FALSE)
box(which = "plot",lty = "solid")
axis(side = 2,at = seq(from = -1, to = 1, by = 0.2),labels = seq(from = -1, to = 1, by = 0.2),tck = 0.03)
axis(side = 1,at = c(5,25,50,75,95),labels = c("5th","25th","50th","75th","95th"),tck = -0.03)
axis(side = 1,at = c(33,66),labels = NA,lty = 1,tck = 0.03,xpd = NA)
axis(side = 1,at = c(33,66),labels = c("33rd","66th"),line = -2.3,lty = 0,xpd = NA)
abline(h = 0, lty = 3, col = "darkgrey")
title(main = expression(italic("A. anguilla") * ", ERA5"),line = -1,adj = 0.5)
points(t.tab$percent,t.tab$late, type = "b", col = "red")
points(t.tab$percent,t.tab$average, type = "b", col = "black")
# eel op
t.tab <- as.data.frame(as.matrix(t(tab_nostars[16:18,5:11])))
colnames(t.tab) <- tab_nostars[16:18,3]
t.tab$percent <- c(5,25,33,50,66,75,95)
par(mar = c(1,1,0,0))
plot(t.tab$percent,t.tab$early, type = "b", col = "blue", ylim = c(-1,1), ylab = "",xlab = "Percentile", xpd = NA, axes = FALSE)
box(which = "plot",lty = "solid")
axis(side = 2,at = seq(from = -1, to = 1, by = 0.2),labels = NA,tck = 0.03)
axis(side = 1,at = c(5,25,50,75,95),labels = c("5th","25th","50th","75th","95th"),tck = -0.03)
axis(side = 1,at = c(33,66),labels = NA,lty = 1,tck = 0.03,xpd = NA)
axis(side = 1,at = c(33,66),labels = c("33rd","66th"),line = -2.3,lty = 0,xpd = NA)
abline(h = 0, lty = 3, col = "darkgrey")
title(main = expression(italic("A. anguilla") * ", SEAS5"),line = -1,adj = 0.5)
points(t.tab$percent,t.tab$late, type = "b", col = "red")
points(t.tab$percent,t.tab$average, type = "b", col = "black")
invisible(dev.off())
```

**Table 1.** *Receiver Operating Characteristic Skill Scores for seasonal forecasting model chains under known (ERA5) and retrospective seasonal conditions (SEAS5) for Atlantic salmon smolts (*S. salar*), Anadromous brown trout smolts (*S. trutta*), and European silver eels (*A. anguilla*). Skill scores that were significantly greater than random forecast are marked with an outlined box. The colour scale intensity illustrates the magnitude of ROCSS, and the hue relates to its sign (green positive, yellow negative).*
