---
title: 'Appendix S4: A seasonal forecasting workflow for the seaward migrations of European silver eel'
subtitle: |
  | Manuscript title: A seasonal forecasting workflow for the seaward migrations of diadromous fishes
author: |
  | Andrew S French^1^, Tadhg N Moore^2^^[Present address: Virginia Tech, Department of Biological Sciences, Blacksburg, Virginia, USA], Seán Kelly^2^^[Present address: Inland Fisheries Ireland, 3044 Lake Drive, Citywest Business Campus, Dublin, Ireland],
  | Eleanor Jennings^2^, Russell Poole^1^, Gerard Rogan^1^,
  | Mary Dillane^1^, Maialen Iturbide^3^, Sixto Herrera García^4^,
  | María Dolores Frías^4^, François Clayer^5^, Muhammed Shikhani^6^,
  | Daniel Mercado-Bettín^7^, Rafael Marcé^7,8^, Elvira de Eyto^1^
date: |
  | Author affiliations:
  | ^1^Marine Institute, Furnace, Newport, Co. Mayo, Ireland;
  | ^2^Dundalk Institute of Technology, Dublin Road, Dundalk, Co. Louth, Ireland;
  | ^3^Meteorology Group, Insituto de Física de Cantabria, CSIC - Universidad de Cantabria, Avda. de los Castros, s/n, 39005, Santander, Spain;
  | ^4^Meteorology Group, Dpto. de Matemática Aplicada y Ciencias de la Computación, Universidad de Cantabria, Avda. de los Castros, s/n, 39005, Santander, Spain;
  | ^5^Norwegian Institute for Water Research (NIVA), Oslo, Norway;
  | ^6^Department of Lake Research, Helmholtz Centre for Environmental Research, Magdeburg, Germany;
  | ^7^Catalan Institute for Water Research (ICRA), Girona, Spain;
  | ^8^University of Girona, Girona, Spain
  |
  | Corresponding author:
  | Andrew S French; address: Marine Institute, Furnace, Newport, Co. Mayo, Ireland; email: Andrew.French@marine.ie; Phone: +353 98 42300
output:
  bookdown::pdf_document2:
    number_sections: no
    toc: yes
    toc_depth: 2
    keep_tex: yes
  bookdown::html_document2:
    fig_retina: null
    toc: yes
    toc_float: yes
    theme: united
    keep_md: yes
    fig_caption: yes
    number_sections: no
  bookdown::word_document2:
    reference_docx: word-styles-reference-02.docx
    toc: yes
    toc_depth: 2
    number_sections: no
linestretch: 1.5
fontsize: 11pt
geometry: margin=1.5in
bibliography: Literature_cited.bib
csl: FishFisheries.csl
include-before: '`\newpage{}`{=latex}'
header-includes:
- \usepackage[section]{placeins}
- \usepackage{lineno}
- \nolinenumbers
- \usepackage{gensymb}
- \usepackage[justification=raggedright,labelfont=bf,singlelinecheck=false]{caption}
- \pagenumbering{gobble}
- \renewcommand\linenumberfont{\normalfont\small\sffamily}
- \usepackage{booktabs}
- \usepackage{makecell}
vignette: |
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{Appendix S4: A seasonal forecasting workflow for the seaward migrations of European silver eel} 
  %\VignetteEngine{knitr::rmarkdown}
editor_options:
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
options(tinytex.verbose = TRUE)
```

\singlespacing

\linenumbers

\pagebreak

# INTRODUCTION {.unnumbered}

In this appendix, we add figures and tables to complement the workflow schematic presented in **Figure 1** of the accompanying manuscript. The rmarkdown version of this document contains R code, which along with R scripts contained in the `fishcastr` GitHub repository [/data-raw/](https://github.com/as-french/fishcastr/tree/master/data-raw) folder for accessing climate data using the Copernicus CDS, complete the reproducibility chain.

This appendix is included alongside the manuscript to complement descriptions of data included the manuscript and provide model validation plots specifically related to a model chain for forecasting the timing of European silver eel (*Anguilla anguilla* (Linnaeus, 1758)) migration. See **Appendix S1** for aspects of the seasonal forecasting workflow, which are shared among species; namely:

- Rating curve fitting for estimation of catchment discharge from water level data
- Calibrations of hydrologic and water temperature models;
- Access to lunar and solar data and derivation of moonlight exposure;
- Bias adjustment of climate data

The following sections correspond to numbered items **1 a** through **3 b** in **Figure 1** of the accompanying manuscript.

# (1) DATA PROVENANCE AND PRE-PROCESSING

## (1a) Compile catchment specific data

### *Fish counts*

Here, we present seaward migrating European silver eel counts recorded between 1981 and 2019 in Burrishoole. **Figure \@ref(fig:catchment-specific-data-1-eel)** illustrates the width of the temporal window (~150 consecutive calendar days) during which downstream migrating eels are expected in the Burrishoole fish traps. Note the considerable dispersion of annual counts relative to the phenology curve described by the 1981 - 2019 average daily count. As described in the manuscript, data for 1984 ad 1989 are known to be incomplete owing to large autumn floods which allowed eels to bypass the traps.

```{r catchment-specific-data, out.width="100%", eval=FALSE, echo = FALSE}
# ---------------------------------------------------------------------------------------------------------- #
# FISH COUNTS ----
# ---------------------------------------------------------------------------------------------------------- #
# download fish data from Foras na Mara Marine Institute (Ireland)
fishcastr::download_fish_data()
data_seel <- fishcastr::import_fish_data(species = "seel")

data_seel$year <-lubridate::year(data_seel$date)
data_seel$yday <-lubridate::yday(data_seel$date)
data_seel <- data_seel[data_seel$year >= 1981,]

# calculate average per year day
mean_daily_count <- tapply(data_seel$seel,INDEX = data_seel$yday,FUN = mean,na.rm = TRUE)
lower_pct <- tapply(data_seel$seel,INDEX = data_seel$yday,FUN = quantile, probs = 0.025,na.rm = TRUE)
upr_pct <- tapply(data_seel$seel,INDEX = data_seel$yday,FUN = quantile,probs = 0.975,na.rm = TRUE)
df_mean <- data.frame("yday" = names(mean_daily_count),
                        "mean_count" = as.vector(mean_daily_count),
                        "lwr" = as.vector(lower_pct),
                        "upr" = as.vector(upr_pct))
df_counts <- merge(data_seel,df_mean, by = "yday",all.x = TRUE)
df_counts_order <- df_counts[order(df_counts$date),]

  # for plotting clarity replace zeros with NAs
  ####
      df_counts_order$seel[1] <- ifelse(df_counts_order$seel[1] == 0 & df_counts_order$seel[2] == 0, NA, df_counts_order$seel[1])

      for(j in 2:(length(df_counts_order$seel)-1)){
        df_counts_order$seel[j] <- ifelse(df_counts_order$seel[j] == 0 & df_counts_order$seel[j-1] == 0 & df_counts_order$seel[j+1] == 0, NA, df_counts_order$seel[j])
      }

      df_counts_order$seel[length(df_counts_order$seel)] <- ifelse(df_counts_order$seel[length(df_counts_order$seel)] == 0 & df_counts_order$seel[length(df_counts_order$seel)-1] == 0, NA, df_counts_order$seel[length(df_counts_order$seel)])
  ####

# set plot colours
rgb_col <- col2rgb("black")
col_alpha_black <- rgb(red = rgb_col[1], green = rgb_col[2], blue = rgb_col[3],
                             alpha = 50, maxColorValue = 255)
rgb_col <- col2rgb("red")
col_alpha_red <- rgb(red = rgb_col[1], green = rgb_col[2], blue = rgb_col[3],
                             alpha = 60, maxColorValue = 255)

# plot data
# create vignettes folder
dir_dat <- paste0(system.file("", package = "fishcastr"),"/vignettes/")
dir.create(dir_dat, showWarnings = TRUE, recursive = TRUE, mode = "0777")

dirName <- paste0(system.file("extdata", package = "fishcastr"),"/eel_wflow_figs/")
dir.create(dirName, showWarnings = TRUE, mode = "0777")

png(filename = paste0(dirName,"catchment_specific_data-1-eel.png"), height = 2300, width = 1500, res =300)
par(mfcol = c(13,3),oma = c(8,4,1,1), mar = c(0.5,2,0.1,0.1), mgp = c(1,0.5,0))
for(i in unique(df_counts_order$year)) {
  ylims <- c(0,max(c(max(df_counts_order$upr[df_counts_order$year == i],na.rm = TRUE),
                   max(df_counts_order$seel[df_counts_order$year == i],na.rm = TRUE))))
        low_yvals <- ifelse(is.na(df_counts_order$seel[df_counts_order$year == i]),NA, 0)
  low_yvals_ave <- ifelse(is.na(df_counts_order$lwr[df_counts_order$year == i]),NA, 0)
        
#  ylims = c(0,700)
  xlims <- c(180,365)
  plot(df_counts_order$yday[df_counts_order$year == i],
       df_counts_order$mean_count[df_counts_order$year == i], col = NULL, ylim = ylims,xlab = "", ylab = "",
       xaxt = "n",yaxt = "n", xlim = xlims)
  title(main = i,adj = 0.9, line = -1)
  if(i %in% c(1993,2006,2019)){
    axis(side = 1, tck = 0.1)
  }
 #   if(i %in% c(1981:1993)){
    axis(side = 2, tck = 0.1)
#    }
  
  # polygons upper 95% PI
  fishcastr::step_style_polygon(
    xvals = ifelse(is.na(low_yvals_ave), NA,
                       df_counts_order$yday[df_counts_order$year == i]),
    y_vals_low = low_yvals_ave,
    y_vals_up = ifelse(is.na(low_yvals_ave), NA,
                       df_counts_order$upr[df_counts_order$year == i]),
    col_alpha_rgb = col_alpha_black,
    border = NA
  )
  
  # line for mean
  lines(df_counts_order$yday[df_counts_order$year == i &
                                   df_counts_order$mean_count > 0],
          df_counts_order$mean_count[df_counts_order$year == i &
                                             df_counts_order$mean_count > 0], lwd = 0.5, col = col_alpha_black,type = "s")
  
  fishcastr::step_style_polygon(
    xvals = ifelse(is.na(low_yvals), NA,
                       df_counts_order$yday[df_counts_order$year == i]),
    y_vals_low = low_yvals,
    y_vals_up = ifelse(is.na(low_yvals), NA,
                       df_counts_order$seel[df_counts_order$year == i]),
    col_alpha_rgb = col_alpha_red,
    border = "red", lwd = 0.5
  )
  
}
mtext(side = 1,text = "Calendar year day",outer = TRUE,line = 2)
mtext(side = 2,text = expression(italic("A. anguilla ")~silver~count),outer = TRUE,line = 0)
legend("bottomright", legend = c("Daily count","1981 - 2019 mean daily count\nand 95 percentile range"),
       col = c(col_alpha_red,col_alpha_black),pt.lwd = c(NA,1),
       lty = c(NA,1),lwd = c(NA,1),
       pch = c(15,15),bty = "n",
       inset = c(0.1,-2.5),
       xpd = NA, cex = 1.3)
dev.off()
```

```{r catchment-specific-data-1-eel, out.width="70%", eval = TRUE, fig.align = 'center', fig.cap = "(ref:catchment-specific-data-1-eel)", echo = FALSE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/eel_wflow_figs/")
knitr::include_graphics(path = paste0(dirName,"catchment_specific_data-1-eel.png"))
```

(ref:catchment-specific-data-1-eel) *Migration phenology curves (relative to 1981 - 2019 average) described by the combined daily counts of  European silver eel (*A. anguilla*) recorded leaving the two freshwater outflows from Lough Feeagh and entering a tidal lagoon at Burrishoole, Ireland.*

*Stratifying silver eel census data into forecast years*

As described in the **Manuscript: Section 2.1.1**, we aimed to define species specific forecast years (i.e., salmonid years and eel years) with the intention of assigning all counts within each year to a single period of smoltification or silvering.

Stratifying silver eel counts into discrete silvering periods is challenging owing to the prolonged nature of silvering, whereby individual eels will not necessarily reach tidal waters during the same calendar year in which they started silvering and gained pre-migratory silvering characteristics [@feunteun_european_2000]. In this sense, the pre-migratory progression of silvering is a flexible maturation process, whereby individuals accumulate silvering characteristics during one or more years. With this individual variation in mind, we did not assume that it is possible to model the entire silvering process within one calendar year; however, the marked seasonality of the geographically variable but nonetheless annually confined run period [@righton_empirical_2016], suggests that progression to the final stage of silvering (i.e., the stage that encompasses changes which coincide with propensity to migrate given tolerable conditions) is confined to annual cycles. Therefore, we assume that inter-annual variability in run timing within catchments might plausibly be related to the rate at which the final silvering stage in reached. We propose that progression to this final silvering stage might correlate with seasonal scale variability such as degree days, akin to smoltification in salmonids. In this sense, we assume each eel forecast year (eel year) (i.e., the year during which final stage of silvering occurs within a maturing cohort) starts on the winter solstice; however, we assume that each forecast year may overlap the following winter solstice, because European eels ostensibly maintain silvering morphology and propensity to migrate into spring if autumn migration is impeded by physical barriers [@acou_migration_2008], or following a state of winter dormancy [@westerberg_overwintering_2015].

We hypothesis that degree days associate with inter-annual variability in migration phenology at the catchment level through hastened physiological progression of silvering. If so, the apparently increasingly early onset of migration recorded in Burrishoole, Ireland [@sandlund_timing_2017] may be related to warmer winter lake temperatures in Burrishoole. Here, the annual minimum winter surface temperature of the largest lake in Burrishoole has increased since the 1970s, most noticeably since the 1990s [@woolway_substantial_2019]. Such warming could shorten (if present) a period of dormancy induced by low temperatures, as could be inferred for lakes where overwintering dormancy has been observed [@westerberg_overwintering_2015]; thereby hastening any temperature mediated physiological changes associated with silvering. With prediction of counts and biomass of silver eels a primary modelling aim, developers of solely hydrologically based predictive models for silver eel migration have acknowledged that the inclusion of temperature information should improve predictions [@teichert_towards_2020]. Moreover, the start and end of each year's silver eel migration (and its inter-annual variability) is not always clear owing to reduced fishing effort when low catches are expected, even in monitored rivers [@lenihan_modelling_2020]. As such, the Burrishoole daily census data provide an extremely valuable opportunity to explore inter-annual variation in silver eel migration timing in relation to factors such as degree days.

In Burrishoole, the silver eel run invariably peaks in Autumn, but seaward migrating silver eels have been recorded during all months of the year. Therefore, we had to define a cut-off date to separate counts among calendar years into distinct runs. We defined a variable cut-off date that always occurred during spring, but varied among years based on the theoretical end date of the preceding year's run. We assumed that the active migration of any eels that had silvered prior to that date but not yet successfully migrated would cease. We defined the cut-off date as the first date after the 1^st^ of January on which daily mean water temperature for the preceding 10 days had exceeded 11 \degree C. This temperature threshold was chosen because it approximately marked the point at which a reversal of silvering characteristics has been observed in wild silvered eels held in captivity at ambient temperature [@durif_seasonal_2009]. While our definition of eel year allows the total number of days in each forecast year to vary throughout the dataset, we used the 124^th^ calendar day of the year (i.e., the earliest eel year start date at Burrishoole, or earliest "biofix"; 4^th^ May 2011) as a reference first day of each forecast year with which to compare migration timing among years. See **Table \@ref(tab:appendix-s1-table)** for eel forecast year details.

```{r define-eel-bioyears, eval = FALSE, echo = FALSE}
# ---------------------------------------------------------------------------------------------------------- #
# LOAD EEL DATA
# ---------------------------------------------------------------------------------------------------------- #
# silver eels are counted during all months
data_eel <- fishcastr::import_fish_data(species = "seel")
data_eel$month <- lubridate::month(data_eel$date)
tapply(data_eel$seel, data_eel$month, sum)

# ---------------------------------------------------------------------------------------------------------- #
# IMPORT RAW AIR TEMP AND AIR TO WATER TEMP MODEL -----
#----------------------------------------------------------------------------------------------------------- #
data_air_temp <- fishcastr::convert_grid_to_dataframe(grid_obj = fishcastr::grid_ERA5_1979_2019_Jun_bc)[,-2]
names(data_air_temp) <- c("date","tas_era5_bcc","pr_era5_bcc","petH_era5_bcc")
air_to_water_params <- fishcastr::air_to_water_Feeagh_params_ERA5_bcc
data_water_temp <- data.frame(
  "date" = data_air_temp$date,
  "water_temp" = fishcastr::air_to_water_model(
    Ta = data_air_temp$tas_era5_bcc,
    Yday = lubridate::yday(data_air_temp$date),
    A = air_to_water_params$A,
    ac = air_to_water_params$ac,
    b = air_to_water_params$b,
    B = air_to_water_params$B
  )
)

#----------------------------------------------------------------------------------------------------------- #
# DEFINING FORECAST "THERMAL" YEARS, YEAR DAYS AND DAYS SINCE COMMON BIOFIX ----
#----------------------------------------------------------------------------------------------------------- #
eel_bio_year <-
  fishcastr::bio_year_therm(
    mean_temp = data_water_temp$water_temp,
    dates = data_water_temp$date,
    biofix_temp = 11,
    min_no_days_above_biofix = 10,
    increasing_temp = TRUE,
    yday_head = "eel_yday",
    bio_year_head = "eel_year",
    days_since_earliest_biofix_head = "eel_yday_biofix",
    incomplete_first_year = 1978,
    start_previous_calendar_year = FALSE
  )

eel_bio_year <-
  eel_bio_year[eel_bio_year$eel_year %in% c(1981:2018), ]

#----------------------------------------------------------------------------------------------------------- #
# SAVE EEL BIOYEAR DATA FOR SUPPLEMENTARY TABLE ----
#----------------------------------------------------------------------------------------------------------- #
tab_eel_latex <-
  knitr::kable(
    fishcastr::min_max_bio_year_date(
      dates = eel_bio_year$date,
      bio_years = eel_bio_year$eel_year,
      biofix_day = eel_bio_year$eel_yday_biofix
    ),
  format = "latex",
  caption = "\\label{tab:appendix-s1-table}\\textit{European eel (\\textnormal{A. anguilla}) forecast years defined for Burrishoole between 1981 and 2018. Forecast year start dates and end dates are defined concurrently. Forecast year start dates are denoted by the first day of the calendar year that follows a consecutive period of 10 days during which water temperatures exceeded of 11\\degree C.}"
  , booktabs = TRUE)

tab_eel_html <-
  knitr::kable(
    fishcastr::min_max_bio_year_date(
      dates = eel_bio_year$date,
      bio_years = eel_bio_year$eel_year,
      biofix_day = eel_bio_year$eel_yday_biofix
    ),
  format = "html",
  caption = "\\label{tab:appendix-s1-table}\\textit{European eel (\\textnormal{A. anguilla}) forecast years defined for Burrishoole between 1981 and 2018. Forecast year start dates and end dates are defined concurrently. Forecast year start dates are denoted by the first day of the calendar year that follows a consecutive period of 10 days during which water temperatures exceeded 11\\degree C.}"
  , booktabs = TRUE)

eel_year_table_latex <-
  kableExtra::kable_styling(kable_input = tab_eel_latex, position = "center", font_size = 7.5)

eel_year_table_html <-
  kableExtra::kable_styling(kable_input = tab_eel_html, position = "center", font_size = 7.5)

# Create vignette sub directory ----
dirName <-
  paste0(system.file("extdata", package = "fishcastr"),
         "/vignette_tables/")
dir.create(dirName, showWarnings = TRUE, mode = "0777")
saveRDS(eel_year_table_latex, file = paste0(dirName, "eel_year_table_latex.rds"))
saveRDS(eel_year_table_html, file = paste0(dirName, "eel_year_table_html.rds"))

rm(list = ls(all.names = TRUE))
invisible(gc())
```

```{r appendix-s1-table, out.width="100%", eval = TRUE, fig.align = 'center', echo = FALSE}
# ----------------------------------------------------------------------------------------------------------- #
# LOAD SUPPLEMENTARY DATA
# ----------------------------------------------------------------------------------------------------------- #
eel_year_table <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                 "/vignette_tables/eel_year_table_latex.rds"))
eel_year_table
```

*Observed migration timing anomalies and phenology curves*

To clarify context regarding anomaly definitions, we are skipping ahead to one of the outputs of workflow step 3. In **Figure \@ref(fig:catchment-specific-data-1b-eel)**, we present observed (tercile based) anomalies for the mean date of migration of European silver eels in Burrishoole (NOTE - for comparison with later seasonal forecast anomalies, computations of migration summary statistics are based solely on fish counts during forecast year "target season"; i.e., July to December for eels). These data are not detrended, although the fishcastr package facilitates *linear* detrending of terciles; i.e., adjusting the 1/3 and 2/3 percentiles positions according to a fitted linear regression. In the presence of multidecadal trends in migration timing, linear detrending can be useful for assessing a seasonal forecast system's propensity to discriminate between occurrence and non-occurrence of anomalies, when the definition of anomalies for each year are adjusted relative to expectations given "contemporary conditions". Detrending is also useful for exploring phenotypic plasticity [@iler_detrending_2017] by answering questions such as: *Is inter-annual variability in timing anomalies more or less variable during 2000-2010 that variability during 1980-2000?*; i.e., *Do Atlantic salmon smolts have a greater or lesser propensity to adjust their migration timing to match seasonal conditions?*. This question assumes inter-annual variability in seasonal climate is consistent throughout the time series, although quantification of inter-annual variability in seasonal climate for selected windows could be used to adjust for any differences.

```{r observed-anomalies-eel, eval = FALSE, echo = FALSE}
# ---------------------------------------------------------------------------------------------------------- #
# IMPORT BIAS ADJUSTED METEOROLOGICAL DATA -----
# ---------------------------------------------------------------------------------------------------------- #
data_ERA5_1979_2019_Jun_bc <- fishcastr::convert_grid_to_dataframe(grid_obj = fishcastr::grid_ERA5_1979_2019_Jun_bc)[,-2]
names(data_ERA5_1979_2019_Jun_bc)[which(names(data_ERA5_1979_2019_Jun_bc) == "dates1")] <- "date"

# ---------------------------------------------------------------------------------------------------------- #
# RUN AIR TO WATER TEMP MODEL -----
# ---------------------------------------------------------------------------------------------------------- #
data_water_temp <- data.frame(
  "date" = data_ERA5_1979_2019_Jun_bc$date,
  "water_temp" = fishcastr::air_to_water_model(
    Ta = data_ERA5_1979_2019_Jun_bc$tas,
    Yday = lubridate::yday(data_ERA5_1979_2019_Jun_bc$date),
    A = fishcastr::air_to_water_Feeagh_params_ERA5_bcc$A,
    ac = fishcastr::air_to_water_Feeagh_params_ERA5_bcc$ac,
    b = fishcastr::air_to_water_Feeagh_params_ERA5_bcc$b,
    B = fishcastr::air_to_water_Feeagh_params_ERA5_bcc$B
  )
)

# ---------------------------------------------------------------------------------------------------------- #
# STRATIFY FORECAST YEARS ----
# ---------------------------------------------------------------------------------------------------------- #
# stratify forecast years and retain water temperature
data_seel_forecast_years <- fishcastr::bio_year_therm(mean_temp = data_water_temp$water_temp,
                                                      dates = data_water_temp$date,
                                                      biofix_temp = 11,
                                                      min_no_days_above_biofix = 10,
                                                      increasing_temp = TRUE,
                                                      yday_head = "eel_yday",
                                                      bio_year_head = "eel_year",
                                                      days_since_earliest_biofix_head = "eel_yday_biofix",
                                                      incomplete_first_year = 1978,
                                                      start_previous_calendar_year = FALSE)
#names(data_seel_forecast_years)[which(names(data_seel_forecast_years) == "meanT")] <- "water_temp"

# download fish data from Foras na Mara Marine Institute (Ireland)
fishcastr::download_fish_data()
data_seel <- fishcastr::import_fish_data(species = "seel")

# silver eels are counted in all months, but primarily from July to December
data_seel$month <- lubridate::month(data_seel$date)
tapply(data_seel$seel, data_seel$month, sum)

# merge data and subset to target season
data_counts <- merge(data_seel,data_seel_forecast_years, by = "date", all.x = TRUE)
data_counts$eel_year[data_counts$date %in% seq(from = as.Date("2019-07-01"), to = as.Date("2019-12-31"), by = "day")] <- 2019
data_counts <- data_counts[data_counts$date <= as.Date("2019-12-31"),]
data_counts$eel_yday_biofix[data_counts$date >= as.Date("2019-07-01")] <- seq(from = 59, by = 1, length.out = (length(data_counts$eel_year[data_counts$eel_year %in% 2019])-42))

data_counts_eel <- data_counts[data_counts$eel_year %in% c(1981:2019),]
data_counts_eel$month <- lubridate::month(data_counts_eel$date)
data_counts_eel_target_s <- data_counts_eel

data_counts_eel_target_s$seel[data_counts_eel_target_s$month %in% c(1:6)] <- 0

data_counts_eel_84_89 <- data_counts_eel_target_s[data_counts_eel_target_s$eel_year != 1984 & data_counts_eel_target_s$eel_year != 1989,]

# ---------------------------------------------------------------------------------------------------------- #
# PLOT OBSERVED PHENOLOGY ANOMALIES
# ---------------------------------------------------------------------------------------------------------- #
# Create vignette sub directory ----
dirName <- paste0(system.file("extdata",package = "fishcastr"),
                      "/eel_wflow_figs/", sep = "", collapse = NULL)
dir.create(dirName, showWarnings = TRUE, mode = "0777")

png(file = paste0(dirName,"catchment_specific_data-1b-eel.png"), width=4500, height=6500, res=150)
eel_anoms <-
  fishcastr::ridgeline_plot_phenology(
    bio_year = data_counts_eel_84_89$eel_year,
    counts = data_counts_eel_84_89$seel,
    yday = data_counts_eel_84_89$eel_yday_biofix,
    dates = data_counts_eel_84_89$date,
    method = "mean",
    species_name = "European eel (silver)",
    season = "autumn",
    plot = TRUE,
    detrended = FALSE,
    unreliable_years = c(1984, 1989),
    xlims_plot = c(0, 1)
  )
invisible(dev.off())

# remove white space in figure
image <- magick::image_read(paste0(dirName,"catchment_specific_data-1b-eel.png"))
image_trimmed <- magick::image_trim(image) # trim white space
magick::image_write(image_trimmed, paste0(dirName,"catchment_specific_data-1b-eel_trim.png"))
```

```{r catchment-specific-data-1b-eel, out.width="70%", eval = TRUE, fig.align = 'center', fig.cap = "(ref:catchment-specific-data-1b-eel)", echo = FALSE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/eel_wflow_figs/")
knitr::include_graphics(path = paste0(dirName,"catchment_specific_data-1b-eel_trim.png"))
```

(ref:catchment-specific-data-1b-eel) *Migration phenology curves and migration timing anomalies (of mean forecast year day) described by the combined daily counts of European silver eel (*A. anguilla*) recorded leaving the two freshwater outflows from Lough Feeagh and entering a tidal lagoon at Burrishoole, Ireland.*

<!-- ### Water temperature -->

```{r catchment-specific-data-water-temp, eval=FALSE, echo = FALSE}
# ---------------------------------------------------------------------------------------------------------- #
# WATER TEMPERATURE (see: data-raw/data_Feeagh2m_temp.R) ----
fishcastr::download_Feeagh_water_temp() # this could take a few minutes to download and unzip

data_Feeagh2m_temp <- readRDS(file = paste0(system.file("extdata",
                                                        package = "fishcastr"),
                                            "/data_Feeagh2m_temp.rds"))

data_Feeagh2m_temp$year <-lubridate::year(data_Feeagh2m_temp$date)
data_Feeagh2m_temp$yday <-lubridate::yday(data_Feeagh2m_temp$date)

# calculate average per year day
mean_daily_temp <- tapply(data_Feeagh2m_temp$Water_Temp_2m,INDEX = data_Feeagh2m_temp$yday,FUN = mean,na.rm = TRUE)
lower_pct <- tapply(data_Feeagh2m_temp$Water_Temp_2m,INDEX = data_Feeagh2m_temp$yday,FUN = quantile, probs = 0.025,na.rm = TRUE)
upr_pct <- tapply(data_Feeagh2m_temp$Water_Temp_2m,INDEX = data_Feeagh2m_temp$yday,FUN = quantile,probs = 0.975,na.rm = TRUE)
df_mean <- data.frame("yday" = names(mean_daily_temp),
                        "mean_temp" = as.vector(mean_daily_temp),
                        "lwr" = as.vector(lower_pct),
                        "upr" = as.vector(upr_pct))
df_temps <- merge(data_Feeagh2m_temp,df_mean, by = "yday",all.x = TRUE)
df_temps_order <- df_temps[order(df_temps$date),]

# set plot colours
rgb_col <- col2rgb("black")
col_alpha_black <- rgb(red = rgb_col[1], green = rgb_col[2], blue = rgb_col[3],
                             alpha = 50, maxColorValue = 255)

# plot data
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/eel_wflow_figs/")
#dir.create(dirName, showWarnings = TRUE, mode = "0777")

png(filename = paste0(dirName,"catchment_specific_data-2-eel.png"), height = 1500, width = 2000, res =300)
#png(filename = "figure/catchment_specific_data-2-eel.png")
par(mfcol = c(4,4),oma = c(10,4,1,1), mar = c(1,0.5,0.1,0.1))
for(i in unique(df_temps_order$year)) {
  ylims <- c(0,max(c(max(df_temps_order$upr[df_temps_order$year == i],na.rm = TRUE),
                   max(df_temps_order$Water_Temp_2m[df_temps_order$year == i], na.rm = TRUE))))
  xlims <- c(1,365)
  plot(df_temps_order$yday[df_temps_order$year == i],
       df_temps_order$mean_temp[df_temps_order$year == i], col = NULL, ylim = ylims,xlab = "", ylab = "",xaxt = "n",yaxt = "n", xlim = xlims)
  title(main = i,adj = 0.9, line = -1)
  if(i %in% c(2007,2011,2015,2019)){
    axis(side = 1, tck = 0.1)
  }
    if(i %in% c(2004:2007)){
    axis(side = 2, tck = 0.1)
  }
  # polygons
  fishcastr::step_style_polygon(xvals = df_temps_order$yday[df_temps_order$year == i],
                     y_vals_low = df_temps_order$lwr[df_temps_order$year == i],
                     y_vals_up = df_temps_order$upr[df_temps_order$year == i],
                     col_alpha_rgb = col_alpha_black, border = NA)

    lines(df_temps_order$yday[df_temps_order$year == i],
        df_temps_order$mean_temp[df_temps_order$year == i], lty = 1, lwd = 0.75, col = col_alpha_black)
  
  lines(df_temps_order$yday[df_temps_order$year == i],
        df_temps_order$Water_Temp_2m[df_temps_order$year == i], lty = 1, lwd = 0.75, col = "red")

}
mtext(side = 1,text = "yday",outer = TRUE,line = 2)
mtext(side = 2,text = expression("Water temperature ("*~degree*C*")"),outer = TRUE,line = 2)
legend("bottomright", legend = c("Water temperature","1981 - 2019 mean daily water temperature\nand 95 percentile range"),col = c("red",col_alpha_black), pch = c(NA,15),lty = c(1,NULL),bty = "n",inset = c(0.1,-1.8), xpd = NA, cex = 1.5)
dev.off()
```

```{r catchment-specific-data-2-eel, out.width="70%", eval=FALSE, fig.align = 'center', fig.cap = "\\textit{Lough Feeagh AWQMS recorded water temperature at 2m depth (relative to 2004 - 2019 average).}", echo = FALSE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/eel_wflow_figs/")
knitr::include_graphics(path = paste0(dirName,"catchment_specific_data-2-eel.png"))
```

<!-- ### Catchment discharge -->

```{r catchment-specific-data-discharge, eval=FALSE, echo = FALSE}
# ---------------------------------------------------------------------------------------------------------- #
# CATCHMENT DISCHARGE ----
#data_Feeagh_discharge <- fishcastr::data_Feeagh_discharge
fishcastr::download_Feeagh_wlevel()

data_Feeagh_discharge <- readRDS(file = paste0(system.file("extdata",
                                                        package = "fishcastr"),
                                            "/data_Feeagh_discharge_corr.rds"))

data_Feeagh_discharge$year <-lubridate::year(data_Feeagh_discharge$date)
data_Feeagh_discharge$yday <-lubridate::yday(data_Feeagh_discharge$date)
data_Feeagh_discharge <- data_Feeagh_discharge[data_Feeagh_discharge$year >= 1981 & data_Feeagh_discharge$year <= 2019,]

# calculate average per year day
mean_daily_discharge <- tapply(data_Feeagh_discharge$discharge_m3.s,INDEX = data_Feeagh_discharge$yday,FUN = mean,na.rm = TRUE)
lower_pct <- tapply(data_Feeagh_discharge$discharge_m3.s,INDEX = data_Feeagh_discharge$yday,FUN = quantile, probs = 0.025,na.rm = TRUE)
upr_pct <- tapply(data_Feeagh_discharge$discharge_m3.s,INDEX = data_Feeagh_discharge$yday,FUN = quantile,probs = 0.975,na.rm = TRUE)
df_mean <- data.frame("yday" = names(mean_daily_discharge),
                        "mean_discharge" = as.vector(mean_daily_discharge),
                        "lwr" = as.vector(lower_pct),
                        "upr" = as.vector(upr_pct))
df_discharge <- merge(data_Feeagh_discharge,df_mean, by = "yday",all.x = TRUE)
df_discharge_order <- df_discharge[order(df_discharge$date),]

# set plot colours
rgb_col <- col2rgb("black")
col_alpha_black <- rgb(red = rgb_col[1], green = rgb_col[2], blue = rgb_col[3],
                             alpha = 40, maxColorValue = 255)

# plot data
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/eel_wflow_figs/")
png(filename = paste0(dirName,"catchment_specific_data-3-eel.png"), height = 2300, width = 1500, res =300)
par(mfcol = c(13,3),oma = c(8,4,1,1), mar = c(0.5,0.5,0.1,0.1))
for(i in unique(df_discharge_order$year)) {
  ylims <- c(0,max(c(max(df_discharge_order$upr[df_discharge_order$year == i],na.rm = TRUE),
                   max(df_discharge_order$discharge_m3.s[df_discharge_order$year == i], na.rm = TRUE))))
  xlims <- c(1,365)
  plot(df_discharge_order$yday[df_discharge_order$year == i],
       df_discharge_order$mean_discharge[df_discharge_order$year == i], col = NULL, ylim = ylims,xlab = "", ylab = "",xaxt = "n",yaxt = "n", xlim = xlims)
  title(main = i,adj = 0.5, line = -1)
  if(i %in% c(1993,2006,2019)){
    axis(side = 1, tck = 0.1)
  }
    if(i %in% c(1981:1993)){
    axis(side = 2, tck = 0.1)
  }
  # polygons
  fishcastr::step_style_polygon(xvals = df_discharge_order$yday[df_discharge_order$year == i],
                     y_vals_low = df_discharge_order$lwr[df_discharge_order$year == i],
                     y_vals_up = df_discharge_order$upr[df_discharge_order$year == i],
                     col_alpha_rgb = col_alpha_black, border = NA)

      lines(df_discharge_order$yday[df_discharge_order$year == i],
        df_discharge_order$mean_discharge[df_discharge_order$year == i], lty = 1, lwd = 0.75, col = col_alpha_black)
  
  lines(df_discharge_order$yday[df_discharge_order$year == i],df_discharge_order$discharge_m3.s[df_discharge_order$year == i], lty = 1, lwd = 1, col = "blue")

}
mtext(side = 1,text = "yday",outer = TRUE,line = 2)
mtext(side = 2,text = expression(paste("Catchment discharge (","m"^"3", "/s)")),outer = TRUE,line = 2)

legend("bottomright", legend = c("Catchment discharge","1981 - 2019 mean daily count\nand 95 percentile range"),
       col = c("blue",col_alpha_black),pt.lwd = c(NA,1),
       lty = c(1,1),lwd = c(1,1),
       pch = c(NA,15),bty = "n",
       inset = c(0.1,-2.5),
       xpd = NA, cex = 1.3)

dev.off()

# ---------------------------------------------------------------------------------------------------------- #
# DATES AND LOCATION OF CATCHMENT ----
# dates <- data_seel$date
# latitude <- 53.932458
# longitude <- -9.575556
```

```{r catchment-specific-data-3-eel, out.width="70%", eval=FALSE, fig.align = 'center', fig.cap = "\\textit{Rating curve estimated catchment discharge from the combined outflows of Lough Feeagh (relative to 1981 - 2019 average).}", echo = FALSE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/eel_wflow_figs/")
knitr::include_graphics(path = paste0(dirName,"catchment_specific_data-3-eel.png"))
```

<!-- ## (1b) Access lunar and solar data -->

```{r lunar-solar-data, eval=FALSE, echo = FALSE}
# ---------------------------------------------------------------------------------------------------------- #
# CALCULATE PHOTOPERIOD (see: R/photper_calc.R) ----
data_photper <- fishcastr::photper_calc(dates = fishcastr::import_fish_data(species = "seel")[["date"]][1:1000],
                                        latitude = 53.932458,
                                        longitude = -9.575556)
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/eel_wflow_figs/")
png(filename = paste0(dirName,"lunar_solar_data-1-eel.png"), height = 1000, width = 1500, res =300)
plot(fishcastr::import_fish_data(species = "seel")[["date"]][1:1000], data_photper[1:1000], type = "l", ylab = "photperiod (hours)", xlab = paste0("days after ",min(fishcastr::import_fish_data(species = "seel")[["date"]])))
dev.off()
#knitr::include_graphics(path = "eel_wflow_figs/lunar_solar_data-1-eel.png")

# ---------------------------------------------------------------------------------------------------------- #
# CATCHMENT MOONLIGHT EXPOSURE (see: R/lunar_light_exposure.R) ----
# subset of dates here as long to calculate
# data_lunar <- fishcastr::lunar_light_exposure(date_of_interest = fishcastr::import_fish_data(species = "seel")[["date"]][1:365],
#                                               lat = 53.932458,
#                                               lon = -9.575556,
#                                               log_result = FALSE)
# 
# dirName <- paste0(system.file("extdata", package = "fishcastr"),"/eel_wflow_figs/")
# png(filename = paste0(dirName,"lunar_solar_data-2-eel.png"), height = 1000, width = 1500, res =300)
# plot(fishcastr::import_fish_data(species = "seel")[["date"]][1:365], data_lunar[1:365], type = "l", ylab = "moonlight exposure",xlab = paste0("days after ",min(fishcastr::import_fish_data(species = "seel")[["date"]])))
# dev.off()

# ---------------------------------------------------------------------------------------------------------- #
data_lunar <- fishcastr::lunar_light_exposure(date_of_interest = fishcastr::import_fish_data(species = "seel")[["date"]],
                                              lat = 53.932458,
                                              lon = -9.575556,
                                              log_result = FALSE)
data_lunar_df <- data.frame("date" = fishcastr::import_fish_data(species = "seel")[["date"]],
                            "moonlight_exposure" = data_lunar)

data_lunar_df$year <-lubridate::year(data_lunar_df$date)
data_lunar_df$yday <-lubridate::yday(data_lunar_df$date)

# calculate average per year day
mean_lunar_exp <- tapply(data_lunar_df$moonlight_exposure,INDEX = data_lunar_df$yday,FUN = mean,na.rm = TRUE)
lower_pct <- tapply(data_lunar_df$moonlight_exposure,INDEX = data_lunar_df$yday,FUN = quantile, probs = 0.025,na.rm = TRUE)
upr_pct <- tapply(data_lunar_df$moonlight_exposure,INDEX = data_lunar_df$yday,FUN = quantile,probs = 0.975,na.rm = TRUE)
df_mean <- data.frame("yday" = names(mean_lunar_exp),
                        "mean_exp" = as.vector(mean_lunar_exp),
                        "lwr" = as.vector(lower_pct),
                        "upr" = as.vector(upr_pct))
df_temps <- merge(data_lunar_df,df_mean, by = "yday",all.x = TRUE)
df_temps_order <- df_temps[order(df_temps$date),]

# set plot colours
rgb_col <- col2rgb("black")
col_alpha_black <- rgb(red = rgb_col[1], green = rgb_col[2], blue = rgb_col[3],
                             alpha = 50, maxColorValue = 255)

# plot data
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/eel_wflow_figs/")
#dir.create(dirName, showWarnings = TRUE, mode = "0777")

png(filename = paste0(dirName,"lunar_solar_data-3-eel.png"), height = 2300, width = 1500, res =300)
par(mfcol = c(13,3),oma = c(8,4,1,1), mar = c(0.5,0.5,0.1,0.1))
for(i in 1981:2019) {
  ylims <- c(0,max(c(max(df_temps_order$upr[df_temps_order$year == i],na.rm = TRUE),
                   max(df_temps_order$moonlight_exposure[df_temps_order$year == i], na.rm = TRUE))))
  xlims <- c(1,365)
  plot(df_temps_order$yday[df_temps_order$year == i],
       df_temps_order$mean_exp[df_temps_order$year == i], col = NULL, ylim = ylims,xlab = "", ylab = "",xaxt = "n",yaxt = "n", xlim = xlims)
  title(main = i,adj = 0.5, line = -1)
  if(i %in% c(1993,2006,2019)){
    axis(side = 1, tck = 0.1)
  }
    if(i %in% c(1981:1993)){
    axis(side = 2, tck = 0.1)
    }
  # polygons
  fishcastr::step_style_polygon(xvals = df_temps_order$yday[df_temps_order$year == i],
                     y_vals_low = df_temps_order$lwr[df_temps_order$year == i],
                     y_vals_up = df_temps_order$upr[df_temps_order$year == i],
                     col_alpha_rgb = col_alpha_black, border = NA)

    lines(df_temps_order$yday[df_temps_order$year == i],
        df_temps_order$mean_exp[df_temps_order$year == i], lty = 1, lwd = 0.75, col = col_alpha_black)
  
  lines(df_temps_order$yday[df_temps_order$year == i],
        df_temps_order$moonlight_exposure[df_temps_order$year == i], lty = 1, lwd = 0.75, col = "red")

}
mtext(side = 1,text = "Calendar year day",outer = TRUE,line = 2)
mtext(side = 2,text = expression("Moonlight exposure"),outer = TRUE,line = 2)
legend("bottomright", legend = c("Moonlight exposure","1981 - 2019 mean daily moonlight exposure\nand 95 percentile range"),
       col = c("red",col_alpha_black),pt.lwd = c(NA,1),
       lty = c(NA,1),lwd = c(NA,1),
       pch = c(15,15),bty = "n",
       inset = c(0.1,-2.5),
       xpd = NA, cex = 1.3)
dev.off()
```

```{r lunar-solar-data-2-eel, out.width="70%", eval=FALSE, fig.align = 'center', fig.cap = "\\textit{(Clear-sky) Moonlight exposure estimated for the Burrishoole catchment calculated using suncalc::getSunlightTimes, \\textnormal{suncalc::getMoonIllumination} and \\textnormal{suncalc::getMoonPosition}.}", echo = FALSE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/eel_wflow_figs/")
knitr::include_graphics(path = paste0(dirName,"lunar_solar_data-3-eel.png"))
```

## (1c) Access climate data

```{r access-climate-data, eval=FALSE, echo = FALSE}
# ---------------------------------------------------------------------------------------------------------- #
# LOCAL OBSERVATIONS (see: data-raw/data_met_obs/..)  ----
fishcastr::download_Met_Eireann_station_data()

# GRID PSEUDO-OBSERVATIONS FOR GAP FILLING ----
library(rJava)
fishcastr::download_EWEMBI()

# run script to identify gaps in local observed data and fill with EWEMBI or linearly interpolate ----
source(file = paste0(system.file("extdata", package = "fishcastr"),
                     "/01_data_grid_met_obs_1979_2019.R"))

# gap filled data
grid_met_obs_1979_2019 <- readRDS(file = paste0(system.file("extdata",
                                                        package = "fishcastr"),
                                            "/grid_met_obs_1979_2019.rds"))
data_met_obs_1979_2019 <- fishcastr::convert_grid_to_dataframe(grid_obj = grid_met_obs_1979_2019)[,-2]
names(data_met_obs_1979_2019)[1] <- "date"

# plot to identify any outliers if present.
# visualizeR::temporalPlot(... = grid_met_obs_1979_2019$tas)

# manual station data with gaps
data_met_obs_1979_2019 <- readRDS(file = paste0(system.file("extdata",
                                                        package = "fishcastr"),
                                            "/data_met_manual_station_1959_2019.rds"))

data_met_obs_1979_2019$petH_manual <- fishcastr::potential_ev_HS(data_met_obs_1979_2019$tas_min_manual,
                                                                 tasmax = data_met_obs_1979_2019$tas_max_manual,
                                                                 refdates = data_met_obs_1979_2019$date,
                                                                 lats = 53.932458)
# plot manual station data
label_text <- list("tas" = list("var" = "tas_manual",
                                "lab" = expression("Mean daily air temperature ("*~degree*C*")"),
                                "legend_lab" = "Mean daily air temperature",
                                "col" = "red"),
                   "pr" = list("var" = "pr_manual",
                                "lab" = expression("Total daily precipitation (mm)"),
                                "legend_lab" = "Total daily precipitation",
                                "col" = "blue"),
                   "petH" = list("var" = "petH_manual",
                                "lab" = expression("Daily potential evapotranspiration (mm)"),
                                "legend_lab" = "Daily potential evapotranspiration",
                                "col" = "darkblue"))

lapply(label_text, function(x){
data_met_obs_df <- data.frame("date" = data_met_obs_1979_2019[["date"]],
                            "tas" = data_met_obs_1979_2019[[x[[1]]]])

data_met_obs_df$year <-lubridate::year(data_met_obs_df$date)
data_met_obs_df$yday <-lubridate::yday(data_met_obs_df$date)

# calculate average per year day
mean_met <- tapply(data_met_obs_df$tas,INDEX = data_met_obs_df$yday,FUN = mean,na.rm = TRUE)
lower_pct <- tapply(data_met_obs_df$tas,INDEX = data_met_obs_df$yday,FUN = quantile, probs = 0.025,na.rm = TRUE)
upr_pct <- tapply(data_met_obs_df$tas,INDEX = data_met_obs_df$yday,FUN = quantile,probs = 0.975,na.rm = TRUE)
df_mean <- data.frame("yday" = names(mean_met),
                        "mean_exp" = as.vector(mean_met),
                        "lwr" = as.vector(lower_pct),
                        "upr" = as.vector(upr_pct))
df_met <- merge(data_met_obs_df,df_mean, by = "yday",all.x = TRUE)
df_met_order <- df_met[order(df_met$date),]

# set plot colours
rgb_col <- col2rgb("black")
col_alpha_black <- rgb(red = rgb_col[1], green = rgb_col[2], blue = rgb_col[3],
                             alpha = 50, maxColorValue = 255)

dirName <- paste0(system.file("extdata", package = "fishcastr"),"/eel_wflow_figs/")
png(filename = paste0(dirName,"access_climate_data-1-eel_",x,".png"), height = 2300, width = 1500, res =300)
par(mfcol = c(13,3),oma = c(8,4,1,1), mar = c(0.5,0.5,0.1,0.1))
for(i in 1981:2019) {
  ylims <- c(0,max(c(max(df_met_order$upr[df_met_order$year == i],na.rm = TRUE),
                   max(df_met_order$tas[df_met_order$year == i], na.rm = TRUE))))
  xlims <- c(1,365)
  plot(df_met_order$yday[df_met_order$year == i],
       df_met_order$mean_exp[df_met_order$year == i], col = NULL, ylim = ylims,xlab = "", ylab = "",xaxt = "n",yaxt = "n", xlim = xlims)
  title(main = i,adj = 0.9, line = -1)
  if(i %in% c(1993,2006,2019)){
    axis(side = 1, tck = 0.1)
  }
    if(i %in% c(1981:1993)){
    axis(side = 2, tck = 0.1)
    }
  # polygons
  fishcastr::step_style_polygon(xvals = df_met_order$yday[df_met_order$year == i],
                     y_vals_low = df_met_order$lwr[df_met_order$year == i],
                     y_vals_up = df_met_order$upr[df_met_order$year == i],
                     col_alpha_rgb = col_alpha_black, border = NA)

    lines(df_met_order$yday[df_met_order$year == i],
        df_met_order$mean_exp[df_met_order$year == i], lty = 1, lwd = 0.75, col = col_alpha_black)
  
  lines(df_met_order$yday[df_met_order$year == i],
        df_met_order$tas[df_met_order$year == i], lty = 1, lwd = 0.75, col = x[[4]])

}
mtext(side = 1,text = "Calendar year day",outer = TRUE,line = 2)
mtext(side = 2,text = x[[2]],outer = TRUE,line = 2)
legend("bottomright", legend = c(x[[3]],
                                 paste0("1981 - 2019 ", x[[3]],"\nand 95 percentile range")),
       col = c(x[[4]],col_alpha_black),pt.lwd = c(NA,1),
       lty = c(1,1),lwd = c(1,1),
       pch = c(NA,15),bty = "n",
       inset = c(0.1,-2.5),
       xpd = NA, cex = 1.3)
dev.off()
})

# ---------------------------------------------------------------------------------------------------------- #
# REANALYSIS (see: data-raw/grid_ERA5_reforecasts/..) ----
# raw grid (Re-forecasts and archived operational forecast years; 1993 - 2019)
grid_ERA5_1979_2019_Jun_bc <- fishcastr::grid_ERA5_1979_2019_Jun_bc
#visualizeR::temporalPlot(... = grid_ERA5_1979_2019_Jun_raw$tas)
data_ERA5_1979_2019_Jun_bc <- fishcastr::convert_grid_to_dataframe(grid_obj = grid_ERA5_1979_2019_Jun_bc)

# plot reanalysis data
label_text <- list("tas" = list("var" = "tas",
                                "lab" = expression("Mean 2m air temperature ("*~degree*C*")"),
                                "legend_lab" = "Mean 2m air temperature",
                                "col" = "red"),
                   "pr" = list("var" = "pr",
                                "lab" = expression("Total daily precipitation (mm)"),
                                "legend_lab" = "Total daily precipitation",
                                "col" = "blue"),
                   "petH" = list("var" = "petH",
                                "lab" = expression("Daily potential evapotranspiration (mm)"),
                                "legend_lab" = "Daily potential evapotranspiration",
                                "col" = "darkblue"))

lapply(label_text, function(x){
data_met_obs_df <- data.frame("date" = data_ERA5_1979_2019_Jun_bc[["dates1"]],
                            "tas" = data_ERA5_1979_2019_Jun_bc[[x[[1]]]])

data_met_obs_df$year <-lubridate::year(data_met_obs_df$date)
data_met_obs_df$yday <-lubridate::yday(data_met_obs_df$date)

# calculate average per year day
mean_met <- tapply(data_met_obs_df$tas,INDEX = data_met_obs_df$yday,FUN = mean,na.rm = TRUE)
lower_pct <- tapply(data_met_obs_df$tas,INDEX = data_met_obs_df$yday,FUN = quantile, probs = 0.025,na.rm = TRUE)
upr_pct <- tapply(data_met_obs_df$tas,INDEX = data_met_obs_df$yday,FUN = quantile,probs = 0.975,na.rm = TRUE)
df_mean <- data.frame("yday" = names(mean_met),
                        "mean_exp" = as.vector(mean_met),
                        "lwr" = as.vector(lower_pct),
                        "upr" = as.vector(upr_pct))
df_met <- merge(data_met_obs_df,df_mean, by = "yday",all.x = TRUE)
df_met_order <- df_met[order(df_met$date),]

# set plot colours
rgb_col <- col2rgb("black")
col_alpha_black <- rgb(red = rgb_col[1], green = rgb_col[2], blue = rgb_col[3],
                             alpha = 50, maxColorValue = 255)

dirName <- paste0(system.file("extdata", package = "fishcastr"),"/eel_wflow_figs/")
png(filename = paste0(dirName,"access_climate_data-2-eel_",x,"_reanalysis.png"), height = 2300, width = 1500, res =300)
par(mfcol = c(13,3),oma = c(8,4,1,1), mar = c(0.5,0.5,0.1,0.1))
for(i in 1981:2019) {
  ylims <- c(0,max(c(max(df_met_order$upr[df_met_order$year == i],na.rm = TRUE),
                   max(df_met_order$tas[df_met_order$year == i], na.rm = TRUE))))
  xlims <- c(1,365)
  plot(df_met_order$yday[df_met_order$year == i],
       df_met_order$mean_exp[df_met_order$year == i], col = NULL, ylim = ylims,xlab = "", ylab = "",xaxt = "n",yaxt = "n", xlim = xlims)
  title(main = i,adj = 0.9, line = -1)
  if(i %in% c(1993,2006,2019)){
    axis(side = 1, tck = 0.1)
  }
    if(i %in% c(1981:1993)){
    axis(side = 2, tck = 0.1)
    }
  # polygons
  fishcastr::step_style_polygon(xvals = df_met_order$yday[df_met_order$year == i],
                     y_vals_low = df_met_order$lwr[df_met_order$year == i],
                     y_vals_up = df_met_order$upr[df_met_order$year == i],
                     col_alpha_rgb = col_alpha_black, border = NA)

    lines(df_met_order$yday[df_met_order$year == i],
        df_met_order$mean_exp[df_met_order$year == i], lty = 1, lwd = 0.75, col = col_alpha_black)
  
  lines(df_met_order$yday[df_met_order$year == i],
        df_met_order$tas[df_met_order$year == i], lty = 1, lwd = 0.75, col = x[[4]])

}
mtext(side = 1,text = "Calendar year day",outer = TRUE,line = 2)
mtext(side = 2,text = x[[2]],outer = TRUE,line = 2)
legend("bottomright", legend = c(x[[3]],
                                 paste0("1981 - 2019 ", x[[3]],"\nand 95 percentile range")),
       col = c(x[[4]],col_alpha_black),pt.lwd = c(NA,1),
       lty = c(1,1),lwd = c(1,1),
       pch = c(NA,15),bty = "n",
       inset = c(0.1,-2.5),
       xpd = NA, cex = 1.3)
dev.off()
})

# ---------------------------------------------------------------------------------------------------------- #
# SEASONAL CLIMATE FORECAST (Re-forecasts and archived operational forecasts 1993 - 2019) ----
# (see: data-raw/grid_SEAS5_reforecasts/..)
grid_SEAS5_1993_2019_7_8_9_10_11_12_tas_pr_petH_bc <- fishcastr::grid_SEAS5_1993_2019_7_8_9_10_11_12_tas_pr_petH_bc
data_SEAS5_1993_2019_7_8_9_10_11_12_tas_pr_petH_bc <- fishcastr::convert_grid_to_dataframe(grid_obj = grid_SEAS5_1993_2019_7_8_9_10_11_12_tas_pr_petH_bc)

label_text <- list("tas" = list("var" = "tas",
                                "lab" = expression("Mean 2m air temperature ("*~degree*C*")"),
                                "legend_lab" = "Mean 2m air temperature",
                                "col" = "red"),
                   "pr" = list("var" = "pr",
                                "lab" = expression("Total daily precipitation (mm)"),
                                "legend_lab" = "Total daily precipitation",
                                "col" = "blue"),
                   "petH" = list("var" = "petH",
                                "lab" = expression("Daily potential evapotranspiration (mm)"),
                                "legend_lab" = "Daily potential evapotranspiration",
                                "col" = "darkblue"))

lapply(label_text, function(x){
  # convert data to single dataframe for each variable
data_SEAS_tas <- lapply(data_SEAS5_1993_2019_7_8_9_10_11_12_tas_pr_petH_bc,function(y){y[[x[[1]]]]})
data_SEAS_tas_tab <- data.frame("date" = data_SEAS5_1993_2019_7_8_9_10_11_12_tas_pr_petH_bc[[1]][["dates1"]],
                                as.data.frame(do.call(cbind,data_SEAS_tas)))
data_SEAS_tas_tab$yday <- lubridate::yday(data_SEAS_tas_tab$date)
data_SEAS_tas_tab$date <- NULL

# cast to long format retaining ydays
longform <- tidyr::pivot_longer(data_SEAS_tas_tab,
                                cols=c(paste0("V",1:25)),
                                names_to = "member", values_to = x[[1]])

mean_met <- tapply(longform[[x[[1]]]],INDEX = longform$yday,FUN = mean,na.rm = TRUE)
lower_pct <- tapply(longform[[x[[1]]]],INDEX = longform$yday,FUN = quantile, probs = 0.025,na.rm = TRUE)
upr_pct <- tapply(longform[[x[[1]]]],INDEX = longform$yday,FUN = quantile,probs = 0.975,na.rm = TRUE)
#plot(1:213,mean_met,type = "l", ylim = c(0,20))
#lines(1:213,lower_pct)
#lines(1:213,upr_pct)

data_SEAS_tas_tab_dat <- data.frame("date" = data_SEAS5_1993_2019_7_8_9_10_11_12_tas_pr_petH_bc[[1]][["dates1"]],
                                    "yday" = lubridate::yday(data_SEAS5_1993_2019_7_8_9_10_11_12_tas_pr_petH_bc[[1]][["dates1"]]),
                                as.data.frame(do.call(cbind,data_SEAS_tas)))

df_mean <- data.frame("yday" = names(mean_met),
                        "mean_exp" = as.vector(mean_met),
                        "lwr" = as.vector(lower_pct),
                        "upr" = as.vector(upr_pct))
df_met <- merge(data_SEAS_tas_tab_dat,df_mean, by = "yday",all.x = TRUE)
df_met_order <- df_met[order(df_met$date),]
df_met_order$year <- lubridate::year(df_met_order$date)

# plot seasonal climate forecast data with backdrop of historic forecast
# averages (although note the calculated back drop are calculated from all
# forecast members (e.g., mean and percentiles) and are analogous to climatology
# because the SEAS5 is calibrated and data have been bias corrected.

# set plot colours
rgb_col <- col2rgb("black")
col_alpha_black <- rgb(red = rgb_col[1], green = rgb_col[2], blue = rgb_col[3],
                             alpha = 30, maxColorValue = 255)
rgb_col <- col2rgb(x[[4]])
col_alpha_red <- rgb(red = rgb_col[1], green = rgb_col[2], blue = rgb_col[3],
                             alpha = 30, maxColorValue = 255)

dirName <- paste0(system.file("extdata", package = "fishcastr"),"/eel_wflow_figs/")
png(filename = paste0(dirName,"access_climate_data-3-eel_",x,"_SF.png"), height = 1700, width = 1700, res =300)
par(mfcol = c(9,3),oma = c(8,4,1,1), mar = c(0.5,0.5,0.1,0.1))
for(i in 1993:2019) {
  ylims <- c(0,max(c(max(df_met_order$upr[df_met_order$year == i],na.rm = TRUE),
                   max(df_met_order[df_met_order$year == i,c(3:27)], na.rm = TRUE))))
  xlims <- c(min(df_met_order$yday),max(df_met_order$yday))
  plot(df_met_order$yday[df_met_order$year == i],
       df_met_order$mean_exp[df_met_order$year == i], col = NULL, ylim = ylims,xlab = "", ylab = "",xaxt = "n",yaxt = "n", xlim = xlims)
  
  if(x[[1]] %in% c("tas","petH")){
  title(main = i,adj = 0.9, line = -1)
  }
    if(x[[1]] == "pr"){
  title(main = i,adj = 0.1, line = -1)
  }
    
  if(i %in% c(2001,2010,2019)){
    axis(side = 1, tck = 0.1)
  }
    if(i %in% c(1993:2001)){
    axis(side = 2, tck = 0.1)
    }
  # polygons
  fishcastr::step_style_polygon(xvals = df_met_order$yday[df_met_order$year == i],
                     y_vals_low = df_met_order$lwr[df_met_order$year == i],
                     y_vals_up = df_met_order$upr[df_met_order$year == i],
                     col_alpha_rgb = col_alpha_black, border = NA)

    lines(df_met_order$yday[df_met_order$year == i],
        df_met_order$mean_exp[df_met_order$year == i], lty = 1, lwd = 0.75, col = col_alpha_black)
  
    for(j in 3:27){
  lines(df_met_order$yday[df_met_order$year == i],
        df_met_order[df_met_order$year == i,j], lty = 1, lwd = 0.75, col = col_alpha_red)
}
      
}
mtext(side = 1,text = "Calendar year day",outer = TRUE,line = 2)
mtext(side = 2,text = x[[2]],outer = TRUE,line = 2)
legend("bottomright", legend = c(x[[3]],
                                 paste0("1993 - 2019 ", x[[3]],"\nand 95 percentile range")),
       col = c(x[[4]],col_alpha_black),pt.lwd = c(NA,1),
       lty = c(1,1),lwd = c(1,1),
       pch = c(NA,15),bty = "n",
       inset = c(0.1,-2.5),
       xpd = NA, cex = 1.3)
dev.off()
})

#visualizeR::temporalPlot(... = data_SEAS5_1993_2019_7_8_9_10_11_12_tas_pr_petH_bc$pr)
```

<!-- ### Local met station -->

```{r access-climate-data-1-eel-tas, out.width="70%", eval=FALSE, fig.align = 'center', fig.cap = "\\textit{Recorded mean daily air temperature at the manual meteorological station in Burrishoole (relative to 1981 - 2019 average).}", echo = FALSE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/eel_wflow_figs/")
knitr::include_graphics(path = paste0(dirName,"access_climate_data-1-eel_tas_manual.png"))
```

```{r access-climate-data-1-eel-pr, out.width="70%", eval=FALSE, fig.align = 'center',fig.cap = "\\textit{Recorded daily total precipitation at the manual meteorological station in Burrishoole (relative to 1981 - 2019 average).}", echo = FALSE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/eel_wflow_figs/")
knitr::include_graphics(path = paste0(dirName,"access_climate_data-1-eel_pr_manual.png"))
```

```{r accessclimate-data-1-eel-petH, out.width="70%", eval=FALSE, fig.align = 'center',fig.cap = "\\textit{Estimated daily potential evapotranspiration in Burrishoole estimated using the Hargreaves-Samani equation (relative to 1981 - 2019 average).}", echo = FALSE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/eel_wflow_figs/")
knitr::include_graphics(path = paste0(dirName,"access_climate_data-1-eel_petH_manual.png"))
```

### *Climate reanalysis*

For each retrospective seasonal eel migration forecast, we append two years (antecedent) bias adjusted ERA5 climate reanalysis up to the end of June to SEAS5 seasonal climate forecasts from July to December - hence the cessation of ERA5 data in mid-2019 illustrated in **Figure \@ref(fig:access-climate-data-2-eel-tas)**. The data presented here are bias adjusted relative to local meteorological observations; therefore, the long run average climate illustrated by shading of **Figure \@ref(fig:access-climate-data-2-eel-tas)** are consistent with meteorological observation long run averages.

```{r access-climate-data-2-eel-tas, out.width="70%", eval = TRUE, fig.align = 'center', fig.cap = "(ref:access-climate-data-2-eel-tas)", echo = FALSE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/eel_wflow_figs/")
knitr::include_graphics(path = paste0(dirName,"access_climate_data-2-eel_tas_reanalysis.png"))
```

(ref:access-climate-data-2-eel-tas) *Bias adjusted ECMWF ERA5 modelled mean daily air temperature at 2m (calculated from hourly resolution ERA5) in Burrishoole (relative to 1981 - 2019 average).*

```{r access-climate-data-2-eel-pr, out.width="70%", eval=FALSE, fig.align = 'center',fig.cap = "\\textit{Bias adjusted ECMWF ERA5 modelled daily total precipitation in Burrishoole (relative to 1981 - 2019 average).}", echo = FALSE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/eel_wflow_figs/")
knitr::include_graphics(path = paste0(dirName,"access_climate_data-2-eel_pr_reanalysis.png"))
```

```{r access-climate-data-2-eel-petH, out.width="70%", eval=FALSE, fig.align = 'center', fig.cap = "\\textit{Hargreaves-Samani equation estimated daily potential evapotranspiration calculated from ECMWF ERA5 modelled daily minimum and maximum temperatures (extracted from hourly resolution ERA5) in Burrishoole (relative to 1981 - 2019 average).}", echo = FALSE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/eel_wflow_figs/")
knitr::include_graphics(path = paste0(dirName,"access_climate_data-2-eel_petH_reanalysis.png"))
```

### *Seasonal climate forecast*

We accessed SEAS5 seasonal climate forecasts initialised on July 1 from which we retained data up to December 31. **Figure \@ref(fig:access-climate-data-3-eel-tas)** illustrates ensemble spread relative to long run average (1993 - 2019) ensemble spread; that is, following bias adjustment, long run average ensemble spread (illustrated by shading in **Figure \@ref(fig:access-climate-data-3-eel-tas)**) is consistent with long run average climate calculated from local meteorological observations.

```{r access-climate-data-3-eel-tas, out.width="70%", eval = TRUE, fig.align = 'center', fig.cap = "(ref:access-climate-data-3-eel-tas)", echo = FALSE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/eel_wflow_figs/")
knitr::include_graphics(path = paste0(dirName,"access_climate_data-3-eel_tas_SF.png"))
```

(ref:access-climate-data-3-eel-tas) *Bias adjusted ECMWF SEAS5 modelled mean daily air temperature at 2m (aggregated from 6-hourly resolution SEAS5) in Burrishoole (relative to 1993 - 2019 average).*

```{r access-climate-data-3-eel-pr, out.width="70%", eval=FALSE, fig.align = 'center', fig.cap = "\\textit{ECMWF SEAS5 modelled daily total precipitation in Burrishoole (relative to 1993 - 2019 average).}",echo = FALSE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/eel_wflow_figs/")
knitr::include_graphics(path = paste0(dirName,"access_climate_data-3-eel_pr_SF.png"))
```

```{r access-climate-data-3-eel-petH, out.width="70%", eval=FALSE, fig.align = 'center', fig.cap = "\\textit{Hargreaves-Samani equation estimated daily potential evapotranspiration calculated from ECMWF SEAS modelled daily minimum and maximum temperatures (extracted from 6-hourly resolution SEAS5) in Burrishoole (relative to 1993 - 2019 average).}",echo = FALSE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/eel_wflow_figs/")
knitr::include_graphics(path = paste0(dirName,"access_climate_data-3-eel_petH_SF.png"))
```

## (1d) Pre-process climate data

See **Appendix S1: Section 1d** for calculation of potential evapotranspiration and climate variable bias adjustment.

# (2) MODEL CHAIN DEVELOPMENT

<!-- ## (2a) Model hydrology and water temperature -->

See **Appendix S1: Section 2a** for hydrologic model and air to water temperature model calibration details.

```{r model-hydrology-water-temp, eval=FALSE, echo = FALSE}
# ---------------------------------------------------------------------------------------------------------- #
# CALIBRATE CATCHMENT DISCHARGE MODEL (see: data_raw/model_GR4J_calibration.R) ----
GR4J_Burr_params_ERA5_bcc <- fishcastr::GR4J_Burr_params_ERA5_bcc

calibration_validation_stats_GR4J <- readRDS(file = paste0(system.file("extdata",
                                                        package = "fishcastr"),
                                            "/vignette_figures/hydrologic_model/GR4J_cal_val_stats.rds"))

# ---------------------------------------------------------------------------------------------------------- #
# CALIBRATE WATER TEMPERATURE MODEL (see: data_raw/model_air_to_water_calibration.R) ----
air_to_water_Feeagh_params_ERA5_bcc <- fishcastr::air_to_water_Feeagh_params_ERA5_bcc

calibration_validation_stats_air_to_water_temp <- readRDS(file = paste0(system.file("extdata",
                                                        package = "fishcastr"),
                                            "/vignette_figures/air_water_temp_model/air_water_temp_val_stats.rds"))
```

## (2b) Model proxy for migration preparedness

The factors associated with the onset of active migration of silver eels that occurs during the final stages of silvering are unclear [@durif_silvering_2005], which makes derivation of a proxy variable for migration preparedness for sea entry of silver eels speculative. However, as a conceptual starting point, we propose that photoperiod-weighted degree days (after the winter solstice) are associated with factors that describe progression from pre-migratory to silver phase; e.g., through accumulation of total carcass fats related to increased feeding opportunities, which has been observed to correlate with gonad weight [@van_ginneken_silvering_2007], and or other temperature mediated physiological activity associated with silvering. In this case, inter-annual variability in accumulation of photoperiod-weighted degree days might plausibly relate to inter-annual variation of the temporal window during which progression to active migration might occur (where active migration is triggered by sub-seasonal environmental factors).

We assume that sub seasonal time scale variables, such as average rate of change in temperature over the preceding 20 days might plausibly associate with attainment of the migratory silvering phase because a decline in temperature may be indicative of declining feeding opportunities and therefore correlate with gut regression observed in silver eels (vs. yellow eels) [@van_ginneken_silvering_2007]. It is plausible that eels will start to migrate as feeding opportunities begin to decrease, as this would maximise retention of fat stores accumulated through spring and summer feeding (although see @svedang_low_1997 for discussion of low fat content in ostensibly seaward migrating silver eels, and @aarestrup_survival_2008 for discussion of near coast residency in early marine phase of spring migrating silver eels). An alternative conceptual starting point could be that the window during which eels have propensity to migrate is inter-annually consistent (at the individual catchment level), and that inter-annual variation in timing of migration is solely associated with day-to-day variation in the tolerability of migration conditions, which seems less plausible, at least in Burrishoole, given the apparently increasingly earlier onset of silver eel migrations [@sandlund_timing_2017].

Further complicating matters, if fat reserves are a determining factor in the transformation from pre-migrant to migrant, it is also possible that increasingly earlier onset of silver eel migrations in Burrishoole are related to increased feeding opportunities (or other physiological activity related to silvering) during the preceding autumn through winter (not just feeding opportunities following winter solstice immediately prior to the year an individual ultimately migrates, as implied by our methods). Under the fat reserves assumption, autumn through winter feeding could theoretically allow eels to attain sufficient condition earlier in the calendar year and leave freshwater earlier (i.e., prior to late summer).

Descriptions of model functional form and fitting procedure may be found in **Appendix S1: Section 2b**. Below, **Figure \@ref(fig:model-proxy-preparedness-1-eel)** illustrates the extent of consistency between fitted "migration preparedness" model simulations and observations of standardised (scaled) daily counts vs. photoperiod-weighted degree days. In **Figure \@ref(fig:model-proxy-preparedness-2-eel)**, we present model checking plots.

```{r model-proxy-preparedness, eval=FALSE, echo = FALSE}
# ---------------------------------------------------------------------------------------------------------- #
# CALIBRATE MIGRATION PREPAREDNESS MODEL (see: data_raw/model_physio_expmG_eel_calibration.R) ----
model_physio_expmG_inv_eel <- fishcastr::model_physio_expmG_inv_eel
```

```{r model-proxy-preparedness-1-eel, out.width="60%", eval = TRUE, fig.align = 'center', fig.cap = "(ref:model-proxy-preparedness-1-eel)", echo = FALSE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/migration_prep_models/eel/")
knitr::include_graphics(path = paste0(dirName,"genpois_eel.png"))
```

(ref:model-proxy-preparedness-1-eel) *Fitted inverted exponentially modified Gaussian relationship between photoperiod-weighted degree days and scaled daily counts of European silver eel (*A. anguilla*) recorded in the freshwater outflow traps of the Burrishoole catchment. Observations are colour-faceted by decade and are illustrated relative to the positive y axis. Simulations from the model fitted to data from 1981 - 1992 are mirrored on the negative y axis.*

```{r model-proxy-preparedness-2-eel, fig.show = "hold", out.width="40%", eval = TRUE, fig.align = 'center', fig.cap = "(ref:model-proxy-preparedness-2-eel)", echo = FALSE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/migration_prep_models/eel/val_plots/")
knitr::include_graphics(path = paste0(dirName,"resid_fitted.png"))
knitr::include_graphics(path = paste0(dirName,"dispersion.png"))
knitr::include_graphics(path = paste0(dirName,"param_profiles.png"))
```

(ref:model-proxy-preparedness-2-eel) *Model checking plots for fitted inverted exponentially modified Gaussian relationship between photoperiod-weighted degree days and scaled daily counts of European silver eel (*A. anguilla*) recorded in the freshwater outflow traps of the Burrishoole catchment.*

## (2c) Model fish counts

### *Calculate predictors*

Prior to fitting glmmTMB models, we pre-processed the raw and model derived catchment environmental data included in `fishcastr`. Pre-processing steps included stratification of eel forecast years, log transformation of positive skewed predictors (moonlight exposure, discharge and migration preparedness). We included both the log transformed and non-transformed data of these three "likely candidates" in the initial modelling dataset, as it was not clear form the outset whether transformations would improve statistical fit and or computation of the fitting procedure.

```{r calculate-predictors,eval = FALSE, echo = FALSE}
# ---------------------------------------------------------------------------------------------------------- #
# IMPORT BIAS ADJUSTED METEOROLOGICAL DATA -----
# ---------------------------------------------------------------------------------------------------------- #
data_ERA5_1979_2019_Jun_bc <- fishcastr::convert_grid_to_dataframe(grid_obj = fishcastr::grid_ERA5_1979_2019_Jun_bc)[,-2]
names(data_ERA5_1979_2019_Jun_bc)[which(names(data_ERA5_1979_2019_Jun_bc) == "dates1")] <- "date"

# ---------------------------------------------------------------------------------------------------------- #
# RUN AIR TO WATER TEMP MODEL -----
# ---------------------------------------------------------------------------------------------------------- #
data_water_temp <- data.frame(
  "date" = data_ERA5_1979_2019_Jun_bc$date,
  "water_temp" = fishcastr::air_to_water_model(
    Ta = data_ERA5_1979_2019_Jun_bc$tas,
    Yday = lubridate::yday(data_ERA5_1979_2019_Jun_bc$date),
    A = fishcastr::air_to_water_Feeagh_params_ERA5_bcc$A,
    ac = fishcastr::air_to_water_Feeagh_params_ERA5_bcc$ac,
    b = fishcastr::air_to_water_Feeagh_params_ERA5_bcc$b,
    B = fishcastr::air_to_water_Feeagh_params_ERA5_bcc$B
  )
)

# ---------------------------------------------------------------------------------------------------------- #
# RUN HYDROLOGIC MODEL ----
# ---------------------------------------------------------------------------------------------------------- #
data_discharge <- fishcastr::hydrologic_model(met_data = data_ERA5_1979_2019_Jun_bc[,c("date","pr","petH")] ,
                                              warm_up_dates_range = c(as.Date("1979-01-01"),
                                                                     as.Date("1980-12-20")),
                                              run_dates_range = c(as.Date("1980-12-21"),
                                                                 as.Date("2019-06-30")),
                                              GR4J_params = as.numeric(fishcastr::GR4J_Burr_params_ERA5_bcc),
                                              log_transform = FALSE)

ln_data_discharge <- data.frame("date" = data_discharge$date,
                                "ln_discharge" = log(data_discharge$discharge))

# ---------------------------------------------------------------------------------------------------------- #
# ESTIMATE MIGRATION PREPAREDNESS ----
# ---------------------------------------------------------------------------------------------------------- #

# stratify forecast years and retain photoperiod
data_seel_forecast_years <- fishcastr::bio_year_therm(mean_temp = data_water_temp$water_temp,
                                                      dates = data_water_temp$date,
                                                      biofix_temp = 11,
                                                      min_no_days_above_biofix = 10,
                                                      increasing_temp = TRUE,
                                                      yday_head = "eel_yday",
                                                      bio_year_head = "eel_year",
                                                      days_since_earliest_biofix_head = "eel_yday_biofix",
                                                      incomplete_first_year = 1978,
                                                      start_previous_calendar_year = FALSE)
names(data_seel_forecast_years)[which(names(data_seel_forecast_years) == "meanT")] <- "water_temp"

data_seel_forecast_years$photoper <- fishcastr::photper_calc(dates = data_seel_forecast_years$date,
                                                             latitude = 53.932458,
                                                             longitude = -9.575556)

# subset water temp to same dates as eel years
data_water_temp <- data_water_temp[data_water_temp$date %in% c(data_seel_forecast_years$date),]

# calculate photoperiod weighted degree days from specified solstice dates
pwdds <- fishcastr::convert_stratified_census_data_to_model_warmup_list(
  water_temp = data_water_temp$water_temp,
  photoper = data_seel_forecast_years$photoper,
  forecast_years = data_seel_forecast_years$eel_year,
  forecast_yday = data_seel_forecast_years$eel_yday_biofix,
  dates = data_seel_forecast_years$date,
  no_years_warmup = 1,
  delete_op_year = TRUE
)

# convert photoperiod weighted degree days to proxy preparedness variable
migration_preparedness <- data.frame("date"= pwdds$date, "migration_prep" =
  fishcastr::exp_mod_Gaussian_resp_inv(
    x = pwdds$weighted_dds_water,
    c = fishcastr::model_physio_expmG_inv_eel$coefs["c"],
    mu_exmg = fishcastr::model_physio_expmG_inv_eel$coefs["mu_exmg"],
    sigma_exmg = fishcastr::model_physio_expmG_inv_eel$coefs["sigma_exmg"],
    lamb = fishcastr::model_physio_expmG_inv_eel$coefs["lamb"]
  ))

ln_migration_preparedness <- data.frame("date"= pwdds$date, "ln_migration_prep" =
  log(migration_preparedness$migration_prep))

# ---------------------------------------------------------------------------------------------------------- #
# ESTIMATE MOONLIGHT EXPOSURE ----
# ---------------------------------------------------------------------------------------------------------- #
data_lunar <- data.frame("date"= migration_preparedness$date,
                         "moonlight_exposure" = fishcastr::lunar_light_exposure(log_result = FALSE, date_of_interest = migration_preparedness$date,
                                                                                lat = 53.932458,
                                                                                lon = -9.575556))
ln_data_lunar <- data.frame("date"= migration_preparedness$date,
                         "ln_moonlight_exposure" = fishcastr::lunar_light_exposure(log_result = TRUE, date_of_interest = migration_preparedness$date,
                                                                                lat = 53.932458,
                                                                                lon = -9.575556))

# -------------------------------------------------------------------------------------------------- #
# ADD DELTA TEMPERATURE ----
# -------------------------------------------------------------------------------------------------- #
Delta_temp <- data.frame("date" = data_water_temp$date,
                         "Delta_temp" = fishcastr::delta_var(y = data_water_temp$water_temp,
                                                             react_time = 20))

# -------------------------------------------------------------------------------------------------- #
# ADD DELTA PHOTOPERIOD ----
# -------------------------------------------------------------------------------------------------- #
Delta_Photo <- data.frame("date" = data_seel_forecast_years$date,
                          "Delta_photo" = fishcastr::delta_var(y = data_seel_forecast_years$photoper,
                                                               react_time = 1))

# ---------------------------------------------------------------------------------------------------------- #
# IMPORT AND APPEND COUNT DATA TO FORECAST YEARS ENVIRONMENTAL DATA ----
# ---------------------------------------------------------------------------------------------------------- #
fishcastr::download_fish_data()
data_seel <- fishcastr::import_fish_data(species = "seel")

# Use Reduce function instead of merge...
data_seel_enviro_1981_2019 <- Reduce(function(x,y) merge(x,y,by="date"),
                                       list(data_seel,
                                            data_seel_forecast_years,
                                            data_discharge,
                                            ln_data_discharge,
                                            migration_preparedness,
                                            ln_migration_preparedness,
                                            data_lunar,
                                            ln_data_lunar,
                                            Delta_temp,
                                            Delta_Photo))

dirName <- paste0(system.file("extdata", package = "fishcastr"),"/vignette_data/")
dir.create(dirName, showWarnings = TRUE, mode = "0777")

 saveRDS(data_seel_enviro_1981_2019, file = paste0(dirName,"data_seel_enviro_1981_2019.rds"))
 rm(list = ls(all.names = TRUE))
 invisible(gc())
```

### *Refine model structure based on fit to historic data and check*

Prior to model fitting, we centred and scaled all explanatory variables with the aim of mitigating computational problems with model convergence (see [here](https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html) and [here](https://cran.r-project.org/web/packages/glmmTMB/vignettes/troubleshooting.html)).

Residual plots for models trained using data for 1981 - 1992 were used to refine model structure for silver eels (**Figure \@ref(fig:model-eel-counts-1981-1992-fit-eel-1)**). Residual plots for models trained using data for 1981 - 2018 were used to examine the extent to which the 1981- 1992 model structure remained appropriate for contemporary predictions (**Figure \@ref(fig:model-eel-counts-2019-fit-operational-eel-1)**).

```{r model-eel-counts-1981-1992-fit-model,eval = FALSE, echo = FALSE}
# ---------------------------------------------------------------------------------------------------------- #
# LOAD COUNT AND PREDICTOR DATA ----
# ---------------------------------------------------------------------------------------------------------- #
data_seel_enviro_1981_2019 <- readRDS(paste0(system.file("extdata",
                                                    package = "fishcastr"),
                                               "/vignette_data/data_seel_enviro_1981_2019.rds"))

names(data_seel_enviro_1981_2019)[which(names(data_seel_enviro_1981_2019) == "water_temp")] <- "Tw_mod"

# -------------------------------------------------------------------------------------------------- #
# SUBSET DATA TO 1981 - 1992 TO MAINTAIN OUT OF SAMPLE MODEL VALIDATION OF MODEL STRUCTURE ----
# -------------------------------------------------------------------------------------------------- #
# This step is carried out to reduce the risk of overfitting (model structure)
# to the test set. This does not reduce the risk of over-parameterizing the
# model for these data; rather, the aim is stop model re-structuring (relative
# to full model containing no predictor transformations) at the first point at
# which a statistically acceptable model is identified. Priorities for
# acceptability/validation:
# (i) limited set of plausible predictors and no more complex than three-way
# interactions (choice of predictors is set form the outset based on literature);
# (ii) linearity (predictors are transformed to remove patterns in residual vs.
# individual predictor plots);
# (iii) residual dispersion (over/under dispersion - important to get this right
# as using model simulations (and predictions) for forecasts) - here we move
# beyond Poisson to choose a conditional distribution of the response (daily
# count), e.g., negative binomial type I or II, or generalised Poisson (as these
# are implemented in glmmTMB);
# (iv) independence of errors (check for residual autocorrelation within and
# among years using ACF);
# (v) influential groups - check using plots of Cook's distance and dfbetas.
# After model checking as above, we want to assess out of sample predictive
# performance. We use leave-one-year-out cross-validation to refit the model
# sequentially for all years between 1981 to 2019, and we plot the model
# simulations for each year on top of observations to visually assess
# inconsistencies between simulated and observed data. ASSUMPTION - by using
# leave-one-year-out model fitting, we assume that the structure of model
# (derived from 1981 - 1992 fit) is consistent across time series, although it
# is possible that parameters (i.e., associations between counts and predictors)
# may vary through time.
# -------------------------------------------------------------------------------------------------- #

# -------------------------------------------------------------------------------------------------- #
# SUBSET DATA 1981 - 1992 ----
# DATA 1981 - 1992 (minus 1984 and 1989) ---- add two more years to make 12 training (same as salmonids)
# noting overlap with reforecast period, not at this stage (just 10 years to train)
# -------------------------------------------------------------------------------------------------- #
min_1981 <- min(data_seel_enviro_1981_2019$date[data_seel_enviro_1981_2019$eel_year == 1981])
max_1983 <- max(data_seel_enviro_1981_2019$date[data_seel_enviro_1981_2019$eel_year == 1983])
min_1985 <- min(data_seel_enviro_1981_2019$date[data_seel_enviro_1981_2019$eel_year == 1985])
max_1988 <- max(data_seel_enviro_1981_2019$date[data_seel_enviro_1981_2019$eel_year == 1988])
min_1990 <- min(data_seel_enviro_1981_2019$date[data_seel_enviro_1981_2019$eel_year == 1990])
max_1992 <- max(data_seel_enviro_1981_2019$date[data_seel_enviro_1981_2019$eel_year == 1992])

Train_data <- subset(
  data_seel_enviro_1981_2019,
  select = c(
    date,
    seel,
    eel_year,
    eel_yday_biofix,
    migration_prep,
    ln_migration_prep,
    moonlight_exposure,
    ln_moonlight_exposure,
    discharge,
    ln_discharge,
    Delta_temp,
    Delta_photo,
    photoper,
    Tw_mod
  ),
  subset = data.table::between(
    data_seel_enviro_1981_2019$date,
    lower = min_1981,
    upper = max_1983
  ) | data.table::between(
    data_seel_enviro_1981_2019$date,
    lower = min_1985,
    upper = max_1988
  ) | data.table::between(
    data_seel_enviro_1981_2019$date,
    lower = min_1990,
    upper = max_1992
  )
)


# -------------------------------------------------------------------------------------------------- #
# SCALE PREDICTORS AND CENTRE THOSE THAT HAVE NON-MEANINGFUL ZEROS (Here, just scale...) ----
# -------------------------------------------------------------------------------------------------- #
library(caret)
pP_params_train <- caret::preProcess(Train_data[,4:ncol(Train_data)], method = c("center","scale"))
Train_data_scaled_centred_train <- predict(object = pP_params_train, newdata = Train_data)

#dirName <- paste0(system.file("extdata", package = "fishcastr"), "/vignette_data/")
#saveRDS(Train_data_scaled_centred_train, file = paste0(dirName,"Train_data_scaled_centred_train.rds"))

# -------------------------------------------------------------------------------------------------- #
# FIT MODEL ----
# -------------------------------------------------------------------------------------------------- #
require(glmmTMB)
# model 1 all 2 way
# m1 <- glmmTMB::glmmTMB(seel ~ (migration_prep + discharge + moonlight_exposure + Tw_mod + Delta_temp)^2 + (1|eel_year),
#                                       poisson(link = "log"),
#                                       data=Train_data_scaled_centred_train)
# simulatedResiduals_m1 <- DHARMa::simulateResiduals(m1)
# par(mfrow = c(2,1))
# DHARMa::testDispersion(simulatedResiduals_m1)
# DHARMa::testZeroInflation(simulatedResiduals_m1)
# #dispersion okish but zero inflated and non-linearity for all but moonlight exposure
# # log skewed variables discharge, migration prep and change conditional distribution
# 
# # -------------------------------------------------------------------------------------------------- #
# # model 2 genpois
# m2 <- glmmTMB::glmmTMB(seel ~ (ln_discharge+ln_migration_prep + moonlight_exposure + Delta_temp + Tw_mod)^2 + (1|eel_year),
#                        genpois(link = "log"),
#                                       data=Train_data_scaled_centred_train)
# simulatedResiduals_m2 <- DHARMa::simulateResiduals(m2)
# par(mfrow = c(2,1))
# DHARMa::testDispersion(simulatedResiduals_m2)
# DHARMa::testZeroInflation(simulatedResiduals_m2)
# # ok, but non-linearity for temp

# -------------------------------------------------------------------------------------------------- #
# model 3 genpois quadratic temp
m3 <- glmmTMB::glmmTMB(seel ~ (Tw_mod + I(Tw_mod^2))*(ln_discharge+ln_migration_prep + moonlight_exposure + Delta_temp) + (ln_discharge+ln_migration_prep + moonlight_exposure + Delta_temp)^2 + (1|eel_year),
                                      genpois(link = "log"),
                                      data=Train_data_scaled_centred_train)
simulatedResiduals_m3 <- DHARMa::simulateResiduals(m3)
#par(mfrow = c(2,1))
#DHARMa::testDispersion(simulatedResiduals_m3)
#DHARMa::testZeroInflation(simulatedResiduals_m3)

# # model 3b check structure using poly
m3b <- glmmTMB::glmmTMB(seel ~ (ln_discharge+ln_migration_prep + moonlight_exposure + Delta_temp + poly(Tw_mod,2,raw = TRUE))^2  + (1|eel_year),
                                      genpois(link = "log"),
                                      data=Train_data_scaled_centred_train)
simulatedResiduals_m3b <- DHARMa::simulateResiduals(m3b)
summary(m3b)
par(mfrow = c(2,1))
DHARMa::testDispersion(simulatedResiduals_m3b)
DHARMa::testZeroInflation(simulatedResiduals_m3b)

# check effectively identical
effs <- (glmmTMB::fixef(m3))
effsb <- (glmmTMB::fixef(m3b))
param_diffs <- as.vector((signif(sort(effs$cond),3)) - signif(sort(effsb$cond),3))
# do the models produce effectively identical parameter estimates?
ifelse(all(param_diffs <= 0.00005), TRUE,FALSE)

 # extract equation in Tex form (not yet supporting glmers in master branch, but see glmer branch if desired - I suspect this package will become essential to multilvel modelling, particularly teaching!)
#devtools::install_github("datalorax/equatiomatic@glmer")
#remotes::install_github("datalorax/equatiomatic@glmer")
#lr <- lme4::glmer(seel ~ (ln_migration_prep + ln_discharge + moonlight_exposure + Tw_mod)^2 + (1|eel_year), data=Train_data_scaled_centred_train,family = poisson(link = "log"))
#equatiomatic::extract_eq(lr, wrap = TRUE, show_distribution = TRUE)

# -------------------------------------------------------------------------------------------------- #
# MODEL VALIDATION PLOTS FOR CHOSEN MODEL ------
# -------------------------------------------------------------------------------------------------- #
mod_check <- simulatedResiduals_m3
# Create vignette sub directories ------------------------------------------------------
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/vignette_figures/")
dir.create(dirName, showWarnings = TRUE, mode = "0777")

dirName <- paste0(system.file("extdata", package = "fishcastr"),"/vignette_figures/count_model_checks/")
dir.create(dirName, showWarnings = TRUE, mode = "0777")

dirName <- paste0(system.file("extdata", package = "fishcastr"),"/vignette_figures/count_model_checks/eel/")
dir.create(dirName, showWarnings = TRUE, mode = "0777")

png(file = paste0(dirName,'FigS5a.png'), width=2100, height=1200, res=300)
plot(mod_check, rank = T, smoothScatter = FALSE, quantreg = TRUE)
invisible(dev.off())

png(file = paste0(dirName,'FigS5b.png'), width=1800, height=2100, res=300)
par(mfrow = c(2,1), oma = c(0,0,0,0), mar = c(4,4,5,4))
# overdispersion
DHARMa::testDispersion(mod_check)
# zero inflation
DHARMa::testZeroInflation(mod_check)
invisible(dev.off())

# -------------------------------------------------------------------------------------------------- #
# NON-LINEARITY VALIDATION PLOTS (IF PATTERNS PRESENT IN FIT VS RESIDUALS) ----
# -------------------------------------------------------------------------------------------------- #
# individual predictors
png(file = paste0(dirName,'FigS5e.png'), width=2500, height=3200, res=300)
par(mfrow = c(3,2), mar = c(3.5,3.5,3.5,0.5),mgp = c(2.5,1,0))
DHARMa::plotResiduals(form = Train_data_scaled_centred_train$ln_migration_prep,
                      simulationOutput = mod_check,
                      quantreg = T,smoothScatter = FALSE,
                      rank = T, xlab = "ln_migration_prep")
DHARMa::plotResiduals(form = Train_data_scaled_centred_train$moonlight_exposure,
                      simulationOutput = mod_check,
                      quantreg = T,smoothScatter = FALSE,
                      rank = T, xlab = "moonlight_exposure",)
DHARMa::plotResiduals(form = Train_data_scaled_centred_train$ln_discharge,
                      simulationOutput = mod_check,
                      quantreg = T,smoothScatter = FALSE,
                      rank = T, xlab = "ln_discharge")
DHARMa::plotResiduals(form = Train_data_scaled_centred_train$Tw_mod,
                      simulationOutput = mod_check,
                      quantreg = T,smoothScatter = FALSE,
                      rank = T, xlab = "Tw_mod")
DHARMa::plotResiduals(form = Train_data_scaled_centred_train$Delta_temp,
                      simulationOutput = mod_check,
                      quantreg = T,smoothScatter = FALSE,
                      rank = T, xlab = "Delta_temp")
invisible(dev.off())

# -------------------------------------------------------------------------------------------------- #
# TEMPORAL AUTOCORRELATION ----
# -------------------------------------------------------------------------------------------------- #
temp_autocorr_plot_data <- data.frame("residssim_date" = Train_data_scaled_centred_train$date,
                                      "residssim" = mod_check$scaledResiduals,
                                      "residssim_bioyear" = Train_data_scaled_centred_train$eel_year)

# among years ---
png(file = paste0(dirName,'FigS5c.png'), width=2400, height=1400, res=300)
par(mfrow = c(1,1), oma = c(0,0,0,0), mar = c(4,4,5,4))
DHARMa::plotResiduals(mod_check,
                      Train_data_scaled_centred_train$eel_year,
                      asFactor = TRUE, main = "A. anguilla")
invisible(dev.off())

# within years -----
temp_auto_within_year <-
  lapply(
    unique(temp_autocorr_plot_data$residssim_bioyear),
    FUN = function(x) {
      DHARMa::testTemporalAutocorrelation(
        temp_autocorr_plot_data$residssim[temp_autocorr_plot_data$residssim_bioyear == x],
        time = temp_autocorr_plot_data$residssim_date[temp_autocorr_plot_data$residssim_bioyear == x],
        plot = FALSE
      )
    }
  )

png(file = paste0(dirName,'FigS5d.png'), width=2500, height=2000, res=300)
par(mfrow = c(4,3), mar = c(3.5,4.5,0.5,0.5),mgp = c(2,1,0))
temp_auto_within_year_acf <- lapply(unique(temp_autocorr_plot_data$residssim_bioyear),FUN = function(x){
acf(x = temp_autocorr_plot_data$residssim[temp_autocorr_plot_data$residssim_bioyear == x])
  mtext(text = paste0(x),side = 3,line = -1.5, cex = 0.75, adj = 0.9)
})
invisible(dev.off())

# export model
#dirName <- paste0(system.file("extdata", package = "fishcastr"), "/vignette_data/")
#saveRDS(m3, file = paste0(dirName,"m3_eel_historic.rds"))

 rm(list = ls(all.names = TRUE))
 invisible(gc())

# -------------------------------------------------------------------------------------------------- #
# INFLUENTIAL YEARS ----
# see https://cran.r-project.org/web/packages/glmmTMB/vignettes/model_evaluation.pdf
# -------------------------------------------------------------------------------------------------- #
library(glmmTMB)
source(system.file("other_methods","influence_mixed.R", package="glmmTMB"))
library(car)
 
chosen_model = m3

system.time(chosen_model_influence <- influence_mixed(chosen_model,
                                                      groups = "eel_year",
                                                      component = "cond"))
#51.86 /60# 0.86 mins

inf <- as.data.frame(chosen_model_influence[["fixed.effects[-eel_year]"]])
inf <- transform(inf,
                 eel_year=rownames(inf),
                 cooks=stats::cooks.distance(chosen_model_influence))
inf$ord <- rank(inf$cooks)

inf_full_mod_eff <-as.list(chosen_model_influence[["fixed.effects"]])

# extract standard errors of param estimates excluding higher levels under investigation
year_names <- names(chosen_model_influence[["vcov[-eel_year]"]])
serrs_list <- lapply(year_names,FUN = function(x){
  sqrt(diag(chosen_model_influence[["vcov[-eel_year]"]][[x]]))
})
serrs <- do.call(rbind,serrs_list)
rownames(serrs) <- year_names

# calculate dfbetas - each value will be positive if the effect with the included level is stronger than without it.
  dfbetas <- inf
for(i in 1:(ncol(inf)-3)){
  dfbetas[,i] = (inf[,i] - inf_full_mod_eff[[i]])/serrs[,i]
}

#for(i in 1:(ncol(inf)-3)){
#  dfbetas[,i] = (inf[,i] - inf_full_mod_eff[[i]])
#}

dfbetas <- transform(dfbetas,
                     eel_year=rownames(dfbetas))

#inf_long_sort <- inf_long[with(inf_long, order(inf_long$variable,-inf_long$ord)),]

library(ggplot2)
library(reshape2)

theme_set(theme_bw())
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/vignette_figures/count_model_checks/eel/")
png(file = paste0(dirName,'FigS5f.png'), width=7000, height=4000, res=300)
if (require(reshape2)){
  inf_long <- reshape2::melt(dfbetas, id.vars=c("ord","eel_year"))
#  inf_long_sort <- inf_long[with(inf_long, order(inf_long$variable,-inf_long$ord)),]
  gg_infl <- (ggplot2::ggplot(inf_long, aes(eel_year,value))
              + geom_segment(aes(x=eel_year,xend=eel_year,y=0,yend=value),colour="black", size = 2)
              + facet_wrap(~variable, scale="free_y")
              + scale_y_continuous(expand=expansion(mult=0.5))
              + geom_text(data=subset(inf_long,
                                       abs(value) > 1),
                           aes(y = value + (0.6 * (value)), label=eel_year),
                           vjust=0.0, angle = 90)
              + geom_hline(yintercept=0,linetype = "dashed")
              + theme(axis.text.x = element_text(angle = 90)))
  print(gg_infl)}
invisible(dev.off())

# -------------------------------------------------------------------------------------------------- #
# GENERAL PLOTS TO TEST FISHCASTR SIMULATION FUNCTION CONSISTENCY WITH GLMMTMB BUILT IN ----
# -------------------------------------------------------------------------------------------------- #

library(glmmTMB)
object <- m3
new_data <- Train_data_scaled_centred_train

#for checking if long term trend remains in simulations when new levels added (see re.form documentation in glmmTMB)
#new_data$eel_year <- Train_data_scaled_centred_train$eel_year + 40

# extract conditional mean
cond_mean <- predict(object, newdata=new_data,
                     type="conditional",
                     re.form = NA,
                     allow.new.levels=TRUE, 
                     na.action = na.pass)

# extract dispersion parameter as function of fixed effects, noting log link (hence exp())
f <- formula(object, component = "disp")
X <- model.matrix(f, data = new_data)
beta <- fixef(object)[["disp"]]
eta <- X %*% beta
odp <- c(exp(eta))

# generate random deviates
mu = cond_mean
disp_param = odp

theta <- as.numeric(mu*(1 - (1 - sqrt(1/disp_param))))
lambda <- (1 - sqrt(1/disp_param))
result <- RMKdiscrete::rLGP(n = 1,theta = theta,lambda = lambda)

# check annual sums are reasonably consistent
df_check <- data.frame("result" = result,
                       "eel_year" = new_data$eel_year,
                       "seel" = new_data$seel)
tapply(df_check$result,INDEX = df_check$eel_year,FUN = sum)
tapply(df_check$seel,INDEX = df_check$eel_year,FUN = sum)
#par(mfrow = c(1,1))
plot(tapply(df_check$result,INDEX = df_check$eel_year,FUN = sum),
     tapply(df_check$seel,INDEX = df_check$eel_year,FUN = sum))

#######
# # or if single param poisson zeroinf
# #or if single pram
# zi_prob <- predict(object, newdata=new_data, type="zprob", allow.new.levels=TRUE, na.action = na.pass,re.form = NA)
# 
# cond <- rpois(n = nrow(new_data),
#               lambda = cond_mean)
# 
# result <- ifelse(stats::runif(nrow(new_data))< zi_prob, 0, cond)
# 
#######
 
 mTrain_genpois_op_sims_sqr <- simulate(object,nsim = 1)
# # plot simulations 
 c = 0
 i = 1
      par(mfrow = c(3,1), mar = c(4,4,1,1))
 plot((1+c):(365+c),mTrain_genpois_op_sims_sqr$sim_1[(1+c):(365+c)], type = "s", col = NULL, ylim = c(0,500), main = paste0(i, "glmmtmb"))
 lines((1+c):(365+c),mTrain_genpois_op_sims_sqr$sim_1[(1+c):(365+c)], type = "h", col = "blue")
 plot((1+c):(365+c),result[(1+c):(365+c)], type = "h", col = "green3", main = "manual",ylim = c(0,500))
 plot((1+c):(365+c),Train_data_scaled_centred_train$seel[(1+c):(365+c)], type = "h", col = "red", main = "seel",ylim = c(0,500))
# 
#      for(i in 1:length(unique(df_check$eel_year))-1){
#      par(mfrow = c(3,1), mar = c(4,4,1,1))
#  c = 365*i
# plot((1+c):(365+c),mTrain_genpois_op_sims_sqr$sim_1[(1+c):(365+c)], type = "s", col = NULL, ylim = c(0,500), main = paste0(i+1, "glmmtmb"))
# lines((1+c):(365+c),mTrain_genpois_op_sims_sqr$sim_1[(1+c):(365+c)], type = "h", col = "blue")
# plot((1+c):(365+c),result[(1+c):(365+c)], type = "h", col = "green3", main = "manual",ylim = c(0,500))
# plot((1+c):(365+c),Train_data_scaled_centred_train$seel[(1+c):(365+c)], type = "h", col = "red", main = "seel",ylim = c(0,500))
# }
 rm(list = ls(all.names = TRUE))
 invisible(gc())
```

```{r model-eel-counts-1981-1992-fit-eel-1, fig.show = "hold", out.width="30%", eval = TRUE, fig.align = 'center', fig.cap = "(ref:model-eel-counts-1981-1992-fit-eel-1)", echo = FALSE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/count_model_checks/eel/")
knitr::include_graphics(path = paste0(dirName,"FigS5a.png"))
knitr::include_graphics(path = paste0(dirName,"FigS5b.png"))
knitr::include_graphics(path = paste0(dirName,"FigS5c.png"))
knitr::include_graphics(path = paste0(dirName,"FigS5d.png"))
knitr::include_graphics(path = paste0(dirName,"FigS5e.png"))
knitr::include_graphics(path = paste0(dirName,"FigS5f.png"))
knitr::include_graphics(path = paste0(dirName,"FigS5g.png"))
knitr::include_graphics(path = paste0(dirName,"FigS5h.png"))
```

(ref:model-eel-counts-1981-1992-fit-eel-1) *Model validation plots for daily fish count model trained on data from 1981 - 1992.*

<!-- ### *Fit refined model to data using leave-one-year-out approach* -->
   
```{r model-eel-counts-1981-2018-fit-loo,eval = FALSE, echo = FALSE}            
# ---------------------------------------------------------------------------------------------------------- #
# LOAD COUNT AND PREDICTOR DATA ----
# ---------------------------------------------------------------------------------------------------------- #
data_seel_enviro_1981_2019 <- readRDS(paste0(system.file("extdata",
                                                    package = "fishcastr"),
                                               "/vignette_data/data_seel_enviro_1981_2019.rds"))

names(data_seel_enviro_1981_2019)[which(names(data_seel_enviro_1981_2019) == "water_temp")] <- "Tw_mod"

######################################################################################################
# -------------------------------------------------------------------------------------------------- #
# SUBSET DATA TO 1981 - 2018 TO BUILD MODEL LIST FOR SEASONAL FORECAST LOO VALIDATION ----
# but remove years 1984 and 1989 owing to floods allowing eels to bypass traps
# -------------------------------------------------------------------------------------------------- #
data_seel_enviro_1981_2018 <- data_seel_enviro_1981_2019[data_seel_enviro_1981_2019$eel_year %in% c(1981:1983, 1985:1988, 1990:2018),]
all_timeseries_years <- as.list(c(1981:1983, 1985:1988, 1990:2018))
suppressMessages(library(glmmTMB))
suppressMessages(library(caret))
suppressMessages(library(plyr))
  suppressMessages(library(parallel))
  suppressMessages(library(doSNOW))
  # n_cores <- 3
  n_cores <- parallel::detectCores() -1
  
  cl <- parallel::makeCluster(n_cores, type = "SOCK")
  
  parallel::clusterSetRNGStream(cl, iseed = 123)
  parallel::clusterCall(cl, function(){ library(glmmTMB)})
  parallel::clusterCall(cl, function(){ library(caret)})
  parallel::clusterCall(cl, function(){ library(plyr)})
  parallel::clusterExport(cl, varlist = c('data_seel_enviro_1981_2018',
                                          'all_timeseries_years'),
                          envir = environment())
  
    doSNOW::registerDoSNOW(cl)

# calibrate models for all years except for year x (i.e., leave-one-year-out
# calibration). This results in models for all years up to 2018. To build
# operational predictions for year 2019, all years PLUS 2018 must be used for
# calibration.
# FOR 1981 - 2018...
system.time({model_list <- plyr::llply(.data = all_timeseries_years, .fun = function(x){
list_x <- do.call(c, all_timeseries_years)
list_minus_x <- list_x[-which(list_x == x)]

# -------------------------------------------------------------------------------------------------- #
# SCALE PREDICTOR VARIABLES IN TRAINING AND TEST DATASETS ----
# -------------------------------------------------------------------------------------------------- #
Train_data <- subset(data_seel_enviro_1981_2018,
                     eel_year %in% c(list_minus_x), select = c(date,
                                                               seel,
                                                               eel_year,
                                                               ln_migration_prep,
                                                               eel_yday_biofix,
                                                               moonlight_exposure,
                                                               ln_discharge,
                                                               Tw_mod,
                                                               Delta_temp))

# SCALE PREDICTORS AND CENTRE THOSE THAT HAVE NON-MEANINGFUL ZEROS (Here, just scale...)
pP_params <- caret::preProcess(Train_data[,4:ncol(Train_data)], method = c("center","scale"))
Train_data_scaled_centred <- predict(object = pP_params, newdata = Train_data)
#Test_data_scaled_centred <- predict(object = pP_params, newdata = Test_data)

# -------------------------------------------------------------------------------------------------- #
# generalised poisson for underdispersion or overdispersion... ----
# -------------------------------------------------------------------------------------------------- #
mTrain_genpois <- glmmTMB::glmmTMB(seel ~ (Tw_mod + I(Tw_mod^2))*(ln_discharge+ln_migration_prep + moonlight_exposure + Delta_temp) + (ln_discharge+ln_migration_prep + moonlight_exposure + Delta_temp)^2 + (1|eel_year),
                                   genpois(link = "log"),
                                   data=Train_data_scaled_centred,
                                   control = glmmTMBControl(parallel = 3))

return(list(mTrain_genpois,pP_params))
}, .progress = 'text', .parallel = TRUE)})

    parallel::stopCluster(cl) # Close all open clusters
# 505.31/60 # 8.5 mins for 1981-2018 years
 
# -------------------------------------------------------------------------------------------------- #
# EXPORT MODEL AND SCALING FACTOR LIST AS "TWO" rds OBJECTS FOR REDUCING FILE SIZE to less than 100mb for Git Push  ----
# -------------------------------------------------------------------------------------------------- #

# save
model_list_1of2 <- model_list[1:20]
model_list_2of2 <- model_list[21:length(model_list)]

dirName <- paste0(system.file("extdata", package = "fishcastr"), "/vignette_data/")
saveRDS(model_list_1of2, file = paste0(dirName,"mTrain_genpois_eel_list_1of2.rds"))
saveRDS(model_list_2of2, file = paste0(dirName,"mTrain_genpois_eel_list_2of2.rds"))

# # load
# dirName <- paste0(system.file("extdata", package = "fishcastr"), "/vignette_data/")
# model_list_1of2 <- readRDS(file = paste0(dirName,"mTrain_genpois_eel_list_1of2.rds"))
# model_list_2of2 <- readRDS(file = paste0(dirName,"mTrain_genpois_eel_list_2of2.rds"))
# model_list <- list()
# model_list[1:length(model_list_1of2)] <- model_list_1of2
# model_list[(1 + length(model_list_1of2)):(length(model_list_1of2)+length(model_list_2of2))] <- model_list_2of2
 rm(list = ls(all.names = TRUE))
 invisible(gc())
```

<!-- ### *Fit refined model structure to all data up to operational year and check* -->

```{r model-eel-counts-2019-fit-operational,eval = FALSE, echo = FALSE}
# ---------------------------------------------------------------------------------------------------------- #
# LOAD COUNT AND PREDICTOR DATA ----
# ---------------------------------------------------------------------------------------------------------- #
data_seel_enviro_1981_2019 <- readRDS(paste0(system.file("extdata",
                                                    package = "fishcastr"),
                                               "/vignette_data/data_seel_enviro_1981_2019.rds"))

names(data_seel_enviro_1981_2019)[which(names(data_seel_enviro_1981_2019) == "water_temp")] <- "Tw_mod"

# -------------------------------------------------------------------------------------------------- #
# OPERATIONAL YEAR 2019 (ALL DATA) ----
# -------------------------------------------------------------------------------------------------- #

min_1981 <- min(data_seel_enviro_1981_2019$date[data_seel_enviro_1981_2019$eel_year == 1981])
max_1983 <- max(data_seel_enviro_1981_2019$date[data_seel_enviro_1981_2019$eel_year == 1983])
min_1985 <- min(data_seel_enviro_1981_2019$date[data_seel_enviro_1981_2019$eel_year == 1985])
max_1988 <- max(data_seel_enviro_1981_2019$date[data_seel_enviro_1981_2019$eel_year == 1988])
min_1990 <- min(data_seel_enviro_1981_2019$date[data_seel_enviro_1981_2019$eel_year == 1990])
max_2018 <- max(data_seel_enviro_1981_2019$date[data_seel_enviro_1981_2019$eel_year == 2018])

Train_data_op <- subset(
  data_seel_enviro_1981_2019,
  select = c(
    date,
    seel,
    eel_year,
    ln_migration_prep,
    eel_yday_biofix,
    moonlight_exposure,
    ln_discharge,
    Tw_mod,
    Delta_temp
  ),
  subset = data.table::between(
    data_seel_enviro_1981_2019$date,
    lower = min_1981,
    upper = max_1983
  ) | data.table::between(
    data_seel_enviro_1981_2019$date,
    lower = min_1985,
    upper = max_1988
  ) | data.table::between(
    data_seel_enviro_1981_2019$date,
    lower = min_1990,
    upper = max_2018
  )
)

# -------------------------------------------------------------------------------------------------- #
# SCALE PREDICTORS AND CENTRE THOSE THAT HAVE NON-MEANINGFUL ZEROS (Here, just scale...) ----
# -------------------------------------------------------------------------------------------------- #
library(caret)
pP_params_op <- caret::preProcess(Train_data_op[,4:ncol(Train_data_op)], method = c("center","scale"))
Train_data_scaled_centred_op <- predict(object = pP_params_op, newdata = Train_data_op)
    
# -------------------------------------------------------------------------------------------------- #
# FIT MODEL ----
# -------------------------------------------------------------------------------------------------- #
library(glmmTMB)
mop <- glmmTMB::glmmTMB(seel ~ (Tw_mod + I(Tw_mod^2))*(ln_discharge+ln_migration_prep + moonlight_exposure + Delta_temp) + (ln_discharge+ln_migration_prep + moonlight_exposure + Delta_temp)^2 + (1|eel_year),
                                   genpois(link = "log"),
                                   data=Train_data_scaled_centred_op)

simulatedResiduals_genpois <- DHARMa::simulateResiduals(mop)

# -------------------------------------------------------------------------------------------------- #
# MODEL VALIDATION PLOTS FOR OPERATIONAL YEAR (CHECK FOR ISSUES) ------
# -------------------------------------------------------------------------------------------------- #
mod_check <- simulatedResiduals_genpois
# Create vignette sub directories ------------------------------------------------------
dirName <- paste0(system.file("extdata", package = "fishcastr"),"/vignette_figures/count_model_checks/eel/op_model/")
dir.create(paste0(dirName), showWarnings = TRUE, mode = "0777")

png(file = paste0(dirName,'FigS5a.png'), width=2100, height=1200, res=300)
plot(mod_check, rank = T, smoothScatter = FALSE, quantreg = TRUE)
invisible(dev.off())

png(file = paste0(dirName,'FigS5b.png'), width=1800, height=2100, res=300)
par(mfrow = c(2,1), oma = c(0,0,0,0), mar = c(4,4,5,4))
# overdispersion
DHARMa::testDispersion(mod_check)
# zero inflation
DHARMa::testZeroInflation(mod_check)
invisible(dev.off())

# -------------------------------------------------------------------------------------------------- #
# NON-LINEARITY VALIDATION PLOTS (IF PATTERNS PRESENT IN FIT VS RESIDUALS) ----
# -------------------------------------------------------------------------------------------------- #
# individual predictors
png(file = paste0(dirName,'FigS5e.png'), width=2500, height=3200, res=300)
par(mfrow = c(3,2), mar = c(3.5,3.5,3.5,0.5),mgp = c(2.5,1,0))
DHARMa::plotResiduals(form = Train_data_scaled_centred_op$ln_migration_prep,
                      simulationOutput = mod_check,
                      quantreg = T,smoothScatter = FALSE,
                      rank = T, xlab = "ln_migration_prep")
DHARMa::plotResiduals(form = Train_data_scaled_centred_op$moonlight_exposure,
                      simulationOutput = mod_check,
                      quantreg = T,smoothScatter = FALSE,
                      rank = T, xlab = "moonlight_exposure",)
DHARMa::plotResiduals(form = Train_data_scaled_centred_op$ln_discharge,
                      simulationOutput = mod_check,
                      quantreg = T,smoothScatter = FALSE,
                      rank = T, xlab = "ln_discharge")
DHARMa::plotResiduals(form = Train_data_scaled_centred_op$Tw_mod,
                      simulationOutput = mod_check,
                      quantreg = T,smoothScatter = FALSE,
                      rank = T, xlab = "Tw_mod")
DHARMa::plotResiduals(form = Train_data_scaled_centred_op$Delta_temp,
                      simulationOutput = mod_check,
                      quantreg = T,smoothScatter = FALSE,
                      rank = T, xlab = "Delta_temp")
invisible(dev.off())

# -------------------------------------------------------------------------------------------------- #
# TEMPORAL AUTOCORRELATION ----
# -------------------------------------------------------------------------------------------------- #
temp_autocorr_plot_data <- data.frame("residssim_date" = Train_data_scaled_centred_op$date,
                                      "residssim" = mod_check$scaledResiduals,
                                      "residssim_bioyear" = Train_data_scaled_centred_op$eel_year)

# among years ---
png(file = paste0(dirName,'FigS5c.png'), width=2400, height=1400, res=300)
par(mfrow = c(1,1), oma = c(0,0,0,0), mar = c(4,4,5,4))
DHARMa::plotResiduals(mod_check,
                      Train_data_scaled_centred_op$eel_year,
                      asFactor = TRUE, main = "A. anguilla")
invisible(dev.off())

# within years -----
temp_auto_within_year <- lapply(unique(temp_autocorr_plot_data$residssim_bioyear),FUN = function(x){
DHARMa::testTemporalAutocorrelation(temp_autocorr_plot_data$residssim[temp_autocorr_plot_data$residssim_bioyear == x],
                                    time = temp_autocorr_plot_data$residssim_date[temp_autocorr_plot_data$residssim_bioyear == x], plot = FALSE)
})

png(file = paste0(dirName,'FigS5d.png'), width=2500, height=2000, res=300)
par(mfrow = c(6,7), mar = c(2.5,3.0,0.1,0.1),mgp = c(1.5,0.5,0))
temp_auto_within_year_acf <- lapply(unique(temp_autocorr_plot_data$residssim_bioyear),FUN = function(x){
acf(x = temp_autocorr_plot_data$residssim[temp_autocorr_plot_data$residssim_bioyear == x], cex.axis = 0.75, cex.lab = 0.75)
  mtext(text = paste0(x),side = 3,line = -1.5, cex = 0.75, adj = 0.9)
})
invisible(dev.off())

# -------------------------------------------------------------------------------------------------- #
# INFLUENTIAL YEARS
# see https://cran.r-project.org/web/packages/glmmTMB/vignettes/model_evaluation.pdf
# -------------------------------------------------------------------------------------------------- #
chosen_model <- mop
source(system.file("other_methods","influence_mixed.R", package="glmmTMB"))
system.time(chosen_model_influence <- influence_mixed(chosen_model,
                                                      groups = "eel_year",
                                                      component = "cond"))

#606.26 /60# 10.1 mins

#inf_ind_plot_data <- car::infIndexPlot(chosen_model_influence)# run this first to load libraryd libraries
#cookdist <- cooks.distance(chosen_model_influence)

#cookdist
#png(file = paste0(dirName,'eel/FigS5fm5cook.png'), width=1000, height=10000, res=300)
#inf_ind_plot_data <- car::infIndexPlot(chosen_model_influence)
#invisible(dev.off())
#stats::cooks.distance(infl = chosen_model_influence)
#?cooks.distance
library(car)
inf <- as.data.frame(chosen_model_influence[["fixed.effects[-eel_year]"]])
inf_full_mod_eff <-as.list(chosen_model_influence[["fixed.effects"]])
inf <- transform(inf,
                 eel_year=rownames(inf),
                 cooks=stats::cooks.distance(chosen_model_influence))
inf$ord <- rank(inf$cooks)

# extract standard errors of param estimates excluding higher levels under investigation
year_names <- names(chosen_model_influence[["vcov[-eel_year]"]])
serrs_list <- lapply(year_names,FUN = function(x){
  sqrt(diag(chosen_model_influence[["vcov[-eel_year]"]][[x]]))
})
serrs <- do.call(rbind,serrs_list)
rownames(serrs) <- year_names

# calculate dfbetas - each value will be positive if the effect with the included level is stronger than without it.
# e.g., the intercept is greater with the inclusion of 1987 data (because 1987 was a high count)
  dfbetas <- inf
for(i in 1:(ncol(inf)-3)){
  dfbetas[,i] = (inf[,i] - inf_full_mod_eff[[i]])/serrs[,i]
}

#for(i in 1:(ncol(inf)-3)){
#  dfbetas[,i] = (inf[,i] - inf_full_mod_eff[[i]])
#}

dfbetas <- transform(dfbetas,
                     eel_year=rownames(dfbetas))

#inf_long_sort <- inf_long[with(inf_long, order(inf_long$variable,-inf_long$ord)),]

library(ggplot2)
theme_set(theme_bw())
png(file = paste0(dirName,'FigS5f.png'), width=7000, height=4000, res=300)
if (require(reshape2)){
  inf_long <- reshape2::melt(dfbetas, id.vars=c("ord","eel_year"))
#  inf_long_sort <- inf_long[with(inf_long, order(inf_long$variable,-inf_long$ord)),]
  gg_infl <- (ggplot2::ggplot(inf_long, aes(eel_year,value))
              + geom_segment(aes(x=eel_year,xend=eel_year,y=0,yend=value),colour="black", size = 2)
              + facet_wrap(~variable, scale="free_y")
              + scale_y_continuous(expand=expansion(mult=0.5))
              + geom_text(data=subset(inf_long,
                                       abs(value) > 1),
                           aes(y = value + (0.6 * (value)), label=eel_year),
                           vjust=0.0, angle = 90)
              + geom_hline(yintercept=0,linetype = "dashed")
              + theme(axis.text.x = element_text(angle = 90)))
  print(gg_infl)}
invisible(dev.off())

# -------------------------------------------------------------------------------------------------- #
# PLOT ALL TWO-WAY INTERACTIONS OF SELECTED MODEL
# -------------------------------------------------------------------------------------------------- #
interactions_list_3 <- list("1" = c("Tw_mod","ln_discharge"),
                          "2" = c("Tw_mod","ln_migration_prep"),
                          "3" = c("Tw_mod","moonlight_exposure"),
                          "4" = c("Tw_mod","Delta_temp"),
                          "5" = c("ln_discharge","ln_migration_prep"),
                          "6" = c("ln_discharge","moonlight_exposure"),
                          "7" = c("ln_discharge","Delta_temp"),
                          "8" = c("ln_migration_prep","moonlight_exposure"),
                          "9" = c("ln_migration_prep","Delta_temp"),
                          "10" = c("moonlight_exposure","Delta_temp"))

# -------------------------------------------------------------------------------------------------- #
# with points
int_plots <- lapply(interactions_list_3,FUN = function(x){
  
  # set x axis lims
  # 75th
  data_75_plus <- Train_data_scaled_centred_op[Train_data_scaled_centred_op[[x[2]]] >= quantile(Train_data_scaled_centred_op[[x[2]]], probs = c((((75+50)/2)/100))),]
xlims75 <- c(range(data_75_plus[[x[1]]]))
  # 50th
  data_50_plus <- Train_data_scaled_centred_op[Train_data_scaled_centred_op[[x[2]]] >= quantile(Train_data_scaled_centred_op[[x[2]]], probs = c((((50+50)/2)/100))),]
xlims50 <- c(range(data_50_plus[[x[1]]]))
  # 75th
  data_25_plus <- Train_data_scaled_centred_op[Train_data_scaled_centred_op[[x[2]]] >= quantile(Train_data_scaled_centred_op[[x[2]]], probs = c((((25+50)/2)/100))),]
xlims25 <- c(range(data_25_plus[[x[1]]]))
# xlims
xlims_min <- max(c(xlims75[1],xlims50[1],xlims25[1]))
xlims_max <- min(c(xlims75[2],xlims50[2],xlims25[2]))
xlims <- c(xlims_min,xlims_max)

 int_plot <- interactions::interact_plot(chosen_model,
                            pred = !!(x[1]),
                            modx = !!(x[2]),
                            linearity.check = FALSE,interval = TRUE, int.width = 0.95,
                            modx.values = c(quantile(Train_data_scaled_centred_op[[x[2]]],
                                                     probs = c(0.25,0.50,0.75))),
                            plot.points = TRUE,data = Train_data_scaled_centred_op, allow.new.levels=TRUE) + scale_x_continuous(expand = c(0,0)) + coord_cartesian(clip = 'on', ylim = c(0, max(Train_data_scaled_centred_op$seel)),xlim = xlims)
  
 return(int_plot)
})

# dirName <- paste0(getwd(),"/vignette_figures", "/count_model_checks", "/", sep = "", collapse = NULL)
# png(file = paste0(dirName,'eel/FigS5g.png'), width=4000, height=4000, res=300)
# ggpubr::ggarrange(int_plots[[1]],int_plots[[2]],int_plots[[3]],int_plots[[4]],int_plots[[5]],int_plots[[6]],int_plots[[7]],int_plots[[8]],int_plots[[9]],int_plots[[10]],
#           labels = c("A","B","C","D","E","F","G","H","I","J"),
#           ncol = 2, nrow = 5)
# invisible(dev.off())

#dirName <- paste0(system.file("extdata", package = "fishcastr"),"/vignette_figures/count_model_checks/eel/op_model/")
png(file = paste0(dirName,'FigS5g.png'), width=2500, height=4000, res=300)
ggpubr::ggarrange(int_plots[[1]],int_plots[[2]],int_plots[[3]],int_plots[[4]],int_plots[[5]],int_plots[[6]],int_plots[[7]],int_plots[[8]],int_plots[[9]],int_plots[[10]],
          labels = c("Disch","Prep","Moon","DTemp","Prep","Moon", "DTemp", "Moon", "DTemp","DTemp"),
          ncol = 2, nrow = 5)
invisible(dev.off())

# -------------------------------------------------------------------------------------------------- #
# without points
int_plots_no_points <- lapply(interactions_list_3,FUN = function(x){
  
    # set x axis lims
  # 75th
  data_75_plus <- Train_data_scaled_centred_op[Train_data_scaled_centred_op[[x[2]]] >= quantile(Train_data_scaled_centred_op[[x[2]]], probs = c((((75+50)/2)/100))),]
xlims75 <- c(range(data_75_plus[[x[1]]]))
  # 50th
  data_50_plus <- Train_data_scaled_centred_op[Train_data_scaled_centred_op[[x[2]]] >= quantile(Train_data_scaled_centred_op[[x[2]]], probs = c((((50+50)/2)/100))),]
xlims50 <- c(range(data_50_plus[[x[1]]]))
  # 75th
  data_25_plus <- Train_data_scaled_centred_op[Train_data_scaled_centred_op[[x[2]]] >= quantile(Train_data_scaled_centred_op[[x[2]]], probs = c((((25+50)/2)/100))),]
xlims25 <- c(range(data_25_plus[[x[1]]]))
# xlims
xlims_min <- max(c(xlims75[1],xlims50[1],xlims25[1]))
xlims_max <- min(c(xlims75[2],xlims50[2],xlims25[2]))
xlims <- c(xlims_min,xlims_max)
  
int_plot <-  interactions::interact_plot(chosen_model,
                            pred = !!(x[1]),
                            modx = !!(x[2]),
                            linearity.check = FALSE,interval = TRUE, int.width = 0.95,
                            modx.values = c(quantile(Train_data_scaled_centred_op[[x[2]]],
                                                     probs = c(0.25,0.50,0.75))),
                            plot.points = FALSE,data = Train_data_scaled_centred_op, allow.new.levels=TRUE) + scale_x_continuous(expand = c(0,0)) + coord_cartesian(xlim = xlims)

# extract auto ylims and change to max count if exceeding it.
if(ggplot_build(int_plot)$layout$panel_scales_y[[1]]$range$range[2] >= max(Train_data_scaled_centred_op$seel)){
int_plot$coordinates$limits$y <- c(0,max(Train_data_scaled_centred_op$seel))
}
return(int_plot)
})

png(file = paste0(dirName,'FigS5h.png'), width=2500, height=4000, res=300)
ggpubr::ggarrange(int_plots_no_points[[1]],int_plots_no_points[[2]],int_plots_no_points[[3]],int_plots_no_points[[4]],int_plots_no_points[[5]],int_plots_no_points[[6]],int_plots_no_points[[7]],int_plots_no_points[[8]],int_plots_no_points[[9]],int_plots_no_points[[10]],
          labels = c("Disch","Prep","Moon","DTemp","Prep","Moon", "DTemp", "Moon", "DTemp","DTemp"),
          ncol = 2, nrow = 5)
invisible(dev.off())

 #rm(list = ls(all.names = TRUE))
 #invisible(gc())

# -------------------------------------------------------------------------------------------------- #
# GENERAL PLOTS TO TEST FISHCASTR SIMULATION FUNCTION CONSISTENCY WITH GLMMTMB BUILT IN ----
# -------------------------------------------------------------------------------------------------- #
object = mop
new_data = Train_data_scaled_centred_op

#for checking if long term trend remains in simulations when new levels added (see re.form documentation in glmmTMB)
#new_data$eel_year <- Train_data_scaled_centred_train$eel_year + 40

# extract conditional mean
cond_mean <- predict(object, newdata=new_data,
                     type="conditional",
                     re.form = NA,
                     allow.new.levels=TRUE, 
                     na.action = na.pass)

# extract dispersion parameter as function of fixed effects, noting log link (hence exp())
f <- formula(object, component = "disp")
X <- model.matrix(f, data = new_data)
beta <- fixef(object)[["disp"]]
eta <- X %*% beta
odp <- c(exp(eta))

# generate random deviates
mu = cond_mean
disp_param = odp

theta <- as.numeric(mu*(1 - (1 - sqrt(1/disp_param))))
lambda <- (1 - sqrt(1/disp_param))
result <- RMKdiscrete::rLGP(n = 1,theta = theta,lambda = lambda)

# check annual sums are consistent
df_check <- data.frame("result" = result,
                       "eel_year" = new_data$eel_year,
                       "seel" = new_data$seel)
tapply(df_check$result,INDEX = df_check$eel_year,FUN = sum)
tapply(df_check$seel,INDEX = df_check$eel_year,FUN = sum)
#par(mfrow = c(1,1))
plot(tapply(df_check$result,INDEX = df_check$eel_year,FUN = sum),
     tapply(df_check$seel,INDEX = df_check$eel_year,FUN = sum))

#######
# # or if single param poisson zeroinf
# #or if single pram
# zi_prob <- predict(object, newdata=new_data, type="zprob", allow.new.levels=TRUE, na.action = na.pass,re.form = NA)
# 
# cond <- rpois(n = nrow(new_data),
#               lambda = cond_mean)
# 
# result <- ifelse(stats::runif(nrow(new_data))< zi_prob, 0, cond)
# 
#######

 mTrain_genpois_op_sims_sqr <- simulate(mop,nsim = 1)
 # plot simulations 
 c = 0
 i = 1
      par(mfrow = c(3,1), mar = c(4,4,1,1))
 plot((1+c):(365+c),mTrain_genpois_op_sims_sqr$sim_1[(1+c):(365+c)], type = "s", col = NULL, ylim = c(0,500), main = paste0(i, "glmmtmb"))
 lines((1+c):(365+c),mTrain_genpois_op_sims_sqr$sim_1[(1+c):(365+c)], type = "h", col = "blue")
 plot((1+c):(365+c),result[(1+c):(365+c)], type = "h", col = "green3", main = "manual",ylim = c(0,500))
 plot((1+c):(365+c),Train_data_scaled_centred_op$seel[(1+c):(365+c)], type = "h", col = "red", main = "seel",ylim = c(0,500))
# 
#      for(i in 1:length(unique(df_check$eel_year))-1){
#      par(mfrow = c(3,1), mar = c(4,4,1,1))
#  c = 365*i
# plot((1+c):(365+c),mTrain_genpois_op_sims_sqr$sim_1[(1+c):(365+c)], type = "s", col = NULL, ylim = c(0,500), main = paste0(i+1, "glmmtmb"))
# lines((1+c):(365+c),mTrain_genpois_op_sims_sqr$sim_1[(1+c):(365+c)], type = "h", col = "blue")
# plot((1+c):(365+c),result[(1+c):(365+c)], type = "h", col = "green3", main = "manual",ylim = c(0,500))
# plot((1+c):(365+c),Train_data_scaled_centred_op$seel[(1+c):(365+c)], type = "h", col = "red", main = "seel",ylim = c(0,500))
# }
              
# -------------------------------------------------------------------------------------------------- #
# EXPORT MOST RECENT MODEL TO RData OBJECT ----
# -------------------------------------------------------------------------------------------------- #

dirName <- paste0(system.file("extdata", package = "fishcastr"), "/vignette_data/")
saveRDS(mop, file = paste0(dirName,"mTrain_genpois_eel_2019.rds"))

# -------------------------------------------------------------------------------------------------- #
# EXPORT MOST RECENT SCALING FACTORS TO RData OBJECT -----
# -------------------------------------------------------------------------------------------------- #
#dirName <- paste0(system.file("extdata", package = "fishcastr"), "/vignette_data/")
saveRDS(pP_params_op, file = paste0(dirName,"pP_params_eel_2019.rds"))

rm(list = ls(all.names = TRUE))
invisible(gc())

```

```{r model-eel-counts-2019-fit-operational-eel-1, fig.show = "hold", out.width="30%", eval = TRUE, fig.align = 'center', fig.cap = "(ref:model-eel-counts-2019-fit-operational-eel-1)", echo = FALSE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/count_model_checks/eel/op_model/")
knitr::include_graphics(path = paste0(dirName,"FigS5a.png"))
knitr::include_graphics(path = paste0(dirName,"FigS5b.png"))
knitr::include_graphics(path = paste0(dirName,"FigS5c.png"))
knitr::include_graphics(path = paste0(dirName,"FigS5d.png"))
knitr::include_graphics(path = paste0(dirName,"FigS5e.png"))
knitr::include_graphics(path = paste0(dirName,"FigS5f.png"))
knitr::include_graphics(path = paste0(dirName,"FigS5g.png"))
knitr::include_graphics(path = paste0(dirName,"FigS5h.png"))
```

(ref:model-eel-counts-2019-fit-operational-eel-1) *Model validation plots for daily fish count model trained on data from 1981 - 2018.*

# (3) EVALUATE FORECAST PERFORMANCE

## Evaluating seasonal climate forecast skill

Prior to evaluating seasonal forecast skill for the eel model chain under ERA5 and SEAS5 forcing, we can evaluate forecast skill for specific SEAS5 meteorological forcing variables themselves. Consistent with convention, we specify a lead time (e.g., one month; July) and target season period (e.g., August to November) (**Figures \@ref(fig:seas-forecast-skill-SEAS5-autumn-eel-tas)**, **\@ref(fig:seas-forecast-skill-SEAS5-autumn-eel-pr)** and **\@ref(fig:seas-forecast-skill-SEAS5-autumn-eel-petH)**).

```{r seas-forecast-skill-SEAS5-autumn-eel, eval = FALSE, echo = FALSE}
# LOAD ERA 5 RDATA
ERA5_data_op_Jun_2019 <- fishcastr::grid_ERA5_1979_2019_Jun_bc

variables = c("tas","pr","petH")
ERA5_data_op_Jul_Dec_2019 <- fishcastr::grid_SEAS5_1993_2019_7_8_9_10_11_12_tas_pr_petH_bc
ERA5_data_op_Jul_Dec_2019_m1 <- lapply(variables, function(x){
  res <- transformeR::subsetGrid(grid = ERA5_data_op_Jul_Dec_2019[[x]],
                          members = 1,
                          years = 2019,
                          season = 7:12)
  res_2 <- res[-c(5,6)] # remove member and initialisation dates information
  return(res_2)
  })
names(ERA5_data_op_Jul_Dec_2019_m1) <- variables

# bind grids by time
ERA5_data_op <- lapply(variables, function(x){
  transformeR::bindGrid(list(ERA5_data_op_Jun_2019[[x]],
                             ERA5_data_op_Jul_Dec_2019_m1[[x]]),
                        dimension = "time")
})
names(ERA5_data_op) <- variables

target_season <- 8:11

# subset to target season and SEAS5 years
obs <- lapply(variables, function(x){
  transformeR::subsetGrid(grid = ERA5_data_op[[x]],
                                         years = 1993:2019,
                                         season = target_season)})
names(obs) <- variables

# load SEAS5 data
forecast.data <- fishcastr::grid_SEAS5_1993_2019_7_8_9_10_11_12_tas_pr_petH_bc

# note that there might be no longname for pr or tas, which must be assigned for tercile plots...
attr(forecast.data$pr$Variable, "longname") <- c("Total precipitation")
attr(forecast.data$tas$Variable, "longname") <- c("2 meter air temperature")
attr(forecast.data$petH$Variable, "longname") <- c("Potential evapotranspiration (Hargreaves-Samani)")

# remove lead month
lead_month = 1
hind <- lapply(forecast.data, function(x)
  transformeR::subsetGrid(x, season = 8:11))

# 
season <- transformeR::getSeason(hind[[1]])
obs.sub <- lapply(1:length(obs), function(x) {transformeR::intersectGrid(obs[[x]], hind[[x]], type = "temporal", which.return = 1)})
hind <- lapply(1:length(obs), function(x) {transformeR::intersectGrid(obs[[x]], hind[[x]], type = "temporal", which.return = 2)})

names(obs.sub) <- variables
names(hind) <- variables

# plot terciles (edit the tercile function temporarily to extract tercile probabilities)
trace(visualizeR::tercilePlot, edit=TRUE) # add "return(cofinogram.data)" to end of function

library(visualizeR)
cofinogramdat <-
  lapply(variables, function(i) {
    filename = paste0(system.file("extdata", package = "fishcastr"),"/eel_wflow_figs/SEAS5_",paste0(target_season, collapse = "_"),"_",paste0(i, collapse = "_"),".png")
    png(file = filename, width=2100, height=1100, res=300)
    result <- visualizeR::tercilePlot(
      obs = transformeR::redim(obs.sub[[i]], var = T),
      hindcast = transformeR::redim(hind[[i]], var = T),
      detrend = FALSE,
      subtitle = paste0("lead month = ", lead_month, "; (not detrended)")
    )
    dev.off()
    return(result)
  })
names(cofinogramdat) <- variables

# export tercile data as rds
saveRDS(object = cofinogramdat,
        file = paste0(system.file("extdata", package = "fishcastr"),
                                              "/eel_wflow_figs/climate_terciles_",
                      paste0(target_season, collapse = "_"),".rds"))

# discard edits from the tercile plot function
untrace(visualizeR::tercilePlot)

# trim images
image <- magick::image_read(paste0(system.file("extdata",package = "fishcastr"),
                      "/eel_wflow_figs/SEAS5_8_9_10_11_tas.png"))
image_trimmed <- magick::image_trim(image) # trim white space
magick::image_write(image_trimmed, paste0(system.file("extdata",package = "fishcastr"),
                      "/eel_wflow_figs/SEAS5_8_9_10_11_tas.png"))

image <- magick::image_read(paste0(system.file("extdata",package = "fishcastr"),
                      "/eel_wflow_figs/SEAS5_8_9_10_11_pr.png"))
image_trimmed <- magick::image_trim(image) # trim white space
magick::image_write(image_trimmed, paste0(system.file("extdata",package = "fishcastr"),
                      "/eel_wflow_figs/SEAS5_8_9_10_11_pr.png"))

image <- magick::image_read(paste0(system.file("extdata",package = "fishcastr"),
                      "/eel_wflow_figs/SEAS5_8_9_10_11_petH.png"))
image_trimmed <- magick::image_trim(image) # trim white space
magick::image_write(image_trimmed, paste0(system.file("extdata",package = "fishcastr"),
                      "/eel_wflow_figs/SEAS5_8_9_10_11_petH.png"))

```

```{r seas-forecast-skill-SEAS5-autumn-eel-tas, out.width="70%", eval = TRUE, fig.align = 'center', fig.cap = "(ref:seas-forecast-skill-SEAS5-autumn-eel-tas)", echo = FALSE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/eel_wflow_figs/")
knitr::include_graphics(path = paste0(dirName,"SEAS5_8_9_10_11_tas.png"))
```

(ref:seas-forecast-skill-SEAS5-autumn-eel-tas) *Predictive performance of SEAS5 seasonal climate forecast for seasonal mean daily mean air temperature during the target season (August to November). Forecasts have a lead time of one month (i.e., initialisation on 1 July).*

```{r seas-forecast-skill-SEAS5-autumn-eel-pr, out.width="70%", eval = TRUE, fig.align = 'center', fig.cap = "(ref:seas-forecast-skill-SEAS5-autumn-eel-pr)", echo = FALSE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/eel_wflow_figs/")
knitr::include_graphics(path = paste0(dirName,"SEAS5_8_9_10_11_pr.png"))
```

(ref:seas-forecast-skill-SEAS5-autumn-eel-pr) *Predictive performance of SEAS5 seasonal climate forecast for seasonal total precipitation during the target season (August to November). Forecasts have a lead time of one month (i.e., initialisation on 1 July).*

```{r seas-forecast-skill-SEAS5-autumn-eel-petH, out.width="70%", eval = TRUE, fig.align = 'center', fig.cap = "(ref:seas-forecast-skill-SEAS5-autumn-eel-petH)", echo = FALSE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/eel_wflow_figs/")
knitr::include_graphics(path = paste0(dirName,"SEAS5_8_9_10_11_petH.png"))
```

(ref:seas-forecast-skill-SEAS5-autumn-eel-petH) *Predictive performance of SEAS5 seasonal climate forecast for seasonal total potential evapotranspiration during the target season (August to November). Forecasts have a lead time of one month (i.e., initialisation on 1 July).*

## (3a) Generate migration forecast ensembles

### *Known conditions (ECMWF's ERA5)*

We use `fishcastr` to produce a 25 member ensemble of plausible European silver eel daily counts under known conditions. We consider the model chain forcing data a "synthetic ensemble" of bias corrected ECMWF ERA5 data, whereby each member for a given forecast year is identical, but each year contains respective reanalysis data for that year. Owing to the simulation based approach, ensemble fish counts are produced stochastically and are effectively random draws from the (generalised Poisson) conditional distribution; thus each member of the output fish count ensemble is unique.

```{r figure-5a-eel-methods, warning = FALSE, eval = FALSE, echo = FALSE}

# load physio response model
mod_physio_expmG <- fishcastr::model_physio_expmG_inv_eel

# load and subset list into model and scaling lists for relevant years only 1993 - 2019
model_list_1of2 <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_data/mTrain_genpois_eel_list_1of2.rds"))
model_list_2of2 <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_data/mTrain_genpois_eel_list_2of2.rds"))

mTrain_genpois_list <- list()
mTrain_genpois_list[1:length(model_list_1of2)] <- model_list_1of2
mTrain_genpois_list[(1 + length(model_list_1of2)):(length(model_list_1of2)+length(model_list_2of2))] <- model_list_2of2

 # add 2019 data
 mTrain_genpois_eel_2019 <- model_list_1of2 <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                    "/vignette_data/mTrain_genpois_eel_2019.rds"))
 pP_params_eel_2019 <- model_list_1of2 <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                    "/vignette_data/pP_params_eel_2019.rds"))
 
 mTrain_genpois_list[[37]] <- list(mTrain_genpois_eel_2019,
                                 pP_params_eel_2019)

names(mTrain_genpois_list) <- c(1981:1983, 1985:1988, 1990:2019)

# subset to 1981 - 1983 models for testing function
#mTrain_genpois_list_sub <- mTrain_genpois_list[which(names(mTrain_genpois_list) %in% c(1981:1983, 1985:1988, #1990:2019))]

mTrain_genpois_list_sub <- mTrain_genpois_list[which(names(mTrain_genpois_list) %in% c(1981:1983, 1985:1988,1990:2019))]

# model list
mTrain_genpois_list_sub_mod <- sapply(mTrain_genpois_list_sub, "[", 1)
# scaling param list
mTrain_genpois_list_sub_scPara <- sapply(mTrain_genpois_list_sub, "[", 2)

# --------------------------------------------------------------------------------------------------

# --------------------------------------------------------------------------------------------------
# GENERATE LIST OF DF THAT CONTAIN COMBINED LEAD IN REANALYSIS AND SEASONAL FORECASTS FOR EACH INDIVIDUAL MEMBER
# AND SEASONAL FORECASTS DAILY GLMM SIMULATED PREDICTIONS ------------------------------------------

#install.packages("formatR")
#library(formatR)
#formatR::tidy_source()
#obj <- tidy_source("fishcastr\\R\\compile_seasonal_forecast_list_glmm.R", reindent.space=5)

# reanalysis data subset to 2019 for (antecedent in conditions must run to end of Jun 2019)
data_ERA5_1979_2019_Jun_bc <- fishcastr::convert_grid_to_dataframe(grid_obj = fishcastr::grid_ERA5_1979_2019_Jun_bc)[,-2]
names(data_ERA5_1979_2019_Jun_bc)[which(names(data_ERA5_1979_2019_Jun_bc) == "dates1")] <- "date"

# # reanalysis data subset to 2019
# path_to_reanalysis = paste0(getwd(),"/inst\\extdata\\ERA5_bcc_op\\meteo_file.dat")
#   reanalysis_loc <- path_to_reanalysis
#   reanalysis_data <- read.table(reanalysis_loc, sep = '\t',header = FALSE, colClasses=c("V1"="Date"))
# # subset
#   reanalysis_data_sub <- subset(reanalysis_data, V1 <= as.Date("2019-08-31"))
#   # save
# dir.data <-  paste0(getwd(),'/vignettes/vignette_data/ERA5_bcc_ideal_eel')
# dirName <- paste0(dir.data, "/", sep = "", collapse = NULL)
# dir.create(dirName, showWarnings = TRUE, recursive = TRUE, mode = "0777")
# write.table(reanalysis_data_sub, paste0(dirName,"meteo_file.dat", sep = "", collapse = NULL), sep = "\t", row.names = FALSE, col.names = FALSE, quote = FALSE)

data_seel_enviro_1981_2019 <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_data/data_seel_enviro_1981_2019.rds"))

# subset the seasonal forecast grid to test using 3 years of data for example check
seas_subset <- lapply(fishcastr::grid_ERA5_1981_2019_7_8_9_10_11_12_tas_pr_petH_bc,
                      function(x){transformeR::subsetGrid(x,years = c(1981:1983, 1985:1988, 1990:2019))})

#seas_subset <- lapply(fishcastr::grid_ERA5_1981_2019_7_8_9_10_11_12_tas_pr_petH_bc,
#                      function(x){transformeR::subsetGrid(x,years = c(1981:1983, 1985:1988, 1990:2019))})

# GENERATE FORECAST DATA
system.time({seasonal_forecast_list_dfs_seel_daily_stoc <-
  fishcastr::compile_seasonal_forecast_list_glmm(
    calibrated_physio_model = mod_physio_expmG,
    calibrated_daily_model = mTrain_genpois_list_sub_mod,
    predictor_scaling_params = mTrain_genpois_list_sub_scPara,
    hydro_GR4J_model_params = fishcastr::GR4J_Burr_params_ERA5_bcc,
    air_to_water_model_params = fishcastr::air_to_water_Feeagh_params_ERA5_bcc,
    seasonal_forecast_grid = seas_subset,
    reanalysis_data = data_ERA5_1979_2019_Jun_bc,
    counts_and_antecedent_conditions = data_seel_enviro_1981_2019,
    species_bio_year_name = "eel_year",
    species_bio_yday_name = "eel_yday_biofix",
    fish_reaction_time = 20,
    initialisation_month = 7,
    no_forecast_months = 5,
    forecast_method = "stochastic",
    parallel = TRUE,
    parallel_seed_no = 23456,
    operational_year = 2019
  )})
#179.83/60 # 3 mins for 3 years
# 1721.22/60 # 28 mins for 37 years

saveRDS(seasonal_forecast_list_dfs_seel_daily_stoc,
        paste0(system.file("extdata",
                           package = "fishcastr"),
               "/vignette_data/SF_eel_ideal_loo_cv_23456.rds"))

#saveRDS(seasonal_forecast_list_dfs_seel_daily_stoc,
#        paste0(getwd(),"/vignettes",
#               "/vignette_data/SF_eel_ideal_loo_cv.rds"))

  rm(list = ls(all.names = TRUE))
invisible(gc())
```

*Visualisation of uncertainty in ERA5 forced predictions and model chain limitations*

The skill limitations of the model chain for predicting anomalies under known conditions (e.g., shown by **Table 1** and **Figure 4** of the manuscript) can be explored by evaluating the consistency between daily resolution simulated counts (under ERA5 forcing) and observations (e.g., for eels; **Figure \@ref(fig:era5-model-chain-checks-eel-plot-counts)**). In the context of our forecast system, consistency relates to the temporal spread of counts during the target season (the phenology curve shape), not overall numbers, which do not need to be consistent for meaningful comparison of calculated timing summary statistics (e.g., mean date of migration).

```{r era5-model-chain-checks-eel, warning = FALSE, eval = FALSE, echo = FALSE}
# --------------------------------------------------------------------------------------- #
# LOAD SEASONAL FORECAST DATA (PREDICTIONS/SIMULATIONS/PESUEDO-OBSERVATIONS)
# --------------------------------------------------------------------------------------- #

# ERA5 eel
seasonal_forecast_list_dfs_seel_daily_stoc_era5 <-
  readRDS(file = paste0(
    system.file("vignettes",
                package = "fishcastr"),
    "/vignette_data\\SF_eel_ideal_loo_cv_23456.rds"
  ))

# --------------------------------------------------------------------------------------- #
# FISH COUNTS (real obs)
# --------------------------------------------------------------------------------------- #
# add 2019 counts to forecast list object
data_seel <- fishcastr::import_fish_data(species = "seel")

seasonal_forecast_list_dfs_seel_daily_stoc_era5[[37]] <-
  lapply(seasonal_forecast_list_dfs_seel_daily_stoc_era5[[37]], function(x) {
    NA_dates_2019 <- x$date[which(is.na(x$seel))]
    x$seel[x$date %in% NA_dates_2019] <-
      data_seel$seel[data_seel$date %in% NA_dates_2019]
    return(x)
  })

dirName <- paste0(system.file("extdata", package = "fishcastr"),
                                      "/eel_wflow_figs/")
dir.create(dirName, showWarnings = TRUE, mode = "0777")

fish_counts_ERA5 <- fishcastr::plot_ensemble_data(seasonal_ensemble = seasonal_forecast_list_dfs_seel_daily_stoc_era5,
                           pseudo_obs_ensemble = seasonal_forecast_list_dfs_seel_daily_stoc_era5,
                           var_interest = "forecast_sim_counts",
                           obs_count_name = "seel",
                           bio_yday = "eel_yday_biofix",
                           bio_year = "eel_year",
                           colour_theme = "green3",
                           ensemble_name = "ERA5",
                           target_season = 7:12,
                           lead_month = 0,
                           export_to_file = TRUE,
                           ensemble.lty = "s",
                           plot_climatology = FALSE,
                           ylabel = expression("Fish count"),
                           export_file_folder = dirName,
                           multi_panel_plot = TRUE,
                           target_season_only = TRUE,
                           fill_obs_counts = TRUE)

# --------------------------------------------------------------------------------------- #
# HYDROLOGY (pseudo obs)
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                                      "/eel_wflow_figs/")

# sub in obs (not pseudo obs) discharge into list object
calculated_Q <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                              "/data_Feeagh_discharge_corr.rds"))
                                       
hydro_ERA5 <- lapply(seasonal_forecast_list_dfs_seel_daily_stoc_era5, function(x){
 res <- lapply(x, function(y){
    z <- merge(y,calculated_Q,by = "date",all.x = TRUE)
    return(z)
  })
  return(res)
})

hydrology <- fishcastr::plot_ensemble_data(seasonal_ensemble = hydro_ERA5,
                           pseudo_obs_ensemble = hydro_ERA5,
                           var_interest = "discharge",
                           obs_count_name = "discharge_m3.s",
                           bio_yday = "eel_yday_biofix",
                           bio_year = "eel_year",
                           colour_theme = "blue",
                           ensemble_name = "ERA5",
                           target_season = 7:12,
                           lead_month = 0,
                           export_to_file = TRUE,
                           ensemble.lty = "l",
                           plot_climatology = FALSE,
                           ylabel = "Catchment discharge (mm/day)",
                           export_file_folder = dirName,
                           multi_panel_plot = TRUE,
                           target_season_only = FALSE,
                           fill_obs_counts = FALSE)

# --------------------------------------------------------------------------------------- #
# WATER TEMPERATURE (pseudo obs)
# --------------------------------------------------------------------------------------- #
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                                      "/eel_wflow_figs/")

# sub in obs (not pseudo obs) water temps into list object
data_Feeagh2m_temp <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                              "/data_Feeagh2m_temp.rds"))


data_MR_temp <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                              "/data_MR_temp.rds"))

names(data_MR_temp)<- c("date", "Water_Temp_MR")

water_temp.merge <- merge(data_Feeagh2m_temp,data_MR_temp, by = "date", all = TRUE)
water_temp.merge.subset <- water_temp.merge[water_temp.merge$date %in% seq(from = as.Date("1979-01-01"), to = as.Date("2019-12-31"), by = "day"),]
water_temp.merge.subset$water_temp_bind <- water_temp.merge.subset$Water_Temp_2m

water_temp.merge.subset$water_temp_bind <-
  ifelse(
    is.na(water_temp.merge.subset$water_temp_bind) &
      is.na(water_temp.merge.subset$Water_Temp_2m),
    water_temp.merge.subset$Water_Temp_MR,
    water_temp.merge.subset$water_temp_bind
  )

# combine water temperature data
water_temp.merge.subset <- water_temp.merge.subset[,c("date","water_temp_bind")]

wtemp_ERA5 <- lapply(seasonal_forecast_list_dfs_seel_daily_stoc_era5, function(x){
 res <- lapply(x, function(y){
    z <- merge(y,water_temp.merge.subset,by = "date",all.x = TRUE)
    return(z)
  })
  return(res)
})

water_temperature <- fishcastr::plot_ensemble_data(seasonal_ensemble = wtemp_ERA5,
                           pseudo_obs_ensemble = wtemp_ERA5,
                           var_interest = "Tw_mod",
                           obs_count_name = "water_temp_bind",
                           bio_yday = "eel_yday_biofix",
                           bio_year = "eel_year",
                           colour_theme = "red",
                           ensemble_name = "ERA5",
                           target_season = 7:12,
                           lead_month = 0,
                           export_to_file = TRUE,
                           ensemble.lty = "l",
                           plot_climatology = FALSE,
                           ylabel = expression("Water temperature ("*~degree*C*")"),
                           export_file_folder = dirName,
                           multi_panel_plot = TRUE,
                           target_season_only = FALSE,
                           fill_obs_counts = FALSE)
```

```{r era5-model-chain-checks-eel-plot-counts, fig.align = "center", out.width="70%", eval = TRUE, fig.cap = "(ref:era5-model-chain-checks-eel-plot-counts)", echo = FALSE}
knitr::include_graphics(paste0(system.file("extdata", package = "fishcastr"),
                               "/eel_wflow_figs/ERA5_forecast_sim_counts.png"))
```

(ref:era5-model-chain-checks-eel-plot-counts) *Daily resolution European silver eel (*A. anguilla*) simulated counts recorded at Burrishoole during 1981 to 2019 during the seasonal forecast target season (July to December). Grey filled bars illustrate observations, while the 95% prediction intervals of simulated counts generated using known (held-out) model chain forcing data (ECMWF's ERA5 climate reanalysis) are illustrated by green polygons. The green line running through the polygon is the daily median simulated count. Daily median and 95% prediction intervals were calculated from 25 simulations per year. Note the different y-axis scales among plots.*

Further exploration of model chain predictions for hydrology (**Figure \@ref(fig:era5-model-chain-checks-eel-plot-discharge)**) and water temperature (**Figure \@ref(fig:era5-model-chain-checks-eel-plot-water-temp)**) are useful for identifying any systematic biases in seasonal prediction that are less clear when validating the model as a whole (e.g., observation vs. prediction plots and using KGE and rmse statistics).

```{r era5-model-chain-checks-eel-plot-discharge, fig.align = "center", out.width="70%",eval = TRUE, fig.cap = "(ref:era5-model-chain-checks-eel-plot-discharge)", echo = FALSE}
knitr::include_graphics(paste0(system.file("extdata", package = "fishcastr"),
                               "/eel_wflow_figs/ERA5_discharge.png"))
```

(ref:era5-model-chain-checks-eel-plot-discharge) *Daily resolution GR4J hydrologic model predictions and concurrent rating curve derived catchment discharge recorded at Burrishoole during 1981 to 2019 during a subsection of the seasonal forecast antecedent period and the target season for European silver eel (*A. anguilla*) (May 4 to December 31). Note the apparent data gaps relative to the full series illustrated for 2011 - these gaps indicate the early (pre-target season) period during each forecast year where eel counts were assumed to represent counts from a prior silvering period (i.e., late or spring migrants that pursued active migration the previous autumn). May 4 2011 was the earliest calender year day after which modelled water temperature exceeded 11 \degree C for 10 consecutive days. Black lines illustrate rating curve derived discharge, while blue lines illustrate GR4J predictions generated using known (held-out) model chain forcing data (ECMWF's ERA5 climate reanalysis). Note the different y-axis scales among plots.*

```{r era5-model-chain-checks-eel-plot-water-temp, fig.align = "center", out.width="70%",eval = TRUE, fig.cap = "(ref:era5-model-chain-checks-eel-plot-water-temp)", echo = FALSE}
knitr::include_graphics(paste0(system.file("extdata", package = "fishcastr"),
                               "/eel_wflow_figs/ERA5_Tw_mod.png"))
```

(ref:era5-model-chain-checks-eel-plot-water-temp) *Daily resolution statistical air to water temperature model predictions and concurrent measurements recorded at Burrishoole during 1981 to 2019 during a subsection of the seasonal forecast antecedent period and the  target season for European silver eel (*A. anguilla*) (May 4 to December 31). Note the apparent data gaps relative to the full series illustrated for 2011 - these gaps relate to the pre-target season period during each forecast year where eel counts might relate to a prior silvering period (i.e., spring migrants that pursued active migration the previous autumn). May 4 (2011) was the earliest calender year day after which modelled water temperature exceeded 11 \degree C for 10 consecutive days. Black lines illustrate observations (1981 to 2003 paper chart recorder in Mill Race; 2004 - 2019 Lough Feeagh AWQMS 2m depth temperature), while red lines illustrate model predictions generated using held-out model chain forcing data (ECMWF's ERA5 reanalysis). Note the different y-axis scales among plots.*

### *Seasonal forecast (ECMWF's SEAS5)*

We use `fishcastr` to produce a 25 member ensemble of plausible European silver eel daily counts under seasonal forecast conditions. Here, the model chain forcing data is a true ensemble of bias corrected ECMWF SEAS5 data, whereby each member for a given forecast year is unique and different years contained different data. Likewise for the known condition ensemble scenario described above, ensemble fish counts are produced stochastically and are effectively random draws from the (generalised Poisson) conditional distribution. In the SEAS5 scenario, the uniqueness of members of the output fish count ensemble within years are therefore consequence of both the unique forcing data per member *and* the random draw element.

```{r figure-5b-eel-methods, warning = FALSE, fig.height=7, fig.width=7, eval = FALSE, echo = FALSE}

# load physio response model
mod_physio_expmG <- fishcastr::model_physio_expmG_inv_eel

# load and subset list into model and scaling lists for relevant years only 1993 - 2019
model_list_1of2 <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_data/mTrain_genpois_eel_list_1of2.rds"))
model_list_2of2 <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_data/mTrain_genpois_eel_list_2of2.rds"))

mTrain_genpois_list <- list()
mTrain_genpois_list[1:length(model_list_1of2)] <- model_list_1of2
mTrain_genpois_list[(1 + length(model_list_1of2)):(length(model_list_1of2)+length(model_list_2of2))] <- model_list_2of2

 # add 2019 data
 mTrain_genpois_eel_2019 <- model_list_1of2 <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                    "/vignette_data/mTrain_genpois_eel_2019.rds"))
 pP_params_eel_2019 <- model_list_1of2 <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                    "/vignette_data/pP_params_eel_2019.rds"))
 
 mTrain_genpois_list[[37]] <- list(mTrain_genpois_eel_2019,
                                 pP_params_eel_2019)

names(mTrain_genpois_list) <- c(1981:1983, 1985:1988, 1990:2019)

# subset to 1993 - 2019 models for testing function
mTrain_genpois_list_sub <- mTrain_genpois_list[which(names(mTrain_genpois_list) %in% c(1993:2019))]

# model list
mTrain_genpois_list_sub_mod <- sapply(mTrain_genpois_list_sub, "[", 1)
# scaling param list
mTrain_genpois_list_sub_scPara <- sapply(mTrain_genpois_list_sub, "[", 2)

# --------------------------------------------------------------------------------------------------

# --------------------------------------------------------------------------------------------------
# GENERATE LIST OF DF THAT CONTAIN COMBINED LEAD IN REANALYSIS AND SEASONAL FORECASTS FOR EACH INDIVIDUAL MEMBER
# AND SEASONAL FORECASTS DAILY GLMM SIMULATED PREDICTIONS ------------------------------------------

#install.packages("formatR")
#library(formatR)
#formatR::tidy_source()
#obj <- tidy_source("fishcastr\\R\\compile_seasonal_forecast_list_glmm.R", reindent.space=5)

# reanalysis data subset to 2019 for (antecedent in conditions must run to end of Jun 2019)
data_ERA5_1979_2019_Jun_bc <- fishcastr::convert_grid_to_dataframe(grid_obj = fishcastr::grid_ERA5_1979_2019_Jun_bc)[,-2]
names(data_ERA5_1979_2019_Jun_bc)[which(names(data_ERA5_1979_2019_Jun_bc) == "dates1")] <- "date"

# # reanalysis data subset to 2019
# path_to_reanalysis = paste0(getwd(),"/inst\\extdata\\ERA5_bcc_op\\meteo_file.dat")
#   reanalysis_loc <- path_to_reanalysis
#   reanalysis_data <- read.table(reanalysis_loc, sep = '\t',header = FALSE, colClasses=c("V1"="Date"))
# # subset
#   reanalysis_data_sub <- subset(reanalysis_data, V1 <= as.Date("2019-08-31"))
#   # save
# dir.data <-  paste0(getwd(),'/vignettes/vignette_data/ERA5_bcc_ideal_eel')
# dirName <- paste0(dir.data, "/", sep = "", collapse = NULL)
# dir.create(dirName, showWarnings = TRUE, recursive = TRUE, mode = "0777")
# write.table(reanalysis_data_sub, paste0(dirName,"meteo_file.dat", sep = "", collapse = NULL), sep = "\t", row.names = FALSE, col.names = FALSE, quote = FALSE)

data_seel_enviro_1981_2019 <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_data/data_seel_enviro_1981_2019.rds"))

data_seel_enviro_1993_2019 <- data_seel_enviro_1981_2019[data_seel_enviro_1981_2019$eel_year %in% c(1993:2019),]

#View(data_seel_enviro_1981_2019)

# subset the seasonal forecast grid to test using 5 years of data for example check
#seas_subset <- lapply(fishcastr::grid_SEAS5_1993_2019_7_8_9_10_11_12_tas_pr_petH_bc,
#                      function(x){transformeR::subsetGrid(x,years = 2017:2019)})

seas_subset <- lapply(fishcastr::grid_SEAS5_1993_2019_7_8_9_10_11_12_tas_pr_petH_bc,
                      function(x){transformeR::subsetGrid(x,years = 1993:2019)})

# GENERATE FORECAST DATA
system.time({seasonal_forecast_list_dfs_seel_daily_stoc <-
  fishcastr::compile_seasonal_forecast_list_glmm(
    calibrated_physio_model = mod_physio_expmG,
    calibrated_daily_model = mTrain_genpois_list_sub_mod,
    predictor_scaling_params = mTrain_genpois_list_sub_scPara,
    hydro_GR4J_model_params = fishcastr::GR4J_Burr_params_ERA5_bcc,
    air_to_water_model_params = fishcastr::air_to_water_Feeagh_params_ERA5_bcc,
    seasonal_forecast_grid = seas_subset,
    reanalysis_data = data_ERA5_1979_2019_Jun_bc,
    counts_and_antecedent_conditions = data_seel_enviro_1993_2019,
    species_bio_year_name = "eel_year",
    species_bio_yday_name = "eel_yday_biofix",
    fish_reaction_time = 20,
    initialisation_month = 7,
    no_forecast_months = 5,
    forecast_method = "stochastic",
    parallel = TRUE,
    parallel_seed_no = 23456,
    operational_year = 2019
  )})
#174.14/60 # 3 mins for 3 years
# 1262.91/60 # 21 mins for 27 years

saveRDS(seasonal_forecast_list_dfs_seel_daily_stoc,
        paste0(system.file("extdata",
                           package = "fishcastr"),
               "/vignette_data/SF_eel_loo_cv_23456.rds"))

#saveRDS(seasonal_forecast_list_dfs_seel_daily_stoc,
#        paste0(getwd(),"/vignettes",
#               "/vignette_data/SF_eel_loo_cv.rds"))

  rm(list = ls(all.names = TRUE))
invisible(gc())
```

*Visualising uncertainty in SEAS5 forced model chain predictions*

The following **Figures \@ref(fig:SEAS5-model-chain-checks-eel-plot-counts)**, **\@ref(fig:SEAS5-model-chain-checks-eel-plot-discharge)** and **\@ref(fig:SEAS5-model-chain-checks-eel-plot-water-temp)** illustrate ensemble spread for simulated variable outputs from model chain components.

```{r SEAS5-model-chain-checks-eel, warning = FALSE, eval = FALSE, echo = FALSE}
# --------------------------------------------------------------------------------------- #
# LOAD SEASONAL FORECAST DATA (PREDICTIONS/SIMULATIONS/PESUEDO-OBSERVATIONS)
# --------------------------------------------------------------------------------------- #
seasonal_forecast_list_dfs_seel_daily_stoc_SEAS5 <-
  readRDS(file = paste0(
    system.file("vignettes", package = "fishcastr"),
    "/vignette_data\\SF_eel_loo_cv_23456.rds"
  ))

# --------------------------------------------------------------------------------------- #
# FISH COUNTS
# --------------------------------------------------------------------------------------- #

# add 2019 counts to forecast list object
data_seel <- fishcastr::import_fish_data(species = "seel")

seasonal_forecast_list_dfs_seel_daily_stoc_SEAS5[[27]] <-
  lapply(seasonal_forecast_list_dfs_seel_daily_stoc_SEAS5[[27]], function(x) {
    NA_dates_2019 <- x$date[which(is.na(x$seel))]
    x$seel[x$date %in% NA_dates_2019] <-
      data_seel$seel[data_seel$date %in% NA_dates_2019]
    return(x)
  })

dirName <- paste0(system.file("extdata", package = "fishcastr"),
                                      "/eel_wflow_figs/")
dir.create(dirName, showWarnings = TRUE, mode = "0777")

fish_counts_SEAS5 <- plot_ensemble_data(seasonal_ensemble = seasonal_forecast_list_dfs_seel_daily_stoc_SEAS5,
                           pseudo_obs_ensemble = seasonal_forecast_list_dfs_seel_daily_stoc_SEAS5,
                           var_interest = "forecast_sim_counts",
                           obs_count_name = "seel",
                           bio_yday = "eel_yday_biofix",
                           bio_year = "eel_year",
                           colour_theme = "green3",
                           ensemble_name = "SEAS5",
                           target_season = 7:12,
                           lead_month = 0,
                           export_to_file = TRUE,
                           ensemble.lty = "s",
                           plot_climatology = FALSE,
                           ylabel = expression("Fish count"),
                           export_file_folder = dirName,
                           multi_panel_plot = TRUE,
                           target_season_only = TRUE,
                           fill_obs_counts = TRUE)

# --------------------------------------------------------------------------------------- #
# HYDROLOGY
# --------------------------------------------------------------------------------------- #

# sub in rating curve calculated obs (not GR4J pseudo obs) into list object
calculated_Q <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                              "/data_Feeagh_discharge_corr.rds"))

hydro_SEAS5 <- lapply(seasonal_forecast_list_dfs_seel_daily_stoc_SEAS5, function(x){
 res <- lapply(x, function(y){
    z <- merge(y,calculated_Q,by = "date",all.x = TRUE)
    return(z)
  })
  return(res)
})

hydrology <- plot_ensemble_data(seasonal_ensemble = hydro_SEAS5,
                           pseudo_obs_ensemble = hydro_SEAS5,
                           var_interest = "discharge",
                           obs_count_name = "discharge_m3.s",
                           bio_yday = "eel_yday_biofix",
                           bio_year = "eel_year",
                           colour_theme = "blue",
                           ensemble_name = "SEAS5",
                           target_season = 7:12,
                           lead_month = 0,
                           export_to_file = TRUE,
                           ensemble.lty = "l",
                           plot_climatology = FALSE,
                           ylabel = "Catchment discharge (mm/day)",
                           export_file_folder = dirName,
                           multi_panel_plot = TRUE,
                           target_season_only = FALSE,
                           fill_obs_counts = FALSE)

# --------------------------------------------------------------------------------------- #
# WATER TEMPERATURE
# --------------------------------------------------------------------------------------- #

# sub in real data (for Feeagh 2004 - 2019 and Mill Race 1960 - 2017 if desired)
# (not pseudo obs) water temps into list object
data_Feeagh2m_temp <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                              "/data_Feeagh2m_temp.rds"))
data_MR_temp <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                              "/data_MR_temp.rds"))

names(data_MR_temp)<- c("date", "Water_Temp_MR")

water_temp.merge <- merge(data_Feeagh2m_temp,data_MR_temp, by = "date", all = TRUE)
water_temp.merge.subset <- water_temp.merge[water_temp.merge$date %in% seq(from = as.Date("1979-01-01"), to = as.Date("2019-12-31"), by = "day"),]
water_temp.merge.subset$water_temp_bind <- water_temp.merge.subset$Water_Temp_2m

water_temp.merge.subset$water_temp_bind <-
  ifelse(
    is.na(water_temp.merge.subset$water_temp_bind) &
      is.na(water_temp.merge.subset$Water_Temp_2m),
    water_temp.merge.subset$Water_Temp_MR,
    water_temp.merge.subset$water_temp_bind
  )

# combine water temperature data
water_temp.merge.subset <- water_temp.merge.subset[,c("date","water_temp_bind")]

wtemp_SEAS5 <- lapply(seasonal_forecast_list_dfs_seel_daily_stoc_SEAS5, function(x){
 res <- lapply(x, function(y){
    z <- merge(y,water_temp.merge.subset,by = "date",all.x = TRUE)
    return(z)
  })
  return(res)
})

water_temperature <- plot_ensemble_data(seasonal_ensemble = wtemp_SEAS5,
                           pseudo_obs_ensemble = wtemp_SEAS5,
                           var_interest = "Tw_mod",
                           obs_count_name = "water_temp_bind",
                           bio_yday = "eel_yday_biofix",
                           bio_year = "eel_year",
                           colour_theme = "red",
                           ensemble_name = "SEAS5",
                           target_season = 7:12,
                           lead_month = 0,
                           export_to_file = TRUE,
                           ensemble.lty = "l",
                           plot_climatology = FALSE,
                           ylabel = expression("Water temperature ("*~degree*C*")"),
                           export_file_folder = dirName,
                           multi_panel_plot = TRUE,
                           target_season_only = FALSE,
                           fill_obs_counts = FALSE)

```

```{r SEAS5-model-chain-checks-eel-plot-counts, fig.align = "center", out.width="70%",eval = TRUE, fig.cap = "(ref:SEAS5-model-chain-checks-eel-plot-counts)", echo = FALSE}
knitr::include_graphics(paste0(system.file("extdata", package = "fishcastr"),
                               "/eel_wflow_figs/SEAS5_forecast_sim_counts.png"))
```

(ref:SEAS5-model-chain-checks-eel-plot-counts) *Daily resolution European silver eels (*A. anguilla*) simulated counts recorded at Burrishoole during 1993 to 2019 during the seasonal forecast target season (July to December). Grey filled bars illustrate observations, while the 95% prediction intervals of simulated counts generated using seasonal forecast model chain forcing data (ECMWF's SEAS5 seasonal forecast system) are illustrated by green polygons. The green line running through the polygon is the daily median simulated count. Daily median and 95% prediction intervals were calculated from 25 simulations per year. Note the different y-axis scales among plots.*

```{r SEAS5-model-chain-checks-eel-plot-discharge, fig.align = "center", out.width="70%",eval = TRUE, fig.cap = "(ref:SEAS5-model-chain-checks-eel-plot-discharge)", echo = FALSE}
knitr::include_graphics(paste0(system.file("extdata", package = "fishcastr"),
                               "/eel_wflow_figs/SEAS5_discharge.png"))
```

(ref:SEAS5-model-chain-checks-eel-plot-discharge) *Daily resolution GR4J hydrologic model predictions and concurrent rating curve derived catchment discharge recorded at Burrishoole during 1993 to 2019 during the seasonal forecast antecedent, lead-time and target season for European silver eels (*A. anguilla*) (December 20/21/22 to December 31). Note the apparent data gaps relative to the full series illustrated for 2011 - these gaps indicate the early (pre-target season) period during each forecast year where eel counts were assumed to represent counts from a prior silvering period (i.e., late or spring migrants that pursued active migration the previous autumn). Black lines illustrate rating curve derived discharge, while blue polygons illustrate 95% prediction intervals of GR4J predictions generated using seasonal forecast model chain forcing data (ECMWF's SEAS5 seasonal forecast system). Note the different y-axis scales among plots.*

```{r SEAS5-model-chain-checks-eel-plot-water-temp, fig.align = "center", out.width="70%",eval = TRUE, fig.cap = "(ref:SEAS5-model-chain-checks-eel-plot-water-temp)", echo = FALSE}
knitr::include_graphics(paste0(system.file("extdata", package = "fishcastr"),
                               "/eel_wflow_figs/SEAS5_Tw_mod.png"))
```

(ref:SEAS5-model-chain-checks-eel-plot-water-temp) *Daily resolution statistical air to water temperature model predictions and concurrent measurements recorded at Burrishoole during 1981 to 2019 during the seasonal forecast antecedent, lead-time and target season for European silver eels (*A. anguilla*) (December 20/21/22 to December 31). Note the apparent data gaps relative to the full series illustrated for 2011 - these gaps indicate the early (pre-target season) period during each forecast year where eel counts were assumed to represent counts from a prior silvering period (i.e., late or spring migrants that pursued active migration the previous autumn). Black lines illustrate observations (1993 to 2003 paper chart recorder in Mill Race; 2004 - 2019 Lough Feeagh AWQMS 2m depth temperature), while red polygons illustrate 95% prediction intervals of model predictions generated using seasonal forecast model chain forcing data (ECMWF's SEAS5 seasonal forecast system). Note the different y-axis scales among plots.*

## (3b) Evaluate retrospective skill

Tabulated skill scores compactly reveal significant skill scores under ERA5 (**Table \@ref(tab:figure-5a-eel-result-tab-eel-1)**) and SEAS5 (**Table \@ref(tab:figure-5b-eel-result-tab-eel-1)**) forcing for a range of migration timing seasonal summary statistics. Percentile specific tercile plots for seasonal migration predictions under ERA5 (**Figure \@ref(fig:figure-5a-eel-plots-eel-2)**) and SEAS5 (**Figure \@ref(fig:figure-5b-eel-plots-eel-2)**) forcing reveal year-to-year accuracy of probabilistic predictions.

<!-- ### *Known conditions (ECMWF's ERA5)* -->

```{r figure-5a-eel-plots, warning = FALSE, fig.height=7, fig.width=7, eval = FALSE, echo = FALSE}

# load predictions in list format
seasonal_forecast_list_dfs_seel_daily_stoc <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_data/SF_eel_ideal_loo_cv_23456.rds"))

summary_stats = c("mean","50th","5th", "25th","33rd", "66th", "75th", "95th")
pred_or_sim = "forecast_sim_counts"
#pred_or_sim = "forecast_sim_mean"

dirName <- paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_figures/Fig5a/")

#dirName <- paste0(getwd(),"/vignettes/vignette_figures", "/Fig5a/", sep = "",
#                  collapse = NULL)
dir.create(dirName, showWarnings = TRUE, mode = "0777")

sum_stats_list <- lapply(summary_stats, FUN = function(stat){

# --------------------------------------------------------------------------------------------------#
# EXTRACT TERCILE CLASSES FOR OBS DATA ----
# --------------------------------------------------------------------------------------------------#
seas_fore_df_seel_daily_full_obs <- do.call(rbind,lapply(X = seasonal_forecast_list_dfs_seel_daily_stoc,
                                                  FUN = function(x){x[[1]]}))

seas_fore_df_seel_daily <- seas_fore_df_seel_daily_full_obs[seas_fore_df_seel_daily_full_obs$eel_year <= 2019,]

# add observed 2019 eels to df
#fishcastr::download_fish_data()
data_seel <- fishcastr::import_fish_data(species = "seel")

NA_dates_2019 <- seas_fore_df_seel_daily$date[which(is.na(seas_fore_df_seel_daily$seel))]
data_seel$seel[data_seel$date %in% NA_dates_2019]
seas_fore_df_seel_daily$seel[seas_fore_df_seel_daily$date %in% NA_dates_2019] <- data_seel$seel[data_seel$date %in% NA_dates_2019]

seas_fore_df_seel_daily_tercile_data <-
  fishcastr::boxplot_phenology(
    bio_year = seas_fore_df_seel_daily$eel_year,
    counts = seas_fore_df_seel_daily$seel,
    yday = seas_fore_df_seel_daily$eel_yday_biofix,
    dates = seas_fore_df_seel_daily$date,
    method = stat,
    species_name = "European eel (silver)",
    season = "Spring",
    summary_stat_calculation_months = c(7:12),
    plot = FALSE,
    detrended = FALSE
  )

obs <- seas_fore_df_seel_daily_tercile_data

# ------------------------------------------------------------------------------------------------------------- #
# EXTRACT TERCILE CLASSES FOR FORECAST DATA ----
# ------------------------------------------------------------------------------------------------------------- #
seas_list <- plyr::llply(.data = 1:25,.fun = function(y){
  #y = 1
  seas_fore_df_seel_daily_full <- do.call(rbind,lapply(X = seasonal_forecast_list_dfs_seel_daily_stoc,
                                                         FUN = function(x){x[[y]]}))
  seas_fore_df_seel_daily <- seas_fore_df_seel_daily_full[seas_fore_df_seel_daily_full$eel_year <= 2019,]
 # any(is.na(seas_fore_df_seel_daily[[pred_or_sim]]))
  
  # 3. use existing function to calculate quantile trends in observed data
  seas_fore_df_seel_daily_tercile_data_new <-
    fishcastr::boxplot_phenology(
      bio_year = seas_fore_df_seel_daily$eel_year,
      counts = seas_fore_df_seel_daily[[pred_or_sim]],
      yday = seas_fore_df_seel_daily$eel_yday_biofix,
      dates = seas_fore_df_seel_daily$date,
      method = stat,
      species_name = "European eel (silver)",
      season = "Spring",
      summary_stat_calculation_months = c(7:12),
      plot = FALSE,
      detrended = FALSE
    )
  
 reforecasts <- seas_fore_df_seel_daily_tercile_data_new$summary_stats
 return(list(reforecasts_list = reforecasts,
             mean_terciles = seas_fore_df_seel_daily_tercile_data_new$mean_terciles))
})
 #
 names(seas_list) <- 1:25
 
 all_sum_stats_seas_list <- lapply(X = seas_list,FUN = function(x){
    result <- cbind(x[["reforecasts_list"]][["year"]],
                    x[["reforecasts_list"]][[stat]])
return(result)
 })
 
 # bind summ stats together
 all_sum_stats_seas_list.bind <- do.call(cbind,all_sum_stats_seas_list)
 # subset columns to just one year column and 25 members
 all_sum_stats_seas_list.bind.sub <- as.data.frame(cbind(all_sum_stats_seas_list.bind[,1],
                                           all_sum_stats_seas_list.bind[,seq(from = 2, to = ncol(all_sum_stats_seas_list.bind), by = 2)]))
 colnames(all_sum_stats_seas_list.bind.sub) <- c("year",paste0("member_",1:25))

  # compute terciles using all member and year summary stats
 all_member_sum_stats <- c(as.matrix(all_sum_stats_seas_list.bind.sub[,-1]))
#tercile_bnds <- quantile(all_member_sum_stats,probs = c(1/3,2/3))
tercile_bnds <- as.numeric(Hmisc::cut2(all_member_sum_stats,
                                       g=3,
                                       onlycuts = TRUE))[2:3]
 
# assign each member a tercile anomaly
tercile_anoms_sf_ensemble <- cbind(ifelse(all_sum_stats_seas_list.bind.sub[,-1] < tercile_bnds[1],"early",
                              ifelse(all_sum_stats_seas_list.bind.sub[,-1] >= tercile_bnds[2],"late","average")))

rownames(tercile_anoms_sf_ensemble) <- all_sum_stats_seas_list.bind.sub[,1]
colnames(tercile_anoms_sf_ensemble) <- 1:25

# ------------------------------------------------------------------------------------------------------------- #
# TERCILE PLOT ----
# ------------------------------------------------------------------------------------------------------------- #
# dirName <- paste0(getwd(),"/vignettes/vignette_figures", "/Fig5a", "/eel/", sep = "",
#                  collapse = NULL)
#dir.create(dirName, showWarnings = FALSE, mode = "0777")

dirName <- paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_figures/Fig5a/eel/")
dir.create(dirName, showWarnings = FALSE, mode = "0777")

 # plot tercile plot -----
# install latest transformeR
#devtools::install_github("SantanderMetGroup/transformeR@v2.0.1") # was 2.0.1
#devtools::install_github("SantanderMetGroup/downscaleR@v3.3.1") # was 3.3.1

type_of_pred <- ifelse(pred_or_sim == "forecast_sim_counts","sim","pred")

  png(file = paste0(dirName,"Fig5a_ERA5_eel_",type_of_pred,"_",stat,".png"), width=2100, height=2200, res=300)
terciles_summary_stat_plot <-
  fishcastr::tercile_plot_summary_stats(
    seasonal_forecast_predictions = tercile_anoms_sf_ensemble,
    observed_anomalies = obs,
    species_name = "European eel (silver)",
    season = "autumn",
    method = stat,
    plot = FALSE
  )
  invisible(dev.off())
  
  return(list("individual_members"= seas_list,
              "combined_members_data" = list("all_member_sum_stat_data" = all_sum_stats_seas_list.bind.sub,
                                             "all_member_sum_stat_data_minus_op_year" = all_member_sum_stats,
                                             "tercile_bnds"= tercile_bnds,
                                             "tercile_anoms_sf_ensemble" = tercile_anoms_sf_ensemble),
              "obs" = obs,
              "terciles_summary_stat_plot" = terciles_summary_stat_plot,
              "seas_fore_df_seel_daily_full_obs" = seas_fore_df_seel_daily_full_obs,
              "tercile_anoms_sf_ensemble" = tercile_anoms_sf_ensemble))
  
})
    names(sum_stats_list) <- summary_stats

# --------------------------------------------------------------------------------------------------#
# EXPORT ALL TERCILE DATA AS RDS
# --------------------------------------------------------------------------------------------------#
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_figures/Fig5a/eel/")

sum_stats_list_subset <- lapply(sum_stats_list,function(x){
  res <- x[-c(which(names(x) == "seas_fore_df_seel_daily_full_obs"))]
  return(res)
})

saveRDS(object = sum_stats_list_subset,
        file = paste0(dirName,"Fig5a_ERA5_eel_tercile_data.rds"))
    
# --------------------------------------------------------------------------------------------------#
# COMPILE WINDOWS OF OPPORTUNITY SUMMARY TABLE ----
# --------------------------------------------------------------------------------------------------#
windows_op_table_data <- sapply(sapply(sum_stats_list, "[", 4),"[",2)

df <- plyr::ldply(windows_op_table_data, data.frame)

windows_op_table <- t(data.frame("statistic" = sapply(strsplit(df$.id, "\\."),"[",1),
  "early" = paste0(df$early_ROC.score,ifelse(df$early_ROC.significant_0_05 ==TRUE,"*","")),
                  "average" = paste0(df$average_ROC.score,ifelse(df$average_ROC.significant_0_05 ==TRUE,"*","")),
                  "late" = paste0(df$late_ROC.score,ifelse(df$late_ROC.significant_0_05 ==TRUE,"*",""))))
# export table
dir.data <- paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_figures/Fig5a/eel")
dirName <- paste0(dir.data, "/", sep = "", collapse = NULL)
#dir.create(dirName, showWarnings = TRUE, recursive = TRUE, mode = "0777")
write.table(x = windows_op_table, file = paste0(dirName,"windows_op_ERA5_eel.csv"), row.names = TRUE, sep = ",",col.names = FALSE)
  
# --------------------------------------------------------------------------------------------------#
# PLOT ALL SIMULATIONS (uncomment if required) ----
# --------------------------------------------------------------------------------------------------#
#    dirName <- paste0(getwd(),"/vignettes/vignette_figures", "/Fig5a", "/eel/year_mem_plot/", sep = "",
#                   collapse = NULL)
# dir.create(dirName, showWarnings = FALSE, mode = "0777")
# 
# type_of_pred <- ifelse(pred_or_sim == "forecast_sim_counts","sim","pred")
# 
#   for(i in c(1981:1983, 1985:1988, 1990:2019)){
#  # plot ensemble predictions individually ----
#     png(file = paste0(dirName,'Fig5a_',type_of_pred,'_ideal',i,'.png'), width=8200, height=2500, res=300)
#     ensemble_forecast_data_sumstat <-
#       plot_ensemble_forecast_data_sumstat(
#         seasonal_forecast_predictions = sum_stats_list$mean$tercile_anoms_sf_ensemble,
#         observed_anomalies = sum_stats_list$mean$obs,
#         forecast_list_object = seasonal_forecast_list_dfs_seel_daily_stoc,
#         bioyear_name = "eel_year",
#         bioyear_yday_name = "eel_yday_biofix",
#         count_name = "seel",
#         forecast_data_name = pred_or_sim,
#         plot = TRUE,
#         plot_CIs = FALSE,
#         plot_op_year = i,
#         plot_op_year_obs = TRUE
#       )
#     invisible(dev.off())
#   }

# --------------------------------------------------------------------------------------------------#
# PLOT SIMULATED COUNTS FOR ALL YEARS IN RIDGE LINE PLOT STYLE ----
# --------------------------------------------------------------------------------------------------#
dirName_plots <- paste0(
     system.file("extdata", package = "fishcastr"),
     "/vignette_figures/count_model_checks/"
   )
dir.create(dirName_plots, showWarnings = TRUE, mode = "0777")
png(file = paste0(dirName_plots,"FigS6c_ridge_mean.png"), width=9000, height=13000, res=300)
eel_anoms <- fishcastr::ridgeline_plot_phenology(bio_year = sum_stats_list$mean$seas_fore_df_seel_daily_full_obs$eel_year,
                                         counts = sum_stats_list$mean$seas_fore_df_seel_daily_full_obs[[pred_or_sim]],
                                         yday = sum_stats_list$mean$seas_fore_df_seel_daily_full_obs$eel_yday_biofix,
                                         dates = sum_stats_list$mean$seas_fore_df_seel_daily_full_obs$date,
                                         method = "mean",
                                         species_name = "European eel (silver)",
                                         season = "spring",
                                         unreliable_years = c(1984,1989),
                                         plot = TRUE,
                                         detrended = FALSE,
                                         xlims_plot = c(0.020,0.950))
invisible(dev.off())

  rm(list = ls(all.names = TRUE))
invisible(gc())
```

```{r figure-5a-eel-result-tab-eel-1, out.width="70%", eval = TRUE, fig.align = 'center', echo = FALSE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_figures/Fig5a/eel/")
res_tab <- read.table(file = paste0(dirName,"windows_op_ERA5_eel.csv"), sep = ",",
                      stringsAsFactors = FALSE)
colnames(res_tab) <- res_tab[1,]
res_tab <- res_tab[-1,]

tab <- knitr::kable(res_tab,row.names = FALSE,format = "latex",
                    caption = "(ref:figure-5a-eel-result-tab-eel-1)",
                    booktabs = TRUE)
#library(magrittr)
#tab %>% kableExtra::kable_classic(full_width = FALSE,html_font = "Arial")
tab
```

(ref:figure-5a-eel-result-tab-eel-1) *Receiver Operating Characteristic Skill Scores (ROCSS) for tercile based anomalies of migration timing summary statistics under ECMWF ERA5 forcing.*

```{r figure-5a-eel-plots-eel-1, out.width="70%", eval=FALSE, warning=FALSE, fig.align = 'center', echo = FALSE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/Fig5a/eel/")

# ---------------------------------------------------------------------------------------------- #
# 5th ----
image <- magick::image_read(paste0(dirName,"Fig5a_ERA5_eel_sim_5th.png"))
image_trimmed <- magick::image_trim(image) # trim white space
image_cropped <- magick::image_crop(image_trimmed, "2300x770+0x0", gravity = c("southwest")) 
image_cropped2 <- magick::image_crop(image_cropped, "2300x300+0x0", gravity = c("northwest")) 
image_chopped2 <- magick::image_trim(image_cropped2)
magick::image_write(image_chopped2, paste0(dirName,"Fig5a_ERA5_eel_sim_5th_crop.png"))

# ---------------------------------------------------------------------------------------------- #
# 25th ----
image <- magick::image_read(paste0(dirName,"Fig5a_ERA5_eel_sim_25th.png"))
image_trimmed <- magick::image_trim(image) # trim white space
image_cropped <- magick::image_crop(image_trimmed, "2300x770+0x0", gravity = c("southwest")) 
image_cropped2 <- magick::image_crop(image_cropped, "2300x300+0x0", gravity = c("northwest")) 
image_chopped2 <- magick::image_trim(image_cropped2)
magick::image_write(image_chopped2, paste0(dirName,"Fig5a_ERA5_eel_sim_25th_crop.png"))

# ---------------------------------------------------------------------------------------------- #
# 33rd ----
image <- magick::image_read(paste0(dirName,"Fig5a_ERA5_eel_sim_33rd.png"))
image_trimmed <- magick::image_trim(image) # trim white space
image_cropped <- magick::image_crop(image_trimmed, "2300x770+0x0", gravity = c("southwest")) 
image_cropped2 <- magick::image_crop(image_cropped, "2300x300+0x0", gravity = c("northwest")) 
image_chopped2 <- magick::image_trim(image_cropped2)
magick::image_write(image_chopped2, paste0(dirName,"Fig5a_ERA5_eel_sim_33rd_crop.png"))

# ---------------------------------------------------------------------------------------------- #
# 50th ----
image <- magick::image_read(paste0(dirName,"Fig5a_ERA5_eel_sim_50th.png"))
image_trimmed <- magick::image_trim(image) # trim white space
image_cropped <- magick::image_crop(image_trimmed, "2300x770+0x0", gravity = c("southwest")) 
image_cropped2 <- magick::image_crop(image_cropped, "2300x300+0x0", gravity = c("northwest")) 
image_chopped2 <- magick::image_trim(image_cropped2)
magick::image_write(image_chopped2, paste0(dirName,"Fig5a_ERA5_eel_sim_50th_crop.png"))

# ---------------------------------------------------------------------------------------------- #
# 66th ----
image <- magick::image_read(paste0(dirName,"Fig5a_ERA5_eel_sim_66th.png"))
image_trimmed <- magick::image_trim(image) # trim white space
image_cropped <- magick::image_crop(image_trimmed, "2300x770+0x0", gravity = c("southwest")) 
image_cropped2 <- magick::image_crop(image_cropped, "2300x300+0x0", gravity = c("northwest")) 
image_chopped2 <- magick::image_trim(image_cropped2)
magick::image_write(image_chopped2, paste0(dirName,"Fig5a_ERA5_eel_sim_66th_crop.png"))

# ---------------------------------------------------------------------------------------------- #
# 75th ----
image <- magick::image_read(paste0(dirName,"Fig5a_ERA5_eel_sim_75th.png"))
image_trimmed <- magick::image_trim(image) # trim white space
image_cropped <- magick::image_crop(image_trimmed, "2300x770+0x0", gravity = c("southwest")) 
image_cropped2 <- magick::image_crop(image_cropped, "2300x300+0x0", gravity = c("northwest")) 
image_chopped2 <- magick::image_trim(image_cropped2)
magick::image_write(image_chopped2, paste0(dirName,"Fig5a_ERA5_eel_sim_75th_crop.png"))

# ---------------------------------------------------------------------------------------------- #
# 95th ----
image <- magick::image_read(paste0(dirName,"Fig5a_ERA5_eel_sim_95th.png"))
image_trimmed <- magick::image_trim(image) # trim white space
image_cropped <- magick::image_crop(image_trimmed, "2300x770+0x0", gravity = c("southwest")) 
image_cropped2 <- magick::image_crop(image_cropped, "2300x300+0x0", gravity = c("northwest")) 
image_chopped2 <- magick::image_trim(image_cropped2)
magick::image_write(image_chopped2, paste0(dirName,"Fig5a_ERA5_eel_sim_95th_crop.png"))

# ---------------------------------------------------------------------------------------------- #
# mean ----
image <- magick::image_read(paste0(dirName,"Fig5a_ERA5_eel_sim_mean.png"))
image_trimmed <- magick::image_trim(image) # trim white space
image_cropped <- magick::image_crop(image_trimmed, "2300x770+0x0", gravity = c("southwest")) 
image_cropped2 <- magick::image_crop(image_cropped, "2300x400+0x0", gravity = c("northwest")) 
image_chopped2 <- magick::image_trim(image_cropped2)
magick::image_write(image_chopped2, paste0(dirName,"Fig5a_ERA5_eel_sim_mean_crop.png"))

# ---------------------------------------------------------------------------------------------- #
# legend ----
image <- magick::image_read(paste0(dirName,"Fig5a_ERA5_eel_sim_mean.png"))
image_chopped <- magick::image_trim(image) # trim white space
image_cropped <- magick::image_crop(image_chopped, "2300x370+0x0", gravity = c("southwest")) 
image_cropped2 <- magick::image_crop(image_cropped, "2300x500+0x0", gravity = c("northwest")) 
image_chopped2 <- magick::image_trim(image_cropped2)
magick::image_write(image_chopped2, paste0(dirName,"Fig5a_legcrop.png"))

library(multipanelfigure)

png(file = paste0(dirName,"Fig5a_ERA5.png"), width=1755, height=3200, res=300)
Fig5a_ERA5 <- multipanelfigure::multi_panel_figure(columns = 1, width = 132, height = c(24.3,24.3,24.3,24.3,24.3,24.3,24.3,31.0,28.0), unit = "mm") %>%
multipanelfigure::fill_panel(paste0(dirName,"Fig5a_ERA5_eel_sim_5th_crop.png"), row = 1,  column = 1,scaling = "shrink", panel_clip = "on",label = "5th") %>%
multipanelfigure::fill_panel(paste0(dirName,"Fig5a_ERA5_eel_sim_25th_crop.png"), row = 2,  column = 1,scaling = "shrink", panel_clip = "on",label = "25th") %>%
multipanelfigure::fill_panel(paste0(dirName,"Fig5a_ERA5_eel_sim_33rd_crop.png"), row = 3,  column = 1,scaling = "shrink", panel_clip = "on",label = "33rd") %>%
multipanelfigure::fill_panel(paste0(dirName,"Fig5a_ERA5_eel_sim_50th_crop.png"), row = 4,  column = 1,scaling = "shrink", panel_clip = "on",label = "50th") %>%
multipanelfigure::fill_panel(paste0(dirName,"Fig5a_ERA5_eel_sim_66th_crop.png"), row = 5,  column = 1,scaling = "shrink", panel_clip = "on",label = "66th") %>%
multipanelfigure::fill_panel(paste0(dirName,"Fig5a_ERA5_eel_sim_75th_crop.png"), row = 6,  column = 1,scaling = "shrink", panel_clip = "on",label = "75th") %>%
multipanelfigure::fill_panel(paste0(dirName,"Fig5a_ERA5_eel_sim_95th_crop.png"), row = 7,  column = 1,scaling = "shrink", panel_clip = "on",label = "95th") %>%
multipanelfigure::fill_panel(paste0(dirName,"Fig5a_ERA5_eel_sim_mean_crop.png"), row = 8,  column = 1,scaling = "shrink", panel_clip = "on",label = "mean") %>%
multipanelfigure::fill_panel(paste0(dirName,"Fig5a_legcrop.png"), row = 9,  column = 1,scaling = "shrink", panel_clip = "on",label = "")
Fig5a_ERA5
invisible(dev.off())
```

```{r figure-5a-eel-plots-eel-2, out.width="70%", eval = TRUE, warning=FALSE, fig.align = 'center', fig.cap = "(ref:figure-5a-eel-plots-eel-2)", echo = FALSE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/Fig5a/eel/")
knitr::include_graphics(path = paste0(dirName,"Fig5a_ERA5.png"))
```

(ref:figure-5a-eel-plots-eel-2) *Tercile plots illustrating the model chain's propensity to correctly predict anomaly categories during the retrospective period (1981 - 2019) using ECMWF's ERA5 as forcing data.*

<!-- ### *Seasonal forecast (ECMWF's SEAS5)* -->

```{r figure-5b-eel-plots, warning = FALSE,  fig.height=7, fig.width=7, eval = FALSE, echo = FALSE}
library(fishcastr)

# load predictions in list format
seasonal_forecast_list_dfs_seel_daily_stoc <- readRDS(paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_data/SF_eel_loo_cv_23456.rds"))

forecast_op_year <- 2019

summary_stats = c("mean","50th","5th", "25th","33rd", "66th", "75th", "95th")
pred_or_sim = "forecast_sim_counts"
#pred_or_sim = "forecast_sim_mean"
#stat = "mean"
#devtools::install_github("SantanderMetGroup/transformeR@v2.0.1") # was 1.7.4
#devtools::install_github("SantanderMetGroup/downscaleR@v3.3.1") # was 3.1.3

dirName <- paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_figures/Fig5b/")
dir.create(dirName, showWarnings = TRUE, mode = "0777")

sum_stats_list <- lapply(summary_stats, FUN = function(stat){
# --------------------------------------------------------------------------------------------------#
# EXTRACT TERCILE CLASSES FOR OBS DATA ----
# --------------------------------------------------------------------------------------------------#
seas_fore_df_seel_daily_full_obs <- do.call(rbind,lapply(X = seasonal_forecast_list_dfs_seel_daily_stoc,
                                                  FUN = function(x){x[[1]]}))

seas_fore_df_seel_daily <- seas_fore_df_seel_daily_full_obs[seas_fore_df_seel_daily_full_obs$eel_year <= 2019,]

# add observed 2019 eels to df
data_seel <- fishcastr::import_fish_data(species = "seel")

NA_dates_2019 <- seas_fore_df_seel_daily$date[which(is.na(seas_fore_df_seel_daily$seel))]
data_seel$seel[data_seel$date %in% NA_dates_2019]
seas_fore_df_seel_daily$seel[seas_fore_df_seel_daily$date %in% NA_dates_2019] <- data_seel$seel[data_seel$date %in% NA_dates_2019]

#par(mfrow = c(1,1))
# 3. use existing function to calculate quantile trends in obs data
#dev.new()
seas_fore_df_seel_daily_tercile_data <- fishcastr::boxplot_phenology(bio_year = seas_fore_df_seel_daily$eel_year,
                                                            counts = seas_fore_df_seel_daily$seel,
                                                            yday = seas_fore_df_seel_daily$eel_yday_biofix,
                                                            dates = seas_fore_df_seel_daily$date,
                                                            method = stat,
                                                            species_name = "European eel (silver)",
                                                            season = "Spring",
                                                            plot = FALSE,
                                                            summary_stat_calculation_months = c(7:12),
                                                            detrended = FALSE)

obs <- seas_fore_df_seel_daily_tercile_data

# ------------------------------------------------------------------------------------------------------------- #
# EXTRACT TERCILE CLASSES FOR FORECAST DATA ----
# ------------------------------------------------------------------------------------------------------------- #
 seas_list <- plyr::llply(.data = 1:25,.fun = function(y){
   #y = 1
   seas_fore_df_seel_daily_full <- do.call(rbind,lapply(X = seasonal_forecast_list_dfs_seel_daily_stoc,
                                                   FUN = function(x){x[[y]]}))
# which(is.na(seas_fore_df_seel_daily_full$rain_mm_1day))
 seas_fore_df_seel_daily <- seas_fore_df_seel_daily_full[seas_fore_df_seel_daily_full$eel_year <= 2019,]
#any(is.na(seas_fore_df_seel_daily[[pred_or_sim]]))
 # 3. use existing function to calculate quantile trends in observed data
 seas_fore_df_seel_daily_tercile_data_new <- fishcastr::boxplot_phenology(bio_year = seas_fore_df_seel_daily$eel_year,
                                                            counts = seas_fore_df_seel_daily[[pred_or_sim]],
                                                            yday = seas_fore_df_seel_daily$eel_yday_biofix,
                                                            dates = seas_fore_df_seel_daily$date,
                                                            method = stat,
                                                            species_name = "European eel (silver)",
                                                            season = "Spring",
                                                            plot = FALSE,
                                                            summary_stat_calculation_months = c(7:12),
                                                            detrended = FALSE)
 
 reforecasts <- seas_fore_df_seel_daily_tercile_data_new$summary_stats
 return(list(reforecasts_list = reforecasts,
             mean_terciles = seas_fore_df_seel_daily_tercile_data_new$mean_terciles))
 })
 #
 names(seas_list) <- 1:25
 
 all_sum_stats_seas_list <- lapply(X = seas_list,FUN = function(x){
    result <- cbind(x[["reforecasts_list"]][["year"]],
                    x[["reforecasts_list"]][[stat]])
return(result)
 })
 
 # bind summ stats together
 all_sum_stats_seas_list.bind <- do.call(cbind,all_sum_stats_seas_list)
 # subset columns to just one year column and 25 members
 all_sum_stats_seas_list.bind.sub <- as.data.frame(cbind(all_sum_stats_seas_list.bind[,1],
                                           all_sum_stats_seas_list.bind[,seq(from = 2, to = ncol(all_sum_stats_seas_list.bind), by = 2)]))
 colnames(all_sum_stats_seas_list.bind.sub) <- c("year",paste0("member_",1:25))

  # compute terciles using all member and year summary stats (removing op year
  # data before computing tercile boundaries) # note this differs from
  # calculation in visualizeR::tercilePlot in that tercile boundaries and
  # tercile classifications for visualizeR are computed for each member in turn
  # (using summary stats calculated for all years for that member), not using
  # all members of all years lumped together.
 
 #all_member_sum_stats_old <- c(as.matrix(all_sum_stats_seas_list.bind.sub[,-1]))
  #tercile_bnds <- quantile(all_member_sum_stats,probs = c(1/3,2/3))
 
  all_member_sum_stats <- c(as.matrix(all_sum_stats_seas_list.bind.sub[-which(all_sum_stats_seas_list.bind.sub[,"year"] == forecast_op_year),-1]))
  tercile_bnds <- as.numeric(Hmisc::cut2(all_member_sum_stats,
                                       g=3,
                                       onlycuts = TRUE))[2:3]
 
# assign each member a tercile anomaly
tercile_anoms_sf_ensemble <- cbind(ifelse(all_sum_stats_seas_list.bind.sub[,-1] < tercile_bnds[1],"early",
                              ifelse(all_sum_stats_seas_list.bind.sub[,-1] >= tercile_bnds[2],"late","average")))

rownames(tercile_anoms_sf_ensemble) <- all_sum_stats_seas_list.bind.sub[,1]
colnames(tercile_anoms_sf_ensemble) <- 1:25

# ------------------------------------------------------------------------------------------------------------- #
# TERCILE PLOT ----
# ------------------------------------------------------------------------------------------------------------- #
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_figures/Fig5b/eel/")
dir.create(dirName, showWarnings = FALSE, mode = "0777")

type_of_pred <- ifelse(pred_or_sim == "forecast_sim_counts","sim","pred")

 # plot tercile plot -----
  png(file = paste0(dirName,"Fig5b_SEAS5_eel_",type_of_pred,"_",stat,".png"), width=2100, height=2200, res=300)
terciles_summary_stat_plot <-
  fishcastr::tercile_plot_summary_stats(
    seasonal_forecast_predictions = tercile_anoms_sf_ensemble,
    observed_anomalies = obs,
    species_name = "European eel (silver)",
    season = "spring",
    method = stat,
    plot = TRUE
  )
  invisible(dev.off())
  
  return(list("individual_members"= seas_list,
              "combined_members_data" = list("all_member_sum_stat_data" = all_sum_stats_seas_list.bind.sub,
                                             "all_member_sum_stat_data_minus_op_year" = all_member_sum_stats,
                                             "tercile_bnds"= tercile_bnds,
                                             "tercile_anoms_sf_ensemble" = tercile_anoms_sf_ensemble),
              "obs" = obs,
              "terciles_summary_stat_plot" = terciles_summary_stat_plot,
              "seas_fore_df_seel_daily_full_obs" = seas_fore_df_seel_daily_full_obs,
              "tercile_anoms_sf_ensemble" = tercile_anoms_sf_ensemble))
  
})
    names(sum_stats_list) <- summary_stats

# --------------------------------------------------------------------------------------------------#
# EXPORT ALL TERCILE DATA AS RDS
# --------------------------------------------------------------------------------------------------#
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_figures/Fig5b/eel/")

sum_stats_list_subset <- lapply(sum_stats_list,function(x){
  res <- x[-c(which(names(x) == "seas_fore_df_seel_daily_full_obs"))]
  return(res)
})

saveRDS(object = sum_stats_list_subset,
        file = paste0(dirName,"Fig5b_SEAS5_eel_tercile_data.rds"))
    
# --------------------------------------------------------------------------------------------------#
# COMPILE WINDOWS OF OPPORTUNITY SUMMARY TABLE ----
# --------------------------------------------------------------------------------------------------#
windows_op_table_data <- sapply(sapply(sum_stats_list, "[", 4),"[",2)

df <- plyr::ldply(windows_op_table_data, data.frame)

windows_op_table <- t(data.frame("statistic" = sapply(strsplit(df$.id, "\\."),"[",1),
  "early" = paste0(df$early_ROC.score,ifelse(df$early_ROC.significant_0_05 ==TRUE,"*","")),
                  "average" = paste0(df$average_ROC.score,ifelse(df$average_ROC.significant_0_05 ==TRUE,"*","")),
                  "late" = paste0(df$late_ROC.score,ifelse(df$late_ROC.significant_0_05 ==TRUE,"*",""))))
# export table
dir.data <- paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_figures/Fig5b/eel/")
dirName <- paste0(dir.data, "/", sep = "", collapse = NULL)
write.table(x = windows_op_table, file = paste0(dirName,"windows_op_SEAS5_eel.csv"), row.names = TRUE, sep = ",",col.names = FALSE)
  
# --------------------------------------------------------------------------------------------------#
# PLOT ALL SIMULATIONS (uncomment if required) ----
# --------------------------------------------------------------------------------------------------#
# dirName <- paste0(getwd(),"/vignettes/vignette_figures", "/Fig6", "/eel/year_mem_plot/", sep = "",
#                   collapse = NULL)
# dir.create(dirName, showWarnings = FALSE, mode = "0777")
# 
# type_of_pred <- ifelse(pred_or_sim == "forecast_sim_counts","sim","pred")
# 
#   for(i in 1993:2019){
#  # plot ensemble predictions individually ----
#     png(file = paste0(dirName,'Fig6a_',type_of_pred,'_SF',i,'.png'), width=8200, height=2500, res=300)
#     ensemble_forecast_data_sumstat <-
#       plot_ensemble_forecast_data_sumstat(
#         seasonal_forecast_predictions = sum_stats_list$mean$tercile_anoms_sf_ensemble,
#         observed_anomalies = sum_stats_list$mean$obs,
#         forecast_list_object = seasonal_forecast_list_dfs_seel_daily_stoc,
#         bioyear_name = "eel_year",
#         bioyear_yday_name = "eel_yday_biofix",
#         count_name = "seel",
#         forecast_data_name = pred_or_sim,
#         plot = TRUE,
#         plot_CIs = FALSE,
#         plot_op_year = i,
#         plot_op_year_obs = TRUE
#       )
#     invisible(dev.off())
#   }

# --------------------------------------------------------------------------------------------------#
# PLOT ANOMALY HISTORICAL CONTEXT (experimental) ----
# --------------------------------------------------------------------------------------------------#
# seas_fore_df_seel_daily <- sum_stats_list$mean$seas_fore_df_seel_daily_full_obs[sum_stats_list$mean$seas_fore_df_seel_daily_full_obs$eel_year <= 2019,]
# 
#  dirName <- paste0(getwd(),"/vignettes/vignette_figures", "/Fig7", "/", sep = "",
#                   collapse = NULL)
#  dir.create(dirName, showWarnings = FALSE, mode = "0777")
# 
#   png(file = paste0(dirName,"Fig7a.png"), width=8200, height=2500, res=300)
#  plot_hist_context_op_forecast_sumstat_poly(seasonal_reforecasts_df = seas_fore_df_seel_daily,
#                                             seasonal_reforecast_summary = sum_stats_list$mean$terciles_summary_stat_plot$tercile_data,
#                                             biological_year_name = "eel_year",
#                                             biological_yday_name = "eel_yday_biofix",
#                                             count_name = "seel",
#                                             style = "poly")
#  invisible(dev.off())

rm(list = ls(all.names = TRUE))
invisible(gc())
```

```{r figure-5b-eel-result-tab-eel-1, out.width="70%", eval = TRUE, fig.align = 'center', echo = FALSE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                                   "/vignette_figures/Fig5b/eel/")
res_tab <- read.table(file = paste0(dirName,"windows_op_SEAS5_eel.csv"), sep = ",",
                      stringsAsFactors = FALSE)
colnames(res_tab) <- res_tab[1,]
res_tab <- res_tab[-1,]

tab <- knitr::kable(res_tab,row.names = FALSE,format = "latex", caption = "(ref:figure-5b-eel-result-tab-eel-1)",
                    booktabs = TRUE)
#library(magrittr)
#tab %>% kableExtra::kable_classic(full_width = FALSE,html_font = "Arial")
tab
```

(ref:figure-5b-eel-result-tab-eel-1) *Receiver Operating Characteristic Skill Scores (ROCSS) for tercile based anomalies of migration timing summary statistics under ECMWF SEAS5 forcing.*

```{r figure-5b-eel-plots-eel-1, out.width="70%", eval=FALSE, warning=FALSE, fig.align = 'center', echo = FALSE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/Fig5b/eel/")

# ---------------------------------------------------------------------------------------------- #
# 5th ----
image <- magick::image_read(paste0(dirName,"Fig5b_SEAS5_eel_sim_5th.png"))
image_trimmed <- magick::image_trim(image) # trim white space
image_cropped <- magick::image_crop(image_trimmed, "2300x770+0x0", gravity = c("southwest")) 
image_cropped2 <- magick::image_crop(image_cropped, "2300x300+0x0", gravity = c("northwest")) 
image_chopped2 <- magick::image_trim(image_cropped2)
magick::image_write(image_chopped2, paste0(dirName,"Fig5b_SEAS5_eel_sim_5th_crop.png"))

# ---------------------------------------------------------------------------------------------- #
# 25th ----
image <- magick::image_read(paste0(dirName,"Fig5b_SEAS5_eel_sim_25th.png"))
image_trimmed <- magick::image_trim(image) # trim white space
image_cropped <- magick::image_crop(image_trimmed, "2300x770+0x0", gravity = c("southwest")) 
image_cropped2 <- magick::image_crop(image_cropped, "2300x300+0x0", gravity = c("northwest")) 
image_chopped2 <- magick::image_trim(image_cropped2)
magick::image_write(image_chopped2, paste0(dirName,"Fig5b_SEAS5_eel_sim_25th_crop.png"))

# ---------------------------------------------------------------------------------------------- #
# 33rd ----
image <- magick::image_read(paste0(dirName,"Fig5b_SEAS5_eel_sim_33rd.png"))
image_trimmed <- magick::image_trim(image) # trim white space
image_cropped <- magick::image_crop(image_trimmed, "2300x770+0x0", gravity = c("southwest")) 
image_cropped2 <- magick::image_crop(image_cropped, "2300x300+0x0", gravity = c("northwest")) 
image_chopped2 <- magick::image_trim(image_cropped2)
magick::image_write(image_chopped2, paste0(dirName,"Fig5b_SEAS5_eel_sim_33rd_crop.png"))

# ---------------------------------------------------------------------------------------------- #
# 50th ----
image <- magick::image_read(paste0(dirName,"Fig5b_SEAS5_eel_sim_50th.png"))
image_trimmed <- magick::image_trim(image) # trim white space
image_cropped <- magick::image_crop(image_trimmed, "2300x770+0x0", gravity = c("southwest")) 
image_cropped2 <- magick::image_crop(image_cropped, "2300x300+0x0", gravity = c("northwest")) 
image_chopped2 <- magick::image_trim(image_cropped2)
magick::image_write(image_chopped2, paste0(dirName,"Fig5b_SEAS5_eel_sim_50th_crop.png"))

# ---------------------------------------------------------------------------------------------- #
# 66th ----
image <- magick::image_read(paste0(dirName,"Fig5b_SEAS5_eel_sim_66th.png"))
image_trimmed <- magick::image_trim(image) # trim white space
image_cropped <- magick::image_crop(image_trimmed, "2300x770+0x0", gravity = c("southwest")) 
image_cropped2 <- magick::image_crop(image_cropped, "2300x300+0x0", gravity = c("northwest")) 
image_chopped2 <- magick::image_trim(image_cropped2)
magick::image_write(image_chopped2, paste0(dirName,"Fig5b_SEAS5_eel_sim_66th_crop.png"))

# ---------------------------------------------------------------------------------------------- #
# 75th ----
image <- magick::image_read(paste0(dirName,"Fig5b_SEAS5_eel_sim_75th.png"))
image_trimmed <- magick::image_trim(image) # trim white space
image_cropped <- magick::image_crop(image_trimmed, "2300x770+0x0", gravity = c("southwest")) 
image_cropped2 <- magick::image_crop(image_cropped, "2300x300+0x0", gravity = c("northwest")) 
image_chopped2 <- magick::image_trim(image_cropped2)
magick::image_write(image_chopped2, paste0(dirName,"Fig5b_SEAS5_eel_sim_75th_crop.png"))

# ---------------------------------------------------------------------------------------------- #
# 95th ----
image <- magick::image_read(paste0(dirName,"Fig5b_SEAS5_eel_sim_95th.png"))
image_trimmed <- magick::image_trim(image) # trim white space
image_cropped <- magick::image_crop(image_trimmed, "2300x770+0x0", gravity = c("southwest")) 
image_cropped2 <- magick::image_crop(image_cropped, "2300x300+0x0", gravity = c("northwest")) 
image_chopped2 <- magick::image_trim(image_cropped2)
magick::image_write(image_chopped2, paste0(dirName,"Fig5b_SEAS5_eel_sim_95th_crop.png"))

# ---------------------------------------------------------------------------------------------- #
# MEAN ----
image <- magick::image_read(paste0(dirName,"Fig5b_SEAS5_eel_sim_mean.png"))
image_trimmed <- magick::image_trim(image) # trim white space
image_cropped <- magick::image_crop(image_trimmed, "2300x770+0x0", gravity = c("southwest")) 
image_cropped2 <- magick::image_crop(image_cropped, "2300x400+0x0", gravity = c("northwest")) 
image_chopped2 <- magick::image_trim(image_cropped2)
magick::image_write(image_chopped2, paste0(dirName,"Fig5b_SEAS5_eel_sim_mean_crop.png"))

# ---------------------------------------------------------------------------------------------- #
# legend ----
image <- magick::image_read(paste0(dirName,"Fig5b_SEAS5_eel_sim_mean.png"))
image_chopped <- magick::image_trim(image) # trim white space
image_cropped <- magick::image_crop(image_chopped, "2300x370+0x0", gravity = c("southwest")) 
image_cropped2 <- magick::image_crop(image_cropped, "2300x500+0x0", gravity = c("northwest")) 
image_chopped2 <- magick::image_trim(image_cropped2)
magick::image_write(image_chopped2, paste0(dirName,"Fig5b_legcrop.png"))

# ---------------------------------------------------------------------------------------------- #
# nulti-panel figure ----
library(multipanelfigure)

dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/Fig5b/eel/")

png(file = paste0(dirName,"Fig5b_SEAS5.png"), width=1755, height=3300, res=300)
Fig5a_ERA5 <- multipanelfigure::multi_panel_figure(columns = 1, width = 132, height = c(24.3,24.3,24.3,24.3,24.3,24.3,24.3,31.0,28.0), unit = "mm") %>%
multipanelfigure::fill_panel(paste0(dirName,"Fig5b_SEAS5_eel_sim_5th_crop.png"), row = 1,  column = 1,scaling = "shrink", panel_clip = "on",label = "5th") %>%
multipanelfigure::fill_panel(paste0(dirName,"Fig5b_SEAS5_eel_sim_25th_crop.png"), row = 2,  column = 1,scaling = "shrink", panel_clip = "on",label = "25th") %>%
multipanelfigure::fill_panel(paste0(dirName,"Fig5b_SEAS5_eel_sim_33rd_crop.png"), row = 3,  column = 1,scaling = "shrink", panel_clip = "on",label = "33rd") %>%
multipanelfigure::fill_panel(paste0(dirName,"Fig5b_SEAS5_eel_sim_50th_crop.png"), row = 4,  column = 1,scaling = "shrink", panel_clip = "on",label = "50th") %>%
multipanelfigure::fill_panel(paste0(dirName,"Fig5b_SEAS5_eel_sim_66th_crop.png"), row = 5,  column = 1,scaling = "shrink", panel_clip = "on",label = "66th") %>%
multipanelfigure::fill_panel(paste0(dirName,"Fig5b_SEAS5_eel_sim_75th_crop.png"), row = 6,  column = 1,scaling = "shrink", panel_clip = "on",label = "75th") %>%
multipanelfigure::fill_panel(paste0(dirName,"Fig5b_SEAS5_eel_sim_95th_crop.png"), row = 7,  column = 1,scaling = "shrink", panel_clip = "on",label = "95th") %>%
multipanelfigure::fill_panel(paste0(dirName,"Fig5b_SEAS5_eel_sim_mean_crop.png"), row = 8,  column = 1,scaling = "shrink", panel_clip = "on",label = "mean") %>%
multipanelfigure::fill_panel(paste0(dirName,"Fig5b_legcrop.png"), row = 9,  column = 1,scaling = "shrink", panel_clip = "on",label = "")
Fig5a_ERA5
invisible(dev.off())
```

```{r figure-5b-eel-plots-eel-2, out.width="70%", eval = TRUE, warning=FALSE, fig.align = 'center', fig.cap = "(ref:figure-5b-eel-plots-eel-2)", echo = FALSE}
dirName <- paste0(system.file("extdata", package = "fishcastr"),
                  "/vignette_figures/Fig5b/eel/")
knitr::include_graphics(path = paste0(dirName,"Fig5b_SEAS5.png"))
```

(ref:figure-5b-eel-plots-eel-2) *Tercile plots illustrating the model chain's propensity to correctly predict anomaly categories during the retrospective period (1993 - 2019) using ECMWF's SEAS5 as forcing data.*

# DATA LICENSING

To facilitate faster reproducibility checks while minimising the volume of data stored within the package, we have included only post-processed ECMWF ERA5 and SEAS5 data that we accessed using the [Copernicus Climate Data Store (CDS)](https://doi.org/10.24381/cds.adbb2d47). Here, we aggregated sub-daily data (hourly for ERA5; 6-hourly for SEAS5) to daily values, calculated daily potential evapotranspiration, spatially interpolated from grid to point for Burrishoole and statistically bias adjusted against local gap-filled weather station data. To access the raw ERA5 and SEAS5 data using the Copernicus CDS and follow our processing steps, see [/data-raw/grid_ERA5_download_scripts/](https://github.com/as-french/fishcastr/tree/master/data-raw/grid_ERA5_download_scripts) and [/data-raw/grid_SEAS5_download_scripts/](https://github.com/as-french/fishcastr/tree/master/data-raw/grid_SEAS5_download_scripts).

To comply with the [License to Use Copernicus Products](https://cds.climate.copernicus.eu/api/v2/terms/static/licence-to-use-copernicus-products.pdf) in addition to the [License to Use C3S seasonal forecast multi-system](https://cds.climate.copernicus.eu/api/v2/terms/static/Additional-licence-to-use-non-European-contributions.pdf) for data originating from European modelling centres, we state:

**The fishcastr R package contains modified Copernicus Climate Change Service information derived from the ECMWF ERA5 hourly data on single levels from 1979 to present (years included in fishcastr: 1979 - 2019) and modified ECMWF SEAS5 Seasonal forecast daily and subdaily data on single levels 1993 to present (years included in fishcastr: 1993 - 2019)**

# LITERATURE CITED
